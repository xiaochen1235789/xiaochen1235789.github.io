<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="å…­å“¥è£è€€WIKI,è§’è‰²,å…‰é”¥,å…»æˆææ–™,æ¸¸æˆæ”»ç•¥">
    <meta name="description" content="å…­å“¥è£è€€WIKIï¼Œæ•´ç†æ¸¸æˆå†…è§’è‰²ã€å…‰é”¥ã€å…»æˆææ–™ç­‰ä¿¡æ¯ï¼Œä¸ºç©å®¶æä¾›è¯¦ç»†å‚è€ƒï¼Œçº¯å±è™šæ„å¨±ä¹ã€‚">
    
    <!-- Open Graph å’Œ Twitter å¡ç‰‡ä¼˜åŒ– -->
    <meta property="og:title" content="å…­å“¥è£è€€WIKI">
    <meta property="og:description" content="æ•´ç†æ¸¸æˆå†…è§’è‰²ã€å…‰é”¥ã€å…»æˆææ–™ç­‰ä¿¡æ¯ï¼Œä¸ºç©å®¶æä¾›è¯¦ç»†å‚è€ƒ">
    <meta property="og:image" content="https://xiaochen1235789.github.io/images/wangzhantupian.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="å…­å“¥è£è€€WIKI">
    <meta name="twitter:description" content="æ•´ç†æ¸¸æˆå†…è§’è‰²ã€å…‰é”¥ã€å…»æˆææ–™ç­‰ä¿¡æ¯ï¼Œä¸ºç©å®¶æä¾›è¯¦ç»†å‚è€ƒ">
    
    <!-- ç»“æ„åŒ–æ•°æ® -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "å…­å“¥è£è€€WIKI",
        "description": "æ•´ç†æ¸¸æˆå†…è§’è‰²ã€å…‰é”¥ã€å…»æˆææ–™ç­‰ä¿¡æ¯ï¼Œä¸ºç©å®¶æä¾›è¯¦ç»†å‚è€ƒ",
        "url": "https://xiaochen1235789.github.io"
    }
    </script>
    
    <link rel="icon" href="https://xiaochen1235789.github.io/images/wangzhantupian.png" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>å…­å“¥è£è€€WIKI</title>
    
    <!-- Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==================== åŸºç¡€å˜é‡ ==================== */
        :root {
            --bg: #121212;
            --card-bg: #1e3a2f;
            --card-bg-hover: #284a3c;
            --text-main: #e0e0e0;
            --text-highlight: #81c784;
            --text-secondary: #99aabb;
            --radius: 6px;
            --gap: 12px;
            --special-color: #ffd700;
            --border-color: #3d725f;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --supabase-blue: #3ecf8e;
            --supabase-purple: #8a4baf;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }
        
        body {
            overflow-x: hidden;
            padding-bottom: 120px !important;
            background: var(--bg) !important;
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* ==================== åŠ è½½ç›¸å…³æ ·å¼ ==================== */
        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--text-highlight);
            z-index: 9999999;
            transition: width 0.3s ease, opacity 0.5s ease;
            opacity: 1;
        }
        
        #global-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(129, 199, 132, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-highlight);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* éª¨æ¶å±æ•ˆæœ */
        .skeleton {
            background: linear-gradient(90deg, #2a3a35 25%, #354540 50%, #2a3a35 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== */
        .top-nav {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 12px 16px;
            margin: 16px auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            max-width: 1200px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 9999;
        }
        
        .nav-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-highlight);
            margin-right: auto;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link {
            color: var(--text-main);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            white-space: nowrap;
            position: relative;
        }
        
        .nav-link:hover {
            background: var(--card-bg-hover);
            color: var(--text-highlight);
            transform: translateY(-1px);
        }
        
        .nav-link.active {
            background: var(--card-bg-hover);
            color: var(--special-color);
            font-weight: 600;
            border: 1px solid var(--special-color);
        }
        
        /* ==================== ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ ==================== */
        .user-nav-section {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-info-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(129, 199, 132, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(129, 199, 132, 0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .username {
            color: var(--text-highlight);
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .logout-btn {
            background: transparent;
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, 0.3);
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .logout-btn:hover {
            background: rgba(248, 113, 113, 0.1);
            transform: translateY(-1px);
        }
        
        /* ==================== æœç´¢åŠŸèƒ½ ==================== */
        .search-container {
            max-width: 1200px;
            margin: 0 auto 16px;
            padding: 0 8px;
            position: relative;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            background: #2d3748;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-main);
            font-size: 0.95rem;
            outline: none;
            transition: all var(--transition-fast);
        }
        
        #search-input:focus {
            border-color: var(--text-highlight);
            box-shadow: 0 0 0 2px rgba(129, 199, 132, 0.2);
        }
        
        .search-icon {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .search-history {
            position: absolute;
            top: 100%;
            left: 8px;
            right: 8px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-top: 4px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-history.show {
            display: block;
        }
        
        .history-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-clear {
            padding: 8px 16px;
            text-align: center;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* ç©ºç»“æœæç¤º */
        .empty-result {
            max-width: 1200px;
            margin: 40px auto;
            padding: 40px 30px;
            text-align: center;
            background: var(--card-bg);
            border-radius: var(--radius);
            color: var(--text-secondary);
            display: none;
            border: 1px dashed var(--border-color);
        }
        
        /* ==================== ç½‘ç«™è¿è¡Œå¤©æ•° ==================== */
        .site-age-container {
            max-width: 1200px;
            margin: 0 auto 16px;
            padding: 12px 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid transparent;
        }
        
        #site-age {
            color: var(--text-highlight);
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(129, 199, 132, 0.1);
        }
        
        #site-age.special {
            color: var(--special-color);
            animation: flash 1.5s infinite alternate;
            background: rgba(255, 215, 0, 0.1);
            padding: 8px 16px;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        
        @keyframes flash {
            from { 
                opacity: 1; 
                text-shadow: 0 0 5px rgba(255,215,0,0.5); 
            }
            to { 
                opacity: 0.9; 
                text-shadow: 0 0 15px rgba(255,215,0,0.8); 
            }
        }
        
        /* ==================== å†…å®¹å¡ç‰‡ç½‘æ ¼ ==================== */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--gap);
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 8px;
        }
        
        .content-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            width: 100% !important;
            height: auto !important;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .content-card::before {
            content: attr(data-type);
            position: absolute;
            top: 6px;
            left: 6px;
            padding: 2px 8px;
            background: var(--text-highlight);
            color: var(--bg);
            font-size: 0.7rem;
            border-radius: 4px;
            font-weight: 600;
            z-index: 1;
            opacity: 0.9;
        }
        
        .content-card.lightcone-card::before {
            background: #8197c7;
        }
        
        .content-card.material-card::before {
            background: #c781a6;
        }
        
        .content-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            background: var(--card-bg-hover);
            border-color: var(--text-highlight);
        }
        
        /* å›¾ç‰‡å®¹å™¨ */
        .card-img {
            width: 100%;
            background: #2d5243;
            border-radius: var(--radius);
            margin-bottom: 12px;
            padding: 0 !important;
            overflow: hidden !important;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .content-card:not(.lightcone-card):not(.material-card) .card-img {
            aspect-ratio: 4/5;
        }
        
        .lightcone-card .card-img {
            aspect-ratio: 3/4;
            transform: rotate(-5deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .material-card .card-img {
            aspect-ratio: 1/1;
            border: 1px solid var(--border-color);
        }
        
        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
            opacity: 0;
        }
        
        .card-img img.loaded {
            opacity: 1;
        }
        
        /* å¡ç‰‡æ–‡å­—æ ·å¼ */
        .card-name {
            font-size: 1rem;
            color: var(--text-highlight);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
            font-weight: 600;
        }
        
        .card-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 36px;
            line-height: 1.4;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        .section-header {
            max-width: 1200px;
            margin: 32px auto 16px;
            font-size: 1.4rem;
            color: var(--text-highlight);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            padding-left: 8px;
            scroll-margin-top: 100px;
        }
        
        /* ==================== æ”¶è—æŒ‰é’®æ ·å¼ ==================== */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
            opacity: 0;
        }
        
        .content-card:hover .favorite-btn {
            opacity: 1;
        }
        
        .favorite-btn.active {
            color: #f87171;
        }
        
        /* ==================== æ›´æ–°æ—¥å¿—æ ·å¼ ==================== */
        .changelog-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            margin: 0 auto 250px;
            max-width: 1200px;
        }
        
        .pet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .pet-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--text-highlight);
        }
        
        .pet-title {
            font-size: 1.3rem;
            color: var(--text-highlight);
            font-weight: 600;
        }
        
        .changelog-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 0 16px;
        }
        
        .control-btn {
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .changelog-list {
            padding: 16px;
            line-height: 1.8;
        }
        
        .changelog-item {
            margin: 10px 0;
            border-radius: 6px;
            overflow: hidden;
            background-color: #23322d;
            border: 1px solid var(--border-color);
        }
        
        .changelog-item summary {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: bold;
            background-color: #2d443b;
            list-style: none;
            color: #a8d0b9;
            display: flex;
            align-items: center;
        }
        
        .changelog-content {
            padding: 12px 16px;
            border-top: 1px solid #3a5048;
        }
        
        .version-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            background: rgba(129, 199, 132, 0.2);
            color: var(--text-highlight);
            border: 1px solid rgba(129, 199, 132, 0.3);
        }
        
        .highlight {
            color: var(--special-color);
            font-weight: 600;
            background: rgba(255, 215, 0, 0.1);
            padding: 0 4px;
            border-radius: 3px;
            margin: 0 2px;
        }
        
        /* ==================== è¯„è®ºç³»ç»ŸåŸºç¡€æ ·å¼ ==================== */
        .comments-system {
            max-width: 1200px;
            margin: 0 auto 60px;
            padding: 0 8px;
        }
        
        .comments-stats {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(129, 199, 132, 0.05);
            border-radius: var(--radius);
        }
        
        .comments-sort {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .sort-btn {
            padding: 8px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sort-btn.active {
            background: var(--text-highlight);
            color: var(--bg);
            border-color: var(--text-highlight);
        }
        
        /* è¯„è®ºè¡¨å• */
        .comment-form-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comment-editor textarea {
            width: 100%;
            padding: 16px;
            background: #2d3748;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-main);
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            min-height: 100px;
            max-height: 300px;
        }
        
        .editor-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tools-left {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-submit {
            padding: 10px 24px;
            background: var(--text-highlight);
            color: var(--bg);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* è¯„è®ºåˆ—è¡¨ */
        .comments-list {
            margin-top: 30px;
            min-height: 200px;
        }
        
        .comment-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }
        
        .comment-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .comment-content {
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 16px;
            word-break: break-word;
        }
        
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* å›å¤è¡¨å• */
        .reply-form {
            margin-top: 16px;
            padding-left: 52px;
        }
        
        .comment-replies {
            margin-left: 52px;
            margin-top: 16px;
            border-left: 2px solid var(--border-color);
            padding-left: 20px;
        }
        
        /* è¯„è®ºåˆ†é¡µ */
        .comments-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .page-btn {
            padding: 8px 16px;
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
        }
        
        /* ç©ºè¯„è®ºçŠ¶æ€ */
        .empty-comments {
            text-align: center;
            padding: 60px 20px;
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px dashed var(--border-color);
        }
        
        /* ==================== é¡µè„š ==================== */
        footer {
            text-align: center;
            padding: 30px 0;
            font-size: 0.9rem;
            color: #888;
            margin-top: 60px;
            border-top: 1px solid var(--border-color);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* ==================== éŸ³ä¹æ’­æ”¾å™¨ ==================== */
        #musicPlayerIframe {
            display: block !important;
            visibility: visible !important;
            height: 380px !important;
            width: 100% !important;
            z-index: 99999 !important;
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            border: none !important;
            background: transparent !important;
            overflow: visible !important;
            transition: height 0.3s ease !important;
        }
        
        /* ==================== å›åˆ°é¡¶éƒ¨æŒ‰é’® ==================== */
        .back-to-top {
            position: fixed;
            bottom: 130px;
            right: 20px;
            width: 46px;
            height: 46px;
            background: var(--card-bg-hover);
            color: var(--text-highlight);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            z-index: 9999;
            border: 1px solid var(--text-highlight);
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* ==================== é€šçŸ¥æ¶ˆæ¯ ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text-highlight);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.4s ease;
            border-left: 4px solid var(--text-highlight);
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left-color: #4ade80;
            color: #4ade80;
        }
        
        .notification.error {
            border-left-color: #f87171;
            color: #f87171;
        }
        
        .notification.warning {
            border-left-color: #fbbf24;
            color: #fbbf24;
        }
        
        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 768px) {
    .grid-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .top-nav {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        scrollbar-width: none;
        align-items: center;
        padding: 10px 12px;
        gap: 8px;
        -ms-overflow-style: none;
    }
    
    .top-nav::-webkit-scrollbar {
        display: none;
    }
    
    .nav-title {
        margin-right: 12px;
        position: sticky;
        left: 0;
        background: var(--card-bg);
        z-index: 2;
        padding-right: 8px;
    }
    
    .nav-link {
        flex-shrink: 0;
    }
    
    .user-nav-section {
        margin-left: auto;
        flex-shrink: 0;
        border-top: none;
        padding-top: 0;
        margin-top: 0;
        width: auto;
    }
    
    .favorite-btn {
        opacity: 1;
    }
    
    body {
        padding-bottom: 60px !important;
    }
    
    #musicPlayerIframe {
        height: 90px !important;
    }
}
        
        @media (max-width: 480px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .comments-pagination {
                flex-direction: column;
                gap: 10px;
            }
            
            .page-btn {
                width: 100%;
            }
        }
        
        /* ==================== æ»šåŠ¨æ¡ä¼˜åŒ– ==================== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-highlight);
        }
    </style>
</head>
<body>
    <!-- åŠ è½½è¿›åº¦æ¡ -->
    <div class="loading-progress" id="loadingProgress"></div>
    
    <!-- å…¨å±€åŠ è½½åŠ¨ç”» -->
    <div id="global-loading">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="color: var(--text-highlight); margin-top: 16px; font-size: 1.1rem;">åŠ è½½èµ„æºä¸­...</p>
        </div>
    </div>

    <!-- é€šçŸ¥æ¶ˆæ¯å®¹å™¨ -->
    <div class="notification" id="notification"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="top-nav" aria-label="ä¸»è¦å¯¼èˆª">
        <div class="nav-title">
            <span>å…­å“¥è£è€€WIKI</span>
        </div>
        <a href="#character" class="nav-link" data-target="character">è§’è‰²</a>
        <a href="#lightcone" class="nav-link" data-target="lightcone">å…‰é”¥</a>
        <a href="profile.html" class="nav-link">ä¸ªäººä¸»é¡µ</a>
        <a href="#material" class="nav-link" data-target="material">å…»æˆææ–™</a>
        <a href="#changelog" class="nav-link" data-target="changelog">æ›´æ–°æ—¥å¿—</a>
        <a href="#comments" class="nav-link" data-target="comments">ç”¨æˆ·è¯„è®º</a>
        
        <!-- ç”¨æˆ·å¯¼èˆªéƒ¨åˆ† -->
        <div class="user-nav-section" id="userNavSection">
            <a href="login-real.html" class="nav-link">ç™»å½•/æ³¨å†Œ</a>
        </div>
    </nav>

    <!-- æœç´¢æ¡† -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="æœç´¢è§’è‰²/å…‰é”¥/ææ–™ï¼ˆæ”¯æŒå…³é”®è¯æ¨¡ç³ŠåŒ¹é…ï¼‰" aria-label="æœç´¢å†…å®¹">
        <div class="search-icon">ğŸ”</div>
        <div class="search-history" id="searchHistory">
            <div class="history-clear" id="clearHistory">æ¸…ç©ºæœç´¢å†å²</div>
        </div>
    </div>

    <!-- ç½‘ç«™è¿è¡Œå¤©æ•° -->
    <div class="site-age-container">
        <span id="site-age"><span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; margin-right: 6px;"></span>åŠ è½½ä¸­...</span>
    </div>

    <!-- ç©ºç»“æœæç¤º -->
    <div class="empty-result">
        <i>ğŸ”</i>
        <h3>æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</h3>
        <p>è¯•è¯•æ›´æ¢å…³é”®è¯æˆ–æ£€æŸ¥æ‹¼å†™~</p>
    </div>

    <!-- è§’è‰²åˆ—è¡¨ -->
    <h2 class="section-header" id="character">è§’è‰²åˆ—è¡¨</h2>
    <div class="grid-container" data-category="character">
        <div class="content-card" onclick="jumpToDetail('yunli-detail.html', 'äº‘ç’ƒ')" data-type="è§’è‰²" data-name="äº‘ç’ƒ" data-desc="æ¯ç­ Â· ç‰©ç† | é­”æ”¹äº”æ˜Ÿ | æ— ç‰ˆæœ¬">
            <div class="card-img skeleton">
                <img src="./images/yunli.webp" alt="äº‘ç’ƒè§’è‰²å¡ç‰‡ - æ¯ç­ç‰©ç†ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">äº‘ç’ƒ</div>
            <div class="card-desc">æ¯ç­ Â· ç‰©ç† | é­”æ”¹äº”æ˜Ÿ | æ— ç‰ˆæœ¬</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('luguan-detail.html', 'é¹¿å°†å†›')" data-type="è§’è‰²" data-name="é¹¿å°†å†›" data-desc="å·¡çŒ Â· é£ | é™å®šäº”æ˜Ÿ | 1.0ä¸ŠåŠ">
            <div class="card-img skeleton">
                <img src="./images/changjinglu.webp" alt="é¹¿å°†å†›è§’è‰²å¡ç‰‡ - å·¡çŒé£ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">é¹¿å°†å†›</div>
            <div class="card-desc">å·¡çŒ Â· é£ | é™å®šäº”æ˜Ÿ | 1.0ä¸ŠåŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('pige-detail.html', 'çš®å“¥')" data-type="è§’è‰²" data-name="çš®å“¥" data-desc="å­˜æŠ¤ Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.0ä¸‹åŠ">
            <div class="card-img skeleton">
                <img src="./images/pige.webp" alt="çš®å“¥è§’è‰²å¡ç‰‡ - å­˜æŠ¤ç‰©ç†ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">çš®å“¥</div>
            <div class="card-desc">å­˜æŠ¤ Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.0ä¸‹åŠ</div>
        </div>    
        
        <div class="content-card" onclick="jumpToDetail('jiazijie-detail.html', 'å¤¹å­å§')" data-type="è§’è‰²" data-name="å¤¹å­å§" data-desc="æ™ºè¯† Â· é›· | é™å®šäº”æ˜Ÿ | 1.1ä¸ŠåŠ">
            <div class="card-img skeleton">
                <img src="./images/jiazijie.webp" alt="å¤¹å­å§è§’è‰²å¡ç‰‡ - æ™ºè¯†é›·ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å¤¹å­å§</div>
            <div class="card-desc">æ™ºè¯† Â· é›· | é™å®šäº”æ˜Ÿ | 1.1ä¸ŠåŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('han-detail.html', 'æ¶µ')" data-type="è§’è‰²" data-name="æ¶µ" data-desc="åŒè° Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.1ä¸‹åŠ">
            <div class="card-img skeleton">
                <img src="./images/han.webp" alt="æ¶µè§’è‰²å¡ç‰‡ - åŒè°ç‰©ç†ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">æ¶µ</div>
            <div class="card-desc">åŒè° Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.1ä¸‹åŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('yuzhiboyan-detail.html', 'å®‡æ™ºæ³¢.è¨€')" data-type="è§’è‰²" data-name="å®‡æ™ºæ³¢.è¨€" data-desc="æ¯ç­ Â· é›· | é™å®šäº”æ˜Ÿ | 1.2ä¸ŠåŠ">
            <div class="card-img skeleton">
                <img src="./images/yuzhiboyan.webp" alt="å®‡æ™ºæ³¢.è¨€è§’è‰²å¡ç‰‡ - æ¯ç­é›·ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å®‡æ™ºæ³¢.è¨€</div>
            <div class="card-desc">æ¯ç­ Â· é›· | é™å®šäº”æ˜Ÿ | 1.2ä¸ŠåŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('banxierencheng-detail.html', 'åŠæ¢°äºº.æˆ')" data-type="è§’è‰²" data-name="åŠæ¢°äºº.æˆ" data-desc="æ¯ç­ Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.2ä¸‹åŠ">
            <div class="card-img skeleton">
                <img src="./images/banxierencheng.webp" alt="åŠæ¢°äºº.æˆè§’è‰²å¡ç‰‡ - æ¯ç­ç‰©ç†ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">åŠæ¢°äºº.æˆ</div>
            <div class="card-desc">æ¯ç­ Â· ç‰©ç† | é™å®šäº”æ˜Ÿ | 1.2ä¸‹åŠ</div>
        </div>
    
        <div class="content-card" onclick="jumpToDetail('meng-detail.html', 'æ¢¦')" data-type="è§’è‰²" data-name="æ¢¦" data-desc="è™šæ—  Â· é£ | é™å®šäº”æ˜Ÿ | 1.3ä¸ŠåŠ">
            <div class="card-img skeleton">
                <img src="./images/meng.webp" alt="æ¢¦è§’è‰²å¡ç‰‡ - è™šæ— é£ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">æ¢¦</div>
            <div class="card-desc">è™šæ—  Â· é£ | é™å®šäº”æ˜Ÿ | 1.3ä¸ŠåŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('shenshengpige-detail.html', 'ç¥åœ£.çš®å“¥')" data-type="è§’è‰²" data-name="ç¥åœ£.çš®å“¥" data-desc="ä¸°é¥¶ Â· è™šæ•° | é™å®šäº”æ˜Ÿ | 1.3ä¸‹åŠ">
            <div class="card-img skeleton">
                <img src="./images/shenshengpige.webp" alt="ç¥åœ£.çš®å“¥è§’è‰²å¡ç‰‡ - ä¸°é¥¶è™šæ•°ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ç¥åœ£.çš®å“¥</div>
            <div class="card-desc">ä¸°é¥¶ Â· è™šæ•° | é™å®šäº”æ˜Ÿ | 1.3ä¸‹åŠ</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('tianmingrenhouge-detail.html', 'å¤©å‘½äºº.çŒ´å“¥')" data-type="è§’è‰²" data-name="å¤©å‘½äºº.çŒ´å“¥" data-desc="ç¹è‚² Â· é‡å­ | é™å®šäº”æ˜Ÿ | 2.0ä¸ŠåŠ">
            <div class="card-img skeleton">
                <img src="./images/tianmingrenhouge.webp" alt="å¤©å‘½äºº.çŒ´å“¥è§’è‰²å¡ç‰‡ - ç¹è‚²é‡å­ç³»è§’è‰²" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å¤©å‘½äºº.çŒ´å“¥</div>
            <div class="card-desc">ç¹è‚² Â· é‡å­ | é™å®šäº”æ˜Ÿ | 2.0ä¸ŠåŠ</div>
        </div>
    </div>
    
    <!-- å…‰é”¥åˆ—è¡¨ -->
    <h2 class="section-header" id="lightcone">å…‰é”¥åˆ—è¡¨</h2>
    <div class="grid-container" data-category="lightcone">
        <div class="content-card lightcone-card" onclick="jumpToDetail('Light cone data/changjinglu.html','å¿«ä¹çš„è·¯ä¸€å¤©')" data-type="å…‰é”¥" data-name="å¿«ä¹çš„è·¯ä¸€å¤©" data-desc="å·¡çŒ | é¹¿å°†å†›ä¸“æ­¦">
            <div class="card-img skeleton">
                <img src="./guangzhui.images/changjinglu.jpg" alt="å¿«ä¹çš„è·¯ä¸€å¤©å…‰é”¥ - å·¡çŒç±»å‹" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å¿«ä¹çš„è·¯ä¸€å¤©</div>
            <div class="card-desc">å·¡çŒ | é¹¿å°†å†›ä¸“æ­¦</div>
        </div>
        
        <div class="content-card lightcone-card" data-type="å…‰é”¥" data-name="å¹»çµçŒ«é­…" data-desc="æ¬¢æ„‰ | é­”æ³•çŒ«å’ª.å°å’ªä¸“æ­¦">
            <div class="card-img skeleton">
                <img src="./guangzhui.images/xiaomi.jpg" alt="å¹»çµçŒ«é­…å…‰é”¥ - æ¬¢æ„‰ç±»å‹" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å¹»çµçŒ«é­…</div>
            <div class="card-desc">æ¬¢æ„‰ | é­”æ³•çŒ«å’ª.å°å’ªä¸“æ­¦</div>
        </div>
        
        <div class="content-card lightcone-card" data-type="å…‰é”¥" data-name="æœªçŸ¥å…‰é”¥" data-desc="ï¼Ÿï¼Ÿï¼Ÿ">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="æœªçŸ¥å…‰é”¥" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">æœªçŸ¥å…‰é”¥</div>
            <div class="card-desc">ï¼Ÿï¼Ÿï¼Ÿ</div>
        </div>
    </div>
    
    <!-- å…»æˆææ–™ -->
    <h2 class="section-header" id="material">å…»æˆææ–™</h2>
    <div class="grid-container" data-category="material">
        <div class="content-card material-card" data-type="ææ–™" data-name="å…»æˆææ–™1" data-desc="ï¼Ÿï¼Ÿï¼Ÿ">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="å…»æˆææ–™1" loading="lazy" width="150" height="150" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å…»æˆææ–™1</div>
            <div class="card-desc">ï¼Ÿï¼Ÿï¼Ÿ</div>
        </div>
        
        <div class="content-card material-card" data-type="ææ–™" data-name="å…»æˆææ–™2" data-desc="ï¼Ÿï¼Ÿï¼Ÿ">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="å…»æˆææ–™2" loading="lazy" width="150" height="150" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">å…»æˆææ–™2</div>
            <div class="card-desc">ï¼Ÿï¼Ÿï¼Ÿ</div>
        </div>
    </div>

    <!-- æ›´æ–°æ—¥å¿— -->
    <h2 class="section-header" id="changelog">æ›´æ–°æ—¥å¿—</h2>
    <div class="pet-system" style="margin-top: 0;" id="changelogContainer">
        <div class="changelog-box">
            <div class="pet-header">
                <div class="pet-icon">
                    <img src="./images/rizhitupian.webp" 
                         alt="æ›´æ–°æ—¥å¿—å›¾æ ‡" 
                         style="width: 100%; height: 100%; object-fit: contain;"
                         onload="imageLoaded(this)"
                         onerror="imageError(this)">
                </div>
                <div>
                    <div class="pet-title">WIKIç‰ˆæœ¬æ›´æ–°è®°å½•</div>
                    <div class="changelog-stats">
                        <span>ğŸ“Š å…± 15 æ¬¡æ›´æ–°</span>
                        <span>ğŸ‘¤ 10 ä¸ªè§’è‰²</span>
                        <span>âœ¨ 3 ä¸ªå…‰é”¥</span>
                        <span>âš¡ 5 é¡¹ä¼˜åŒ–</span>
                        <span>ğŸ› 2 é¡¹ä¿®å¤</span>
                    </div>
                </div>
            </div>
            
            <div class="changelog-controls">
                <button onclick="toggleAllChangelogs()" class="control-btn">
                    <span>å±•å¼€å…¨éƒ¨</span>
                    <span class="icon">â–¼</span>
                </button>
                <button onclick="copyChangelog()" class="control-btn">
                    <span>å¤åˆ¶æ›´æ–°è®°å½•</span>
                    <span class="icon">ğŸ“‹</span>
                </button>
            </div>
            
            <div class="changelog-list">
                <details class="changelog-item" open>
                    <summary>
                        <h4 class="changelog-version">
                            åŠŸèƒ½æ•™ç¨‹ä¸“ç”¨æ 
                            <span class="version-tag beta">æ•™ç¨‹</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">éŸ³ä¹æ’­æ”¾å™¨æ•™ç¨‹</span>
                                <span class="content">
                                    ğŸ”Š-éŸ³é‡ä¸º<span class="highlight">100%</span>
                                    ğŸ”‰-éŸ³é‡ä¸º<span class="highlight">50%</span>
                                    ğŸ”‡-éŸ³é‡ä¸º<span class="highlight">0%</span>
                                    <br>
                                    â–¶ - æ’­æ”¾<span class="highlight">ä¸‹ä¸€é¦–</span>æ­Œæ›²
                                    â—€ - æ’­æ”¾<span class="highlight">ä¸Šä¸€é¦–</span>æ­Œæ›²
                                    <br>
                                    ğŸ“œ æ­Œæ›²åˆ—è¡¨-å¯ä»¥ç”¨æ¥å¿«æ·å¬æ­Œ
                                    <br>
                                    â¸ - æ’­æ”¾çŠ¶æ€ | â–¶ - æš‚åœçŠ¶æ€
                                    <br>
                                    ğŸ”-åˆ—è¡¨é¡ºåºæ’­æ”¾
                                    ğŸ”„-åˆ—è¡¨å¾ªç¯æ’­æ”¾
                                    ğŸ”‚-å•æ›²å¾ªç¯æ’­æ”¾
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
                
                <details class="changelog-item">
                    <summary>
                        <h4 class="changelog-version">
                            2025-12 | V1.0.6~1.1.0
                            <span class="version-tag">ç¨³å®šç‰ˆ</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">2025-12-20 | V1.1.0</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    æ­Œæ›² <span class="highlight">1</span> é¦–
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-14 | V1.0.9</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    å…‰é”¥ï¼š<span class="highlight">å¿«ä¹çš„è·¯ä¸€å¤© | å·¡çŒ.æš´å‡»ç‰¹åŒ–</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-12 | V1.0.8</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">å¤©å‘½äºº.çŒ´å“¥ | ç¹è‚².é‡å­</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-07 | V1.0.7</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">æ¢¦ | è™šæ— .é£</span>
                                    <br>
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">ç¥åœ£.çš®å“¥ | ä¸°é¥¶.è™šæ•°</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-06 | V1.0.6</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    éŸ³ä¹æ’­æ”¾å™¨(ç®€æ˜“å®Œæ•´ç‰ˆ)
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
                
                <details class="changelog-item">
                    <summary>
                        <h4 class="changelog-version">
                            2025-11 | V1.0.0~1.0.5
                            <span class="version-tag">ç¨³å®šç‰ˆ</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">2025-11-30 | V1.0.5</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">åŠæ¢°äºº.æˆ | æ¯ç­.ç‰©ç†</span>
                                    <br>
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">å¤¹å­å§ | æ™ºè¯†.é›·</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-16 | V1.0.4</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">æ¶µ | åŒè°.ç‰©ç†</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-15 | V1.0.3</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    éŸ³ä¹æ’­æ”¾å™¨ï¼ˆåŠæˆå“ï¼‰
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-10 | V1.0.2</span>
                                <span class="content">
                                    <span class="update-badge">æ–°å¢</span>
                                    è§’è‰²ï¼š<span class="highlight">å®‡æ™ºæ³¢.è¨€ | æ¯ç­.é›·</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-09 | V1.0.1</span>
                                <span class="content">
                                    <span class="update-badge">ä¿®å¤</span>
                                    äº‘ç’ƒè§’è‰²å¡ç‰‡è·³è½¬é”™è¯¯
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-10-31 | V1.0.0</span>
                                <span class="content">
                                    <span class="update-badge">ä¸Šçº¿</span>
                                    å…­å“¥è£è€€WIKIä¸Šçº¿
                                    <br>
                                    ğŸ‰ åŒ…å«è§’è‰²ã€å…‰é”¥ã€å…»æˆææ–™åŸºç¡€æ¨¡å—
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
            </div>
        </div>
    </div>
    <!-- ç»§ç»­ç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ -->

<!-- è¯„è®ºç³»ç»Ÿ -->
<h2 class="section-header" id="comments">ğŸ’¬ ç”¨æˆ·è¯„è®º</h2>
<div class="comments-system" id="commentsSection">
    <!-- è¯„è®ºç»Ÿè®¡ -->
    <div class="comments-stats">
        <div class="stats-container">
            <span class="stat-item">
                <i class="fas fa-comments"></i>
                æ€»è¯„è®ºï¼š<span id="totalComments">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-users"></i>
                å‚ä¸ç”¨æˆ·ï¼š<span id="uniqueUsers">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-fire"></i>
                çƒ­é—¨è®¨è®ºï¼š<span id="hotComments">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-eye"></i>
                ä»Šæ—¥æ´»è·ƒï¼š<span id="todayActive">0</span>
            </span>
        </div>
    </div>

    <!-- è¯„è®ºæ’åºé€‰é¡¹ -->
    <div class="comments-sort">
        <button class="sort-btn active" data-sort="newest">
            <i class="fas fa-clock"></i> æœ€æ–°
        </button>
        <button class="sort-btn" data-sort="hottest">
            <i class="fas fa-fire"></i> æœ€çƒ­
        </button>
        <button class="sort-btn" data-sort="oldest">
            <i class="fas fa-history"></i> æœ€æ—©
        </button>
        <button class="sort-btn" data-sort="pinned">
            <i class="fas fa-thumbtack"></i> ç½®é¡¶
        </button>
    </div>

    <!-- å‘è¡¨è¯„è®ºåŒºåŸŸ -->
    <div class="comment-form-container" id="commentFormContainer">
        <div class="comment-form-header">
            <div class="user-avatar-small">
                <div id="commentAvatarPlaceholder"></div>
            </div>
            <div class="form-header-text">
                <span id="commentFormTitle">å‘è¡¨è¯„è®º</span>
                <small>æ–‡æ˜å‘è¨€ï¼Œéµå®ˆç¤¾åŒºè§„èŒƒ</small>
            </div>
        </div>
        
        <div class="comment-editor">
            <textarea 
                id="commentInput" 
                placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." 
                maxlength="1000"
                rows="4"
            ></textarea>
            
            <div class="editor-tools">
                <div class="tools-left">
                    <button class="tool-btn" title="åŠ ç²—" onclick="formatText('bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="tool-btn" title="æ–œä½“" onclick="formatText('italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="tool-btn" title="ä»£ç " onclick="formatText('code')">
                        <i class="fas fa-code"></i>
                    </button>
                </div>
                <div class="tools-right">
                    <span class="char-count">
                        <span id="charCount">0</span>/1000
                    </span>
                    <button 
                        class="btn-submit" 
                        id="submitCommentBtn"
                        onclick="submitComment()"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                        å‘å¸ƒè¯„è®º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div class="comments-list" id="commentsList">
        <div class="loading-comments">
            <div class="spinner"></div>
            <p>åŠ è½½è¯„è®ºä¸­...</p>
        </div>
    </div>

    <!-- è¯„è®ºåˆ†é¡µ -->
    <div class="comments-pagination" id="commentsPagination">
        <button class="page-btn" onclick="loadPrevPage()" disabled>
            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
        </button>
        <div class="page-info">
            ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">1</span> é¡µ
        </div>
        <div class="page-size">
            <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                <option value="10">10æ¡/é¡µ</option>
                <option value="20" selected>20æ¡/é¡µ</option>
                <option value="30">30æ¡/é¡µ</option>
            </select>
        </div>
        <button class="page-btn" onclick="loadNextPage()" disabled>
            ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

    <!-- é¡µè„š -->
    <footer>
        Â© <span id="year"></span> å…­å“¥è£è€€WIKI. æœ¬WIKIçº¯å±è™šæ„å¨±ä¹.
        <br>
        <span style="font-size: 0.8rem; color: #666;">ç”¨æˆ·è®¤è¯ç”±Supabaseæä¾›æŠ€æœ¯æ”¯æŒ</span>
    </footer>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <iframe 
        id="musicPlayerIframe"
        src="music-player.html"
        frameborder="0"
        scrolling="no"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"
        title="éŸ³ä¹æ’­æ”¾å™¨"
        aria-label="éŸ³ä¹æ’­æ”¾å™¨"
    ></iframe>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" onclick="scrollToTop()" aria-label="å›åˆ°é¡¶éƒ¨">â†‘</button>

<script>
// ==================== 1. å…¨å±€å˜é‡å®šä¹‰ ====================
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
let searchTimeout;
let supabaseClient = null;
let currentUser = null;

// Supabaseé…ç½®
const SUPABASE_URL = 'https://ysmijycsyzpjoieaknmb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzbWlqeWNzeXpwam9pZWFrbm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNDgzNjMsImV4cCI6MjA4MjgyNDM2M30.H7dx2k_0099LVXprMrghHOFh16OoSSgtCUOib2otHPA';

// è¯„è®ºç³»ç»Ÿå…¨å±€å˜é‡
let commentCurrentPage = 1;
let commentTotalPages = 1;
let commentPageSize = 20;
let commentCurrentSort = 'newest';

// ==================== è¾…åŠ©å‡½æ•° ====================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'åˆšåˆš';
    if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
    if (diffDays < 7) return `${diffDays}å¤©å‰`;
    return date.toLocaleDateString('zh-CN');
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function updateLoadingProgress(percent) {
    const progressBar = document.getElementById('loadingProgress');
    if (progressBar) {
        progressBar.style.width = `${percent}%`;
    }
}

// ==================== å›¾ç‰‡å¤„ç†å‡½æ•° ====================
function imageLoaded(img) {
    img.classList.add('loaded');
    const parent = img.closest('.skeleton');
    if (parent) {
        parent.classList.remove('skeleton');
    }
}

function imageError(img) {
    const placeholder = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="188" viewBox="0 0 150 188"><rect width="100%" height="100%" fill="%232d5243"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%2381c784" font-family="sans-serif">å›¾ç‰‡åŠ è½½å¤±è´¥</text></svg>`;
    img.src = placeholder;
    img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
    const parent = img.closest('.skeleton');
    if (parent) {
        parent.classList.remove('skeleton');
    }
}

// ==================== ç½‘ç«™è¿è¡Œå¤©æ•°åŠŸèƒ½ ====================
function initializeSiteAge() {
    const launchDate = new Date(2025, 10, 1); // 2025å¹´11æœˆ1æ—¥
    const siteAgeElem = document.getElementById('site-age');
    
    const specialDays = {
        30: 'ğŸ‰ å…­å“¥è£è€€WIKIä¸Šçº¿30å¤©å•¦ï¼æ„Ÿæ©é™ªä¼´ ğŸ‰',
        50: 'â›„å†¬è‡³å¿«ä¹ï¼Œè®°å¾—åƒé¥ºå­ğŸ¥Ÿâ›„',
        58: 'ğŸ° æ­å–œè¨€å“¥å“¥18å²ï¼Œç”Ÿæ—¥å¿«ä¹ğŸ°',
        59: ' ğŸ§¨è·¨å¹´å€’è®¡æ—¶2å¤©ğŸ§¨',
        60: ' ğŸ‰è·¨å¹´å€’è®¡æ—¶1å¤©ğŸ‰',
        61: ' ğŸ‰æ¬¢è¿æ¥åˆ°2026å¹´ğŸ‰',
        100: 'ğŸŠ ç™¾æ—¥åº†å…¸ï¼å…­å“¥è£è€€WIKIä¸ä½ åŒè¡Œ100å¤© ğŸŠ',
        365: 'ğŸ‚ å‘¨å¹´å¿«ä¹ï¼å…­å“¥è£è€€WIKIä¸€å‘¨å¹´çºªå¿µ ğŸ‚'
    };
    
    function updateSiteAge() {
        const today = new Date();
        const days = Math.floor((today - launchDate) / (1000 * 60 * 60 * 24));
        
        if (specialDays[days]) {
            siteAgeElem.innerHTML = specialDays[days];
            siteAgeElem.classList.add('special');
        } else {
            siteAgeElem.innerHTML = `ğŸ“… å…­å“¥è£è€€WIKIå·²ä¸Šçº¿ ${days} å¤© Â· æŒç»­æ›´æ–°ä¸­`;
            siteAgeElem.classList.remove('special');
        }
    }
    
    updateSiteAge();
    setInterval(updateSiteAge, 86400000);
}

// ==================== æœç´¢åŠŸèƒ½ ====================
function initializeSearch() {
    const searchInput = document.getElementById('search-input');
    const searchHistoryElem = document.getElementById('searchHistory');
    const allCards = document.querySelectorAll('.content-card');
    const emptyResult = document.querySelector('.empty-result');
    
    function renderSearchHistory() {
        if (searchHistory.length === 0) {
            searchHistoryElem.innerHTML = '<div class="history-item" style="color: var(--text-secondary);">æš‚æ— æœç´¢å†å²</div>';
            return;
        }
        
        searchHistoryElem.innerHTML = '';
        
        searchHistory.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.textContent = item;
            historyItem.addEventListener('click', () => {
                searchInput.value = item;
                performSearch(item);
                searchHistoryElem.classList.remove('show');
            });
            searchHistoryElem.appendChild(historyItem);
        });
        
        const clearBtn = document.createElement('div');
        clearBtn.className = 'history-clear';
        clearBtn.textContent = 'æ¸…ç©ºæœç´¢å†å²';
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæœç´¢å†å²å—ï¼Ÿ')) {
                searchHistory = [];
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                renderSearchHistory();
                showNotification('æœç´¢å†å²å·²æ¸…ç©º', 'success');
            }
        });
        searchHistoryElem.appendChild(clearBtn);
    }
    
    function performSearch(keyword) {
        let matchCount = 0;
        
        if (!keyword) {
            allCards.forEach(card => card.style.display = 'block');
            emptyResult.style.display = 'none';
            return;
        }
        
        if (keyword && !searchHistory.includes(keyword)) {
            searchHistory.unshift(keyword);
            if (searchHistory.length > 10) searchHistory.pop();
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        }
        
        allCards.forEach(card => {
            const name = card.dataset.name?.toLowerCase() || '';
            const desc = card.dataset.desc?.toLowerCase() || '';
            const type = card.dataset.type?.toLowerCase() || '';
            
            const isMatch = name.includes(keyword) || 
                           desc.includes(keyword) || 
                           type.includes(keyword);
            
            card.style.display = isMatch ? 'block' : 'none';
            if (isMatch) matchCount++;
        });
        
        emptyResult.style.display = matchCount === 0 ? 'block' : 'none';
    }
    
    renderSearchHistory();
    
    searchInput.addEventListener('focus', () => {
        if (searchHistory.length > 0) {
            searchHistoryElem.classList.add('show');
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchHistoryElem.contains(e.target)) {
            searchHistoryElem.classList.remove('show');
        }
    });
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch(this.value.trim().toLowerCase());
        }, 200);
    });
}

// ==================== å¯¼èˆªå’Œæ»šåŠ¨åŠŸèƒ½ ====================
function initializeNavigation() {
    const backToTopBtn = document.querySelector('.back-to-top');
    const navLinks = document.querySelectorAll('.nav-link');
    
    window.scrollToTop = function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
        
        const sections = document.querySelectorAll('.section-header');
        let currentSection = '';
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop - 150;
            if (window.scrollY >= sectionTop) {
                currentSection = section.id;
            }
        });
        
        navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.target === currentSection);
        });
    });
    
    navLinks.forEach(link => {
        if (link.getAttribute('href').startsWith('#')) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const target = document.getElementById(targetId);
                if (target) {
                    const targetPosition = target.offsetTop - 80;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                    history.pushState(null, null, `#${targetId}`);
                }
            });
        }
    });
    
    window.jumpToDetail = function(targetUrl, charName) {
        if (!targetUrl) {
            showNotification('è¯¦æƒ…é¡µåœ°å€ä¸å­˜åœ¨', 'error');
            return;
        }
        
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--card-bg); padding: 16px 24px; border-radius: var(--radius);
            z-index: 999999; color: var(--text-highlight); display: flex; align-items: center; gap: 8px;
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
        `;
        loadingDiv.innerHTML = `<span class="loading-spinner" style="width: 20px; height: 20px;"></span> å‰å¾€ã€${charName}ã€‘è¯¦æƒ…é¡µ...`;
        document.body.appendChild(loadingDiv);
        
        setTimeout(() => {
            window.location.href = targetUrl;
        }, 300);
    };
}

// ==================== å›¾ç‰‡æ‡’åŠ è½½ ====================
function initializeLazyLoad() {
    const images = document.querySelectorAll('img[loading="lazy"]');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src && img.dataset.src !== img.src) {
                        img.src = img.dataset.src;
                    }
                    imageObserver.unobserve(img);
                }
            });
        });
        
        images.forEach(img => {
            if (!img.src && img.dataset.src) {
                imageObserver.observe(img);
            }
        });
    }
}

// ==================== Supabase åˆå§‹åŒ– ====================
async function initializeSupabase() {
    try {
        console.log('åˆå§‹åŒ–Supabase...');
        
        if (typeof supabase === 'undefined') {
            console.error('Supabaseåº“æœªåŠ è½½');
            showNotification('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            return false;
        }
        
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        });
        
        // æµ‹è¯•è¿æ¥
        const { data, error } = await supabaseClient
            .from('comments')
            .select('count', { count: 'exact', head: true })
            .limit(1);
            
        if (error) {
            console.error('Supabaseè¿æ¥æµ‹è¯•å¤±è´¥:', error);
            showNotification('æ•°æ®åº“è¿æ¥å¤±è´¥', 'error');
            return false;
        }
        
        console.log('Supabaseè¿æ¥æˆåŠŸï¼');
        
        // è·å–å½“å‰ç”¨æˆ·
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (!userError && user) {
            currentUser = user;
            console.log('å½“å‰ç”¨æˆ·:', user.email);
            
            localStorage.setItem('user', JSON.stringify({
                email: user.email,
                id: user.id,
                username: user.user_metadata?.username || user.email.split('@')[0],
                isLoggedIn: true
            }));
        } else {
            console.log('æ²¡æœ‰ç”¨æˆ·ç™»å½•');
            localStorage.removeItem('user');
        }
        
        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event);
            
            if (event === 'SIGNED_IN' && session?.user) {
                currentUser = session.user;
                showNotification(`æ¬¢è¿å›æ¥ï¼Œ${session.user.email}!`, 'success');
                
                localStorage.setItem('user', JSON.stringify({
                    email: session.user.email,
                    id: session.user.id,
                    username: session.user.user_metadata?.username || session.user.email.split('@')[0],
                    isLoggedIn: true
                }));
                
                updateUserUI();
                
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                localStorage.removeItem('user');
                showNotification('å·²é€€å‡ºç™»å½•', 'info');
                updateUserUI();
            }
        });
        
        return true;
    } catch (error) {
        console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
        showNotification('åˆå§‹åŒ–å¤±è´¥', 'error');
        return false;
    }
}

// ==================== ç”¨æˆ·çŠ¶æ€ç®¡ç† ====================
async function updateUserUI() {
    const userNavSection = document.getElementById('userNavSection');
    
    if (!userNavSection) return;
    
    if (currentUser) {
        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
        const avatarLetter = username.charAt(0).toUpperCase();
        
        userNavSection.innerHTML = `
            <div class="user-info-container">
                <div class="user-avatar" title="${username}">${avatarLetter}</div>
                <span class="username">${username}</span>
                <button class="logout-btn" onclick="logoutUser()">é€€å‡º</button>
            </div>
        `;
        
        // æ›´æ–°è¯„è®ºè¡¨å•å¤´åƒ
        updateCommentFormAvatar();
    } else {
        userNavSection.innerHTML = `
            <a href="login-real.html" class="nav-link">ç™»å½•/æ³¨å†Œ</a>
        `;
    }
}

async function logoutUser() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        try {
            if (supabaseClient) {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
            }
            
            currentUser = null;
            localStorage.removeItem('user');
            showNotification('å·²é€€å‡ºç™»å½•', 'success');
            updateUserUI();
            
        } catch (error) {
            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            showNotification('é€€å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        }
    }
}

// ==================== æ›´æ–°è¯„è®ºè¡¨å•å¤´åƒ ====================
function updateCommentFormAvatar() {
    const avatarPlaceholder = document.getElementById('commentAvatarPlaceholder');
    if (!avatarPlaceholder || !currentUser) return;
    
    const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
    const avatarLetter = username.charAt(0).toUpperCase();
    
    avatarPlaceholder.innerHTML = `
        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
            ${avatarLetter}
        </div>
    `;
}

// ==================== æ”¶è—åŠŸèƒ½ ====================
function addFavoriteButtons() {
    const cards = document.querySelectorAll('.content-card');
    
    cards.forEach(card => {
        if (!card.querySelector('.favorite-btn')) {
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = 'favorite-btn';
            favoriteBtn.innerHTML = 'â™¡';
            favoriteBtn.setAttribute('aria-label', 'æ”¶è—');
            favoriteBtn.setAttribute('title', 'ç‚¹å‡»æ”¶è—');
            
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                if (!currentUser) {
                    showNotification('è¯·å…ˆç™»å½•åä½¿ç”¨æ”¶è—åŠŸèƒ½', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login-real.html';
                    }, 1500);
                    return;
                }
                
                const type = card.dataset.type === 'è§’è‰²' ? 'character' : 'lightcone';
                const name = card.dataset.name;
                
                showNotification(`å·²æ”¶è— ${name}`, 'success');
                
                // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                if (favoriteBtn.innerHTML === 'â™¡') {
                    favoriteBtn.innerHTML = 'â™¥';
                    favoriteBtn.style.color = '#f87171';
                } else {
                    favoriteBtn.innerHTML = 'â™¡';
                    favoriteBtn.style.color = 'white';
                }
            });
            
            card.appendChild(favoriteBtn);
        }
    });
}

// ==================== æ›´æ–°æ—¥å¿—åŠŸèƒ½ ====================
function initializeChangelogFunctions() {
    function highlightCurrentYearUpdates() {
        const currentYear = new Date().getFullYear();
        
        document.querySelectorAll('.changelog-version').forEach(title => {
            if (title.textContent.includes(`${currentYear}`)) {
                title.style.color = 'var(--special-color)';
            }
        });
    }
    
    window.toggleAllChangelogs = function() {
        const changelogs = document.querySelectorAll('.changelog-item');
        const controlBtn = document.querySelector('.control-btn span:first-child');
        const icon = document.querySelector('.control-btn .icon');
        
        const allOpen = Array.from(changelogs).every(item => item.open);
        
        changelogs.forEach(item => {
            item.open = !allOpen;
        });
        
        if (allOpen) {
            controlBtn.textContent = 'å±•å¼€å…¨éƒ¨';
            icon.textContent = 'â–¼';
            showNotification('å·²æ”¶èµ·æ‰€æœ‰æ›´æ–°è®°å½•', 'success');
        } else {
            controlBtn.textContent = 'æ”¶èµ·å…¨éƒ¨';
            icon.textContent = 'â–²';
            showNotification('å·²å±•å¼€æ‰€æœ‰æ›´æ–°è®°å½•', 'success');
        }
    };
    
    window.copyChangelog = function() {
        const changelogContent = document.querySelector('.changelog-list');
        const text = changelogContent.innerText;
        
        navigator.clipboard.writeText(text).then(() => {
            showNotification('æ›´æ–°è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
        });
    };
    
    highlightCurrentYearUpdates();
}

// ==================== éŸ³ä¹æ’­æ”¾å™¨ä¼˜åŒ– ====================
function initializeMusicPlayer() {
    const iframe = document.getElementById('musicPlayerIframe');
    iframe.style.height = '110px';
    
    window.addEventListener('message', (e) => {
        if (e.data?.type === 'SONG_LIST_TOGGLED') {
            iframe.style.height = e.data.isShow ? '400px' : '110px';
        }
    });
}

// ==================== é¡µé¢åˆå§‹åŒ– ====================
async function initializePage() {
    console.log('é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
    
    updateLoadingProgress(30);
    
    // åˆå§‹åŒ–å¹´ä»½
    document.getElementById('year').textContent = new Date().getFullYear();
    updateLoadingProgress(40);
    
    // åˆå§‹åŒ–ç½‘ç«™è¿è¡Œå¤©æ•°
    initializeSiteAge();
    updateLoadingProgress(50);
    
    // åˆå§‹åŒ–Supabase
    await initializeSupabase();
    updateLoadingProgress(60);
    
    // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
    initializeSearch();
    updateLoadingProgress(70);
    
    // åˆå§‹åŒ–å¯¼èˆªåŠŸèƒ½
    initializeNavigation();
    updateLoadingProgress(80);
    
    // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
    initializeLazyLoad();
    updateLoadingProgress(90);
    
    // åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€
    await updateUserUI();
    updateLoadingProgress(95);
    
    // æ·»åŠ æ”¶è—æŒ‰é’®
    addFavoriteButtons();
    
    // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
    initializeMusicPlayer();
    updateLoadingProgress(97);
    
    // åˆå§‹åŒ–æ›´æ–°æ—¥å¿—åŠŸèƒ½
    initializeChangelogFunctions();
    updateLoadingProgress(98);
    
    // åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
    setTimeout(() => {
        if (document.getElementById('commentsSection')) {
            initializeCommentSystem();
        }
    }, 1000);
    
    updateLoadingProgress(99);
    
    // é¡µé¢åŠ è½½å®Œæˆ
    setTimeout(() => {
        updateLoadingProgress(100);
        hideLoading();
        showNotification('é¡µé¢åŠ è½½å®Œæˆï¼', 'success');
        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    }, 300);
}

function hideLoading() {
    const loading = document.getElementById('global-loading');
    const progress = document.getElementById('loadingProgress');
    
    if (loading) {
        loading.style.opacity = '0';
        setTimeout(() => {
            loading.style.display = 'none';
        }, 500);
    }
    
    if (progress) {
        progress.style.opacity = '0';
        setTimeout(() => {
            progress.style.display = 'none';
        }, 500);
    }
}

// å¼ºåˆ¶3ç§’åéšè—åŠ è½½åŠ¨ç”»
setTimeout(hideLoading, 3000);

// ==================== è¯„è®ºç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ ====================
async function initializeCommentSystem() {
    console.log('åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ...');
    
    try {
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupCommentEventListeners();
        
        // åŠ è½½è¯„è®ºåˆ—è¡¨
        await loadComments(commentCurrentPage, commentCurrentSort);
        
        console.log('è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        console.error('åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿå¤±è´¥:', error);
        showNotification('è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
    }
}

function setupCommentEventListeners() {
    // è¯„è®ºè¾“å…¥æ¡†äº‹ä»¶
    const commentInput = document.getElementById('commentInput');
    if (commentInput) {
        commentInput.addEventListener('input', handleCommentInput);
        commentInput.addEventListener('keydown', handleCommentKeydown);
    }
    
    // æ’åºæŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', handleSortButtonClick);
    });
}

function handleCommentInput(e) {
    updateCharCount();
    validateCommentInput();
}

function handleCommentKeydown(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        submitComment();
    }
}

function validateCommentInput() {
    const commentInput = document.getElementById('commentInput');
    const submitBtn = document.getElementById('submitCommentBtn');
    
    if (!commentInput || !submitBtn) return;
    
    const content = commentInput.value.trim();
    const isValid = content.length > 0 && content.length <= 1000;
    
    submitBtn.disabled = !isValid;
    
    const charCount = document.getElementById('charCount');
    if (charCount) {
        if (content.length > 950) {
            charCount.classList.add('danger');
            charCount.classList.remove('warning');
        } else if (content.length > 800) {
            charCount.classList.add('warning');
            charCount.classList.remove('danger');
        } else {
            charCount.classList.remove('warning', 'danger');
        }
    }
}

function updateCharCount() {
    const commentInput = document.getElementById('commentInput');
    const charCount = document.getElementById('charCount');
    
    if (commentInput && charCount) {
        charCount.textContent = commentInput.value.length;
    }
}

// ==================== æ ¼å¼åŒ–æ–‡æœ¬å·¥å…· ====================
function formatText(type) {
    const commentInput = document.getElementById('commentInput');
    if (!commentInput) return;
    
    const start = commentInput.selectionStart;
    const end = commentInput.selectionEnd;
    const selectedText = commentInput.value.substring(start, end);
    let formattedText = '';
    
    switch (type) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'code':
            formattedText = selectedText.includes('\n') 
                ? `\`\`\`\n${selectedText}\n\`\`\`` 
                : `\`${selectedText}\``;
            break;
        default:
            return;
    }
    
    commentInput.value = commentInput.value.substring(0, start) + 
                        formattedText + 
                        commentInput.value.substring(end);
    
    commentInput.focus();
    const newPosition = start + formattedText.length;
    commentInput.setSelectionRange(newPosition, newPosition);
    
    updateCharCount();
    validateCommentInput();
}

// ==================== è¯„è®ºæäº¤åŠŸèƒ½ ====================
async function submitComment() {
    if (!currentUser) {
        showNotification('è¯·å…ˆç™»å½•åå‘è¡¨è¯„è®º', 'warning');
        setTimeout(() => {
            window.location.href = 'login-real.html?redirect=' + encodeURIComponent(window.location.pathname);
        }, 1500);
        return;
    }
    
    const commentInput = document.getElementById('commentInput');
    if (!commentInput) return;
    
    const content = commentInput.value.trim();
    if (!content) {
        showNotification('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
    }
    
    const submitBtn = document.getElementById('submitCommentBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘å¸ƒä¸­...';
    submitBtn.disabled = true;
    
    try {
        const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
        
        const commentData = {
            user_id: currentUser.id,
            username: username,
            content: content,
            page_type: 'index',
            page_id: 'home'
        };
        
        const { data: comment, error } = await supabaseClient
            .from('comments')
            .insert(commentData)
            .select()
            .single();
        
        if (error) throw error;
        
        // æ¸…ç©ºè¡¨å•
        commentInput.value = '';
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = true;
        updateCharCount();
        
        showNotification('è¯„è®ºå‘å¸ƒæˆåŠŸ', 'success');
        
        // é‡æ–°åŠ è½½è¯„è®º
        await reloadComments();
        
        // æ»šåŠ¨åˆ°æ–°è¯„è®º
        setTimeout(() => {
            const commentElement = document.getElementById(`comment-${comment.id}`);
            if (commentElement) {
                commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 500);
        
    } catch (error) {
        console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
        showNotification(`å‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
        
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// ==================== è¯„è®ºåŠ è½½åŠŸèƒ½ ====================
async function loadComments(page = 1, sort = 'newest') {
    try {
        const commentsList = document.getElementById('commentsList');
        if (!commentsList) return;
        
        commentsList.innerHTML = `
            <div class="loading-comments">
                <div class="spinner"></div>
                <p>åŠ è½½è¯„è®ºä¸­...</p>
            </div>
        `;
        
        let query = supabaseClient
            .from('comments')
            .select('*', { count: 'exact' })
            .eq('page_type', 'index')
            .eq('page_id', 'home')
            .is('parent_id', null);
        
        switch (sort) {
            case 'newest':
                query = query.order('created_at', { ascending: false });
                break;
            case 'oldest':
                query = query.order('created_at', { ascending: true });
                break;
            case 'hottest':
                query = query.order('likes_count', { ascending: false });
                break;
            case 'pinned':
                query = query.order('is_pinned', { ascending: false });
                break;
        }
        
        const from = (page - 1) * commentPageSize;
        const to = from + commentPageSize - 1;
        query = query.range(from, to);
        
        const { data: comments, error, count } = await query;
        
        if (error) {
            console.error('æŸ¥è¯¢è¯„è®ºå¤±è´¥:', error);
            showEmptyComments();
            return;
        }
        
        commentTotalPages = Math.ceil((count || 0) / commentPageSize);
        commentCurrentPage = page;
        
        if (!comments || comments.length === 0) {
            showEmptyComments();
        } else {
            renderComments(comments);
        }
        
        updateCommentPagination();
        
    } catch (error) {
        console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
        showCommentLoadError();
    }
}

async function reloadComments() {
    await loadComments(commentCurrentPage, commentCurrentSort);
}

// ==================== è¯„è®ºæ¸²æŸ“åŠŸèƒ½ ====================
function renderComments(comments) {
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    
    let commentsHTML = '';
    comments.forEach(comment => {
        commentsHTML += renderCommentItem(comment);
    });
    
    commentsList.innerHTML = commentsHTML;
}

function renderCommentItem(comment) {
    const username = comment.username || 'åŒ¿åç”¨æˆ·';
    const avatarLetter = username.charAt(0).toUpperCase();
    const timeAgo = formatTimeAgo(comment.created_at);
    
    return `
        <div class="comment-item" id="comment-${comment.id}">
            <div class="comment-header">
                <div class="comment-avatar">
                    <div class="avatar-placeholder">${avatarLetter}</div>
                </div>
                <div class="comment-meta">
                    <div class="comment-author">
                        <span class="author-name">${escapeHtml(username)}</span>
                    </div>
                    <div class="comment-time">
                        <span>${timeAgo}</span>
                    </div>
                </div>
            </div>
            
            <div class="comment-content">
                ${formatCommentContent(comment.content)}
            </div>
            
            <div class="comment-actions">
                <button class="action-btn like-btn" onclick="toggleCommentLike('${comment.id}')">
                    <i class="fas fa-heart"></i>
                    <span class="action-count like-count">
                        ${comment.likes_count || 0}
                    </span>
                </button>
                
                ${currentUser && currentUser.id === comment.user_id ? `
                    <button class="action-btn delete-btn" onclick="deleteComment('${comment.id}')">
                        <i class="fas fa-trash"></i>
                        <span class="action-count">åˆ é™¤</span>
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

function formatCommentContent(content) {
    if (!content) return '';
    
    let formatted = escapeHtml(content);
    formatted = formatted.replace(/\n/g, '<br>');
    
    // è½¬æ¢é“¾æ¥
    formatted = formatted.replace(/https?:\/\/[^\s<]+/g, url => {
        const displayUrl = url.length > 50 ? url.substring(0, 47) + '...' : url;
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-highlight); text-decoration: underline; word-break: break-all;">${displayUrl}</a>`;
    });
    
    // è½¬æ¢ç²—ä½“
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // è½¬æ¢æ–œä½“
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // è½¬æ¢ä»£ç å—
    formatted = formatted.replace(/```([\s\S]*?)```/g, (match, code) => {
        return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
    });
    
    // è½¬æ¢è¡Œå†…ä»£ç 
    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    return formatted;
}

// ==================== ç‚¹èµåŠŸèƒ½ ====================
async function toggleCommentLike(commentId) {
    if (!currentUser) {
        showNotification('è¯·å…ˆç™»å½•åç‚¹èµ', 'warning');
        return;
    }
    
    const likeBtn = document.querySelector(`#comment-${commentId} .like-btn`);
    if (!likeBtn) return;
    
    try {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
        const likeCountElement = likeBtn.querySelector('.like-count');
        let currentCount = parseInt(likeCountElement.textContent) || 0;
        
        if (likeBtn.classList.contains('liked')) {
            likeBtn.classList.remove('liked');
            currentCount--;
            showNotification('å·²å–æ¶ˆç‚¹èµ', 'info');
        } else {
            likeBtn.classList.add('liked');
            currentCount++;
            showNotification('ç‚¹èµæˆåŠŸ', 'success');
        }
        
        likeCountElement.textContent = currentCount;
        
    } catch (error) {
        console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
        showNotification(`æ“ä½œå¤±è´¥: ${error.message}`, 'error');
    }
}

// ==================== åˆ é™¤è¯„è®º ====================
async function deleteComment(commentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('comments')
            .delete()
            .eq('id', commentId);
        
        if (error) throw error;
        
        const commentElement = document.getElementById(`comment-${commentId}`);
        if (commentElement) {
            commentElement.remove();
            showNotification('è¯„è®ºå·²åˆ é™¤', 'success');
        }
        
    } catch (error) {
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
        showNotification(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// ==================== æ’åºåŠŸèƒ½ ====================
function handleSortButtonClick(e) {
    const button = e.currentTarget;
    const sortType = button.dataset.sort;
    
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    commentCurrentSort = sortType;
    commentCurrentPage = 1;
    loadComments(commentCurrentPage, commentCurrentSort);
}

// ==================== åˆ†é¡µåŠŸèƒ½ ====================
function loadPrevPage() {
    if (commentCurrentPage > 1) {
        commentCurrentPage--;
        loadComments(commentCurrentPage, commentCurrentSort);
        scrollToCommentsTop();
    }
}

function loadNextPage() {
    if (commentCurrentPage < commentTotalPages) {
        commentCurrentPage++;
        loadComments(commentCurrentPage, commentCurrentSort);
        scrollToCommentsTop();
    }
}

function changePageSize(size) {
    commentPageSize = parseInt(size);
    commentCurrentPage = 1;
    loadComments(commentCurrentPage, commentCurrentSort);
}

function updateCommentPagination() {
    const currentPageElement = document.getElementById('currentPage');
    const totalPagesElement = document.getElementById('totalPages');
    const prevBtn = document.querySelector('[onclick="loadPrevPage()"]');
    const nextBtn = document.querySelector('[onclick="loadNextPage()"]');
    
    if (currentPageElement) {
        currentPageElement.textContent = commentCurrentPage;
    }
    
    if (totalPagesElement) {
        totalPagesElement.textContent = commentTotalPages;
    }
    
    if (prevBtn) {
        prevBtn.disabled = commentCurrentPage <= 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = commentCurrentPage >= commentTotalPages;
    }
}

function scrollToCommentsTop() {
    const commentsSection = document.getElementById('commentsSection');
    if (commentsSection) {
        commentsSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// ==================== é”™è¯¯å¤„ç† ====================
function showCommentLoadError() {
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    
    commentsList.innerHTML = `
        <div class="empty-comments">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>åŠ è½½è¯„è®ºå¤±è´¥</h3>
            <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
            <button onclick="reloadComments()" class="btn-submit" style="margin-top: 15px;">
                <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
            </button>
        </div>
    `;
}

function showEmptyComments() {
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    
    commentsList.innerHTML = `
        <div class="empty-comments">
            <i class="fas fa-comment-slash"></i>
            <h3>è¿˜æ²¡æœ‰è¯„è®º</h3>
            <p>å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
            ${!currentUser ? `
                <button onclick="window.location.href='login-real.html?redirect=' + encodeURIComponent(window.location.pathname)" 
                        class="btn-submit" style="margin-top: 15px;">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•åè¯„è®º
                </button>
            ` : ''}
        </div>
    `;
}

// ==================== DOMåŠ è½½å®Œæˆåæ‰§è¡Œ ====================
document.addEventListener('DOMContentLoaded', function() {
    initializePage().catch(console.error);
});

// ==================== å…¨å±€é”™è¯¯å¤„ç† ====================
window.addEventListener('error', function(e) {
    console.error('é¡µé¢é”™è¯¯:', e.error);
    showNotification('é¡µé¢å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
    showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
});
</script>
</body>
</html>