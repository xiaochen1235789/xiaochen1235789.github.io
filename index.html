<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="ÂÖ≠Âì•Ëç£ËÄÄWIKI,ËßíËâ≤,ÂÖâÈî•,ÂÖªÊàêÊùêÊñô,Ê∏∏ÊàèÊîªÁï•">
    <meta name="description" content="ÂÖ≠Âì•Ëç£ËÄÄWIKIÔºåÊï¥ÁêÜÊ∏∏ÊàèÂÜÖËßíËâ≤„ÄÅÂÖâÈî•„ÄÅÂÖªÊàêÊùêÊñôÁ≠â‰ø°ÊÅØÔºå‰∏∫Áé©ÂÆ∂Êèê‰æõËØ¶ÁªÜÂèÇËÄÉÔºåÁ∫ØÂ±ûËôöÊûÑÂ®±‰πê„ÄÇ">
    
    <!-- Open Graph Âíå Twitter Âç°Áâá‰ºòÂåñ -->
    <meta property="og:title" content="ÂÖ≠Âì•Ëç£ËÄÄWIKI">
    <meta property="og:description" content="Êï¥ÁêÜÊ∏∏ÊàèÂÜÖËßíËâ≤„ÄÅÂÖâÈî•„ÄÅÂÖªÊàêÊùêÊñôÁ≠â‰ø°ÊÅØÔºå‰∏∫Áé©ÂÆ∂Êèê‰æõËØ¶ÁªÜÂèÇËÄÉ">
    <meta property="og:image" content="https://xiaochen1235789.github.io/images/wangzhantupian.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ÂÖ≠Âì•Ëç£ËÄÄWIKI">
    <meta name="twitter:description" content="Êï¥ÁêÜÊ∏∏ÊàèÂÜÖËßíËâ≤„ÄÅÂÖâÈî•„ÄÅÂÖªÊàêÊùêÊñôÁ≠â‰ø°ÊÅØÔºå‰∏∫Áé©ÂÆ∂Êèê‰æõËØ¶ÁªÜÂèÇËÄÉ">
    
    <!-- ÁªìÊûÑÂåñÊï∞ÊçÆ -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "ÂÖ≠Âì•Ëç£ËÄÄWIKI",
        "description": "Êï¥ÁêÜÊ∏∏ÊàèÂÜÖËßíËâ≤„ÄÅÂÖâÈî•„ÄÅÂÖªÊàêÊùêÊñôÁ≠â‰ø°ÊÅØÔºå‰∏∫Áé©ÂÆ∂Êèê‰æõËØ¶ÁªÜÂèÇËÄÉ",
        "url": "https://xiaochen1235789.github.io"
    }
    </script>
    
    <link rel="icon" href="https://xiaochen1235789.github.io/images/wangzhantupian.png" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>ÂÖ≠Âì•Ëç£ËÄÄWIKI</title>
    
    <!-- Supabase ÂÆ¢Êà∑Á´ØÂ∫ì -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Font Awesome ÂõæÊ†á -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e3a2f;
            --card-bg-hover: #284a3c;
            --text-main: #e0e0e0;
            --text-highlight: #81c784;
            --text-secondary: #99aabb;
            --radius: 6px;
            --gap: 12px;
            --special-color: #ffd700;
            --border-color: #3d725f;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --supabase-blue: #3ecf8e;
            --supabase-purple: #8a4baf;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }
        
        body {
            overflow-x: hidden;
            padding-bottom: 500px !important;
            background: var(--bg) !important;
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* ==================== Âä†ËΩΩÁõ∏ÂÖ≥Ê†∑Âºè ==================== */
        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--text-highlight);
            z-index: 9999999;
            transition: width 0.3s ease, opacity 0.5s ease;
            opacity: 1;
        }
        
        #global-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(129, 199, 132, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-highlight);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* È™®Êû∂Â±èÊïàÊûú */
        .skeleton {
            background: linear-gradient(90deg, #2a3a35 25%, #354540 50%, #2a3a35 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* ==================== ‰øÆÂ§çÔºöÈ°∂ÈÉ®Âõ∫ÂÆöÂ∏ÉÂ±Ä ==================== */
        .top-nav {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 12px 16px;
            margin: 16px auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            max-width: 1200px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 9999;
            background: var(--card-bg);
        }
        
        .nav-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-highlight);
            margin-right: auto;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link {
            color: var(--text-main);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            white-space: nowrap;
            position: relative;
        }
        
        .nav-link:hover {
            background: var(--card-bg-hover);
            color: var(--text-highlight);
            transform: translateY(-1px);
        }
        
        .nav-link.active {
            background: var(--card-bg-hover);
            color: var(--special-color);
            font-weight: 600;
            border: 1px solid var(--special-color);
        }
        
        .nav-link.active::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--special-color);
            border-radius: 50%;
        }
        
        /* ==================== Áî®Êà∑‰ø°ÊÅØÂå∫Âüü ==================== */
        .user-nav-section {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-info-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(129, 199, 132, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(129, 199, 132, 0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .username {
            color: var(--text-highlight);
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .logout-btn {
            background: transparent;
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, 0.3);
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .logout-btn:hover {
            background: rgba(248, 113, 113, 0.1);
            transform: translateY(-1px);
        }
        
        /* ==================== ÊêúÁ¥¢Áõ∏ÂÖ≥Ê†∑Âºè ==================== */
        .search-container {
            max-width: 1200px;
            margin: 0 auto 16px;
            padding: 0 8px;
            position: relative;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            background: #2d3748;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-main);
            font-size: 0.95rem;
            outline: none;
            transition: all var(--transition-fast);
        }
        
        #search-input:focus {
            border-color: var(--text-highlight);
            box-shadow: 0 0 0 2px rgba(129, 199, 132, 0.2);
        }
        
        #search-input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-icon {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .search-history {
            position: absolute;
            top: 100%;
            left: 8px;
            right: 8px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-top: 4px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-history.show {
            display: block;
        }
        
        .history-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-item:hover {
            background: var(--card-bg-hover);
            color: var(--text-highlight);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-clear {
            padding: 8px 16px;
            text-align: center;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
        }
        
        .history-clear:hover {
            color: var(--text-highlight);
        }
        
        /* Á©∫ÁªìÊûúÊèêÁ§∫ */
        .empty-result {
            max-width: 1200px;
            margin: 40px auto;
            padding: 40px 30px;
            text-align: center;
            background: var(--card-bg);
            border-radius: var(--radius);
            color: var(--text-secondary);
            display: none;
            border: 1px dashed var(--border-color);
        }
        
        .empty-result i {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
            color: var(--text-highlight);
        }
        
        /* ==================== ÁΩëÁ´ôËøêË°åÂ§©Êï∞ ==================== */
        .site-age-container {
            max-width: 1200px;
            margin: 0 auto 16px;
            padding: 12px 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid transparent;
            transition: border-color var(--transition-normal);
        }
        
        .site-age-container:hover {
            border-color: var(--border-color);
        }
        
        #site-age {
            color: var(--text-highlight);
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(129, 199, 132, 0.1);
            transition: all var(--transition-normal);
        }
        
        #site-age.special {
            color: var(--special-color);
            animation: flash 1.5s infinite alternate;
            background: rgba(255, 215, 0, 0.1);
            padding: 8px 16px;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        
        @keyframes flash {
            from { 
                opacity: 1; 
                text-shadow: 0 0 5px rgba(255,215,0,0.5); 
            }
            to { 
                opacity: 0.9; 
                text-shadow: 0 0 15px rgba(255,215,0,0.8); 
            }
        }
        
        /* ==================== ÂÜÖÂÆπÂç°ÁâáÁΩëÊ†º ==================== */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--gap);
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 8px;
            transition: opacity var(--transition-normal);
        }
        
        /* Âç°ÁâáÁªü‰∏ÄÊ†∑Âºè */
        .content-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            width: 100% !important;
            height: auto !important;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .content-card::before {
            content: attr(data-type);
            position: absolute;
            top: 6px;
            left: 6px;
            padding: 2px 8px;
            background: var(--text-highlight);
            color: var(--bg);
            font-size: 0.7rem;
            border-radius: 4px;
            font-weight: 600;
            z-index: 1;
            opacity: 0.9;
        }
        
        .content-card.lightcone-card::before {
            background: #8197c7;
        }
        
        .content-card.material-card::before {
            background: #c781a6;
        }
        
        .content-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            background: var(--card-bg-hover);
            border-color: var(--text-highlight);
        }
        
        .content-card:active {
            transform: translateY(-2px);
        }
        
        /* ÂõæÁâáÂÆπÂô®‰ºòÂåñ */
        .card-img {
            width: 100%;
            background: #2d5243;
            border-radius: var(--radius);
            margin-bottom: 12px;
            padding: 0 !important;
            overflow: hidden !important;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }
        
        /* ÂõæÁâáÊØî‰æãÁªü‰∏Ä */
        .content-card:not(.lightcone-card):not(.material-card) .card-img {
            aspect-ratio: 4/5;
        }
        
        .lightcone-card .card-img {
            aspect-ratio: 3/4;
            transform: rotate(-5deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .lightcone-card:hover .card-img {
            transform: rotate(-5deg) translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .material-card .card-img {
            aspect-ratio: 1/1;
            border: 1px solid var(--border-color);
        }
        
        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
            opacity: 0;
        }
        
        .card-img img.loaded {
            opacity: 1;
        }
        
        .content-card:hover .card-img img {
            transform: scale(1.08);
        }
        
        .card-img::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 85%, rgba(0,0,0,0.2));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .content-card:hover .card-img::after {
            opacity: 1;
        }
        
        /* Âç°ÁâáÊñáÂ≠óÊ†∑Âºè */
        .card-name {
            font-size: 1rem;
            color: var(--text-highlight);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .card-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 36px;
            line-height: 1.4;
            flex-grow: 1;
        }
        
        /* Ê†áÈ¢ò‰ºòÂåñ */
        .section-header {
            max-width: 1200px;
            margin: 32px auto 16px;
            font-size: 1.4rem;
            color: var(--text-highlight);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 8px;
            scroll-margin-top: 100px;
        }
        
        .section-header::before {
            content: "üìå";
            font-size: 1.2em;
        }
        
        /* ==================== Êî∂ËóèÊåâÈíÆÊ†∑Âºè ==================== */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
            opacity: 0;
        }
        
        .content-card:hover .favorite-btn {
            opacity: 1;
        }
        
        .favorite-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        
        .favorite-btn.active {
            color: #f87171;
        }
        
        /* ==================== Êõ¥Êñ∞Êó•ÂøóÊ†∑Âºè ==================== */
        .changelog-loading, .changelog-error {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            background: var(--card-bg);
            border-radius: var(--radius);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .changelog-error button {
            background: var(--card-bg-hover);
            color: var(--text-highlight);
            border: none;
            padding: 8px 20px;
            border-radius: var(--radius);
            margin-top: 12px;
            cursor: pointer;
            transition: background var(--transition-fast);
            font-weight: 500;
        }
        
        .changelog-error button:hover {
            background: #32634e;
            transform: translateY(-1px);
        }
        
        .changelog-list {
            padding: 16px;
            line-height: 1.8;
        }
        
        .changelog-item {
            margin: 10px 0;
            border-radius: 6px;
            overflow: hidden;
            background-color: #23322d;
            border: 1px solid var(--border-color);
        }
        
        .changelog-item summary {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: bold;
            background-color: #2d443b;
            list-style: none;
            color: #a8d0b9;
            display: flex;
            align-items: center;
            transition: background-color var(--transition-fast);
        }
        
        .changelog-item summary:hover {
            background-color: #345244;
        }
        
        .changelog-item summary::before {
            content: "‚ñº";
            font-size: 12px;
            margin-right: 8px;
            color: #7abf9e;
            transition: transform var(--transition-normal);
        }
        
        .changelog-item[open] summary::before {
            transform: rotate(180deg);
        }
        
        .changelog-content {
            padding: 12px 16px;
            border-top: 1px solid #3a5048;
        }
        
        .changelog-version {
            margin: 0;
            font-size: 16px;
        }
        
        .changelog-content span[style] {
            color: #f0a55f !important;
        }
        
        .changelog-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            margin: 0 auto 250px;
            max-width: 1200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ÁâàÊú¨Ê†áÁ≠æ */
        .version-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            background: rgba(129, 199, 132, 0.2);
            color: var(--text-highlight);
            border: 1px solid rgba(129, 199, 132, 0.3);
        }
        
        .version-tag.beta {
            background: rgba(255, 215, 0, 0.2);
            color: var(--special-color);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        /* Êõ¥Êñ∞ÂæΩÁ´† */
        .update-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin: 0 4px;
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
        }
        
        .update-badge.fix {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }
        
        .update-badge.optimize {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
        }
        
        /* Êõ¥Êñ∞ÁªüËÆ° */
        .changelog-stats {
            margin: 10px 0 20px;
            padding: 12px 16px;
            background: rgba(129, 199, 132, 0.05);
            border-radius: var(--radius);
            border-left: 3px solid var(--text-highlight);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .changelog-stats span {
            display: inline-block;
            margin-right: 15px;
        }
        
        /* Êó∂Èó¥Á∫øÊ†∑Âºè */
        .changelog-list {
            position: relative;
            padding-left: 20px;
        }
        
        .changelog-list::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, 
                rgba(129, 199, 132, 0.3) 0%, 
                rgba(129, 199, 132, 0.6) 50%, 
                rgba(129, 199, 132, 0.3) 100%);
        }
        
        .changelog-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .changelog-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 20px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-highlight);
            border: 2px solid var(--card-bg);
            z-index: 1;
            transition: all var(--transition-fast);
        }
        
        .changelog-item[open]::before {
            background: var(--special-color);
            transform: scale(1.2);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        
        /* Êõ¥Êñ∞ÂÜÖÂÆπ‰ºòÂåñ */
        .changelog-content {
            padding: 16px;
            background: rgba(35, 50, 45, 0.5);
            border-radius: 0 var(--radius) var(--radius) var(--radius);
            margin-top: 2px;
        }
        
        .update-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .update-list li {
            margin: 10px 0;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--border-color);
            transition: all var(--transition-fast);
            position: relative;
            padding-left: 32px;
            display: block;
        }
        
        .update-list li:hover {
            background: rgba(129, 199, 132, 0.05);
            border-left-color: var(--text-highlight);
            transform: translateX(2px);
        }
        
        .update-list li::before {
            content: "‚ñ∏";
            position: absolute;
            left: 12px;
            color: var(--text-highlight);
        }
        
        .update-list .date {
            font-weight: 600;
            color: var(--text-highlight);
            margin-bottom: 4px;
            display: block;
        }
        
        .update-list .content {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .highlight {
            color: var(--special-color);
            font-weight: 600;
            background: rgba(255, 215, 0, 0.1);
            padding: 0 4px;
            border-radius: 3px;
            margin: 0 2px;
        }
        
        /* ÊéßÂà∂ÊåâÈíÆ */
        .changelog-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 0 16px;
        }
        
        .control-btn {
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }
        
        .control-btn:hover {
            background: var(--card-bg-hover);
            border-color: var(--text-highlight);
            transform: translateY(-1px);
        }
        
        .control-btn .icon {
            font-size: 0.8em;
            transition: transform var(--transition-fast);
        }
        
        .control-btn:hover .icon {
            transform: translateY(1px);
        }
        
        /* ÂÆ†Áâ©Á≥ªÁªüÊ†∑Âºè */
        .pet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .pet-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--text-highlight);
            flex-shrink: 0;
        }
        
        .pet-title {
            font-size: 1.3rem;
            color: var(--text-highlight);
            font-weight: 600;
        }
        
        /* ==================== ÊªöÂä®Êù°‰ºòÂåñ ==================== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-highlight);
        }
        
        /* ==================== È°µËÑö ==================== */
        footer {
            text-align: center;
            padding: 30px 0;
            font-size: 0.9rem;
            color: #888;
            margin-top: 60px;
            border-top: 1px solid var(--border-color);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* ==================== Èü≥‰πêÊí≠ÊîæÂô® ==================== */
        #musicPlayerIframe {
            display: block !important;
            visibility: visible !important;
            height: 400px !important;
            width: 100% !important;
            z-index: 99999 !important;
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            border: none !important;
            background: transparent !important;
            overflow: visible !important;
            transition: height 0.3s ease !important;
            will-change: height;
        }
        
        /* ==================== ÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ ==================== */
        .back-to-top {
            position: fixed;
            bottom: 130px;
            right: 20px;
            width: 46px;
            height: 46px;
            background: var(--card-bg-hover);
            color: var(--text-highlight);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            z-index: 9999;
            border: 1px solid var(--text-highlight);
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background: var(--text-highlight);
            color: var(--bg);
            transform: translateY(-2px);
        }
        
        /* ==================== ÈÄöÁü•Ê∂àÊÅØ ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text-highlight);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.4s ease;
            border-left: 4px solid var(--text-highlight);
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            border-left-color: #f87171;
            color: #f87171;
        }
        
        .notification.success {
            border-left-color: #4ade80;
            color: #4ade80;
        }
        
        .notification.info {
            border-left-color: #3b82f6;
            color: #3b82f6;
        }
        
        /* ==================== ÂìçÂ∫îÂºè‰ºòÂåñ ==================== */
        @media (max-width: 1024px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .nav-title {
                font-size: 1.1rem;
            }
            
            .nav-link {
                font-size: 0.85rem;
                padding: 6px 12px;
            }
            
            .section-header {
                font-size: 1.2rem;
                margin: 24px auto 12px;
            }
            
            .card-name {
                font-size: 0.9rem;
            }
            
            .card-desc {
                font-size: 0.75rem;
                min-height: 32px;
            }
            
            body {
                padding-bottom: 120px !important;
            }
            
            #search-input {
                padding: 10px 44px 10px 14px;
                font-size: 0.85rem;
            }
            
            .search-icon {
                right: 20px;
            }
            
            .back-to-top {
                width: 42px;
                height: 42px;
                bottom: 110px;
                right: 15px;
            }
            
            .user-info-container {
                padding: 6px 12px;
                gap: 8px;
            }
            
            .username {
                max-width: 80px;
                font-size: 0.85rem;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            .logout-btn {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .favorite-btn {
                opacity: 1; /* ÁßªÂä®Á´ØÂßãÁªàÊòæÁ§∫ */
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
            
            .top-nav {
                padding: 10px 12px;
                gap: 8px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-nav-section {
                order: 3;
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
                border-top: 1px solid var(--border-color);
                padding-top: 10px;
            }
            
            .nav-link {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .site-age-container {
                padding: 8px 12px;
            }
            
            #site-age {
                font-size: 0.85rem;
            }
            
            .content-card::before {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
            
            .changelog-box {
                padding: 16px;
            }
            
            .pet-icon {
                width: 50px;
                height: 50px;
            }
            
            .pet-title {
                font-size: 1.1rem;
            }
            
            .changelog-controls {
                flex-direction: column;
            }
            
            .changelog-stats span {
                display: block;
                margin: 4px 0;
            }
            
            .user-info-container {
                padding: 4px 8px;
            }
            
            .username {
                max-width: 60px;
                font-size: 0.8rem;
            }
        }
        
        /* ==================== ËØÑËÆ∫Á≥ªÁªüÊ†∑Âºè‰ºòÂåñ ==================== */
.comments-system {
    max-width: 1200px;
    margin: 0 auto 60px;
    padding: 0 8px;
}

/* ËØÑËÆ∫ÁªüËÆ°Â¢ûÂº∫ */
.comments-stats {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.comments-stats::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, 
        var(--text-highlight) 0%,
        var(--supabase-blue) 50%,
        var(--supabase-purple) 100%);
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(129, 199, 132, 0.05);
    border-radius: var(--radius);
    transition: all var(--transition-fast);
}

.stat-item:hover {
    background: rgba(129, 199, 132, 0.1);
    transform: translateY(-2px);
}

.stat-item i {
    font-size: 1.2rem;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(129, 199, 132, 0.1);
    border-radius: 50%;
}

/* ËØÑËÆ∫ÊéíÂ∫è‰ºòÂåñ */
.comments-sort {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
}

.sort-btn {
    padding: 8px 20px;
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 6px;
}

.sort-btn:hover {
    border-color: var(--text-highlight);
    color: var(--text-highlight);
    background: rgba(129, 199, 132, 0.05);
}

.sort-btn.active {
    background: var(--text-highlight);
    color: var(--bg);
    border-color: var(--text-highlight);
}

/* ËØÑËÆ∫Ë°®ÂçïÂ¢ûÂº∫ */
.comment-form-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
}

.comment-format-help {
    margin-left: auto;
    color: var(--text-secondary);
    cursor: help;
    position: relative;
}

.format-help-tooltip {
    position: absolute;
    top: 100%;
    right: 0;
    width: 250px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 12px;
    font-size: 0.85rem;
    line-height: 1.4;
    box-shadow: var(--shadow);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: 100;
}

.comment-format-help:hover .format-help-tooltip {
    opacity: 1;
    visibility: visible;
}

/* ÁºñËæëÂô®‰ºòÂåñ */
.comment-editor textarea {
    width: 100%;
    padding: 16px;
    background: #2d3748;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-main);
    font-size: 1rem;
    line-height: 1.5;
    resize: none;
    outline: none;
    transition: border-color var(--transition-fast);
    font-family: inherit;
    min-height: 100px;
    max-height: 300px;
}

.comment-editor textarea:focus {
    border-color: var(--text-highlight);
    box-shadow: 0 0 0 2px rgba(129, 199, 132, 0.1);
}

/* Â∑•ÂÖ∑ÊåâÈíÆ‰ºòÂåñ */
.editor-tools {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    flex-wrap: wrap;
    gap: 10px;
}

.tools-left {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.tool-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    position: relative;
}

.tool-btn:hover {
    background: var(--card-bg-hover);
    color: var(--text-highlight);
    border-color: var(--text-highlight);
    transform: translateY(-1px);
}

.tool-btn.active {
    background: var(--text-highlight);
    color: var(--bg);
    border-color: var(--text-highlight);
}

/* Â≠óÁ¨¶ËÆ°Êï∞‰ºòÂåñ */
.char-count {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-right: 12px;
    transition: color var(--transition-fast);
}

.char-count.warning {
    color: #f87171;
    font-weight: bold;
}

.char-count.danger {
    color: #dc2626;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

/* Êèê‰∫§ÊåâÈíÆ‰ºòÂåñ */
.btn-submit {
    padding: 10px 24px;
    background: var(--text-highlight);
    color: var(--bg);
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-submit:hover:not(:disabled) {
    background: #6ab56f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(129, 199, 132, 0.3);
}

.btn-submit:disabled {
    background: #4a5568;
    color: var(--text-secondary);
    cursor: not-allowed;
    transform: none !important;
}

.btn-submit.loading {
    position: relative;
    color: transparent;
}

.btn-submit.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid var(--bg);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* ‰∏ä‰º†ËøõÂ∫¶ */
.upload-progress {
    margin-top: 10px;
    padding: 10px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    display: none;
    align-items: center;
    gap: 10px;
}

.progress-bar {
    flex: 1;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    display: block;
    height: 100%;
    background: var(--text-highlight);
    width: 0%;
    transition: width 0.3s ease;
}

#progressText {
    font-size: 0.85rem;
    color: var(--text-secondary);
    min-width: 40px;
}

/* ÂõæÁâáÈ¢ÑËßà */
.image-preview {
    margin-top: 10px;
    position: relative;
    display: none;
}

.image-preview img {
    max-width: 200px;
    max-height: 150px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

.remove-image {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #f87171;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all var(--transition-fast);
}

.remove-image:hover {
    transform: scale(1.1);
}

/* Ë°®ÊÉÖÈÄâÊã©Âô®‰ºòÂåñ */
.emoji-picker {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-top: 10px;
    display: none;
    box-shadow: var(--shadow);
    position: absolute;
    width: 100%;
    z-index: 100;
}

.emoji-picker.show {
    display: block;
}

.emoji-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
}

.close-emoji {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1rem;
}

.close-emoji:hover {
    color: var(--text-highlight);
}

.emoji-categories {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
}

.emoji-search {
    position: relative;
    padding: 12px 16px;
}

.emoji-search input {
    width: 100%;
    padding: 8px 12px 8px 32px;
    background: #2d3748;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-main);
    font-size: 0.9rem;
}

.emoji-search i {
    position: absolute;
    left: 24px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.emoji-grid {
    max-height: 200px;
    overflow-y: auto;
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
    gap: 8px;
}

.emoji-item {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all var(--transition-fast);
}

.emoji-item:hover {
    background: var(--card-bg-hover);
    transform: scale(1.2);
}

/* ËØÑËÆ∫ËøáÊª§ */
.comment-filters {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.filter-group {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.filter-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.9rem;
}

.filter-group input[type="checkbox"] {
    accent-color: var(--text-highlight);
}

.filter-search {
    position: relative;
    flex: 1;
    max-width: 300px;
}

.filter-search input {
    width: 100%;
    padding: 8px 12px 8px 32px;
    background: #2d3748;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-main);
    font-size: 0.9rem;
}

.filter-search i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

/* ËØÑËÆ∫ÂàóË°®‰ºòÂåñ */
.comments-list {
    margin-top: 30px;
    min-height: 200px;
    position: relative;
}

.comment-item {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid var(--border-color);
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.comment-item:hover {
    border-color: var(--text-highlight);
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.comment-item.pinned {
    border-left: 4px solid var(--special-color);
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 215, 0, 0.01) 100%);
}

.comment-item.pinned::before {
    content: 'üìå ÁΩÆÈ°∂';
    position: absolute;
    top: 0;
    right: 0;
    background: var(--special-color);
    color: var(--bg);
    font-size: 0.7rem;
    padding: 4px 12px;
    border-bottom-left-radius: var(--radius);
}

.comment-item.highlight {
    animation: highlight-comment 2s ease;
}

@keyframes highlight-comment {
    0% { background: rgba(129, 199, 132, 0.2); }
    100% { background: var(--card-bg); }
}

.comment-item.best-comment {
    border: 2px solid var(--special-color);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(129, 199, 132, 0.05));
}

.comment-item.best-comment::after {
    content: 'üèÜ ‰ºòË¥®ËØÑËÆ∫';
    position: absolute;
    bottom: 0;
    right: 0;
    background: var(--special-color);
    color: var(--bg);
    font-size: 0.7rem;
    padding: 4px 12px;
    border-top-left-radius: var(--radius);
}

/* ËØÑËÆ∫Â§¥ÈÉ®‰ºòÂåñ */
.comment-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    overflow: hidden;
    flex-shrink: 0;
    border: 2px solid transparent;
    transition: border-color var(--transition-fast);
}

.comment-avatar:hover {
    border-color: var(--text-highlight);
}

.comment-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.comment-avatar .avatar-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}

/* ËØÑËÆ∫ÂÖÉÊï∞ÊçÆ */
.comment-meta {
    flex: 1;
    min-width: 0;
}

.comment-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.author-name {
    color: var(--text-highlight);
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.author-badge {
    background: var(--text-highlight);
    color: var(--bg);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
}

.author-badge.admin {
    background: #f87171;
}

.author-badge.verified {
    background: #3b82f6;
}

.comment-time {
    color: var(--text-secondary);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-time .edited {
    color: var(--text-secondary);
    font-style: italic;
}

/* ËØÑËÆ∫ÂÜÖÂÆπ‰ºòÂåñ */
.comment-content {
    color: var(--text-main);
    line-height: 1.6;
    margin-bottom: 16px;
    word-break: break-word;
}

.comment-content p {
    margin-bottom: 8px;
}

.comment-content code {
    background: #2d3748;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #81c784;
}

.comment-content pre {
    background: #2d3748;
    padding: 12px;
    border-radius: var(--radius);
    overflow-x: auto;
    margin: 10px 0;
}

.comment-content pre code {
    background: none;
    padding: 0;
}

.comment-content img {
    max-width: 100%;
    border-radius: var(--radius);
    margin: 10px 0;
    cursor: zoom-in;
    transition: transform var(--transition-fast);
}

.comment-content img:hover {
    transform: scale(1.02);
}

.comment-content a {
    color: var(--text-highlight);
    text-decoration: none;
    border-bottom: 1px dotted var(--text-highlight);
}

.comment-content a:hover {
    border-bottom-style: solid;
}

/* ËØÑËÆ∫Êìç‰Ωú‰ºòÂåñ */
.comment-actions {
    display: flex;
    align-items: center;
    gap: 20px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
    flex-wrap: wrap;
}

.action-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all var(--transition-fast);
    padding: 6px 10px;
    border-radius: var(--radius);
}

.action-btn:hover {
    background: rgba(129, 199, 132, 0.1);
    color: var(--text-highlight);
}

.action-btn.active {
    color: #f87171;
}

.action-btn.liked {
    color: #f87171;
}

.action-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.disabled:hover {
    background: transparent;
    color: var(--text-secondary);
}

.action-count {
    font-size: 0.85rem;
    font-weight: 500;
}

/* ÂõûÂ§çË°®Âçï‰ºòÂåñ */
.reply-form {
    margin-top: 16px;
    padding-left: 52px;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.reply-form textarea {
    width: 100%;
    padding: 12px;
    background: #2d3748;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-main);
    font-size: 0.9rem;
    line-height: 1.4;
    resize: vertical;
    min-height: 80px;
    max-height: 150px;
}

.reply-form .btn-submit {
    padding: 8px 16px;
    font-size: 0.9rem;
}

/* ÂõûÂ§çÂàóË°®‰ºòÂåñ */
.comment-replies {
    margin-left: 52px;
    margin-top: 16px;
    border-left: 2px solid var(--border-color);
    padding-left: 20px;
}

.reply-item {
    padding: 12px 0;
    border-bottom: 1px dashed var(--border-color);
    animation: fadeIn 0.3s ease;
}

.reply-item:last-child {
    border-bottom: none;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.reply-actions {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}

.view-replies-btn {
    background: transparent;
    border: none;
    color: var(--text-highlight);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    margin-top: 10px;
    border-radius: var(--radius);
    transition: background var(--transition-fast);
}

.view-replies-btn:hover {
    background: rgba(129, 199, 132, 0.1);
}

/* Âä†ËΩΩÁä∂ÊÄÅ‰ºòÂåñ */
.loading-comments {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.loading-comments .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(129, 199, 132, 0.3);
    border-top-color: var(--text-highlight);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

/* ËØÑËÆ∫ÂàÜÈ°µ‰ºòÂåñ */
.comments-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    flex-wrap: wrap;
}

.page-btn {
    padding: 8px 16px;
    background: var(--card-bg);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all var(--transition-fast);
    min-width: 100px;
    justify-content: center;
}

.page-btn:hover:not(:disabled) {
    background: var(--card-bg-hover);
    border-color: var(--text-highlight);
    transform: translateY(-1px);
}

.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.page-size {
    display: flex;
    align-items: center;
    gap: 8px;
}

.page-size select {
    background: var(--card-bg);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 6px 12px;
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
}

.page-size select:focus {
    border-color: var(--text-highlight);
}

/* Á©∫ËØÑËÆ∫Áä∂ÊÄÅ */
.empty-comments {
    text-align: center;
    padding: 60px 20px;
    background: var(--card-bg);
    border-radius: var(--radius);
    border: 1px dashed var(--border-color);
    animation: fadeIn 0.5s ease;
}

.empty-comments i {
    font-size: 3rem;
    color: var(--text-secondary);
    margin-bottom: 20px;
    display: block;
}

.empty-comments h3 {
    color: var(--text-highlight);
    margin-bottom: 10px;
}

/* ÂõûÂà∞ËØÑËÆ∫È°∂ÈÉ®ÊåâÈíÆ */
.back-to-comments-top {
    position: fixed;
    bottom: 180px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: var(--card-bg);
    color: var(--text-highlight);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: var(--shadow);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
    z-index: 9999;
    border: 1px solid var(--border-color);
}

.back-to-comments-top.show {
    opacity: 1;
    visibility: visible;
}

.back-to-comments-top:hover {
    background: var(--text-highlight);
    color: var(--bg);
    transform: translateY(-2px);
}

/* ‰∏æÊä•ÂØπËØùÊ°Ü */
.report-dialog, .comment-detail-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
}

.report-dialog.show, .comment-detail-dialog.show {
    opacity: 1;
    visibility: visible;
}

.report-content, .detail-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    transform: translateY(-20px);
    transition: transform var(--transition-normal);
}

.report-dialog.show .report-content,
.comment-detail-dialog.show .detail-content {
    transform: translateY(0);
}

.report-header, .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}

.close-report, .close-detail {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
}

.close-report:hover, .close-detail:hover {
    color: var(--text-highlight);
}

.report-body, .detail-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.report-reasons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
}

.report-reasons label {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-main);
    cursor: pointer;
    padding: 8px 12px;
    border-radius: var(--radius);
    transition: background var(--transition-fast);
}

.report-reasons label:hover {
    background: rgba(129, 199, 132, 0.1);
}

.report-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
}

.report-cancel, .report-submit {
    padding: 10px 20px;
    border-radius: var(--radius);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.report-cancel {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.report-cancel:hover {
    background: var(--card-bg-hover);
    border-color: var(--text-secondary);
}

.report-submit {
    background: var(--text-highlight);
    color: var(--bg);
    border: none;
}

.report-submit:hover {
    background: #6ab56f;
    transform: translateY(-1px);
}

/* ÂìçÂ∫îÂºèËÆæËÆ°‰ºòÂåñ */
@media (max-width: 768px) {
    .comments-system {
        margin-bottom: 30px;
    }
    
    .stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .stat-item {
        padding: 8px;
        font-size: 0.85rem;
    }
    
    .comment-form-container {
        padding: 16px;
    }
    
    .comment-item {
        padding: 16px;
    }
    
    .reply-form {
        padding-left: 16px;
    }
    
    .comment-replies {
        margin-left: 16px;
        padding-left: 16px;
    }
    
    .comments-pagination {
        flex-direction: column;
        gap: 10px;
    }
    
    .page-btn {
        width: 100%;
    }
    
    .emoji-picker {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        border-radius: var(--radius) var(--radius) 0 0;
    }
    
    .comment-filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-search {
        max-width: 100%;
    }
    
    .back-to-comments-top {
        bottom: 140px;
        right: 15px;
    }
}

@media (max-width: 480px) {
    .editor-tools {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }
    
    .tools-right {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .comment-actions {
        gap: 10px;
        justify-content: space-between;
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .stat-item {
        flex-direction: column;
        text-align: center;
        gap: 6px;
    }
    
    .comments-sort {
        justify-content: center;
    }
    
    .sort-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
}
        
        /* ==================== ÊâìÂç∞Ê†∑Âºè‰ºòÂåñ ==================== */
        @media print {
            .top-nav, #search-input, .site-age-container, 
            .back-to-top, #musicPlayerIframe, footer {
                display: none !important;
            }
            
            body {
                padding-bottom: 0 !important;
                background: white !important;
                color: black !important;
            }
            
            .content-card {
                break-inside: avoid;
                border: 1px solid #ddd !important;
                background: white !important;
                color: black !important;
            }
            
            .card-name {
                color: black !important;
            }
            
            .card-desc {
                color: #555 !important;
            }
        }
    </style>
</head>
<body>

    <!-- Âä†ËΩΩËøõÂ∫¶Êù° -->
    <div class="loading-progress" id="loadingProgress"></div>
    
    <!-- ÂÖ®Â±ÄÂä†ËΩΩÂä®Áîª -->
    <div id="global-loading">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="color: var(--text-highlight); margin-top: 16px; font-size: 1.1rem;">Âä†ËΩΩËµÑÊ∫ê‰∏≠...</p>
        </div>
    </div>

    <!-- ÈÄöÁü•Ê∂àÊÅØÂÆπÂô® -->
    <div class="notification" id="notification"></div>

    <!-- ÂØºËà™Ê†èÔºàÂ∑≤Êï¥ÂêàÁôªÂΩïÁä∂ÊÄÅÔºâ -->
    <nav class="top-nav" aria-label="‰∏ªË¶ÅÂØºËà™">
        <div class="nav-title">
            <span>ÂÖ≠Âì•Ëç£ËÄÄWIKI</span>
        </div>
        <a href="#character" class="nav-link" data-target="character">ËßíËâ≤</a>
        <a href="#lightcone" class="nav-link" data-target="lightcone">ÂÖâÈî•</a>
        <a href="profile.html" class="nav-link">‰∏™‰∫∫‰∏ªÈ°µ</a>
        <a href="#material" class="nav-link" data-target="material">ÂÖªÊàêÊùêÊñô</a>
        <a href="#changelog" class="nav-link" data-target="changelog">Êõ¥Êñ∞Êó•Âøó</a>
        <a href="#comments" class="nav-link" data-target="comments">Áî®Êà∑ËØÑËÆ∫</a>
        
        <!-- Áî®Êà∑ÂØºËà™ÈÉ®ÂàÜÔºàÁî±JavaScriptÂä®ÊÄÅÁîüÊàêÔºâ -->
        <div class="user-nav-section" id="userNavSection">
            <!-- ÈªòËÆ§ÊòæÁ§∫ÁôªÂΩïÈìæÊé•ÔºåÁôªÂΩïÂêéÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ -->
            <a href="login-real.html" class="nav-link">ÁôªÂΩï/Ê≥®ÂÜå</a>
        </div>
    </nav>

    <!-- ÊêúÁ¥¢Ê°Ü -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="ÊêúÁ¥¢ËßíËâ≤/ÂÖâÈî•/ÊùêÊñôÔºàÊîØÊåÅÂÖ≥ÈîÆËØçÊ®°Á≥äÂåπÈÖçÔºâ" aria-label="ÊêúÁ¥¢ÂÜÖÂÆπ">
        <div class="search-icon">üîç</div>
        <div class="search-history" id="searchHistory">
            <div class="history-clear" id="clearHistory">Ê∏ÖÁ©∫ÊêúÁ¥¢ÂéÜÂè≤</div>
        </div>
    </div>

    <!-- ÁΩëÁ´ôËøêË°åÂ§©Êï∞ -->
    <div class="site-age-container">
        <span id="site-age"><span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; margin-right: 6px;"></span>Âä†ËΩΩ‰∏≠...</span>
    </div>

    <!-- Á©∫ÁªìÊûúÊèêÁ§∫ -->
    <div class="empty-result">
        <i>üîç</i>
        <h3>Êú™ÊâæÂà∞ÂåπÈÖçÁªìÊûú</h3>
        <p>ËØïËØïÊõ¥Êç¢ÂÖ≥ÈîÆËØçÊàñÊ£ÄÊü•ÊãºÂÜô~</p>
    </div>

    <!-- ËßíËâ≤ÂàóË°® -->
    <h2 class="section-header" id="character">ËßíËâ≤ÂàóË°®</h2>
    <div class="grid-container" data-category="character">
        <div class="content-card" onclick="jumpToDetail('yunli-detail.html', '‰∫ëÁíÉ')" data-type="ËßíËâ≤" data-name="‰∫ëÁíÉ" data-desc="ÊØÅÁÅ≠ ¬∑ Áâ©ÁêÜ | È≠îÊîπ‰∫îÊòü | Êó†ÁâàÊú¨">
            <div class="card-img skeleton">
                <img src="./images/yunli.webp" alt="‰∫ëÁíÉËßíËâ≤Âç°Áâá - ÊØÅÁÅ≠Áâ©ÁêÜÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">‰∫ëÁíÉ</div>
            <div class="card-desc">ÊØÅÁÅ≠ ¬∑ Áâ©ÁêÜ | È≠îÊîπ‰∫îÊòü | Êó†ÁâàÊú¨</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('luguan-detail.html', 'ÈπøÂ∞ÜÂÜõ')" data-type="ËßíËâ≤" data-name="ÈπøÂ∞ÜÂÜõ" data-desc="Â∑°Áåé ¬∑ È£é | ÈôêÂÆö‰∫îÊòü | 1.0‰∏äÂçä">
            <div class="card-img skeleton">
                <img src="./images/changjinglu.webp" alt="ÈπøÂ∞ÜÂÜõËßíËâ≤Âç°Áâá - Â∑°ÁåéÈ£éÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÈπøÂ∞ÜÂÜõ</div>
            <div class="card-desc">Â∑°Áåé ¬∑ È£é | ÈôêÂÆö‰∫îÊòü | 1.0‰∏äÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('pige-detail.html', 'ÁöÆÂì•')" data-type="ËßíËâ≤" data-name="ÁöÆÂì•" data-desc="Â≠òÊä§ ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.0‰∏ãÂçä">
            <div class="card-img skeleton">
                <img src="./images/pige.webp" alt="ÁöÆÂì•ËßíËâ≤Âç°Áâá - Â≠òÊä§Áâ©ÁêÜÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÁöÆÂì•</div>
            <div class="card-desc">Â≠òÊä§ ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.0‰∏ãÂçä</div>
        </div>    
        
        <div class="content-card" onclick="jumpToDetail('jiazijie-detail.html', 'Â§πÂ≠êÂßê')" data-type="ËßíËâ≤" data-name="Â§πÂ≠êÂßê" data-desc="Êô∫ËØÜ ¬∑ Èõ∑ | ÈôêÂÆö‰∫îÊòü | 1.1‰∏äÂçä">
            <div class="card-img skeleton">
                <img src="./images/jiazijie.webp" alt="Â§πÂ≠êÂßêËßíËâ≤Âç°Áâá - Êô∫ËØÜÈõ∑Á≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Â§πÂ≠êÂßê</div>
            <div class="card-desc">Êô∫ËØÜ ¬∑ Èõ∑ | ÈôêÂÆö‰∫îÊòü | 1.1‰∏äÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('han-detail.html', 'Ê∂µ')" data-type="ËßíËâ≤" data-name="Ê∂µ" data-desc="ÂêåË∞ê ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.1‰∏ãÂçä">
            <div class="card-img skeleton">
                <img src="./images/han.webp" alt="Ê∂µËßíËâ≤Âç°Áâá - ÂêåË∞êÁâ©ÁêÜÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Ê∂µ</div>
            <div class="card-desc">ÂêåË∞ê ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.1‰∏ãÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('yuzhiboyan-detail.html', 'ÂÆáÊô∫Ê≥¢.Ë®Ä')" data-type="ËßíËâ≤" data-name="ÂÆáÊô∫Ê≥¢.Ë®Ä" data-desc="ÊØÅÁÅ≠ ¬∑ Èõ∑ | ÈôêÂÆö‰∫îÊòü | 1.2‰∏äÂçä">
            <div class="card-img skeleton">
                <img src="./images/yuzhiboyan.webp" alt="ÂÆáÊô∫Ê≥¢.Ë®ÄËßíËâ≤Âç°Áâá - ÊØÅÁÅ≠Èõ∑Á≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÂÆáÊô∫Ê≥¢.Ë®Ä</div>
            <div class="card-desc">ÊØÅÁÅ≠ ¬∑ Èõ∑ | ÈôêÂÆö‰∫îÊòü | 1.2‰∏äÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('banxierencheng-detail.html', 'ÂçäÊ¢∞‰∫∫.Êàê')" data-type="ËßíËâ≤" data-name="ÂçäÊ¢∞‰∫∫.Êàê" data-desc="ÊØÅÁÅ≠ ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.2‰∏ãÂçä">
            <div class="card-img skeleton">
                <img src="./images/banxierencheng.webp" alt="ÂçäÊ¢∞‰∫∫.ÊàêËßíËâ≤Âç°Áâá - ÊØÅÁÅ≠Áâ©ÁêÜÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÂçäÊ¢∞‰∫∫.Êàê</div>
            <div class="card-desc">ÊØÅÁÅ≠ ¬∑ Áâ©ÁêÜ | ÈôêÂÆö‰∫îÊòü | 1.2‰∏ãÂçä</div>
        </div>
    
        <div class="content-card" onclick="jumpToDetail('meng-detail.html', 'Ê¢¶')" data-type="ËßíËâ≤" data-name="Ê¢¶" data-desc="ËôöÊó† ¬∑ È£é | ÈôêÂÆö‰∫îÊòü | 1.3‰∏äÂçä">
            <div class="card-img skeleton">
                <img src="./images/meng.webp" alt="Ê¢¶ËßíËâ≤Âç°Áâá - ËôöÊó†È£éÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Ê¢¶</div>
            <div class="card-desc">ËôöÊó† ¬∑ È£é | ÈôêÂÆö‰∫îÊòü | 1.3‰∏äÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('shenshengpige-detail.html', 'Á•ûÂú£.ÁöÆÂì•')" data-type="ËßíËâ≤" data-name="Á•ûÂú£.ÁöÆÂì•" data-desc="‰∏∞È•∂ ¬∑ ËôöÊï∞ | ÈôêÂÆö‰∫îÊòü | 1.3‰∏ãÂçä">
            <div class="card-img skeleton">
                <img src="./images/shenshengpige.webp" alt="Á•ûÂú£.ÁöÆÂì•ËßíËâ≤Âç°Áâá - ‰∏∞È•∂ËôöÊï∞Á≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Á•ûÂú£.ÁöÆÂì•</div>
            <div class="card-desc">‰∏∞È•∂ ¬∑ ËôöÊï∞ | ÈôêÂÆö‰∫îÊòü | 1.3‰∏ãÂçä</div>
        </div>
        
        <div class="content-card" onclick="jumpToDetail('tianmingrenhouge-detail.html', 'Â§©ÂëΩ‰∫∫.Áå¥Âì•')" data-type="ËßíËâ≤" data-name="Â§©ÂëΩ‰∫∫.Áå¥Âì•" data-desc="ÁπÅËÇ≤ ¬∑ ÈáèÂ≠ê | ÈôêÂÆö‰∫îÊòü | 2.0‰∏äÂçä">
            <div class="card-img skeleton">
                <img src="./images/tianmingrenhouge.webp" alt="Â§©ÂëΩ‰∫∫.Áå¥Âì•ËßíËâ≤Âç°Áâá - ÁπÅËÇ≤ÈáèÂ≠êÁ≥ªËßíËâ≤" loading="lazy" width="150" height="188" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Â§©ÂëΩ‰∫∫.Áå¥Âì•</div>
            <div class="card-desc">ÁπÅËÇ≤ ¬∑ ÈáèÂ≠ê | ÈôêÂÆö‰∫îÊòü | 2.0‰∏äÂçä</div>
        </div>
    </div>
    
    <!-- ÂÖâÈî•ÂàóË°® -->
    <h2 class="section-header" id="lightcone">ÂÖâÈî•ÂàóË°®</h2>
    <div class="grid-container" data-category="lightcone">
        <div class="content-card lightcone-card" onclick="jumpToDetail('Light cone data/changjinglu.html','Âø´‰πêÁöÑË∑Ø‰∏ÄÂ§©')" data-type="ÂÖâÈî•" data-name="Âø´‰πêÁöÑË∑Ø‰∏ÄÂ§©" data-desc="Â∑°Áåé | ÈπøÂ∞ÜÂÜõ‰∏ìÊ≠¶">
            <div class="card-img skeleton">
                <img src="./guangzhui.images/changjinglu.jpg" alt="Âø´‰πêÁöÑË∑Ø‰∏ÄÂ§©ÂÖâÈî• - Â∑°ÁåéÁ±ªÂûã" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Âø´‰πêÁöÑË∑Ø‰∏ÄÂ§©</div>
            <div class="card-desc">Â∑°Áåé | ÈπøÂ∞ÜÂÜõ‰∏ìÊ≠¶</div>
        </div>
        
        <div class="content-card lightcone-card" data-type="ÂÖâÈî•" data-name="ÂπªÁÅµÁå´È≠Ö" data-desc="Ê¨¢ÊÑâ | È≠îÊ≥ïÁå´Âí™.Â∞èÂí™‰∏ìÊ≠¶">
            <div class="card-img skeleton">
                <img src="./guangzhui.images/xiaomi.jpg" alt="ÂπªÁÅµÁå´È≠ÖÂÖâÈî• - Ê¨¢ÊÑâÁ±ªÂûã" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÂπªÁÅµÁå´È≠Ö</div>
            <div class="card-desc">Ê¨¢ÊÑâ | È≠îÊ≥ïÁå´Âí™.Â∞èÂí™‰∏ìÊ≠¶</div>
        </div>
        
        <div class="content-card lightcone-card" data-type="ÂÖâÈî•" data-name="Êú™Áü•ÂÖâÈî•" data-desc="ÔºüÔºüÔºü">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="Êú™Áü•ÂÖâÈî•" loading="lazy" width="150" height="200" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">Êú™Áü•ÂÖâÈî•</div>
            <div class="card-desc">ÔºüÔºüÔºü</div>
        </div>
    </div>
    
    <!-- ÂÖªÊàêÊùêÊñô -->
    <h2 class="section-header" id="material">ÂÖªÊàêÊùêÊñô</h2>
    <div class="grid-container" data-category="material">
        <div class="content-card material-card" data-type="ÊùêÊñô" data-name="ÂÖªÊàêÊùêÊñô1" data-desc="ÔºüÔºüÔºü">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="ÂÖªÊàêÊùêÊñô1" loading="lazy" width="150" height="150" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÂÖªÊàêÊùêÊñô1</div>
            <div class="card-desc">ÔºüÔºüÔºü</div>
        </div>
        
        <div class="content-card material-card" data-type="ÊùêÊñô" data-name="ÂÖªÊàêÊùêÊñô2" data-desc="ÔºüÔºüÔºü">
            <div class="card-img skeleton">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d.jpeg~tplv-a9rns2rl98-24:720:720.jpeg" alt="ÂÖªÊàêÊùêÊñô2" loading="lazy" width="150" height="150" onload="imageLoaded(this)" onerror="imageError(this)">
            </div>
            <div class="card-name">ÂÖªÊàêÊùêÊñô2</div>
            <div class="card-desc">ÔºüÔºüÔºü</div>
        </div>
    </div>

    <!-- Êõ¥Êñ∞Êó•Âøó -->
    <h2 class="section-header" id="changelog">Êõ¥Êñ∞Êó•Âøó</h2>
    <div class="pet-system" style="margin-top: 0;" id="changelogContainer">
        <div class="changelog-box">
            <div class="pet-header">
                <div class="pet-icon">
                    <img src="./images/rizhitupian.webp" 
                         alt="Êõ¥Êñ∞Êó•ÂøóÂõæÊ†á" 
                         style="width: 100%; height: 100%; object-fit: contain;"
                         onload="imageLoaded(this)"
                         onerror="imageError(this)">
                </div>
                <div>
                    <div class="pet-title">WIKIÁâàÊú¨Êõ¥Êñ∞ËÆ∞ÂΩï</div>
                    <div class="changelog-stats">
                        <span>üìä ÂÖ± 15 Ê¨°Êõ¥Êñ∞</span>
                        <span>üë§ 10 ‰∏™ËßíËâ≤</span>
                        <span>‚ú® 3 ‰∏™ÂÖâÈî•</span>
                        <span>‚ö° 5 È°π‰ºòÂåñ</span>
                        <span>üêõ 2 È°π‰øÆÂ§ç</span>
                    </div>
                </div>
            </div>
            
            <div class="changelog-controls">
                <button onclick="toggleAllChangelogs()" class="control-btn">
                    <span>Â±ïÂºÄÂÖ®ÈÉ®</span>
                    <span class="icon">‚ñº</span>
                </button>
                <button onclick="copyChangelog()" class="control-btn">
                    <span>Â§çÂà∂Êõ¥Êñ∞ËÆ∞ÂΩï</span>
                    <span class="icon">üìã</span>
                </button>
            </div>
            
            <div class="changelog-list">
                <details class="changelog-item" open>
                    <summary>
                        <h4 class="changelog-version">
                            ÂäüËÉΩÊïôÁ®ã‰∏ìÁî®Ê†è
                            <span class="version-tag beta">ÊïôÁ®ã</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">Èü≥‰πêÊí≠ÊîæÂô®ÊïôÁ®ã</span>
                                <span class="content">
                                    üîä-Èü≥Èáè‰∏∫<span class="highlight">100%</span>
                                    üîâ-Èü≥Èáè‰∏∫<span class="highlight">50%</span>
                                    üîá-Èü≥Èáè‰∏∫<span class="highlight">0%</span>
                                    <br>
                                    ‚ñ∂ - Êí≠Êîæ<span class="highlight">‰∏ã‰∏ÄÈ¶ñ</span>Ê≠åÊõ≤
                                    ‚óÄ - Êí≠Êîæ<span class="highlight">‰∏ä‰∏ÄÈ¶ñ</span>Ê≠åÊõ≤
                                    <br>
                                    üìú Ê≠åÊõ≤ÂàóË°®-ÂèØ‰ª•Áî®Êù•Âø´Êç∑Âê¨Ê≠å
                                    <br>
                                    ‚è∏ - Êí≠ÊîæÁä∂ÊÄÅ | ‚ñ∂ - ÊöÇÂÅúÁä∂ÊÄÅ
                                    <br>
                                    üîÅ-ÂàóË°®È°∫Â∫èÊí≠Êîæ
                                    üîÑ-ÂàóË°®Âæ™ÁéØÊí≠Êîæ
                                    üîÇ-ÂçïÊõ≤Âæ™ÁéØÊí≠Êîæ
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
                
                <details class="changelog-item">
                    <summary>
                        <h4 class="changelog-version">
                            2025-12 | V1.0.6~1.1.0
                            <span class="version-tag">Á®≥ÂÆöÁâà</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">2025-12-20 | V1.1.0</span>
                                <span class="content">
                                    <span class="update-badge optimize">‰ºòÂåñ</span>
                                    ‰∏ªÈ°µÂä†ËΩΩÈÄüÂ∫¶
                                    <br>
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    Ê≠åÊõ≤ <span class="highlight">1</span> È¶ñ
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-14 | V1.0.9</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ÂÖâÈî•Ôºö<span class="highlight">Âø´‰πêÁöÑË∑Ø‰∏ÄÂ§© | Â∑°Áåé.Êö¥ÂáªÁâπÂåñ</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-12 | V1.0.8</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">Â§©ÂëΩ‰∫∫.Áå¥Âì• | ÁπÅËÇ≤.ÈáèÂ≠ê</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-07 | V1.0.7</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">Ê¢¶ | ËôöÊó†.È£é</span>
                                    <br>
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">Á•ûÂú£.ÁöÆÂì• | ‰∏∞È•∂.ËôöÊï∞</span>
                                    <br>
                                    <span class="update-badge optimize">‰ºòÂåñ</span>
                                    Èü≥‰πêÊí≠ÊîæÂô®Ê°ÜÊû∂‰øÆÊîπ
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-12-06 | V1.0.6</span>
                                <span class="content">
                                    <span class="update-badge optimize">‰ºòÂåñ</span>
                                    Êï¥‰ΩìËßíËâ≤Ê°ÜÊû∂
                                    <br>
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    Èü≥‰πêÊí≠ÊîæÂô®(ÁÆÄÊòìÂÆåÊï¥Áâà)
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
                
                <details class="changelog-item">
                    <summary>
                        <h4 class="changelog-version">
                            2025-11 | V1.0.0~1.0.5
                            <span class="version-tag">Á®≥ÂÆöÁâà</span>
                        </h4>
                    </summary>
                    <div class="changelog-content">
                        <ul class="update-list">
                            <li>
                                <span class="date">2025-11-30 | V1.0.5</span>
                                <span class="content">
                                    <span class="update-badge optimize">‰ºòÂåñ</span>
                                    Êï¥‰ΩìËßíËâ≤Ê°ÜÊû∂
                                    <br>
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">ÂçäÊ¢∞‰∫∫.Êàê | ÊØÅÁÅ≠.Áâ©ÁêÜ</span>
                                    <br>
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">Â§πÂ≠êÂßê | Êô∫ËØÜ.Èõ∑</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-16 | V1.0.4</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">Ê∂µ | ÂêåË∞ê.Áâ©ÁêÜ</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-15 | V1.0.3</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    Èü≥‰πêÊí≠ÊîæÂô®ÔºàÂçäÊàêÂìÅÔºâ
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-10 | V1.0.2</span>
                                <span class="content">
                                    <span class="update-badge">Êñ∞Â¢û</span>
                                    ËßíËâ≤Ôºö<span class="highlight">ÂÆáÊô∫Ê≥¢.Ë®Ä | ÊØÅÁÅ≠.Èõ∑</span>
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-11-09 | V1.0.1</span>
                                <span class="content">
                                    <span class="update-badge fix">‰øÆÂ§ç</span>
                                    ‰∫ëÁíÉËßíËâ≤Âç°ÁâáË∑≥ËΩ¨ÈîôËØØ
                                    <br>
                                    <span class="update-badge fix">‰øÆÂ§ç</span>
                                    ÂÖâÈî•ÂõæÁâáÊòæÁ§∫ÂºÇÂ∏∏ÈóÆÈ¢ò
                                </span>
                            </li>
                            <li>
                                <span class="date">2025-10-31 | V1.0.0</span>
                                <span class="content">
                                    <span class="update-badge">‰∏äÁ∫ø</span>
                                    ÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏äÁ∫ø
                                    <br>
                                    üéâ ÂåÖÂê´ËßíËâ≤„ÄÅÂÖâÈî•„ÄÅÂÖªÊàêÊùêÊñôÂü∫Á°ÄÊ®°Âùó
                                </span>
                            </li>
                        </ul>
                    </div>
                </details>
            </div>
        </div>
    </div>

<!-- ËØÑËÆ∫Á≥ªÁªü -->
<h2 class="section-header" id="comments">üí¨ Áî®Êà∑ËØÑËÆ∫</h2>
<div class="comments-system" id="commentsSection">
    <!-- ËØÑËÆ∫ÁªüËÆ° -->
    <div class="comments-stats">
        <div class="stats-container">
            <span class="stat-item">
                <i class="fas fa-comments"></i>
                ÊÄªËØÑËÆ∫Ôºö<span id="totalComments">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-users"></i>
                ÂèÇ‰∏éÁî®Êà∑Ôºö<span id="uniqueUsers">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-fire"></i>
                ÁÉ≠Èó®ËÆ®ËÆ∫Ôºö<span id="hotComments">0</span>
            </span>
            <span class="stat-item">
                <i class="fas fa-eye"></i>
                ‰ªäÊó•Ê¥ªË∑ÉÔºö<span id="todayActive">0</span>
            </span>
        </div>
    </div>

    <!-- ËØÑËÆ∫ÊéíÂ∫èÈÄâÈ°π -->
    <div class="comments-sort">
        <button class="sort-btn active" data-sort="newest">
            <i class="fas fa-clock"></i> ÊúÄÊñ∞
        </button>
        <button class="sort-btn" data-sort="hottest">
            <i class="fas fa-fire"></i> ÊúÄÁÉ≠
        </button>
        <button class="sort-btn" data-sort="oldest">
            <i class="fas fa-history"></i> ÊúÄÊó©
        </button>
        <button class="sort-btn" data-sort="pinned">
            <i class="fas fa-thumbtack"></i> ÁΩÆÈ°∂
        </button>
    </div>

    <!-- ÂèëË°®ËØÑËÆ∫Âå∫Âüü -->
    <div class="comment-form-container" id="commentFormContainer">
        <div class="comment-form-header">
            <div class="user-avatar-small">
                <div id="commentAvatarPlaceholder"></div>
            </div>
            <div class="form-header-text">
                <span id="commentFormTitle">ÂèëË°®ËØÑËÆ∫</span>
                <small>ÊñáÊòéÂèëË®ÄÔºåÈÅµÂÆàÁ§æÂå∫ËßÑËåÉ</small>
            </div>
            <div class="comment-format-help" onclick="toggleFormatHelp()">
                <i class="fas fa-question-circle"></i>
                <div class="format-help-tooltip" id="formatHelpTooltip">
                    <strong>Ê†ºÂºèÊîØÊåÅÔºö</strong><br>
                    **Á≤ó‰Ωì** ‚Üí <strong>Á≤ó‰Ωì</strong><br>
                    *Êñú‰Ωì* ‚Üí <em>Êñú‰Ωì</em><br>
                    `‰ª£Á†Å` ‚Üí <code>‰ª£Á†Å</code><br>
                    [ÈìæÊé•](url) ‚Üí Ë∂ÖÈìæÊé•<br>
                    ![ÂõæÁâá](url) ‚Üí ÊòæÁ§∫ÂõæÁâá
                </div>
            </div>
        </div>
        
        <div class="comment-editor">
            <textarea 
                id="commentInput" 
                placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï...ÔºàÊîØÊåÅMarkdownÊ†ºÂºèÔºâ" 
                maxlength="1000"
                rows="4"
                oninput="autoResizeTextarea(this)"
            ></textarea>
            
            <div class="editor-tools">
                <div class="tools-left">
                    <button class="tool-btn" title="Ë°®ÊÉÖ" onclick="toggleEmojiPicker()">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="tool-btn" title="ÊèíÂÖ•ÂõæÁâá" onclick="openImageUpload()">
                        <i class="far fa-image"></i>
                    </button>
                    <button class="tool-btn" title="Âä†Á≤ó" onclick="formatText('bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="tool-btn" title="Êñú‰Ωì" onclick="formatText('italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="tool-btn" title="ÈìæÊé•" onclick="formatText('link')">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="tool-btn" title="‰ª£Á†Å" onclick="formatText('code')">
                        <i class="fas fa-code"></i>
                    </button>
                </div>
                <div class="tools-right">
                    <span class="char-count">
                        <span id="charCount">0</span>/1000
                    </span>
                    <button 
                        class="btn-submit" 
                        id="submitCommentBtn"
                        onclick="submitComment()"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                        ÂèëÂ∏ÉËØÑËÆ∫
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ÂõæÁâá‰∏ä‰º†ËøõÂ∫¶ -->
        <div class="upload-progress" id="uploadProgress">
            <div class="progress-bar" id="progressBar"></div>
            <span id="progressText">0%</span>
        </div>
        
        <!-- ÂõæÁâáÈ¢ÑËßà -->
        <div class="image-preview" id="imagePreview">
            <button class="remove-image" onclick="removePreviewImage()">
                <i class="fas fa-times"></i>
            </button>
            <img id="previewImage" src="" alt="È¢ÑËßàÂõæÁâá">
        </div>
        
        <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header">
                <span>Ë°®ÊÉÖÈÄâÊã©</span>
                <button class="close-emoji" onclick="toggleEmojiPicker()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="emoji-categories">
                <button class="emoji-category active" data-category="smileys">üòÄ</button>
                <button class="emoji-category" data-category="animals">üê±</button>
                <button class="emoji-category" data-category="food">üçé</button>
                <button class="emoji-category" data-category="objects">üéÆ</button>
                <button class="emoji-category" data-category="symbols">‚ù§Ô∏è</button>
            </div>
            <div class="emoji-search">
                <input type="text" id="emojiSearch" placeholder="ÊêúÁ¥¢Ë°®ÊÉÖ..." oninput="searchEmoji(this.value)">
                <i class="fas fa-search"></i>
            </div>
            <div class="emoji-grid" id="emojiGrid">
                <!-- Ë°®ÊÉÖ‰ºöÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </div>
        </div>
    </div>

    <!-- ËØÑËÆ∫ËøáÊª§ -->
    <div class="comment-filters">
        <div class="filter-group">
            <label>
                <input type="checkbox" id="filterPinned" checked onchange="filterComments()">
                ÊòæÁ§∫ÁΩÆÈ°∂
            </label>
            <label>
                <input type="checkbox" id="filterWithImages" onchange="filterComments()">
                ‰ªÖÊòæÁ§∫Â∏¶ÂõæËØÑËÆ∫
            </label>
        </div>
        <div class="filter-search">
            <input 
                type="text" 
                id="commentSearch" 
                placeholder="ÊêúÁ¥¢ËØÑËÆ∫ÂÜÖÂÆπ..." 
                oninput="searchComments(this.value)"
            >
            <i class="fas fa-search"></i>
        </div>
    </div>

    <!-- ËØÑËÆ∫ÂàóË°® -->
    <div class="comments-list" id="commentsList">
        <div class="loading-comments">
            <div class="spinner"></div>
            <p>Âä†ËΩΩËØÑËÆ∫‰∏≠...</p>
        </div>
    </div>

    <!-- ËØÑËÆ∫ÂàÜÈ°µ -->
    <div class="comments-pagination" id="commentsPagination">
        <button class="page-btn" onclick="loadPrevPage()" disabled>
            <i class="fas fa-chevron-left"></i> ‰∏ä‰∏ÄÈ°µ
        </button>
        <div class="page-info">
            Á¨¨ <span id="currentPage">1</span> È°µ / ÂÖ± <span id="totalPages">1</span> È°µ
        </div>
        <div class="page-size">
            <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                <option value="10">10Êù°/È°µ</option>
                <option value="20">20Êù°/È°µ</option>
                <option value="30">30Êù°/È°µ</option>
                <option value="50">50Êù°/È°µ</option>
            </select>
        </div>
        <button class="page-btn" onclick="loadNextPage()" disabled>
            ‰∏ã‰∏ÄÈ°µ <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- ÂõûÂà∞ËØÑËÆ∫È°∂ÈÉ® -->
    <button class="back-to-comments-top" onclick="scrollToCommentsTop()">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>

<!-- ‰∏æÊä•ÂØπËØùÊ°Ü -->
<div class="report-dialog" id="reportDialog">
    <div class="report-content">
        <div class="report-header">
            <h3>‰∏æÊä•ËØÑËÆ∫</h3>
            <button class="close-report" onclick="closeReportDialog()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="report-body">
            <p id="reportCommentContent"></p>
            <div class="report-reasons">
                <label>
                    <input type="radio" name="reportReason" value="spam" checked>
                    <span>ÂûÉÂúæÂπøÂëä</span>
                </label>
                <label>
                    <input type="radio" name="reportReason" value="offensive">
                    <span>‰∏çÂèãÂñÑÂÜÖÂÆπ</span>
                </label>
                <label>
                    <input type="radio" name="reportReason" value="illegal">
                    <span>ËøùÊ≥ï‰ø°ÊÅØ</span>
                </label>
                <label>
                    <input type="radio" name="reportReason" value="harassment">
                    <span>È™öÊâ∞‰ªñ‰∫∫</span>
                </label>
                <label>
                    <input type="radio" name="reportReason" value="other">
                    <span>ÂÖ∂‰ªñÂéüÂõ†</span>
                </label>
            </div>
            <textarea 
                id="reportDescription" 
                placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞‰∏æÊä•ÂéüÂõ†ÔºàÂèØÈÄâÔºâ"
                rows="3"
                maxlength="500"
            ></textarea>
        </div>
        <div class="report-footer">
            <button class="report-cancel" onclick="closeReportDialog()">ÂèñÊ∂à</button>
            <button class="report-submit" onclick="submitReport()">Êèê‰∫§‰∏æÊä•</button>
        </div>
    </div>
</div>

<!-- ËØÑËÆ∫ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
<div class="comment-detail-dialog" id="commentDetailDialog">
    <div class="detail-content">
        <div class="detail-header">
            <h3>ËØÑËÆ∫ËØ¶ÊÉÖ</h3>
            <button class="close-detail" onclick="closeCommentDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-body" id="detailBody">
            <!-- ËØ¶ÊÉÖÂÜÖÂÆπ‰ºöÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>
</div>

    <!-- È°µËÑö -->
    <footer>
        ¬© <span id="year"></span> ÂÖ≠Âì•Ëç£ËÄÄWIKI. Êú¨WIKIÁ∫ØÂ±ûËôöÊûÑÂ®±‰πê.
        <br>
        <span style="font-size: 0.8rem; color: #666;">Áî®Êà∑ËÆ§ËØÅÁî±SupabaseÊèê‰æõÊäÄÊúØÊîØÊåÅ</span>
    </footer>

    <!-- Èü≥‰πêÊí≠ÊîæÂô® -->
    <iframe 
        id="musicPlayerIframe"
        src="music-player.html"
        frameborder="0"
        scrolling="no"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"
        title="Èü≥‰πêÊí≠ÊîæÂô®"
        aria-label="Èü≥‰πêÊí≠ÊîæÂô®"
    ></iframe>

    <!-- ÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ -->
    <button class="back-to-top" onclick="scrollToTop()" aria-label="ÂõûÂà∞È°∂ÈÉ®">‚Üë</button>

    <script>
        // ==================== 1. ÂÖ®Â±ÄÂèòÈáèÂÆö‰πâ ====================
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let searchTimeout;
        let supabaseClient = null;
        let currentUser = null;
        let userProfile = null; // Êñ∞Â¢ûÔºöÁî®Êà∑ËµÑÊñôÂèòÈáè
        
        // SupabaseÈÖçÁΩÆ
        const SUPABASE_URL = 'https://ysmijycsyzpjoieaknmb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzbWlqeWNzeXpwam9pZWFrbm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNDgzNjMsImV4cCI6MjA4MjgyNDM2M30.H7dx2k_0099LVXprMrghHOFh16OoSSgtCUOib2otHPA';
        
        // ==================== ËØÑËÆ∫Á≥ªÁªüÂÖ®Â±ÄÂèòÈáè ====================
        let commentCurrentPage = 1;
        let commentTotalPages = 1;
        let commentPageSize = 10;
        let commentCurrentSort = 'newest';
        let commentTotalCount = 0;
        let commentUniqueUsers = 0;
        let commentHotCount = 0;
        let commentTodayActive = 0;
        let currentCommentFilter = {
            pinned: true,
            withImages: false,
            searchQuery: ''
        };

        let replyToCommentId = null;
        let editingCommentId = null;
        let reportingCommentId = null;
        let uploadingImage = false;
        let imageUploadProgress = 0;

        // Ë°®ÊÉÖÊï∞ÊçÆ
        const emojiData = {
            smileys: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†'],
            animals: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','üêà','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêø','ü¶î'],
            food: ['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü´î','ü•ó','ü•ò','ü´ï','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','ü´ñ','‚òïÔ∏è','üçµ','üßÉ','ü•§','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßâ','üçæ','üßä','ü•Ñ','üç¥','üçΩ','ü•£','ü•°','ü•¢'],
            objects: ['‚åöÔ∏è','üì±','üì≤','üíª','‚å®Ô∏è','üñ•','üñ®','üñ±','üñ≤','üïπ','üóú','üíΩ','üíæ','üíø','üìÄ','üìº','üì∑','üì∏','üìπ','üé•','üìΩ','üéû','üìû','‚òéÔ∏è','üìü','üì†','üì∫','üìª','üéô','üéö','üéõ','üß≠','‚è±','‚è≤','‚è∞','üï∞','‚åõÔ∏è','‚è≥','üì°','üîã','üîå','üí°','üî¶','üïØ','ü™î','üßØ','üõ¢','üí∏','üíµ','üí¥','üí∂','üí∑','üí∞','üí≥','üíé','‚öñÔ∏è','üß∞','üîß','üî®','‚öí','üõ†','‚õè','üî©','‚öôÔ∏è','üß±','‚õì','üß≤','üî´','üí£','üß®','ü™ì','üî™','üó°','‚öîÔ∏è','üõ°','üö¨','‚ö∞Ô∏è','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥','ü©π','ü©∫','üíä','üíâ','ü©∏','üß¨','ü¶†','üß´','üß™','üå°','üßπ','üß∫','üßª','üöΩ','üö∞','üöø','üõÅ','üîë','üóù','üõã','üõè','üõå','üß∏','üñº','üõç','üõí','üéÅ','üéà','üéè','üéÄ','üéä','üéâ','üß®','üéé','üèÆ','üéê','‚úâÔ∏è','üì©','üì®','üìß','üíå','üì•','üì§','üì¶','üè∑','üì™','üì´','üì¨','üì≠','üìÆ','üìØ','üìú','üìÉ','üìÑ','üìë','üßæ','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üóë','üìá','üóÉ','üó≥','üóÑ','üìã','üìÅ','üìÇ','üóÇ','üóû','üì∞','üìì','üìî','üìí','üìï','üìó','üìò','üìô','üìö','üìñ','üîñ','üß∑','üîó','üìé','üñá','üìê','üìè','üßÆ','üìå','üìç','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üñå','üñç','üìù','‚úèÔ∏è','üîç','üîé','üîè','üîê','üîí','üîì'],
            symbols: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâ','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôàÔ∏è','‚ôâÔ∏è','‚ôäÔ∏è','‚ôãÔ∏è','‚ôåÔ∏è','‚ôçÔ∏è','‚ôéÔ∏è','‚ôèÔ∏è','‚ôêÔ∏è','‚ôëÔ∏è','‚ôíÔ∏è','‚ôìÔ∏è','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàöÔ∏è','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ïÔ∏è','üõë','‚õîÔ∏è','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùóÔ∏è','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØÔ∏è','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôøÔ∏è','üÖøÔ∏è','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','‚öß','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî¢','#Ô∏è‚É£','*Ô∏è‚É£','‚èèÔ∏è','‚ñ∂Ô∏è','‚è∏','‚èØ','‚èπ','‚è∫','‚è≠','‚èÆ','‚è©','‚è™','‚è´','‚è¨','‚óÄÔ∏è','üîº','üîΩ','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','‚ÜôÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü™Ô∏è','‚Ü©Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÄ','üîÅ','üîÇ','üîÑ','üîÉ','üéµ','üé∂','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','„Ä∞Ô∏è','‚û∞','‚ûø','üîö','üîô','üîõ','üîù','üîú','‚úîÔ∏è','‚òëÔ∏è','üîò','üî¥','üü†','üü°','üü¢','üîµ','üü£','üü§','‚ö´Ô∏è','‚ö™Ô∏è','üü•','üüß','üü®','üü©','üü¶','üü™','üü´','‚¨õÔ∏è','‚¨úÔ∏è','‚óºÔ∏è','‚óªÔ∏è','‚óæÔ∏è','‚óΩÔ∏è','‚ñ™Ô∏è','‚ñ´Ô∏è','üî∂','üî∑','üî∏','üîπ','üî∫','üîª','üí†','üîò','üî≥','üî≤']
        };

        // ==================== ËæÖÂä©ÂáΩÊï∞ ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'ÂàöÂàö';
            if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
            if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
            if (diffDays < 7) return `${diffDays}Â§©Ââç`;
            return date.toLocaleDateString('zh-CN');
        }

        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        // ==================== È°µÈù¢ÂàùÂßãÂåñÂáΩÊï∞ ====================
        async function initializePage() {
            console.log('È°µÈù¢ÂºÄÂßãÂàùÂßãÂåñ...');
            
            // Êõ¥Êñ∞Âä†ËΩΩËøõÂ∫¶
            updateLoadingProgress(30);
            
            // ÂàùÂßãÂåñÂπ¥‰ªΩ
            document.getElementById('year').textContent = new Date().getFullYear();
            updateLoadingProgress(40);
            
            // ÂàùÂßãÂåñÁΩëÁ´ôËøêË°åÂ§©Êï∞
            initializeSiteAge();
            updateLoadingProgress(50);
            
            // ÂàùÂßãÂåñSupabase
            await initializeSupabase();
            updateLoadingProgress(60);
            
            // ÂàùÂßãÂåñÊêúÁ¥¢ÂäüËÉΩ
            initializeSearch();
            updateLoadingProgress(70);
            
            // ÂàùÂßãÂåñÂØºËà™ÂäüËÉΩ
            initializeNavigation();
            updateLoadingProgress(80);
            
            // ÂàùÂßãÂåñÂõæÁâáÊáíÂä†ËΩΩ
            initializeLazyLoad();
            updateLoadingProgress(90);
            
            // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
            restoreScrollPosition();
            updateLoadingProgress(95);
            
            // ÂàùÂßãÂåñÁî®Êà∑Áä∂ÊÄÅ
            await updateUserUI();
            updateLoadingProgress(97);
            
            // Ê∑ªÂä†Êî∂ËóèÊåâÈíÆÂà∞Âç°Áâá
            addFavoriteButtons();
            
            // ÂàùÂßãÂåñÈü≥‰πêÊí≠ÊîæÂô®
            initializeMusicPlayer();
            updateLoadingProgress(98);
            
            // ÂàùÂßãÂåñÊõ¥Êñ∞Êó•ÂøóÂäüËÉΩ
            initializeChangelogFunctions();
            updateLoadingProgress(99);
            
            // ÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªüÔºàÂª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Â∞±Áª™Ôºâ
            setTimeout(async () => {
                if (document.getElementById('commentsSection')) {
                    await initializeCommentSystem();
                }
            }, 500);
            
            updateLoadingProgress(99.5);
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàê
            setTimeout(() => {
                updateLoadingProgress(100);
                hideLoading();
                showNotification('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºÅ', 'success');
                console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
            }, 300);
        }
        
        // ==================== DOMÂä†ËΩΩÂÆåÊàêÂêéÊâßË°å ====================
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // ==================== Âä†ËΩΩËøõÂ∫¶Êù°ÊéßÂà∂ ====================
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingProgress');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
        }
        
        // ==================== ÂõæÁâáÂ§ÑÁêÜÂáΩÊï∞ ====================
        function imageLoaded(img) {
            img.classList.add('loaded');
            const parent = img.closest('.skeleton');
            if (parent) {
                parent.classList.remove('skeleton');
            }
        }
        
        function imageError(img) {
            // ÂàõÂª∫ÁÆÄÂçïÁöÑÂç†‰ΩçÂõæ
            const placeholder = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${img.width || 150}" height="${img.height || 188}" viewBox="0 0 ${img.width || 150} ${img.height || 188}"><rect width="100%" height="100%" fill="%232d5243"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%2381c784" font-family="sans-serif">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</text></svg>`;
            img.src = placeholder;
            img.alt = 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';
            const parent = img.closest('.skeleton');
            if (parent) {
                parent.classList.remove('skeleton');
            }
        }
        
        // ==================== ÁΩëÁ´ôËøêË°åÂ§©Êï∞ÂäüËÉΩ ====================
        function initializeSiteAge() {
            const launchDate = new Date(2025, 10, 1); // 2025Âπ¥11Êúà1Êó•
            const siteAgeElem = document.getElementById('site-age');
            
            const specialDays = {
                30: 'üéâ ÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏äÁ∫ø30Â§©Âï¶ÔºÅÊÑüÊÅ©Èô™‰º¥ üéâ',
                50: '‚õÑÂÜ¨Ëá≥Âø´‰πêÔºåËÆ∞ÂæóÂêÉÈ•∫Â≠êü•ü‚õÑ',
                58: 'üç∞ ÊÅ≠ÂñúË®ÄÂì•Âì•18Â≤ÅÔºåÁîüÊó•Âø´‰πêüç∞',
                59: ' üß®Ë∑®Âπ¥ÂÄíËÆ°Êó∂2Â§©üß®',
                60: ' üéâË∑®Âπ¥ÂÄíËÆ°Êó∂1Â§©üéâ',
                61: ' üéâÊ¨¢ËøéÊù•Âà∞2026Âπ¥üéâ',
                78: '‚òÅÔ∏è Â•áÊÄ™ÁöÑÊï∞Â≠óÔºüÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏é‰Ω†ÂêåË°å78Â§© ‚òÅÔ∏è',
                91: 'üßä Â•áÊÄ™ÁöÑÊï∞Â≠óÔºüÊ¢ÖÂºÄ‰∫åÂ∫¶ÔºåÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏é‰Ω†ÂêåË°å91Â§© üßä',
                100: 'üéä ÁôæÊó•Â∫ÜÂÖ∏ÔºÅÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏é‰Ω†ÂêåË°å100Â§© üéä',
                365: 'üéÇ Âë®Âπ¥Âø´‰πêÔºÅÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏ÄÂë®Âπ¥Á∫™Âøµ üéÇ'
            };
            
            function updateSiteAge() {
                const today = new Date();
                const days = Math.floor((today - launchDate) / (1000 * 60 * 60 * 24));
                
                if (specialDays[days]) {
                    siteAgeElem.innerHTML = specialDays[days];
                    siteAgeElem.classList.add('special');
                } else {
                    siteAgeElem.innerHTML = `üìÖ ÂÖ≠Âì•Ëç£ËÄÄWIKIÂ∑≤‰∏äÁ∫ø ${days} Â§© ¬∑ ÊåÅÁª≠Êõ¥Êñ∞‰∏≠`;
                    siteAgeElem.classList.remove('special');
                }
            }
            
            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updateSiteAge();
            
            // ÊØèÂ§©Êõ¥Êñ∞‰∏ÄÊ¨°
            setInterval(updateSiteAge, 86400000); // 24Â∞èÊó∂
        }
        
        // ==================== ÊêúÁ¥¢ÂäüËÉΩ ====================
        function initializeSearch() {
            const searchInput = document.getElementById('search-input');
            const searchHistoryElem = document.getElementById('searchHistory');
            const clearHistoryBtn = document.getElementById('clearHistory');
            const allCards = document.querySelectorAll('.content-card');
            const emptyResult = document.querySelector('.empty-result');
            const gridContainers = document.querySelectorAll('.grid-container');
            
            // Ê∏≤ÊüìÊêúÁ¥¢ÂéÜÂè≤
            function renderSearchHistory() {
                if (searchHistory.length === 0) {
                    searchHistoryElem.innerHTML = '<div class="history-item" style="color: var(--text-secondary);">ÊöÇÊó†ÊêúÁ¥¢ÂéÜÂè≤</div>';
                    return;
                }
                
                searchHistoryElem.innerHTML = '';
                
                // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
                searchHistory.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.textContent = item;
                    historyItem.addEventListener('click', () => {
                        searchInput.value = item;
                        performSearch(item);
                        searchHistoryElem.classList.remove('show');
                    });
                    searchHistoryElem.appendChild(historyItem);
                });
                
                // Ê∑ªÂä†Ê∏ÖÁ©∫ÊåâÈíÆ
                const clearBtn = document.createElement('div');
                clearBtn.className = 'history-clear';
                clearBtn.textContent = 'Ê∏ÖÁ©∫ÊêúÁ¥¢ÂéÜÂè≤';
                clearBtn.addEventListener('click', () => {
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊêúÁ¥¢ÂéÜÂè≤ÂêóÔºü')) {
                        searchHistory = [];
                        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                        renderSearchHistory();
                        showNotification('ÊêúÁ¥¢ÂéÜÂè≤Â∑≤Ê∏ÖÁ©∫', 'success');
                    }
                });
                searchHistoryElem.appendChild(clearBtn);
            }
            
            // ÊâßË°åÊêúÁ¥¢
            function performSearch(keyword) {
                let matchCount = 0;
                
                // Â¶ÇÊûúÊ≤°ÊúâÂÖ≥ÈîÆËØçÔºåÊòæÁ§∫ÊâÄÊúâÂç°Áâá
                if (!keyword) {
                    allCards.forEach(card => card.style.display = 'block');
                    gridContainers.forEach(container => container.style.display = 'grid');
                    emptyResult.style.display = 'none';
                    return;
                }
                
                // ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
                if (keyword && !searchHistory.includes(keyword)) {
                    searchHistory.unshift(keyword);
                    if (searchHistory.length > 10) searchHistory.pop();
                    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                    renderSearchHistory();
                }
                
                // ÊêúÁ¥¢ÂåπÈÖçÈÄªËæë
                allCards.forEach(card => {
                    const name = card.dataset.name?.toLowerCase() || '';
                    const desc = card.dataset.desc?.toLowerCase() || '';
                    const type = card.dataset.type?.toLowerCase() || '';
                    
                    const isMatch = name.includes(keyword) || 
                                   desc.includes(keyword) || 
                                   type.includes(keyword);
                    
                    card.style.display = isMatch ? 'block' : 'none';
                    if (isMatch) matchCount++;
                });
                
                // ÊòæÁ§∫Á©∫ÁªìÊûúÊèêÁ§∫
                emptyResult.style.display = matchCount === 0 ? 'block' : 'none';
                
                // ÈöêËóèÁ©∫ÁöÑÁΩëÊ†ºÂÆπÂô®
                gridContainers.forEach(container => {
                    const visibleCards = Array.from(container.querySelectorAll('.content-card'))
                        .some(card => card.style.display === 'block');
                    container.style.display = visibleCards ? 'grid' : 'none';
                });
            }
            
            // Èò≤ÊäñÂáΩÊï∞
            function debounce(func, delay) {
                return function() {
                    clearTimeout(searchTimeout);
                    const context = this;
                    const args = arguments;
                    searchTimeout = setTimeout(() => func.apply(context, args), delay);
                };
            }
            
            // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
            // Ê∏≤ÊüìÊêúÁ¥¢ÂéÜÂè≤
            renderSearchHistory();
            
            // ÊêúÁ¥¢Ê°ÜÁÑ¶ÁÇπ‰∫ã‰ª∂
            searchInput.addEventListener('focus', () => {
                if (searchHistory.length > 0) {
                    searchHistoryElem.classList.add('show');
                }
            });
            
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÊêúÁ¥¢ÂéÜÂè≤
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchHistoryElem.contains(e.target)) {
                    searchHistoryElem.classList.remove('show');
                }
            });
            
            // ÊêúÁ¥¢ËæìÂÖ•‰∫ã‰ª∂ÔºàÈò≤ÊäñÔºâ
            searchInput.addEventListener('input', debounce(function() {
                performSearch(this.value.trim().toLowerCase());
            }, 200));
        }
        
        // ==================== ÂØºËà™ÂíåÊªöÂä®ÂäüËÉΩ ====================
        function initializeNavigation() {
            const backToTopBtn = document.querySelector('.back-to-top');
            const navLinks = document.querySelectorAll('.nav-link');
            
            // ÂõûÂà∞È°∂ÈÉ®ÂäüËÉΩ
            window.scrollToTop = function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            
            // ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨
            window.addEventListener('scroll', function() {
                // ÊòæÁ§∫/ÈöêËóèÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
                
                // Êõ¥Êñ∞ÂØºËà™ÊøÄÊ¥ªÁä∂ÊÄÅ
                const sections = document.querySelectorAll('.section-header');
                let currentSection = '';
                
                sections.forEach(section => {
                    const sectionTop = section.offsetTop - 150;
                    if (window.scrollY >= sectionTop) {
                        currentSection = section.id;
                    }
                });
                
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.target === currentSection);
                });
            });
            
            // ÈîöÁÇπÂπ≥ÊªëÊªöÂä®
            navLinks.forEach(link => {
                if (link.getAttribute('href').startsWith('#')) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href').substring(1);
                        const target = document.getElementById(targetId);
                        if (target) {
                            const playerHeight = document.getElementById('musicPlayerIframe').offsetHeight || 110;
                            const targetPosition = target.offsetTop - 80 - playerHeight;
                            
                            window.scrollTo({
                                top: targetPosition,
                                behavior: 'smooth'
                            });
                            
                            // Êõ¥Êñ∞URLÂìàÂ∏å
                            history.pushState(null, null, `#${targetId}`);
                        }
                    });
                }
            });
            
            // ËßíËâ≤Ë∑≥ËΩ¨ÂáΩÊï∞
            window.jumpToDetail = function(targetUrl, charName) {
                if (!targetUrl) {
                    showNotification('ËØ¶ÊÉÖÈ°µÂú∞ÂùÄ‰∏çÂ≠òÂú®', 'error');
                    return;
                }
                
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: var(--card-bg); padding: 16px 24px; border-radius: var(--radius);
                    z-index: 999999; color: var(--text-highlight); display: flex; align-items: center; gap: 8px;
                    box-shadow: var(--shadow); border: 1px solid var(--border-color);
                `;
                loadingDiv.innerHTML = `<span class="loading-spinner" style="width: 20px; height: 20px;"></span> ÂâçÂæÄ„Äê${charName}„ÄëËØ¶ÊÉÖÈ°µ...`;
                document.body.appendChild(loadingDiv);
                
                setTimeout(() => {
                    window.location.href = targetUrl;
                }, 300);
            };
        }
        
        // ==================== ÂõæÁâáÊáíÂä†ËΩΩ ====================
        function initializeLazyLoad() {
            const images = document.querySelectorAll('img[loading="lazy"]');
            
            // ‰ΩøÁî®IntersectionObserverÂÆûÁé∞ÊáíÂä†ËΩΩ
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            // Â¶ÇÊûúÊúâdata-srcÂ±ûÊÄßÔºåÂàôÂä†ËΩΩÁúüÂÆûÂõæÁâá
                            if (img.dataset.src && img.dataset.src !== img.src) {
                                img.src = img.dataset.src;
                            }
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => {
                    // Â¶ÇÊûúÂõæÁâáËøòÊ≤°ÊúâsrcÔºåËÆæÁΩÆdata-src
                    if (!img.src && img.dataset.src) {
                        imageObserver.observe(img);
                    }
                });
            }
        }
        
        // ==================== ÊªöÂä®‰ΩçÁΩÆËÆ∞ÂøÜ ====================
        function saveScrollPosition() {
            sessionStorage.setItem('scrollPos', window.scrollY);
        }
        
        function restoreScrollPosition() {
            const savedPos = sessionStorage.getItem('scrollPos');
            if (savedPos) {
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedPos));
                    sessionStorage.removeItem('scrollPos');
                }, 100);
            }
        }
        
        window.addEventListener('beforeunload', saveScrollPosition);
        
        // ==================== SupabaseÂàùÂßãÂåñ ====================
        async function initializeSupabase() {
            try {
                console.log('ÂàùÂßãÂåñSupabase...');
                
                // ÂàõÂª∫SupabaseÂÆ¢Êà∑Á´Ø
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                    return false;
                }
                
                if (user) {
                    currentUser = user;
                    console.log('ÂΩìÂâçÁî®Êà∑:', user.email);
                    
                    // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞Êú¨Âú∞Â≠òÂÇ®
                    localStorage.setItem('user', JSON.stringify({
                        email: user.email,
                        id: user.id,
                        username: user.user_metadata?.username || user.email.split('@')[0],
                        avatarLetter: (user.user_metadata?.username || user.email.split('@')[0]).charAt(0).toUpperCase(),
                        isLoggedIn: true
                    }));
                    
                    // ‰ªéSupabaseÂä†ËΩΩÊî∂Ëóè
                    await loadFavoritesFromSupabase();
                    
                    // ÂàõÂª∫ÊàñÊõ¥Êñ∞Áî®Êà∑ËµÑÊñô
                    await upsertUserProfile();
                    
                } else {
                    console.log('Ê≤°ÊúâÁî®Êà∑ÁôªÂΩï');
                    localStorage.removeItem('user');
                }
                
                // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ:', event);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        showNotification(`Ê¨¢ËøéÂõûÊù•Ôºå${session.user.email}!`, 'success');
                        
                        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
                        localStorage.setItem('user', JSON.stringify({
                            email: session.user.email,
                            id: session.user.id,
                            username: session.user.user_metadata?.username || session.user.email.split('@')[0],
                            avatarLetter: (session.user.user_metadata?.username || session.user.email.split('@')[0]).charAt(0).toUpperCase(),
                            isLoggedIn: true
                        }));
                        
                        // Êõ¥Êñ∞UI
                        updateUserUI();
                        
                        // ÈáçÊñ∞Ê∑ªÂä†Êî∂ËóèÊåâÈíÆ
                        addFavoriteButtons();
                        
                        // ÈáçÊñ∞Âä†ËΩΩÊî∂Ëóè
                        loadFavoritesFromSupabase();
                        
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        localStorage.removeItem('user');
                        showNotification('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'info');
                        
                        // Êõ¥Êñ∞UI
                        updateUserUI();
                        
                        // ÈáçÊñ∞Ê∑ªÂä†Êî∂ËóèÊåâÈíÆÔºàÊÅ¢Â§çÊú™ÁôªÂΩïÁä∂ÊÄÅÔºâ
                        addFavoriteButtons();
                        
                        // Â¶ÇÊûúÊòØ‰ªéÁôªÂΩïÈ°µË∑≥ËΩ¨ËøáÊù•ÁöÑÔºåÂ∞±‰∏çÂà∑Êñ∞È°µÈù¢
                        if (!window.location.href.includes('login-real.html')) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    }
                });
                
                return true;
            } catch (error) {
                console.error('SupabaseÂàùÂßãÂåñÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ==================== Áî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ ====================
        async function updateUserUI() {
            const userNavSection = document.getElementById('userNavSection');
            
            if (currentUser) {
                // Áî®Êà∑Â∑≤ÁôªÂΩï
                // Ëé∑ÂèñÁî®Êà∑ËµÑÊñô
                userProfile = await getUserProfile(currentUser.id);
                
                const username = userProfile?.username || currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                const avatarLetter = username.charAt(0).toUpperCase();
                
                // Êõ¥Êñ∞ÂØºËà™Ê†è
                userNavSection.innerHTML = `
                    <div class="user-info-container">
                        <div class="user-avatar" title="${username}">${avatarLetter}</div>
                        <span class="username">${username}</span>
                        <button class="logout-btn" onclick="logoutUser()">ÈÄÄÂá∫</button>
                    </div>
                `;
                
            } else {
                // Áî®Êà∑Êú™ÁôªÂΩï
                // Êõ¥Êñ∞ÂØºËà™Ê†è‰∏∫ÁôªÂΩïÈìæÊé•
                userNavSection.innerHTML = `
                    <a href="login-real.html" class="nav-link">ÁôªÂΩï/Ê≥®ÂÜå</a>
                `;
            }
        }
        
        // ==================== Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜ ====================
        async function getUserProfile(userId = currentUser?.id) {
            if (!userId) return null;
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                userProfile = data;
                return data;
                
            } catch (error) {
                console.error('Ëé∑ÂèñÁî®Êà∑ËµÑÊñôÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        async function upsertUserProfile() {
            if (!currentUser) return;
            
            try {
                const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        id: currentUser.id,
                        username: username,
                        bio: currentUser.user_metadata?.bio || 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°ÊúâÂÜô...',
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'id',
                        ignoreDuplicates: false
                    });
                
                if (error) throw error;
                
                console.log('Áî®Êà∑ËµÑÊñôÂ∑≤Êõ¥Êñ∞');
                
                // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁî®Êà∑ËµÑÊñô
                userProfile = await getUserProfile(currentUser.id);
                
            } catch (error) {
                console.error('Êõ¥Êñ∞Áî®Êà∑ËµÑÊñôÂ§±Ë¥•:', error);
            }
        }
        
        // ==================== Êî∂ËóèÂäüËÉΩÔºàSupabaseÁâàÔºâ ====================
        async function loadFavoritesFromSupabase() {
            if (!currentUser) {
                // Êú™ÁôªÂΩïÊó∂Ê∏ÖÁ©∫Êú¨Âú∞Êî∂ËóèÁä∂ÊÄÅ
                localStorage.removeItem('userFavorites');
                updateFavoriteButtons();
                return { characters: [], lightcones: [] };
            }
            
            try {
                const { data: favorites, error } = await supabaseClient
                    .from('user_favorites')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // ËΩ¨Êç¢‰∏∫Êú¨Âú∞Ê†ºÂºè
                const favoritesLocal = { characters: [], lightcones: [] };
                if (favorites) {
                    favorites.forEach(item => {
                        if (item.item_type === 'character') {
                            favoritesLocal.characters.push({
                                id: item.item_id,
                                name: item.item_name,
                                type: item.item_description,
                                image: item.item_image
                            });
                        } else if (item.item_type === 'lightcone') {
                            favoritesLocal.lightcones.push({
                                id: item.item_id,
                                name: item.item_name,
                                type: item.item_description,
                                image: item.item_image
                            });
                        }
                    });
                }
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®Ôºà‰Ωú‰∏∫ÁºìÂ≠òÔºâ
                localStorage.setItem('userFavorites', JSON.stringify(favoritesLocal));
                
                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                updateFavoriteButtons();
                
                // Êõ¥Êñ∞ÁªüËÆ°
                await updateUserStats();
                
                return favoritesLocal;
                
            } catch (error) {
                console.error('‰ªéSupabaseÂä†ËΩΩÊî∂ËóèÂ§±Ë¥•:', error);
                // Â§±Ë¥•Êó∂‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®‰Ωú‰∏∫ÂõûÈÄÄ
                return JSON.parse(localStorage.getItem('userFavorites') || '{"characters":[],"lightcones":[]}');
            }
        }
        
        async function toggleFavorite(type, id, name, desc, image) {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩïÂêé‰ΩøÁî®Êî∂ËóèÂäüËÉΩ', 'warning');
                setTimeout(() => {
                    window.location.href = 'login-real.html';
                }, 1500);
                return;
            }
            
            const button = event.target.closest('.favorite-btn');
            const wasFavorite = button.innerHTML === '‚ô•';
            
            try {
                if (wasFavorite) {
                    // ‰ªéSupabaseÂà†Èô§Êî∂Ëóè
                    const { error } = await supabaseClient
                        .from('user_favorites')
                        .delete()
                        .match({ 
                            user_id: currentUser.id, 
                            item_type: type, 
                            item_id: id 
                        });
                    
                    if (error) throw error;
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                    button.innerHTML = '‚ô°';
                    button.style.color = 'white';
                    showNotification(`Â∑≤ÂèñÊ∂àÊî∂Ëóè ${name}`, 'info');
                    
                } else {
                    // Ê∑ªÂä†Âà∞Supabase
                    const { data, error } = await supabaseClient
                        .from('user_favorites')
                        .insert({
                            user_id: currentUser.id,
                            item_type: type,
                            item_id: id,
                            item_name: name,
                            item_description: desc,
                            item_image: image || ''
                        })
                        .select()
                        .single();
                    
                    if (error) {
                        // Â¶ÇÊûúÊòØÂîØ‰∏ÄÁ∫¶ÊùüÂÜ≤Á™ÅÔºåËØ¥ÊòéÂ∑≤ÁªèÊî∂ËóèËøá
                        if (error.code === '23505') {
                            console.log('Â∑≤Êî∂ËóèÔºåÊó†ÈúÄÈáçÂ§çÊ∑ªÂä†');
                            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                            button.innerHTML = '‚ô•';
                            button.style.color = '#f87171';
                        } else {
                            throw error;
                        }
                    } else {
                        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                        button.innerHTML = '‚ô•';
                        button.style.color = '#f87171';
                        showNotification(`Â∑≤Êî∂Ëóè ${name}`, 'success');
                    }
                }
                
                // Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
                await updateUserStats();
                
                // ÈáçÊñ∞Âä†ËΩΩÊî∂ËóèÂàóË°®
                await loadFavoritesFromSupabase();
                
            } catch (error) {
                console.error('Êìç‰ΩúÊî∂ËóèÂ§±Ë¥•:', error);
                showNotification(`Êìç‰ΩúÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        async function updateUserStats() {
            if (!currentUser) return;
            
            try {
                // Ë∞ÉÁî®Â≠òÂÇ®ËøáÁ®ãÊõ¥Êñ∞ÁªüËÆ°
                const { data, error } = await supabaseClient.rpc('update_user_stats', {
                    user_uuid: currentUser.id
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°Â§±Ë¥•:', error);
            }
        }
        
        // ==================== Êî∂ËóèÊåâÈíÆÁÆ°ÁêÜ ====================
        function addFavoriteButtons() {
            const cards = document.querySelectorAll('.content-card');
            
            cards.forEach(card => {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÊî∂ËóèÊåâÈíÆ
                if (!card.querySelector('.favorite-btn')) {
                    const favoriteBtn = document.createElement('button');
                    favoriteBtn.className = 'favorite-btn';
                    favoriteBtn.innerHTML = '‚ô°';
                    favoriteBtn.setAttribute('aria-label', 'Êî∂Ëóè');
                    favoriteBtn.setAttribute('title', 'ÁÇπÂáªÊî∂Ëóè');
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    favoriteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Èò≤Ê≠¢Ëß¶ÂèëÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂
                        
                        const type = card.dataset.type === 'ËßíËâ≤' ? 'character' : 'lightcone';
                        const id = card.dataset.name;
                        const name = card.dataset.name;
                        const desc = card.dataset.desc;
                        const image = card.querySelector('img')?.src || '';
                        
                        toggleFavorite(type, id, name, desc, image);
                    });
                    
                    card.appendChild(favoriteBtn);
                }
            });
            
            // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
            updateFavoriteButtons();
        }
        
        function updateFavoriteButtons() {
            const favorites = JSON.parse(localStorage.getItem('userFavorites') || '{"characters":[],"lightcones":[]}');
            const buttons = document.querySelectorAll('.favorite-btn');
            
            buttons.forEach(button => {
                const card = button.closest('.content-card');
                const type = card.dataset.type === 'ËßíËâ≤' ? 'character' : 'lightcone';
                const id = card.dataset.name;
                const key = type + 's'; // characters Êàñ lightcones
                
                const isFavorite = favorites[key]?.some(item => item.id === id);
                
                if (isFavorite) {
                    button.innerHTML = '‚ô•';
                    button.style.color = '#f87171';
                } else {
                    button.innerHTML = '‚ô°';
                    button.style.color = 'white';
                }
            });
        }
        
        // ==================== ÈÄÄÂá∫ÁôªÂΩïÂáΩÊï∞ ====================
        async function logoutUser() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                try {
                    if (supabaseClient) {
                        const { error } = await supabaseClient.auth.signOut();
                        if (error) throw error;
                    }
                    
                    currentUser = null;
                    userProfile = null;
                    localStorage.removeItem('user');
                    
                    showNotification('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'success');
                    
                    // Êõ¥Êñ∞UI
                    updateUserUI();
                    
                    // Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
                    updateFavoriteButtons();
                    
                } catch (error) {
                    console.error('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error);
                    showNotification('ÈÄÄÂá∫Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                }
            }
        }
        
        // ==================== ÈÄöÁü•Á≥ªÁªü ====================
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ==================== ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ ====================
        window.addEventListener('error', function(e) {
            console.error('È°µÈù¢ÈîôËØØ:', e.error);
            showNotification('È°µÈù¢Âá∫Áé∞ÈîôËØØÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:', e.reason);
            showNotification('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        });
        
        // ==================== ÈöêËóèÂä†ËΩΩÂä®Áîª ====================
        function hideLoading() {
            const loading = document.getElementById('global-loading');
            const progress = document.getElementById('loadingProgress');
            
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 500);
            }
            
            if (progress) {
                progress.style.opacity = '0';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 500);
            }
        }
        
        // Âº∫Âà∂3ÁßíÂêéÈöêËóèÂä†ËΩΩÂä®ÁîªÔºàÂÖúÂ∫ïÔºâ
        setTimeout(hideLoading, 3000);
        
        // ==================== Èü≥‰πêÊí≠ÊîæÂô®‰ºòÂåñ ====================
        function initializeMusicPlayer() {
            const iframe = document.getElementById('musicPlayerIframe');
            
            // ËÆæÁΩÆÂàùÂßãÈ´òÂ∫¶
            iframe.style.height = '110px';
            
            // ÁõëÂê¨Èü≥‰πêÊí≠ÊîæÂô®Áä∂ÊÄÅÂèòÂåñ
            window.addEventListener('message', (e) => {
                if (e.data?.type === 'SONG_LIST_TOGGLED') {
                    iframe.style.height = e.data.isShow ? '400px' : '110px';
                }
            });
        }
        
        // ==================== Êõ¥Êñ∞Êó•ÂøóÂäüËÉΩ ====================
        function initializeChangelogFunctions() {
            // È´ò‰∫ÆÂΩìÂâçÂπ¥‰ªΩÁöÑÊõ¥Êñ∞
            function highlightCurrentYearUpdates() {
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth() + 1;
                
                document.querySelectorAll('.changelog-version').forEach(title => {
                    if (title.textContent.includes(`${currentYear}`)) {
                        title.style.color = 'var(--special-color)';
                        
                        // Â¶ÇÊûúÊòØÂΩìÂâçÊúà‰ªΩÁöÑÊõ¥Êñ∞ÔºåÊ∑ªÂä†ÁâπÊÆäÊ†áËÆ∞
                        const currentMonthStr = currentMonth < 10 ? `0${currentMonth}` : `${currentMonth}`;
                        if (title.textContent.includes(`-${currentMonthStr}-`)) {
                            title.innerHTML += ' <span style="animation: flash 1s infinite alternate;">‚ú®</span>';
                        }
                    }
                });
            }
            
            // ÂàáÊç¢ÊâÄÊúâÊõ¥Êñ∞Êó•ÂøóÁöÑÂ±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
            window.toggleAllChangelogs = function() {
                const changelogs = document.querySelectorAll('.changelog-item');
                const controlBtn = document.querySelector('.control-btn span:first-child');
                const icon = document.querySelector('.control-btn .icon');
                
                const allOpen = Array.from(changelogs).every(item => item.open);
                
                changelogs.forEach(item => {
                    item.open = !allOpen;
                });
                
                if (allOpen) {
                    controlBtn.textContent = 'Â±ïÂºÄÂÖ®ÈÉ®';
                    icon.textContent = '‚ñº';
                    showNotification('Â∑≤Êî∂Ëµ∑ÊâÄÊúâÊõ¥Êñ∞ËÆ∞ÂΩï', 'success');
                } else {
                    controlBtn.textContent = 'Êî∂Ëµ∑ÂÖ®ÈÉ®';
                    icon.textContent = '‚ñ≤';
                    showNotification('Â∑≤Â±ïÂºÄÊâÄÊúâÊõ¥Êñ∞ËÆ∞ÂΩï', 'success');
                }
            };
            
            // Â§çÂà∂Êõ¥Êñ∞Êó•ÂøóÂÜÖÂÆπ
            window.copyChangelog = function() {
                const changelogContent = document.querySelector('.changelog-list');
                const text = changelogContent.innerText;
                
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Êõ¥Êñ∞ËÆ∞ÂΩïÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                }).catch(err => {
                    console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©ÊñáÊú¨Â§çÂà∂', 'error');
                });
            };
            
            // ÊâßË°åÈ´ò‰∫ÆÂäüËÉΩ
            highlightCurrentYearUpdates();
        }
        
        // ==================== ËØÑËÆ∫Á≥ªÁªüÂàùÂßãÂåñ ====================
        async function initializeCommentSystem() {
            console.log('ÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªü...');
            
            try {
                // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
                if (!currentUser) {
                    showLoginPrompt();
                } else {
                    updateCommentFormAvatar();
                }
                
                // ÂàùÂßãÂåñË°®ÊÉÖÈÄâÊã©Âô®
                initializeEmojiPicker();
                
                // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
                setupCommentEventListeners();
                
                // Âä†ËΩΩËØÑËÆ∫ÁªüËÆ°Êï∞ÊçÆ
                await loadCommentStats();
                
                // Âä†ËΩΩËØÑËÆ∫ÂàóË°®
                await loadComments(commentCurrentPage, commentCurrentSort);
                
                // ËÆ¢ÈòÖÂÆûÊó∂Êõ¥Êñ∞
                subscribeToComments();
                
                // ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂
                setupCommentScrollEvents();
                
                // ËÆæÁΩÆÊéíÂ∫èÊåâÈíÆ
                setupSortButtons();
                
                console.log('ËØÑËÆ∫Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªüÂ§±Ë¥•:', error);
                showNotification('ËØÑËÆ∫Á≥ªÁªüÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'error');
            }
        }
        
        // ==================== ËØÑËÆ∫‰∫ã‰ª∂ÁõëÂê¨Âô® ====================
        function setupCommentEventListeners() {
            // ËØÑËÆ∫ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('input', handleCommentInput);
                commentInput.addEventListener('keydown', handleCommentKeydown);
            }
            
            // ÊéíÂ∫èÊåâÈíÆ‰∫ã‰ª∂
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', handleSortButtonClick);
            });
            
            // ËøáÊª§ÈÄâÈ°π‰∫ã‰ª∂
            document.getElementById('filterPinned')?.addEventListener('change', handleFilterChange);
            document.getElementById('filterWithImages')?.addEventListener('change', handleFilterChange);
            
            // ÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂
            const commentSearch = document.getElementById('commentSearch');
            if (commentSearch) {
                let searchTimeout;
                commentSearch.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentCommentFilter.searchQuery = e.target.value;
                        applyCommentFilters();
                    }, 300);
                });
            }
            
            // ÂÖ≥Èó≠Ë°®ÊÉÖÈÄâÊã©Âô®ÔºàÁÇπÂáªÂ§ñÈÉ®Ôºâ
            document.addEventListener('click', (e) => {
                const emojiPicker = document.getElementById('emojiPicker');
                if (emojiPicker && !emojiPicker.contains(e.target) && 
                    !e.target.closest('.tool-btn[title="Ë°®ÊÉÖ"]')) {
                    emojiPicker.classList.remove('show');
                }
            });
        }
        
        function setupSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // ÁßªÈô§ÊâÄÊúâÊøÄÊ¥ªÁä∂ÊÄÅ
                    document.querySelectorAll('.sort-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Ê∑ªÂä†ÂΩìÂâçÊøÄÊ¥ªÁä∂ÊÄÅ
                    this.classList.add('active');
                    
                    // Êõ¥Êñ∞ÊéíÂ∫èÊñπÂºè
                    const sortType = this.dataset.sort;
                    commentCurrentSort = sortType;
                    commentCurrentPage = 1;
                    
                    // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
                    loadComments(commentCurrentPage, commentCurrentSort);
                });
            });
        }
        
        // ==================== ËØÑËÆ∫ËæìÂÖ•Â§ÑÁêÜ ====================
        function handleCommentInput(e) {
            updateCharCount();
            validateCommentInput();
        }
        
        function handleCommentKeydown(e) {
            // Ctrl + Enter Êèê‰∫§ËØÑËÆ∫
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                submitComment();
            }
            
            // Esc ÈîÆÂèñÊ∂àÂõûÂ§ç
            if (e.key === 'Escape' && replyToCommentId) {
                hideReplyForm(replyToCommentId);
                replyToCommentId = null;
            }
        }
        
        function validateCommentInput() {
            const commentInput = document.getElementById('commentInput');
            const submitBtn = document.getElementById('submitCommentBtn');
            
            if (!commentInput || !submitBtn) return;
            
            const content = commentInput.value.trim();
            const isValid = content.length > 0 && content.length <= 1000;
            
            submitBtn.disabled = !isValid;
            
            // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞Ê†∑Âºè
            const charCount = document.getElementById('charCount');
            if (charCount) {
                if (content.length > 950) {
                    charCount.classList.add('danger');
                    charCount.classList.remove('warning');
                } else if (content.length > 800) {
                    charCount.classList.add('warning');
                    charCount.classList.remove('danger');
                } else {
                    charCount.classList.remove('warning', 'danger');
                }
            }
        }
        
        // ==================== Ëá™Âä®Ë∞ÉÊï¥ÊñáÊú¨Âå∫ÂüüÈ´òÂ∫¶ ====================
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
        }
        
        // ==================== Â≠óÁ¨¶ËÆ°Êï∞Êõ¥Êñ∞ ====================
        function updateCharCount() {
            const commentInput = document.getElementById('commentInput');
            const charCount = document.getElementById('charCount');
            
            if (commentInput && charCount) {
                charCount.textContent = commentInput.value.length;
            }
        }
        
        // ==================== Ê†ºÂºèÂåñÊñáÊú¨Â∑•ÂÖ∑ ====================
        function formatText(type) {
            const commentInput = document.getElementById('commentInput');
            if (!commentInput) return;
            
            const start = commentInput.selectionStart;
            const end = commentInput.selectionEnd;
            const selectedText = commentInput.value.substring(start, end);
            let formattedText = '';
            
            switch (type) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'link':
                    const url = prompt('ËØ∑ËæìÂÖ•ÈìæÊé•Âú∞ÂùÄÔºö', 'https://');
                    if (url) {
                        formattedText = `[${selectedText || 'ÈìæÊé•'}](${url})`;
                    } else {
                        return;
                    }
                    break;
                case 'code':
                    formattedText = selectedText.includes('\n') 
                        ? `\`\`\`\n${selectedText}\n\`\`\`` 
                        : `\`${selectedText}\``;
                    break;
            }
            
            // ÊèíÂÖ•Ê†ºÂºèÂåñÊñáÊú¨
            commentInput.value = commentInput.value.substring(0, start) + 
                                formattedText + 
                                commentInput.value.substring(end);
            
            // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆ
            commentInput.focus();
            const newPosition = start + formattedText.length;
            commentInput.setSelectionRange(newPosition, newPosition);
            
            // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞ÂíåÈ™åËØÅ
            updateCharCount();
            validateCommentInput();
            autoResizeTextarea(commentInput);
        }
        
        // ==================== ÂàáÊç¢Ê†ºÂºèÂ∏ÆÂä© ====================
        function toggleFormatHelp() {
            const tooltip = document.getElementById('formatHelpTooltip');
            tooltip.classList.toggle('show');
        }
        
        // ==================== Ë°®ÊÉÖÈÄâÊã©Âô®ÂäüËÉΩ ====================
        function initializeEmojiPicker() {
            const emojiGrid = document.getElementById('emojiGrid');
            if (!emojiGrid) return;
            
            // Âä†ËΩΩÈªòËÆ§ÂàÜÁ±ªÔºàË°®ÊÉÖÔºâ
            loadEmojiCategory('smileys');
            
            // ËÆæÁΩÆÂàÜÁ±ªÂàáÊç¢‰∫ã‰ª∂
            document.querySelectorAll('.emoji-category').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    loadEmojiCategory(category);
                    
                    // Êõ¥Êñ∞ÊøÄÊ¥ªÁä∂ÊÄÅ
                    document.querySelectorAll('.emoji-category').forEach(b => 
                        b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function loadEmojiCategory(category) {
            const emojiGrid = document.getElementById('emojiGrid');
            if (!emojiGrid) return;
            
            const emojis = emojiData[category] || [];
            emojiGrid.innerHTML = emojis.map(emoji => 
                `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`
            ).join('');
        }
        
        function searchEmoji(query) {
            const emojiGrid = document.getElementById('emojiGrid');
            if (!emojiGrid || !query) {
                loadEmojiCategory('smileys');
                return;
            }
            
            let results = [];
            for (const category in emojiData) {
                results.push(...emojiData[category].filter(emoji => 
                    emoji.includes(query)
                ));
            }
            
            emojiGrid.innerHTML = results.map(emoji => 
                `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`
            ).join('');
        }
        
        function insertEmoji(emoji) {
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                const start = commentInput.selectionStart;
                const text = commentInput.value;
                
                commentInput.value = text.substring(0, start) + emoji + text.substring(start);
                commentInput.focus();
                commentInput.selectionStart = commentInput.selectionEnd = start + emoji.length;
                
                updateCharCount();
                validateCommentInput();
                autoResizeTextarea(commentInput);
            }
            
            // ÂÖ≥Èó≠Ë°®ÊÉÖÈÄâÊã©Âô®
            toggleEmojiPicker();
        }
        
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker) {
                emojiPicker.classList.toggle('show');
                
                if (emojiPicker.classList.contains('show')) {
                    // ÈáçÁΩÆÊêúÁ¥¢
                    const searchInput = document.getElementById('emojiSearch');
                    if (searchInput) searchInput.value = '';
                    loadEmojiCategory('smileys');
                }
            }
        }
        
        // ==================== ÂõæÁâá‰∏ä‰º†ÂäüËÉΩ ====================
        async function openImageUpload() {
            if (uploadingImage) {
                showNotification('Ê≠£Âú®‰∏ä‰º†ÂõæÁâáÔºåËØ∑Á®çÂÄô...', 'warning');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // È™åËØÅÊñá‰ª∂
                if (!validateImageFile(file)) {
                    input.remove();
                    return;
                }
                
                // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
                showUploadProgress();
                
                try {
                    // Ê®°Êãü‰∏ä‰º†ËøõÂ∫¶
                    simulateUploadProgress();
                    
                    // ÂéãÁº©ÂõæÁâá
                    const compressedImage = await compressImage(file);
                    
                    // ËΩ¨Êç¢‰∏∫base64
                    const base64Image = await fileToBase64(compressedImage);
                    
                    // ÂÆåÊàê‰∏ä‰º†
                    completeImageUpload(base64Image);
                    
                } catch (error) {
                    console.error('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•:', error);
                    showNotification('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•', 'error');
                    hideUploadProgress();
                }
                
                input.remove();
            };
            
            document.body.appendChild(input);
            input.click();
        }
        
        function validateImageFile(file) {
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂2MBÔºâ
            if (file.size > 2 * 1024 * 1024) {
                showNotification('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB', 'error');
                return false;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
                showNotification('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂', 'error');
                return false;
            }
            
            // Ê£ÄÊü•ÂõæÁâáÂ∞∫ÂØ∏
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const maxWidth = 1920;
                    const maxHeight = 1080;
                    
                    if (img.width > maxWidth || img.height > maxHeight) {
                        showNotification(`ÂõæÁâáÂ∞∫ÂØ∏ËøáÂ§ßÔºåÂª∫ËÆÆ‰∏çË∂ÖËøá ${maxWidth}√ó${maxHeight}`, 'warning');
                    }
                    resolve(true);
                };
                img.onerror = () => {
                    showNotification('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÂõæÁâá', 'error');
                    resolve(false);
                };
                img.src = URL.createObjectURL(file);
            });
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    // ËÆ°ÁÆóÂéãÁº©Â∞∫ÂØ∏
                    let width = img.width;
                    let height = img.height;
                    const maxDimension = 1200;
                    
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                    }
                    
                    // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ÁªòÂà∂ÂéãÁº©ÂêéÁöÑÂõæÁâá
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ËΩ¨Êç¢‰∏∫Blob
                    canvas.toBlob(
                        (blob) => {
                            if (blob) {
                                resolve(new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                }));
                            } else {
                                reject(new Error('ÂõæÁâáÂéãÁº©Â§±Ë¥•'));
                            }
                        },
                        'image/jpeg',
                        0.8 // Ë¥®ÈáèÂèÇÊï∞
                    );
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function showUploadProgress() {
            uploadingImage = true;
            const progress = document.getElementById('uploadProgress');
            const preview = document.getElementById('imagePreview');
            
            if (progress) {
                progress.style.display = 'flex';
            }
            if (preview) {
                preview.style.display = 'none';
            }
        }
        
        function hideUploadProgress() {
            uploadingImage = false;
            const progress = document.getElementById('uploadProgress');
            if (progress) {
                progress.style.display = 'none';
            }
        }
        
        function simulateUploadProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10 + 5;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                updateUploadProgress(progress);
            }, 100);
        }
        
        function updateUploadProgress(percent) {
            imageUploadProgress = percent;
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
            if (progressText) {
                progressText.textContent = `${Math.round(percent)}%`;
            }
        }
        
        function completeImageUpload(base64Image) {
            hideUploadProgress();
            
            // ÊòæÁ§∫ÂõæÁâáÈ¢ÑËßà
            const preview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (preview && previewImage) {
                previewImage.src = base64Image;
                preview.style.display = 'block';
            }
            
            showNotification('ÂõæÁâá‰∏ä‰º†ÊàêÂäü', 'success');
        }
        
        function removePreviewImage() {
            const preview = document.getElementById('imagePreview');
            if (preview) {
                preview.style.display = 'none';
            }
            
            const previewImage = document.getElementById('previewImage');
            if (previewImage) {
                previewImage.src = '';
            }
        }
        
        // ==================== ËØÑËÆ∫Êèê‰∫§ÂäüËÉΩ ====================
        async function submitComment() {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩïÂêéÂèëË°®ËØÑËÆ∫', 'warning');
                setTimeout(() => {
                    window.location.href = 'login-real.html?redirect=' + encodeURIComponent(window.location.pathname);
                }, 1500);
                return;
            }
            
            const commentInput = document.getElementById('commentInput');
            if (!commentInput) return;
            
            const content = commentInput.value.trim();
            if (!content) {
                showNotification('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }
            
            if (content.length > 1000) {
                showNotification('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá1000Â≠ó', 'error');
                return;
            }
            
            // Ëé∑ÂèñÂõæÁâáÈ¢ÑËßà
            const previewImage = document.getElementById('previewImage');
            let imageContent = '';
            if (previewImage && previewImage.src) {
                imageContent = previewImage.src;
            }
            
            // ÁªÑÂêàÂÜÖÂÆπ
            const fullContent = imageContent ? `${content}\n\n![ÂõæÁâá](${imageContent})` : content;
            
            // ËÆæÁΩÆÊèê‰∫§Áä∂ÊÄÅ
            const submitBtn = document.getElementById('submitCommentBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂèëÂ∏É‰∏≠...';
            submitBtn.disabled = true;
            
            try {
                // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                const username = userProfile?.username || currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                const avatarUrl = userProfile?.avatar_url;
                
                // ÂáÜÂ§áËØÑËÆ∫Êï∞ÊçÆ
                const commentData = {
                    user_id: currentUser.id,
                    username: username,
                    avatar_url: avatarUrl,
                    content: fullContent,
                    page_type: 'index',
                    page_id: 'home',
                    parent_id: replyToCommentId,
                    image_url: imageContent || null
                };
                
                // Â¶ÇÊûúÊúâÁºñËæë‰∏≠ÁöÑËØÑËÆ∫
                if (editingCommentId) {
                    commentData.id = editingCommentId;
                    commentData.updated_at = new Date().toISOString();
                }
                
                // Êèê‰∫§ËØÑËÆ∫
                const { data: comment, error } = editingCommentId
                    ? await supabaseClient
                        .from('comments')
                        .update(commentData)
                        .eq('id', editingCommentId)
                        .select()
                        .single()
                    : await supabaseClient
                        .from('comments')
                        .insert(commentData)
                        .select()
                        .single();
                
                if (error) throw error;
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                resetCommentForm();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showNotification(editingCommentId ? 'ËØÑËÆ∫Â∑≤Êõ¥Êñ∞' : 'ËØÑËÆ∫ÂèëÂ∏ÉÊàêÂäü', 'success');
                
                // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
                await reloadComments();
                
                // ÊªöÂä®Âà∞Êñ∞ËØÑËÆ∫ÊàñÊõ¥Êñ∞ÁöÑËØÑËÆ∫
                setTimeout(() => {
                    const commentElement = document.getElementById(`comment-${comment.id}`);
                    if (commentElement) {
                        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        commentElement.classList.add('highlight');
                        
                        // 3ÁßíÂêéÁßªÈô§È´ò‰∫Æ
                        setTimeout(() => {
                            commentElement.classList.remove('highlight');
                        }, 3000);
                    }
                }, 500);
                
                // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                await updateCommentStats();
                
            } catch (error) {
                console.error('ÂèëË°®ËØÑËÆ∫Â§±Ë¥•:', error);
                showNotification(`ÂèëÂ∏ÉÂ§±Ë¥•: ${error.message}`, 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        function resetCommentForm() {
            const commentInput = document.getElementById('commentInput');
            const submitBtn = document.getElementById('submitCommentBtn');
            
            if (commentInput) {
                commentInput.value = '';
                autoResizeTextarea(commentInput);
            }
            
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ÂèëÂ∏ÉËØÑËÆ∫';
                submitBtn.disabled = true;
            }
            
            // Ê∏ÖÁ©∫ÂõæÁâáÈ¢ÑËßà
            removePreviewImage();
            
            // ÈáçÁΩÆÁä∂ÊÄÅ
            editingCommentId = null;
            replyToCommentId = null;
            
            // ÈöêËóèÂõûÂ§çË°®Âçï
            document.querySelectorAll('.reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞
            updateCharCount();
        }
        
        // ==================== ËØÑËÆ∫Âä†ËΩΩÂäüËÉΩ ====================
        async function loadComments(page = 1, sort = 'newest') {
            try {
                const commentsList = document.getElementById('commentsList');
                if (!commentsList) return;
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                commentsList.innerHTML = `
                    <div class="loading-comments">
                        <div class="spinner"></div>
                        <p>Âä†ËΩΩËØÑËÆ∫‰∏≠...</p>
                    </div>
                `;
                
                // ÊûÑÂª∫Êü•ËØ¢
                let query = supabaseClient
                    .from('comments')
                    .select('*, user:user_profiles(username, avatar_url, is_admin, is_verified)', { 
                        count: 'exact' 
                    })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('parent_id', null)
                    .eq('is_hidden', false);
                
                // Â∫îÁî®ÊéíÂ∫è
                switch (sort) {
                    case 'newest':
                        query = query.order('created_at', { ascending: false });
                        break;
                    case 'oldest':
                        query = query.order('created_at', { ascending: true });
                        break;
                    case 'hottest':
                        query = query.order('likes_count', { ascending: false });
                        break;
                    case 'pinned':
                        query = query.order('is_pinned', { ascending: false })
                                    .order('created_at', { ascending: false });
                        break;
                }
                
                // Â∫îÁî®ÂàÜÈ°µ
                const from = (page - 1) * commentPageSize;
                const to = from + commentPageSize - 1;
                query = query.range(from, to);
                
                // ÊâßË°åÊü•ËØ¢
                const { data: comments, error, count } = await query;
                
                if (error) throw error;
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                commentTotalCount = count || 0;
                commentTotalPages = Math.ceil(commentTotalCount / commentPageSize);
                commentCurrentPage = page;
                
                // Ê∏≤ÊüìËØÑËÆ∫
                if (!comments || comments.length === 0) {
                    showEmptyComments();
                } else {
                    renderComments(comments);
                }
                
                // Êõ¥Êñ∞ÂàÜÈ°µ
                updateCommentPagination();
                
                // Âä†ËΩΩÊØè‰∏™ËØÑËÆ∫ÁöÑÂõûÂ§ç
                if (comments && comments.length > 0) {
                    await Promise.all(comments.map(comment => loadCommentReplies(comment.id)));
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error);
                showCommentLoadError();
            }
        }
        
        async function reloadComments() {
            await loadComments(commentCurrentPage, commentCurrentSort);
        }
        
        // ==================== ËØÑËÆ∫Ê∏≤ÊüìÂäüËÉΩ ====================
        function renderComments(comments) {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            // ËøáÊª§ËØÑËÆ∫
            const filteredComments = comments.filter(comment => {
                // ËøáÊª§ÁΩÆÈ°∂ËØÑËÆ∫
                if (!currentCommentFilter.pinned && comment.is_pinned) {
                    return false;
                }
                
                // ËøáÊª§Â∏¶ÂõæËØÑËÆ∫
                if (currentCommentFilter.withImages && !comment.content.includes('![')) {
                    return false;
                }
                
                // ÊêúÁ¥¢ËøáÊª§
                if (currentCommentFilter.searchQuery) {
                    const searchLower = currentCommentFilter.searchQuery.toLowerCase();
                    const contentLower = comment.content.toLowerCase();
                    const usernameLower = comment.user?.username?.toLowerCase() || '';
                    
                    if (!contentLower.includes(searchLower) && !usernameLower.includes(searchLower)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            if (filteredComments.length === 0) {
                showEmptyComments();
                return;
            }
            
            // ÁîüÊàêËØÑËÆ∫HTML
            let commentsHTML = '';
            filteredComments.forEach(comment => {
                commentsHTML += renderCommentItem(comment);
            });
            
            commentsList.innerHTML = commentsHTML;
            
            // ‰∏∫ÊØè‰∏™ËØÑËÆ∫ÂàùÂßãÂåñ‰∫ã‰ª∂
            filteredComments.forEach(comment => {
                initializeCommentEvents(comment.id);
                updateCommentLikeStatus(comment.id);
            });
        }
        
        function renderCommentItem(comment) {
            const username = comment.user?.username || 'ÂåøÂêçÁî®Êà∑';
            const avatarLetter = username.charAt(0).toUpperCase();
            const avatarUrl = comment.user?.avatar_url;
            
            // Ê†ºÂºèÂåñÊó∂Èó¥
            const timeAgo = formatTimeAgo(comment.created_at);
            const editedText = comment.updated_at !== comment.created_at 
                ? `ÔºàÂ∑≤ÁºñËæë ${formatTimeAgo(comment.updated_at)}Ôºâ`
                : '';
            
            // ÊûÑÂª∫Â§¥ÂÉè
            const avatarHtml = avatarUrl 
                ? `<img src="${avatarUrl}" alt="${username}" onerror="this.onerror=null; this.parentElement.innerHTML='${avatarLetter}';">`
                : `<div class="avatar-placeholder">${avatarLetter}</div>`;
            
            // ÊûÑÂª∫Áî®Êà∑ÂæΩÁ´†
            const badges = [];
            if (comment.user?.is_admin) {
                badges.push('<span class="author-badge admin">ÁÆ°ÁêÜÂëò</span>');
            }
            if (comment.user?.is_verified) {
                badges.push('<span class="author-badge verified">ËÆ§ËØÅ</span>');
            }
            if (comment.is_pinned) {
                badges.push('<span class="author-badge">ÁΩÆÈ°∂</span>');
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâá
            const hasImage = comment.content.includes('![');
            
            return `
                <div class="comment-item ${comment.is_pinned ? 'pinned' : ''} ${hasImage ? 'has-image' : ''}" 
                     id="comment-${comment.id}"
                     data-comment-id="${comment.id}"
                     data-user-id="${comment.user_id}"
                     data-created-at="${comment.created_at}"
                     data-likes="${comment.likes_count || 0}">
                    
                    <div class="comment-header">
                        <div class="comment-avatar">
                            ${avatarHtml}
                        </div>
                        <div class="comment-meta">
                            <div class="comment-author">
                                <span class="author-name">${escapeHtml(username)}</span>
                                ${badges.join('')}
                            </div>
                            <div class="comment-time">
                                <span>${timeAgo}</span>
                                <span class="edited">${editedText}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comment-content" id="comment-content-${comment.id}">
                        ${formatCommentContent(comment.content)}
                    </div>
                    
                    <div class="comment-actions">
                        <button class="action-btn like-btn" onclick="toggleCommentLike('${comment.id}')">
                            <i class="fas fa-heart"></i>
                            <span class="action-count like-count" id="like-count-${comment.id}">
                                ${comment.likes_count || 0}
                            </span>
                        </button>
                        
                        <button class="action-btn reply-btn" onclick="showReplyForm('${comment.id}')">
                            <i class="fas fa-reply"></i>
                            <span class="action-count">ÂõûÂ§ç</span>
                        </button>
                        
                        <button class="action-btn share-btn" onclick="shareComment('${comment.id}')">
                            <i class="fas fa-share-alt"></i>
                            <span class="action-count">ÂàÜ‰∫´</span>
                        </button>
                        
                        ${currentUser && currentUser.id === comment.user_id ? `
                            <button class="action-btn edit-btn" onclick="editComment('${comment.id}')">
                                <i class="fas fa-edit"></i>
                                <span class="action-count">ÁºñËæë</span>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteComment('${comment.id}')">
                                <i class="fas fa-trash"></i>
                                <span class="action-count">Âà†Èô§</span>
                            </button>
                        ` : `
                            <button class="action-btn report-btn" onclick="openReportDialog('${comment.id}')">
                                <i class="fas fa-flag"></i>
                                <span class="action-count">‰∏æÊä•</span>
                            </button>
                        `}
                        
                        <button class="action-btn more-btn" onclick="showCommentMoreMenu('${comment.id}', event)">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    
                    <!-- ÂõûÂ§çË°®Âçï -->
                    <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
                        <textarea 
                            id="reply-input-${comment.id}" 
                            placeholder="ÂõûÂ§ç ${escapeHtml(username)}..."
                            rows="3"
                            maxlength="500"
                            oninput="autoResizeTextarea(this)"
                        ></textarea>
                        <div class="reply-actions">
                            <button class="btn-submit" onclick="submitReply('${comment.id}')">
                                <i class="fas fa-paper-plane"></i> ÂèëÈÄÅÂõûÂ§ç
                            </button>
                            <button class="tool-btn" onclick="hideReplyForm('${comment.id}')">
                                <i class="fas fa-times"></i> ÂèñÊ∂à
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÂõûÂ§çÂàóË°® -->
                    <div class="comment-replies" id="replies-${comment.id}">
                        <!-- ÂõûÂ§ç‰ºöÂä®ÊÄÅÂä†ËΩΩ -->
                    </div>
                </div>
            `;
        }
        
        // ==================== ËØÑËÆ∫‰∫ã‰ª∂ÂàùÂßãÂåñ ====================
        function initializeCommentEvents(commentId) {
            // ÂõæÁâáÁÇπÂáªÊîæÂ§ß
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (commentElement) {
                commentElement.querySelectorAll('img').forEach(img => {
                    img.addEventListener('click', () => {
                        openImageLightbox(img.src);
                    });
                });
                
                // ÂèåÂáªÁÇπËµû
                let lastClickTime = 0;
                commentElement.addEventListener('dblclick', (e) => {
                    const currentTime = new Date().getTime();
                    if (currentTime - lastClickTime < 300) return; // Èò≤Ê≠¢ËøûÁª≠Ëß¶Âèë
                    lastClickTime = currentTime;
                    
                    if (!e.target.closest('.comment-actions')) {
                        toggleCommentLike(commentId);
                    }
                });
            }
        }
        
        // ==================== ÂõûÂ§çÂäüËÉΩ ====================
        function showReplyForm(commentId) {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩïÂêéÂõûÂ§çËØÑËÆ∫', 'warning');
                return;
            }
            
            // ÈöêËóèÊâÄÊúâÂÖ∂‰ªñÂõûÂ§çË°®Âçï
            document.querySelectorAll('.reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // ÊòæÁ§∫ÂΩìÂâçÂõûÂ§çË°®Âçï
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
                replyToCommentId = commentId;
                
                // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    const replyInput = document.getElementById(`reply-input-${commentId}`);
                    if (replyInput) {
                        replyInput.focus();
                        autoResizeTextarea(replyInput);
                    }
                }, 100);
            }
        }
        
        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'none';
                replyToCommentId = null;
            }
        }
        
        async function submitReply(commentId) {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩï', 'error');
                return;
            }
            
            const replyInput = document.getElementById(`reply-input-${commentId}`);
            if (!replyInput) return;
            
            const content = replyInput.value.trim();
            if (!content) {
                showNotification('ÂõûÂ§çÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }
            
            try {
                const username = userProfile?.username || currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                const avatarUrl = userProfile?.avatar_url;
                
                const { error } = await supabaseClient
                    .from('comments')
                    .insert({
                        user_id: currentUser.id,
                        username: username,
                        avatar_url: avatarUrl,
                        content: content,
                        page_type: 'index',
                        page_id: 'home',
                        parent_id: commentId
                    });
                
                if (error) throw error;
                
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                replyInput.value = '';
                
                // ÈáçÊñ∞Âä†ËΩΩÂõûÂ§ç
                await loadCommentReplies(commentId);
                
                showNotification('ÂõûÂ§çÊàêÂäü', 'success');
                
                // ÈöêËóèÂõûÂ§çË°®Âçï
                hideReplyForm(commentId);
                
                // Êõ¥Êñ∞ËØÑËÆ∫ÁªüËÆ°
                await updateCommentStats();
                
            } catch (error) {
                console.error('Êèê‰∫§ÂõûÂ§çÂ§±Ë¥•:', error);
                showNotification(`ÂõûÂ§çÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        async function loadCommentReplies(commentId) {
            try {
                const { data: replies, error } = await supabaseClient
                    .from('comments')
                    .select('*, user:user_profiles(username, avatar_url)')
                    .eq('parent_id', commentId)
                    .eq('is_hidden', false)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                const repliesContainer = document.getElementById(`replies-${commentId}`);
                if (!repliesContainer) return;
                
                if (!replies || replies.length === 0) {
                    repliesContainer.innerHTML = '';
                    return;
                }
                
                // Âè™ÊòæÁ§∫Ââç3Êù°ÂõûÂ§çÔºåÂÖ∂‰ªñÁöÑÈúÄË¶ÅÁÇπÂáªÊü•Áúã
                const visibleReplies = replies.slice(0, 3);
                const hasMore = replies.length > 3;
                
                let repliesHTML = '';
                visibleReplies.forEach(reply => {
                    repliesHTML += renderReplyItem(reply);
                });
                
                if (hasMore) {
                    repliesHTML += `
                        <button class="view-replies-btn" onclick="loadAllReplies('${commentId}')">
                            <i class="fas fa-chevron-down"></i>
                            Êü•ÁúãÂÖ®ÈÉ® ${replies.length} Êù°ÂõûÂ§ç
                        </button>
                    `;
                }
                
                repliesContainer.innerHTML = repliesHTML;
                
                // ‰∏∫ÂõûÂ§çÂàùÂßãÂåñ‰∫ã‰ª∂
                visibleReplies.forEach(reply => {
                    const replyElement = repliesContainer.querySelector(`[data-reply-id="${reply.id}"]`);
                    if (replyElement) {
                        replyElement.querySelectorAll('img').forEach(img => {
                            img.addEventListener('click', () => {
                                openImageLightbox(img.src);
                            });
                        });
                    }
                });
                
            } catch (error) {
                console.error('Âä†ËΩΩÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        function renderReplyItem(reply) {
            const username = reply.user?.username || 'ÂåøÂêçÁî®Êà∑';
            const avatarLetter = username.charAt(0).toUpperCase();
            const timeAgo = formatTimeAgo(reply.created_at);
            
            return `
                <div class="reply-item" data-reply-id="${reply.id}">
                    <div class="reply-header">
                        <div class="reply-avatar">
                            <div class="avatar-placeholder" style="width: 24px; height: 24px; font-size: 0.8rem;">
                                ${avatarLetter}
                            </div>
                        </div>
                        <div class="reply-meta">
                            <span class="reply-author">${escapeHtml(username)}</span>
                            <span class="reply-time">${timeAgo}</span>
                        </div>
                    </div>
                    <div class="reply-content">
                        ${formatCommentContent(reply.content)}
                    </div>
                </div>
            `;
        }
        
        async function loadAllReplies(commentId) {
            try {
                const { data: replies, error } = await supabaseClient
                    .from('comments')
                    .select('*, user:user_profiles(username, avatar_url)')
                    .eq('parent_id', commentId)
                    .eq('is_hidden', false)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                const repliesContainer = document.getElementById(`replies-${commentId}`);
                if (!repliesContainer) return;
                
                let repliesHTML = '';
                replies.forEach(reply => {
                    repliesHTML += renderReplyItem(reply);
                });
                
                repliesContainer.innerHTML = repliesHTML;
                
            } catch (error) {
                console.error('Âä†ËΩΩÊâÄÊúâÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        // ==================== ÁÇπËµûÂäüËÉΩ ====================
        async function toggleCommentLike(commentId) {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩïÂêéÁÇπËµû', 'warning');
                return;
            }
            
            const likeBtn = document.querySelector(`#comment-${commentId} .like-btn`);
            if (!likeBtn) return;
            
            // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
            if (likeBtn.classList.contains('disabled')) return;
            likeBtn.classList.add('disabled');
            
            try {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÁÇπËµû
                const { data: existingLike, error: checkError } = await supabaseClient
                    .from('comment_likes')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('comment_id', commentId)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingLike) {
                    // ÂèñÊ∂àÁÇπËµû
                    const { error } = await supabaseClient
                        .from('comment_likes')
                        .delete()
                        .eq('id', existingLike.id);
                    
                    if (error) throw error;
                    
                    // Êõ¥Êñ∞UI
                    likeBtn.classList.remove('liked');
                    updateCommentLikeCount(commentId, -1);
                    
                    // ÊòæÁ§∫Âä®Áîª
                    animateLikeButton(likeBtn, false);
                    
                } else {
                    // Ê∑ªÂä†ÁÇπËµû
                    const { error } = await supabaseClient
                        .from('comment_likes')
                        .insert({
                            user_id: currentUser.id,
                            comment_id: commentId
                        });
                    
                    if (error) throw error;
                    
                    // Êõ¥Êñ∞UI
                    likeBtn.classList.add('liked');
                    updateCommentLikeCount(commentId, 1);
                    
                    // ÊòæÁ§∫Âä®Áîª
                    animateLikeButton(likeBtn, true);
                }
                
            } catch (error) {
                console.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•:', error);
                showNotification(`Êìç‰ΩúÂ§±Ë¥•: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    likeBtn.classList.remove('disabled');
                }, 500);
            }
        }
        
        function animateLikeButton(button, isLiked) {
            const icon = button.querySelector('i');
            const count = button.querySelector('.like-count');
            
            if (isLiked) {
                // ÁÇπËµûÂä®Áîª
                icon.style.transform = 'scale(1.3)';
                count.style.transform = 'translateY(-2px)';
                
                // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
                createLikeParticles(button);
                
            } else {
                // ÂèñÊ∂àÁÇπËµûÂä®Áîª
                icon.style.transform = 'scale(0.9)';
                count.style.transform = 'translateY(2px)';
            }
            
            // ÊÅ¢Â§çÂéüÁä∂
            setTimeout(() => {
                icon.style.transform = '';
                count.style.transform = '';
            }, 300);
        }
        
        function createLikeParticles(button) {
            const rect = button.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.innerHTML = '‚ù§Ô∏è';
                particle.style.cssText = `
                    position: fixed;
                    left: ${x}px;
                    top: ${y}px;
                    font-size: 16px;
                    pointer-events: none;
                    z-index: 10000;
                    opacity: 0;
                    transform: translate(0, 0) scale(1);
                `;
                
                document.body.appendChild(particle);
                
                // ÈöèÊú∫ÊñπÂêë
                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 50;
                const duration = 600 + Math.random() * 400;
                
                particle.animate([
                    {
                        opacity: 1,
                        transform: `translate(0, 0) scale(1)`
                    },
                    {
                        opacity: 0,
                        transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0.5)`
                    }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                });
                
                // ÁßªÈô§Á≤íÂ≠ê
                setTimeout(() => {
                    particle.remove();
                }, duration);
            }
        }
        
        function updateCommentLikeCount(commentId, delta) {
            const countElement = document.getElementById(`like-count-${commentId}`);
            if (countElement) {
                const currentCount = parseInt(countElement.textContent) || 0;
                const newCount = Math.max(0, currentCount + delta);
                countElement.textContent = newCount;
            }
        }
        
        async function updateCommentLikeStatus(commentId) {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('comment_likes')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('comment_id', commentId)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                const likeBtn = document.querySelector(`#comment-${commentId} .like-btn`);
                if (likeBtn) {
                    if (data) {
                        likeBtn.classList.add('liked');
                    } else {
                        likeBtn.classList.remove('liked');
                    }
                }
                
            } catch (error) {
                console.error('Ê£ÄÊü•ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }
        }
        
        // ==================== ËØÑËÆ∫ÁºñËæëÂäüËÉΩ ====================
        function editComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (!commentElement) return;
            
            const contentElement = commentElement.querySelector('.comment-content');
            if (!contentElement) return;
            
            const currentContent = contentElement.textContent.trim();
            
            // ÂàõÂª∫ÁºñËæëË°®Âçï
            contentElement.innerHTML = `
                <textarea id="edit-input-${commentId}" 
                          style="width: 100%; padding: 12px; background: #2d3748; border: 1px solid var(--border-color); border-radius: var(--radius); color: var(--text-main); font-size: 1rem; line-height: 1.5; resize: vertical; min-height: 100px; max-height: 300px; outline: none;"
                          oninput="autoResizeTextarea(this)">${escapeHtml(currentContent)}</textarea>
                <div class="edit-actions" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-submit" onclick="saveEdit('${commentId}')" style="padding: 8px 16px;">
                        <i class="fas fa-save"></i> ‰øùÂ≠ò
                    </button>
                    <button class="tool-btn" onclick="cancelEdit('${commentId}')" style="padding: 8px 16px;">
                        <i class="fas fa-times"></i> ÂèñÊ∂à
                    </button>
                </div>
            `;
            
            // ËÆæÁΩÆÁºñËæëÁä∂ÊÄÅ
            editingCommentId = commentId;
            
            // Ëá™Âä®Ë∞ÉÊï¥È´òÂ∫¶
            setTimeout(() => {
                const textarea = document.getElementById(`edit-input-${commentId}`);
                if (textarea) {
                    autoResizeTextarea(textarea);
                    textarea.focus();
                }
            }, 100);
        }
        
        async function saveEdit(commentId) {
            const editInput = document.getElementById(`edit-input-${commentId}`);
            if (!editInput) return;
            
            const newContent = editInput.value.trim();
            if (!newContent) {
                showNotification('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('comments')
                    .update({ 
                        content: newContent,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', commentId);
                
                if (error) throw error;
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                const commentElement = document.getElementById(`comment-${commentId}`);
                const contentElement = commentElement.querySelector('.comment-content');
                contentElement.innerHTML = formatCommentContent(newContent);
                
                // ÈáçÁΩÆÁºñËæëÁä∂ÊÄÅ
                editingCommentId = null;
                
                showNotification('ËØÑËÆ∫Â∑≤Êõ¥Êñ∞', 'success');
                
            } catch (error) {
                console.error('‰øùÂ≠òÁºñËæëÂ§±Ë¥•:', error);
                showNotification(`‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        function cancelEdit(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (!commentElement) return;
            
            // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂÜÖÂÆπ
            reloadCommentContent(commentId);
            
            // ÈáçÁΩÆÁºñËæëÁä∂ÊÄÅ
            editingCommentId = null;
        }
        
        async function reloadCommentContent(commentId) {
            try {
                const { data: comment, error } = await supabaseClient
                    .from('comments')
                    .select('content')
                    .eq('id', commentId)
                    .single();
                
                if (error) throw error;
                
                const commentElement = document.getElementById(`comment-${commentId}`);
                const contentElement = commentElement.querySelector('.comment-content');
                contentElement.innerHTML = formatCommentContent(comment.content);
                
            } catch (error) {
                console.error('ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂÜÖÂÆπÂ§±Ë¥•:', error);
            }
        }
        
        // ==================== ËØÑËÆ∫Âà†Èô§ÂäüËÉΩ ====================
        async function deleteComment(commentId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('comments')
                    .update({ is_hidden: true })
                    .eq('id', commentId);
                
                if (error) throw error;
                
                // ‰ªéÈ°µÈù¢ÁßªÈô§
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    commentElement.style.opacity = '0.5';
                    commentElement.style.pointerEvents = 'none';
                    
                    setTimeout(() => {
                        commentElement.remove();
                        commentTotalCount--;
                        updateCommentStats();
                        updateCommentPagination();
                        
                        // Â¶ÇÊûúÂΩìÂâçÈ°µÊ≤°ÊúâËØÑËÆ∫‰∫ÜÔºåÂä†ËΩΩ‰∏ä‰∏ÄÈ°µ
                        const commentsList = document.getElementById('commentsList');
                        if (commentsList.children.length === 0 && commentCurrentPage > 1) {
                            loadPrevPage();
                        }
                    }, 500);
                }
                
                showNotification('ËØÑËÆ∫Â∑≤Âà†Èô§', 'success');
                
            } catch (error) {
                console.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:', error);
                showNotification(`Âà†Èô§Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        // ==================== ‰∏æÊä•ÂäüËÉΩ ====================
        function openReportDialog(commentId) {
            if (!currentUser) {
                showNotification('ËØ∑ÂÖàÁôªÂΩïÂêé‰∏æÊä•ËØÑËÆ∫', 'warning');
                return;
            }
            
            reportingCommentId = commentId;
            
            // Ëé∑ÂèñËØÑËÆ∫ÂÜÖÂÆπ
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (commentElement) {
                const content = commentElement.querySelector('.comment-content').textContent;
                const truncatedContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                
                document.getElementById('reportCommentContent').textContent = truncatedContent;
            }
            
            // ÊòæÁ§∫ÂØπËØùÊ°Ü
            document.getElementById('reportDialog').classList.add('show');
        }
        
        function closeReportDialog() {
            document.getElementById('reportDialog').classList.remove('show');
            reportingCommentId = null;
            
            // ÈáçÁΩÆË°®Âçï
            document.querySelector('input[name="reportReason"][value="spam"]').checked = true;
            document.getElementById('reportDescription').value = '';
        }
        
        async function submitReport() {
            if (!currentUser || !reportingCommentId) return;
            
            const reason = document.querySelector('input[name="reportReason"]:checked').value;
            const description = document.getElementById('reportDescription').value.trim();
            
            try {
                const { error } = await supabaseClient
                    .from('comment_reports')
                    .insert({
                        user_id: currentUser.id,
                        comment_id: reportingCommentId,
                        reason: reason,
                        description: description,
                        status: 'pending'
                    });
                
                if (error) {
                    if (error.code === '23505') {
                        showNotification('ÊÇ®Â∑≤Áªè‰∏æÊä•ËøáËøôÊù°ËØÑËÆ∫‰∫Ü', 'warning');
                    } else {
                        throw error;
                    }
                } else {
                    showNotification('‰∏æÊä•Â∑≤Êèê‰∫§ÔºåÊàë‰ª¨‰ºöÂ∞ΩÂø´Â§ÑÁêÜ', 'success');
                }
                
                closeReportDialog();
                
            } catch (error) {
                console.error('Êèê‰∫§‰∏æÊä•Â§±Ë¥•:', error);
                showNotification(`‰∏æÊä•Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        // ==================== ÂàÜ‰∫´ÂäüËÉΩ ====================
        function shareComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (!commentElement) return;
            
            const commentText = commentElement.querySelector('.comment-content').textContent;
            const username = commentElement.querySelector('.author-name').textContent;
            const shareUrl = `${window.location.origin}${window.location.pathname}#comment-${commentId}`;
            
            const shareText = `Êù•Ëá™${username}ÁöÑËØÑËÆ∫Ôºö\n${commentText}\n\nÊü•ÁúãÂÆåÊï¥ËØÑËÆ∫Ôºö${shareUrl}`;
            
            if (navigator.share) {
                // ‰ΩøÁî®Web Share API
                navigator.share({
                    title: 'ÂÖ≠Âì•Ëç£ËÄÄWIKIËØÑËÆ∫ÂàÜ‰∫´',
                    text: shareText,
                    url: shareUrl
                }).catch(console.error);
            } else {
                // ÂõûÈÄÄÊñπÊ°àÔºöÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('ËØÑËÆ∫ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                }).catch(() => {
                    // ÊúÄÂêéÁöÑÂõûÈÄÄÔºöÊòæÁ§∫ÂàÜ‰∫´ÊñáÊú¨
                    prompt('Â§çÂà∂‰ª•‰∏ãÈìæÊé•ÂàÜ‰∫´ËØÑËÆ∫Ôºö', shareUrl);
                });
            }
        }
        
        // ==================== ËØÑËÆ∫ËøáÊª§ÂäüËÉΩ ====================
        function handleFilterChange() {
            currentCommentFilter.pinned = document.getElementById('filterPinned')?.checked ?? true;
            currentCommentFilter.withImages = document.getElementById('filterWithImages')?.checked ?? false;
            
            applyCommentFilters();
        }
        
        function searchComments(query) {
            currentCommentFilter.searchQuery = query.toLowerCase();
            applyCommentFilters();
        }
        
        function applyCommentFilters() {
            const comments = document.querySelectorAll('.comment-item');
            let visibleCount = 0;
            
            comments.forEach(comment => {
                const isPinned = comment.classList.contains('pinned');
                const hasImage = comment.classList.contains('has-image');
                const content = comment.querySelector('.comment-content').textContent.toLowerCase();
                const author = comment.querySelector('.author-name').textContent.toLowerCase();
                
                let shouldShow = true;
                
                // ËøáÊª§ÁΩÆÈ°∂ËØÑËÆ∫
                if (!currentCommentFilter.pinned && isPinned) {
                    shouldShow = false;
                }
                
                // ËøáÊª§Â∏¶ÂõæËØÑËÆ∫
                if (currentCommentFilter.withImages && !hasImage) {
                    shouldShow = false;
                }
                
                // ÊêúÁ¥¢ËøáÊª§
                if (currentCommentFilter.searchQuery) {
                    if (!content.includes(currentCommentFilter.searchQuery) && 
                        !author.includes(currentCommentFilter.searchQuery)) {
                        shouldShow = false;
                    }
                }
                
                // Â∫îÁî®ÊòæÁ§∫/ÈöêËóè
                comment.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÂèØËßÅÁöÑËØÑËÆ∫
            if (visibleCount === 0) {
                showEmptyComments();
            }
        }
        
        // ==================== ÊéíÂ∫èÂäüËÉΩ ====================
        function handleSortButtonClick(e) {
            const button = e.currentTarget;
            const sortType = button.dataset.sort;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // Êõ¥Êñ∞ÊéíÂ∫èÂπ∂ÈáçÊñ∞Âä†ËΩΩ
            commentCurrentSort = sortType;
            commentCurrentPage = 1;
            loadComments(commentCurrentPage, commentCurrentSort);
        }
        
        // ==================== ÂàÜÈ°µÂäüËÉΩ ====================
        function loadPrevPage() {
            if (commentCurrentPage > 1) {
                commentCurrentPage--;
                loadComments(commentCurrentPage, commentCurrentSort);
                scrollToCommentsTop();
            }
        }
        
        function loadNextPage() {
            if (commentCurrentPage < commentTotalPages) {
                commentCurrentPage++;
                loadComments(commentCurrentPage, commentCurrentSort);
                scrollToCommentsTop();
            }
        }
        
        function changePageSize(size) {
            commentPageSize = parseInt(size);
            commentCurrentPage = 1;
            loadComments(commentCurrentPage, commentCurrentSort);
        }
        
        function updateCommentPagination() {
            safeSetText('currentPage', commentCurrentPage.toString());
            safeSetText('totalPages', commentTotalPages.toString());
            
            const prevBtn = document.querySelector('[onclick="loadPrevPage()"]');
            const nextBtn = document.querySelector('[onclick="loadNextPage()"]');
            
            if (prevBtn) {
                prevBtn.disabled = commentCurrentPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = commentCurrentPage >= commentTotalPages;
            }
        }
        
        // ==================== ËØÑËÆ∫ÁªüËÆ°ÂäüËÉΩ ====================
        async function loadCommentStats() {
            try {
                // ÊÄªËØÑËÆ∫Êï∞
                const { count: total, error: totalError } = await supabaseClient
                    .from('comments')
                    .select('*', { count: 'exact', head: true })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('is_hidden', false);
                
                if (!totalError) {
                    commentTotalCount = total || 0;
                    safeSetText('totalComments', commentTotalCount.toString());
                }
                
                // ÂîØ‰∏ÄÁî®Êà∑Êï∞
                const { data: uniqueUsers, error: usersError } = await supabaseClient
                    .from('comments')
                    .select('user_id', { distinct: true })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('is_hidden', false);
                
                if (!usersError && uniqueUsers) {
                    commentUniqueUsers = uniqueUsers.length;
                    safeSetText('uniqueUsers', commentUniqueUsers.toString());
                }
                
                // ÁÉ≠Èó®ËØÑËÆ∫Êï∞ÔºàÁÇπËµûÂ§ß‰∫é5Ôºâ
                const { count: hotCount, error: hotError } = await supabaseClient
                    .from('comments')
                    .select('*', { count: 'exact', head: true })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('is_hidden', false)
                    .gt('likes_count', 5);
                
                if (!hotError) {
                    commentHotCount = hotCount || 0;
                    safeSetText('hotComments', commentHotCount.toString());
                }
                
                // ‰ªäÊó•Ê¥ªË∑ÉÁî®Êà∑Êï∞
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: todayUsers, error: todayError } = await supabaseClient
                    .from('comments')
                    .select('user_id', { distinct: true })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('is_hidden', false)
                    .gte('created_at', today.toISOString());
                
                if (!todayError && todayUsers) {
                    commentTodayActive = todayUsers.length;
                    safeSetText('todayActive', commentTodayActive.toString());
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩËØÑËÆ∫ÁªüËÆ°Â§±Ë¥•:', error);
            }
        }
        
        async function updateCommentStats() {
            await loadCommentStats();
        }
        
        // ==================== ÊªöÂä®ÂäüËÉΩ ====================
        function setupCommentScrollEvents() {
            const commentsSection = document.getElementById('commentsSection');
            const backToTopBtn = document.querySelector('.back-to-comments-top');
            
            if (!commentsSection || !backToTopBtn) return;
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                });
            }, { threshold: 0.1 });
            
            observer.observe(commentsSection);
        }
        
        function scrollToCommentsTop() {
            const commentsSection = document.getElementById('commentsSection');
            if (commentsSection) {
                commentsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // ==================== ÈîôËØØÂ§ÑÁêÜ ====================
        function showCommentLoadError() {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            commentsList.innerHTML = `
                <div class="empty-comments">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•</h3>
                    <p>ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï</p>
                    <button onclick="reloadComments()" class="btn-submit" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> ÈáçÊñ∞Âä†ËΩΩ
                    </button>
                </div>
            `;
        }
        
        function showEmptyComments() {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            commentsList.innerHTML = `
                <div class="empty-comments">
                    <i class="fas fa-comment-slash"></i>
                    <h3>ËøòÊ≤°ÊúâËØÑËÆ∫</h3>
                    <p>Âø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫ÂêßÔºÅ</p>
                    ${!currentUser ? `
                        <button onclick="window.location.href='login-real.html?redirect=' + encodeURIComponent(window.location.pathname)" 
                                class="btn-submit" style="margin-top: 15px;">
                            <i class="fas fa-sign-in-alt"></i> ÁôªÂΩïÂêéËØÑËÆ∫
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        // ==================== ÁôªÂΩïÊèêÁ§∫ ====================
        function showLoginPrompt() {
            const commentFormContainer = document.getElementById('commentFormContainer');
            const commentsList = document.getElementById('commentsList');
            
            if (commentFormContainer) {
                commentFormContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-user-lock" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-highlight); margin-bottom: 10px;">ÁôªÂΩïÂêéÂèÇ‰∏éËÆ®ËÆ∫</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">ÁôªÂΩïÂêéÂèØ‰ª•ÂèëË°®ËØÑËÆ∫„ÄÅÁÇπËµû„ÄÅÂõûÂ§çÂíåÊî∂Ëóè</p>
                        <button onclick="window.location.href='login-real.html?redirect=' + encodeURIComponent(window.location.pathname)" 
                                class="btn-submit" style="padding: 12px 24px;">
                            <i class="fas fa-sign-in-alt"></i> Á´ãÂç≥ÁôªÂΩï
                        </button>
                    </div>
                `;
            }
            
            if (commentsList) {
                loadCommentsAsGuest();
            }
        }
        
        async function loadCommentsAsGuest() {
            try {
                const { data: comments, error } = await supabaseClient
                    .from('comments')
                    .select('*, user:user_profiles(username, avatar_url, is_admin, is_verified)', { count: 'exact' })
                    .eq('page_type', 'index')
                    .eq('page_id', 'home')
                    .eq('parent_id', null)
                    .eq('is_hidden', false)
                    .eq('is_private', false)
                    .order('created_at', { ascending: false })
                    .limit(commentPageSize);
                
                if (error) throw error;
                
                commentTotalCount = comments?.length || 0;
                
                if (comments && comments.length > 0) {
                    renderComments(comments);
                } else {
                    showEmptyComments();
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÊ∏∏ÂÆ¢ËØÑËÆ∫Â§±Ë¥•:', error);
                showEmptyComments();
            }
        }
        
        // ==================== ÂÆûÊó∂ËÆ¢ÈòÖ ====================
        function subscribeToComments() {
            if (!supabaseClient) return;
            
            const commentsChannel = supabaseClient
                .channel('comments-realtime')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'comments',
                        filter: 'page_type=eq.index AND page_id=eq.home AND parent_id=is.null'
                    },
                    async (payload) => {
                        console.log('ËØÑËÆ∫ÂÆûÊó∂Êõ¥Êñ∞:', payload);
                        
                        // Â¶ÇÊûúÊòØÊñ∞ËØÑËÆ∫‰∏îÁî®Êà∑Ê≠£Âú®Êü•ÁúãÊúÄÊñ∞ËØÑËÆ∫
                        if (payload.eventType === 'INSERT' && commentCurrentSort === 'newest' && commentCurrentPage === 1) {
                            // ÈáçÊñ∞Âä†ËΩΩÁ¨¨‰∏ÄÈ°µ
                            await loadComments(1, 'newest');
                            
                            // ÊòæÁ§∫Êñ∞ËØÑËÆ∫ÊèêÁ§∫
                            if (payload.new.user_id !== currentUser?.id) {
                                showNewCommentNotification(payload.new);
                            }
                        }
                        // Â¶ÇÊûúÊòØÊõ¥Êñ∞ÊàñÂà†Èô§ÔºåÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÈ°µ
                        else if (payload.eventType === 'UPDATE' || payload.eventType === 'DELETE') {
                            await reloadComments();
                        }
                    }
                )
                .subscribe();
            
            // ËÆ¢ÈòÖÁÇπËµûÂèòÂåñ
            const likesChannel = supabaseClient
                .channel('likes-realtime')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'comment_likes'
                    },
                    (payload) => {
                        const commentId = payload.new?.comment_id || payload.old?.comment_id;
                        if (commentId) {
                            updateCommentLikeStatus(commentId);
                        }
                    }
                )
                .subscribe();
        }
        
        function showNewCommentNotification(comment) {
            const username = comment.user?.username || 'ÊúâÁî®Êà∑';
            
            const notification = document.createElement('div');
            notification.className = 'notification info';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--card-bg);
                color: var(--text-highlight);
                padding: 12px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 10000;
                transform: translateX(120%);
                transition: transform 0.4s ease;
                border-left: 4px solid var(--text-highlight);
                max-width: 300px;
                cursor: pointer;
            `;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">Êñ∞ËØÑËÆ∫</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    ${username} ÂèëË°®‰∫ÜÊñ∞ËØÑËÆ∫
                </div>
            `;
            
            notification.onclick = () => {
                notification.remove();
                if (comment.id) {
                    const commentElement = document.getElementById(`comment-${comment.id}`);
                    if (commentElement) {
                        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        commentElement.classList.add('highlight');
                        setTimeout(() => {
                            commentElement.classList.remove('highlight');
                        }, 3000);
                    }
                }
            };
            
            document.body.appendChild(notification);
            
            // ÊòæÁ§∫ÈÄöÁü•
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 5ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 5000);
        }
        
        // ==================== ÂõæÁâáÁÅØÁÆ± ====================
        function openImageLightbox(src) {
            const lightbox = document.createElement('div');
            lightbox.className = 'image-lightbox';
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            lightbox.innerHTML = `
                <img src="${src}" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 4px;">
                <button style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(lightbox);
            
            // ÁÇπÂáªÂÖ≥Èó≠
            lightbox.onclick = (e) => {
                if (e.target === lightbox || e.target.closest('button')) {
                    lightbox.style.opacity = '0';
                    setTimeout(() => {
                        if (lightbox.parentNode) {
                            lightbox.parentNode.removeChild(lightbox);
                        }
                    }, 300);
                }
            };
            
            // ESCÈîÆÂÖ≥Èó≠
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    if (lightbox.parentNode) {
                        lightbox.parentNode.removeChild(lightbox);
                    }
                    document.removeEventListener('keydown', handleKeydown);
                }
            };
            
            document.addEventListener('keydown', handleKeydown);
        }
        
        // ==================== Ê†ºÂºèÂåñËØÑËÆ∫ÂÜÖÂÆπ ====================
        function formatCommentContent(content) {
            if (!content) return '';
            
            // ËΩ¨‰πâHTML
            let formatted = escapeHtml(content);
            
            // ËΩ¨Êç¢Êç¢Ë°å
            formatted = formatted.replace(/\n/g, '<br>');
            
            // ËΩ¨Êç¢ÈìæÊé•
            formatted = formatted.replace(/https?:\/\/[^\s<]+/g, url => {
                const displayUrl = url.length > 50 ? url.substring(0, 47) + '...' : url;
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-highlight); text-decoration: underline; word-break: break-all;">${displayUrl}</a>`;
            });
            
            // ËΩ¨Êç¢ÂõæÁâá
            formatted = formatted.replace(/!\[(.*?)\]\((data:image\/[^)]+)\)/g, (match, alt, src) => {
                return `<img src="${src}" alt="${escapeHtml(alt)}" style="max-width: 100%; border-radius: var(--radius); margin: 10px 0; cursor: zoom-in;" loading="lazy">`;
            });
            
            // ËΩ¨Êç¢Á≤ó‰Ωì
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // ËΩ¨Êç¢Êñú‰Ωì
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // ËΩ¨Êç¢‰ª£Á†ÅÂùó
            formatted = formatted.replace(/```([\s\S]*?)```/g, (match, code) => {
                return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
            });
            
            // ËΩ¨Êç¢Ë°åÂÜÖ‰ª£Á†Å
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // ËΩ¨Êç¢Ë°®ÊÉÖÁ¨¶Âè∑ÁÆÄÁ†Å
            const emojiMap = {
                ':smile:': 'üòä',
                ':laugh:': 'üòÑ',
                ':heart:': '‚ù§Ô∏è',
                ':thumbsup:': 'üëç',
                ':fire:': 'üî•',
                ':star:': '‚≠ê',
                ':clap:': 'üëè',
                ':rocket:': 'üöÄ',
                ':tada:': 'üéâ',
                ':100:': 'üíØ'
            };
            
            for (const [shortcode, emoji] of Object.entries(emojiMap)) {
                formatted = formatted.replace(new RegExp(shortcode, 'g'), emoji);
            }
            
            return formatted;
        }
        
        // ==================== Êõ¥Êñ∞ËØÑËÆ∫Ë°®ÂçïÂ§¥ÂÉè ====================
        function updateCommentFormAvatar() {
            const avatarPlaceholder = document.getElementById('commentAvatarPlaceholder');
            if (!avatarPlaceholder || !currentUser) return;
            
            const username = userProfile?.username || currentUser.user_metadata?.username || currentUser.email.split('@')[0];
            const avatarLetter = username.charAt(0).toUpperCase();
            
            avatarPlaceholder.innerHTML = `
                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--supabase-blue), var(--supabase-purple)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                    ${avatarLetter}
                </div>
            `;
        }
        
        // ==================== ÊâìÂç∞‰ºòÂåñ ====================
        window.addEventListener('beforeprint', () => {
            document.body.classList.add('printing');
        });
        
        window.addEventListener('afterprint', () => {
            document.body.classList.remove('printing');
        });
        
        // ==================== ÊÄßËÉΩÁõëÊéß ====================
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const timing = performance.timing;
                    const loadTime = timing.loadEventEnd - timing.navigationStart;
                    console.log(`È°µÈù¢ÊÄªÂä†ËΩΩÊó∂Èó¥: ${loadTime}ms`);
                }, 0);
            });
        }
        
        // ==================== ÁôªÂΩïÈáçÂÆöÂêëÂäüËÉΩ ====================
        function checkLoginRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('login') === 'success') {
                showNotification('ÁôªÂΩïÊàêÂäüÔºÅÊ¨¢ËøéÂõûÊù•~', 'success');
                // ÁßªÈô§URLÂèÇÊï∞
                history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // Âú®È°µÈù¢Âä†ËΩΩÂêéÊ£ÄÊü•
        setTimeout(checkLoginRedirect, 500);
        
        // ==================== Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅÈ™åËØÅ ====================
        // ÂÆöÊúüÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºàÊØè5ÂàÜÈíü‰∏ÄÊ¨°Ôºâ
        setInterval(async () => {
            if (currentUser && supabaseClient) {
                try {
                    const { data: { user }, error } = await supabaseClient.auth.getUser();
                    if (error || !user) {
                        // ÁôªÂΩïÁä∂ÊÄÅÂ§±Êïà
                        currentUser = null;
                        userProfile = null;
                        localStorage.removeItem('user');
                        updateUserUI();
                        showNotification('ÁôªÂΩïÁä∂ÊÄÅÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'warning');
                    }
                } catch (error) {
                    console.error('ÁôªÂΩïÁä∂ÊÄÅÈ™åËØÅÂ§±Ë¥•:', error);
                }
            }
        }, 5 * 60 * 1000); // 5ÂàÜÈíü
        
        // ==================== Ëá™Âä®Â°´ÂÖÖÊµãËØïË¥¶Âè∑Ôºà‰ªÖÂºÄÂèëÁéØÂ¢ÉÔºâ ====================
        function checkAndFillTestAccount() {
            // ‰ªÖÊú¨Âú∞ÁéØÂ¢É‰∏îÁî®Êà∑Êú™ÁôªÂΩïÊó∂ÊòæÁ§∫
            if ((window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && !currentUser) {
                const testHint = document.createElement('div');
                testHint.style.cssText = `
                    position: fixed;
                    bottom: 160px;
                    right: 20px;
                    background: rgba(62, 207, 142, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    z-index: 9998;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    transition: all 0.3s;
                    max-width: 200px;
                `;
                testHint.innerHTML = 'üë®‚Äçüíª ÂºÄÂèëÊèêÁ§∫Ôºö<br>ÊµãËØïË¥¶Âè∑Â∑≤ÂèØÁî®';
                testHint.onclick = () => {
                    window.location.href = 'login-real.html';
                };
                testHint.onmouseover = () => {
                    testHint.style.transform = 'translateY(-2px)';
                    testHint.style.boxShadow = '0 6px 16px rgba(0,0,0,0.3)';
                };
                testHint.onmouseout = () => {
                    testHint.style.transform = 'translateY(0)';
                    testHint.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                };
                document.body.appendChild(testHint);
                
                // 10ÁßíÂêéËá™Âä®ÈöêËóè
                setTimeout(() => {
                    testHint.style.opacity = '0';
                    testHint.style.transform = 'translateY(20px)';
                    setTimeout(() => testHint.remove(), 300);
                }, 10000);
            }
        }
        
        // ==================== ‰øÆÂ§çÔºöÁ°Æ‰øùÂØºËà™Ê†è‰∏ç‰ºöË¢´ÈÅÆÊå° ====================
        window.addEventListener('scroll', function() {
            const nav = document.querySelector('.top-nav');
            if (nav) {
                if (window.scrollY > 50) {
                    nav.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
                    nav.style.background = 'var(--card-bg)';
                } else {
                    nav.style.boxShadow = 'var(--shadow)';
                }
            }
        });
        
        // ==================== ÁßªÂä®Á´Ø‰ºòÂåñ ====================
        if ('ontouchstart' in window) {
            document.documentElement.style.cursor = 'pointer';
        }
        
        // Âª∂ËøüÊâßË°åÊµãËØïË¥¶Âè∑ÊèêÁ§∫
        setTimeout(checkAndFillTestAccount, 1500);
    </script>
</body>
</html>