<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", "PingFang SC", sans-serif; }
        body { background: transparent; padding: 0; margin: 0; height: 100%; }
        
        /* æ’­æ”¾å™¨ä¸»ä½“ - ä¿æŒåŸæ · */
        .player-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            width: 420px;
            max-width: 90vw;
            background: linear-gradient(135deg, #1e3a2f 0%, #2d5243 100%);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 1px solid #3d725f;
            padding: 20px;
            transition: all 0.3s ease;
        }

        /* ç»“æ„ä¿æŒä¸å˜ */
        .mini-music-player {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* æ‰€æœ‰æ ·å¼éƒ½ä¸éœ€è¦ä¿®æ”¹ */
        .player-cover {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: #2d5243;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            position: relative;
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .player-cover.playing img {
            animation: rotateCover 20s linear infinite;
        }
        
        @keyframes rotateCover {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .player-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
        }
        
        .player-title {
            font-size: 1.2rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .player-singer {
            font-size: 0.9rem;
            color: #99aabb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }
        
        .player-btn {
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.2rem;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .play-main-btn {
            background: linear-gradient(135deg, #81c784 0%, #4caf50 100%);
            color: #121212;
            font-size: 1.4rem;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.4);
        }
        
        .prev-next-btn {
            font-size: 1.3rem;
        }
        
        .play-main-btn:hover {
            background: linear-gradient(135deg, #a8d0b9 0%, #66bb6a 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(129, 199, 132, 0.5);
        }
        
        .player-btn:not(.play-main-btn):hover {
            background: rgba(129, 199, 132, 0.15);
            color: #a8d0b9;
        }
        
        .player-progress {
            margin-top: 16px;
        }
        
        .progress-bar-mini {
            width: 100%;
            height: 6px;
            background: #2d5243;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .progress-mini {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #81c784 0%, #4caf50 100%);
            border-radius: 3px;
            transition: width 0.1s linear;
        }
        
        .progress-thumb {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #81c784;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px rgba(129, 199, 132, 0.8);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .progress-bar-mini:hover .progress-thumb {
            opacity: 1;
        }
        
        .time-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #99aabb;
            margin-top: 8px;
        }
        
        .loop-mode-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #2d5243;
            color: #81c784;
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .loop-btn:hover .loop-mode-tooltip {
            opacity: 1;
        }
        
        .player-volume {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }
        
        .volume-btn {
            background: transparent;
            border: none;
            color: #99aabb;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .volume-btn:hover {
            color: #81c784;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: #2d5243;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .volume-slider:hover {
            opacity: 1;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #81c784;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.5);
        }
        
        #backgroundAudio { display: none; }
        
        @media (max-width: 480px) {
            .player-container {
                width: 92vw;
                bottom: 10px;
                padding: 16px;
            }
            
            .player-cover {
                width: 60px;
                height: 60px;
            }
            
            .player-title {
                font-size: 1rem;
            }
            
            .player-singer {
                font-size: 0.8rem;
            }
            
            .player-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .play-main-btn {
                width: 42px;
                height: 42px;
                font-size: 1.2rem;
            }
            
            .prev-next-btn {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="player-container" id="playerContainer">
        <div class="mini-music-player">
            <div class="player-cover" id="playerCover">
                <img src="" alt="å°é¢" id="coverImage">
            </div>
            
            <div class="player-info">
                <div class="player-title" id="playerTitleText">åŠ è½½ä¸­...</div>
                <div class="player-singer" id="playerSinger"></div>
            </div>
            
            <div class="player-controls">
                <!-- ä¸Šä¸€é¦–æŒ‰é’® - å½“æœ‰å¤šé¦–æ­Œæ—¶æ˜¾ç¤º -->
                <button class="player-btn prev-next-btn" id="prevBtn" tabindex="0" style="display: none;">â®</button>
                
                <button class="player-btn play-main-btn" id="miniPlayBtn" tabindex="0">â–¶</button>
                
                <!-- ä¸‹ä¸€é¦–æŒ‰é’® - å½“æœ‰å¤šé¦–æ­Œæ—¶æ˜¾ç¤º -->
                <button class="player-btn prev-next-btn" id="nextBtn" tabindex="0" style="display: none;">â¯</button>
                
                <button class="player-btn loop-btn" id="loopBtn" tabindex="0">
                    ğŸ”
                    <div class="loop-mode-tooltip" id="loopTooltip">é¡ºåºæ’­æ”¾</div>
                </button>
                
                <div class="player-volume">
                    <button class="volume-btn" id="volumeBtn" tabindex="0">ğŸ”Š</button>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                </div>
            </div>
        </div>
        
        <div class="player-progress">
            <div class="progress-bar-mini" id="miniProgressBar">
                <div class="progress-mini" id="miniProgress"></div>
                <div class="progress-thumb" id="progressThumb"></div>
            </div>
            <div class="time-mini">
                <span class="current-time-mini" id="currentTime">00:00</span>
                <span class="total-time-mini" id="totalTime">--:--</span>
            </div>
        </div>
        
        <audio id="backgroundAudio" preload="metadata" playsinline>
            <!-- éŸ³é¢‘æºç”±JavaScriptåŠ¨æ€è®¾ç½® -->
        </audio>
    </div>

<script>
    const songList = [{
        title: 'æ˜”æ¶Ÿ',
        singer: 'å¼ éŸ¶æ¶µã€HOYO-MiX',
        audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3',
        duration: '03:06',
        durationSeconds: 186,
        coverUrl: 'http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300'
    }, {
        title: 'è€€æ–‘',
        singer: 'HOYO-MiX,YMIR',
        audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3',
        duration: '03:33',
        durationSeconds: 213,
        coverUrl: 'http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300'
    }, {
        title: 'æ‹‚æ™“ Proi Proi',
        singer: 'HOYO-MiX,NIDA',
        audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3',
        duration: '03:58',
        durationSeconds: 238,
        coverUrl: 'http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300'
    }];
    // ğŸµ ========== ä»¥ä¸Šæ˜¯å”¯ä¸€éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ ========== ğŸµ

    // å¾ªç¯æ¨¡å¼å®šä¹‰
    const LOOP_MODE = { 
        SEQUENCE: 0,      // é¡ºåºæ’­æ”¾
        LIST_LOOP: 1,     // åˆ—è¡¨å¾ªç¯
        SINGLE_LOOP: 2    // å•æ›²å¾ªç¯
    };

    // è‡ªåŠ¨æ£€æµ‹å¾ªç¯æ¨¡å¼
    const AUTO_LOOP_MODE = songList.length > 1 ? LOOP_MODE.LIST_LOOP : LOOP_MODE.SINGLE_LOOP;

    // åˆå§‹åŒ–æ’­æ”¾çŠ¶æ€
    let playState = JSON.parse(localStorage.getItem('musicPlayerState')) || {
        currentSongIndex: 0,
        isPlaying: false,
        currentTime: 0,
        volume: 0.7,
        loopMode: AUTO_LOOP_MODE
    };

    // è·å–DOMå…ƒç´ 
    const backgroundAudio = document.getElementById('backgroundAudio');
    const playBtn = document.getElementById('miniPlayBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progress = document.getElementById('miniProgress');
    const progressThumb = document.getElementById('progressThumb');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const loopBtn = document.getElementById('loopBtn');
    const loopTooltip = document.getElementById('loopTooltip');
    const playerTitleText = document.getElementById('playerTitleText');
    const playerSinger = document.getElementById('playerSinger');
    const playerCover = document.getElementById('playerCover');
    const coverImage = document.getElementById('coverImage');
    const progressBar = document.getElementById('miniProgressBar');

    let progressUpdateTimer = null;

    // ========== å·¥å…·å‡½æ•° ==========
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    function getVolumeIcon(volume) {
        return volume > 0.5 ? 'ğŸ”Š' : volume > 0 ? 'ğŸ”‰' : 'ğŸ”‡';
    }

    function savePlayState() {
        playState.currentTime = backgroundAudio.currentTime;
        playState.volume = backgroundAudio.volume;
        localStorage.setItem('musicPlayerState', JSON.stringify(playState));
    }

    // ========== æ ¸å¿ƒåŠŸèƒ½ ==========
    function updatePlayerUI() {
        const currentSong = songList[playState.currentSongIndex];
        
        // æ›´æ–°æ­Œæ›²ä¿¡æ¯
        playerTitleText.textContent = currentSong.title;
        playerSinger.textContent = currentSong.singer;
        totalTimeEl.textContent = currentSong.duration;
        
        // æ›´æ–°å°é¢
        coverImage.src = currentSong.coverUrl;
        coverImage.alt = currentSong.title;
        
        // æ›´æ–°æ’­æ”¾æŒ‰é’®
        playBtn.textContent = playState.isPlaying ? 'â¸' : 'â–¶';
        
        // æ›´æ–°éŸ³é‡
        volumeSlider.value = playState.volume;
        volumeBtn.textContent = getVolumeIcon(playState.volume);
        
        // æ›´æ–°å¾ªç¯æ¨¡å¼
        updateLoopModeUI();
        
        // æ›´æ–°è¿›åº¦æ¡
        updateProgressBar();
        
        // æ§åˆ¶ä¸Šä¸‹é¦–æŒ‰é’®æ˜¾ç¤º
        controlPrevNextButtons();
        
        // å°é¢æ—‹è½¬
        updateCoverAnimation();
    }

    function updateLoopModeUI() {
        switch (playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                loopBtn.textContent = 'ğŸ”';
                loopTooltip.textContent = 'é¡ºåºæ’­æ”¾';
                break;
            case LOOP_MODE.LIST_LOOP:
                loopBtn.textContent = 'ğŸ”„';
                loopTooltip.textContent = 'åˆ—è¡¨å¾ªç¯';
                break;
            case LOOP_MODE.SINGLE_LOOP:
                loopBtn.textContent = 'ğŸ”‚';
                loopTooltip.textContent = 'å•æ›²å¾ªç¯';
                break;
        }
    }

    function updateProgressBar() {
        const currentSong = songList[playState.currentSongIndex];
        const currentTime = playState.isPlaying ? backgroundAudio.currentTime : playState.currentTime;
        const percent = (currentTime / currentSong.durationSeconds) * 100;
        
        progress.style.width = `${percent}%`;
        progressThumb.style.left = `${percent}%`;
        currentTimeEl.textContent = formatTime(currentTime);
    }

    function controlPrevNextButtons() {
        // åªæœ‰ä¸€é¦–æ­Œæ—¶éšè—ä¸Šä¸‹é¦–æŒ‰é’®
        if (songList.length <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'flex';
            nextBtn.style.display = 'flex';
        }
    }

    function updateCoverAnimation() {
        if (playState.isPlaying && !playerCover.classList.contains('playing')) {
            playerCover.classList.add('playing');
        } else if (!playState.isPlaying && playerCover.classList.contains('playing')) {
            playerCover.classList.remove('playing');
        }
    }

    function switchSong(index) {
        // è¾¹ç•Œæ£€æŸ¥
        if (index < 0 || index >= songList.length) {
            if (playState.loopMode === LOOP_MODE.LIST_LOOP) {
                index = (index + songList.length) % songList.length;
            } else {
                return; // é¡ºåºæ’­æ”¾æ¨¡å¼ä¸‹ä¸åˆ‡æ¢
            }
        }
        
        playState.currentSongIndex = index;
        const newSong = songList[index];
        
        // åˆ‡æ¢éŸ³é¢‘
        backgroundAudio.src = newSong.audioUrl;
        backgroundAudio.currentTime = 0;
        playState.currentTime = 0;
        
        // å¦‚æœæ˜¯æ’­æ”¾çŠ¶æ€ï¼Œå¼€å§‹æ’­æ”¾æ–°æ­Œ
        if (playState.isPlaying) {
            backgroundAudio.play().then(() => {
                startProgressUpdate();
            }).catch(err => {
                console.error('æ’­æ”¾å¤±è´¥:', err);
                playState.isPlaying = false;
            });
        }
        
        savePlayState();
        updatePlayerUI();
    }

    // ========== è¿›åº¦æ¡æ§åˆ¶ ==========
    function startProgressUpdate() {
        if (progressUpdateTimer) clearInterval(progressUpdateTimer);
        progressUpdateTimer = setInterval(() => {
            if (playState.isPlaying && !backgroundAudio.paused) {
                updatePlayerUI();
            }
        }, 200);
    }

    function stopProgressUpdate() {
        if (progressUpdateTimer) {
            clearInterval(progressUpdateTimer);
            progressUpdateTimer = null;
        }
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    playBtn.addEventListener('click', () => {
        playState.isPlaying = !playState.isPlaying;
        
        if (playState.isPlaying) {
            // å¦‚æœæ˜¯ç¬¬ä¸€é¦–æ­Œä¸”ä»æœªæ’­æ”¾è¿‡ï¼Œå…ˆè®¾ç½®éŸ³é¢‘æº
            if (!backgroundAudio.src || backgroundAudio.src.includes('blob:')) {
                const currentSong = songList[playState.currentSongIndex];
                backgroundAudio.src = currentSong.audioUrl;
            }
            
            backgroundAudio.play().then(() => {
                startProgressUpdate();
                savePlayState();
                updatePlayerUI();
            }).catch(err => {
                console.error('æ’­æ”¾å¤±è´¥:', err);
                playState.isPlaying = false;
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡è¯•');
                updatePlayerUI();
            });
        } else {
            backgroundAudio.pause();
            playState.currentTime = backgroundAudio.currentTime;
            stopProgressUpdate();
            savePlayState();
            updatePlayerUI();
        }
    });

    prevBtn.addEventListener('click', () => {
        switchSong(playState.currentSongIndex - 1);
    });

    nextBtn.addEventListener('click', () => {
        switchSong(playState.currentSongIndex + 1);
    });

    volumeBtn.addEventListener('click', () => {
        if (playState.volume === 1) {
            playState.volume = 0.5;
        } else if (playState.volume === 0.5) {
            playState.volume = 0;
        } else {
            playState.volume = 1;
        }
        
        backgroundAudio.volume = playState.volume;
        updatePlayerUI();
        savePlayState();
    });

    volumeSlider.addEventListener('input', () => {
        playState.volume = parseFloat(volumeSlider.value);
        backgroundAudio.volume = playState.volume;
        updatePlayerUI();
        savePlayState();
    });

    loopBtn.addEventListener('click', () => {
        // æ ¹æ®æ­Œæ›²æ•°é‡è‡ªåŠ¨è°ƒæ•´å¯ç”¨çš„å¾ªç¯æ¨¡å¼
        let nextMode = (playState.loopMode + 1) % 3;
        
        // å¦‚æœåªæœ‰ä¸€é¦–æ­Œï¼Œè·³è¿‡åˆ—è¡¨å¾ªç¯
        if (songList.length === 1 && nextMode === LOOP_MODE.LIST_LOOP) {
            nextMode = LOOP_MODE.SINGLE_LOOP;
        }
        
        playState.loopMode = nextMode;
        savePlayState();
        updatePlayerUI();
    });

    progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const percent = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1) * 100;
        const currentSong = songList[playState.currentSongIndex];
        const newTime = (percent / 100) * currentSong.durationSeconds;
        
        backgroundAudio.currentTime = newTime;
        playState.currentTime = newTime;
        updatePlayerUI();
        savePlayState();
    });

    // ========== éŸ³é¢‘äº‹ä»¶ ==========
    backgroundAudio.addEventListener('ended', () => {
        switch (playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                // é¡ºåºæ’­æ”¾ï¼šæ’­æ”¾ä¸‹ä¸€é¦–ï¼Œå¦‚æœæ˜¯æœ€åä¸€é¦–åˆ™åœæ­¢
                if (playState.currentSongIndex < songList.length - 1) {
                    switchSong(playState.currentSongIndex + 1);
                } else {
                    playState.isPlaying = false;
                    stopProgressUpdate();
                    savePlayState();
                    updatePlayerUI();
                }
                break;
                
            case LOOP_MODE.LIST_LOOP:
                // åˆ—è¡¨å¾ªç¯ï¼šæ’­æ”¾ä¸‹ä¸€é¦–ï¼Œå¾ªç¯åˆ°ç¬¬ä¸€é¦–
                const nextIndex = (playState.currentSongIndex + 1) % songList.length;
                switchSong(nextIndex);
                break;
                
            case LOOP_MODE.SINGLE_LOOP:
                // å•æ›²å¾ªç¯ï¼šé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
                backgroundAudio.currentTime = 0;
                backgroundAudio.play();
                break;
        }
    });

    // ========== åˆå§‹åŒ– ==========
    window.addEventListener('load', () => {
        // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
        if (playState.currentSongIndex >= songList.length) {
            playState.currentSongIndex = 0;
        }
        
        // è®¾ç½®åˆå§‹çŠ¶æ€
        const currentSong = songList[playState.currentSongIndex];
        backgroundAudio.src = currentSong.audioUrl;
        backgroundAudio.volume = playState.volume;
        backgroundAudio.currentTime = playState.currentTime || 0;
        
        // ç«‹å³æ›´æ–°UI
        updatePlayerUI();
        
        // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾çŠ¶æ€ï¼Œå°è¯•ç»§ç»­æ’­æ”¾
        if (playState.isPlaying) {
            setTimeout(() => {
                backgroundAudio.play().then(() => {
                    startProgressUpdate();
                }).catch(() => {
                    // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’
                    playState.isPlaying = false;
                    savePlayState();
                    updatePlayerUI();
                });
            }, 500);
        }
        
        // å®šæœŸä¿å­˜çŠ¶æ€
        setInterval(savePlayState, 5000);
    });

    window.addEventListener('beforeunload', () => {
        savePlayState();
        stopProgressUpdate();
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !e.target.matches('input, textarea, button')) {
            e.preventDefault();
            playBtn.click();
        }
        
        if (e.code === 'ArrowLeft' && songList.length > 1) {
            e.preventDefault();
            prevBtn.click();
        }
        
        if (e.code === 'ArrowRight' && songList.length > 1) {
            e.preventDefault();
            nextBtn.click();
        }
    });

    // åˆå§‹UIæ›´æ–°
    updatePlayerUI();
</script>
</body>
</html>