<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Ë∑®È°µÈü≥‰πêÊí≠ÊîæÂô®ÔºàÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏ìÁî®Ôºâ</title>
    
    <style>
        :root {
            --bg-primary: #1e3a2f;
            --bg-secondary: #2d5243;
            --bg-hover: #284a3c;
            --text-primary: #fff;
            --text-secondary: #99aabb;
            --text-highlight: #81c784;
            --border-color: #3d725f;
            --accent-color: #81c784;
            --shadow-light: rgba(0,0,0,0.2);
            --shadow-medium: rgba(0,0,0,0.3);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 50%;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: "Microsoft YaHei", "PingFang SC", "Segoe UI", sans-serif; 
        }
        
        body { 
            background: transparent; 
            padding: 0; 
            margin: 0; 
            height: 100%; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ÈöêËóèÈü≥È¢ëÊéß‰ª∂ */
        #backgroundAudio, .preload-audio { 
            display: none; 
        }
        
        /* Êí≠ÊîæÂô®‰∏ª‰Ωì */
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            width: 100%;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Ê†∏ÂøÉÊí≠ÊîæÂå∫ */
        .mini-music-player {
            width: 100%;
            height: 80px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }
        
        /* Â∞ÅÈù¢Ê†∑Âºè */
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 2px 8px var(--shadow-medium);
            position: relative;
            transition: transform var(--transition-normal);
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-normal);
            will-change: transform;
        }
        
        /* Â∞ÅÈù¢ÊóãËΩ¨Âä®Áîª‰ºòÂåñ */
        .rotate-on-toggle {
            animation: rotateOnce 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes rotateOnce {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .player-cover:hover img {
            transform: scale(1.05);
        }
        
        /* Ê≠åÊõ≤‰ø°ÊÅØÂå∫ */
        .player-info {
            flex: 1;
            min-width: 150px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        
        .player-title {
            font-size: 1rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.2;
        }
        
        .player-singer {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        /* ÂàóË°®ÊåâÈíÆ */
        .song-list-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-highlight);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 10px;
            border-radius: 12px;
            margin-left: auto;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            outline: none;
            font-weight: 500;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .song-list-btn:hover,
        .song-list-btn:focus {
            background: var(--bg-secondary);
            border-color: var(--text-highlight);
            transform: translateY(-1px);
        }
        
        .song-list-btn:active {
            transform: translateY(0);
        }
        
        /* ÊéßÂà∂Âå∫ */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        
        .player-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: all var(--transition-fast);
            outline: none;
            position: relative;
        }
        
        .player-btn:focus-visible {
            outline: 2px solid var(--text-highlight);
            outline-offset: 2px;
        }
        
        .play-main-btn {
            background: var(--accent-color);
            color: #121212;
            font-size: 1.3rem;
            width: 44px;
            height: 44px;
            box-shadow: 0 -2px 6px rgba(129, 199, 132, 0.4);
            transition: all var(--transition-normal);
        }
        
        .play-main-btn:hover {
            background: #a8d0b9;
            transform: scale(1.05);
            box-shadow: 0 -2px 10px rgba(129, 199, 132, 0.6);
        }
        
        .play-main-btn:active {
            transform: scale(0.98);
        }
        
        .player-btn:not(.play-main-btn):hover {
            background: rgba(129, 199, 132, 0.15);
            color: #a8d0b9;
        }
        
        .player-btn.active {
            color: var(--accent-color);
            background: rgba(129, 199, 132, 0.1);
        }
        
        /* Èü≥ÈáèÊéßÂà∂Âå∫ */
        .player-volume {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        
        .volume-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            z-index: 99999;
            transition: all var(--transition-fast);
            outline: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .volume-btn:hover {
            color: var(--text-highlight);
            background: rgba(129, 199, 132, 0.1);
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            opacity: 1;
            transition: all var(--transition-fast);
            -webkit-appearance: none;
            appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.5);
            transition: transform var(--transition-fast);
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.5);
            border: none;
        }
        
        /* ËøõÂ∫¶Êù°Âå∫Âüü */
        .player-progress {
            width: 100%;
            padding: 0 16px 8px;
            box-sizing: border-box;
        }
        
        .progress-bar-mini {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            transition: height var(--transition-fast);
            overflow: hidden;
        }
        
        .progress-bar-mini:hover {
            height: 6px;
        }
        
        .progress-mini {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-color), #a8d0b9);
            border-radius: 2px;
            transition: width 0.1s linear;
        }
        
        .progress-thumb {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            transform: translate(-50%, -50%) scale(0);
            box-shadow: 0 0 6px rgba(129, 199, 132, 0.8);
            opacity: 0;
            transition: opacity var(--transition-fast), transform var(--transition-fast);
        }
        
        .progress-bar-mini:hover .progress-thumb {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .time-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Âæ™ÁéØÊ®°ÂºèÊèêÁ§∫ */
        .loop-mode-tooltip {
            position: absolute;
            bottom: 120%;
            right: 50%;
            transform: translateX(50%);
            background: var(--bg-secondary);
            color: var(--text-highlight);
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            display: none;
            white-space: nowrap;
            z-index: 100000;
            box-shadow: 0 2px 6px var(--shadow-medium);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .loop-btn:hover .loop-mode-tooltip {
            display: block;
            opacity: 1;
        }
        
        /* Ê≠åÊõ≤ÂàóË°®‰∏ãÊãâÊ°Ü */
        .dropdown-song-list {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            width: 100%;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            max-height: 320px;
            overflow-y: auto;
            z-index: 99998;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.4);
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .dropdown-song-list.show {
            display: block !important;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .song-list {
            list-style: none;
            padding: 0;
        }
        
        .song-list li {
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: background var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(61, 114, 95, 0.3);
        }
        
        .song-list li:last-child {
            border-bottom: none;
        }
        
        /* Á¨¨14È¶ñÂç†‰ΩçÁ¨¶Ê†∑Âºè */
        .song-list li.placeholder {
            color: #4a6e61;
            cursor: default;
            pointer-events: none;
            background: transparent;
            border-bottom: none;
        }
        
        .song-list li.active {
            background: var(--bg-secondary);
            color: var(--text-highlight);
            font-weight: 500;
            position: relative;
        }
        
        .song-list li.active::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-color);
        }
        
        .song-list li:hover:not(.active):not(.placeholder) {
            background: rgba(45, 82, 67, 0.5);
        }
        
        .song-duration {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .placeholder .song-duration {
            color: var(--border-color);
        }
        
        /* ÊªöÂä®Êù°‰ºòÂåñ */
        .dropdown-song-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .dropdown-song-list::-webkit-scrollbar-track {
            background: rgba(45, 82, 67, 0.3);
            border-radius: 3px;
        }
        
        .dropdown-song-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .dropdown-song-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-highlight);
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .mini-music-player {
                padding: 0 12px;
                gap: 12px;
                height: 70px;
            }
            
            .player-cover {
                width: 50px;
                height: 50px;
            }
            
            .play-main-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .player-btn {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .player-info {
                min-width: 120px;
            }
            
            .player-title {
                font-size: 0.9rem;
            }
            
            .player-singer {
                font-size: 0.75rem;
            }
            
            .volume-slider {
                width: 60px;
            }
            
            .dropdown-song-list {
                bottom: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .mini-music-player {
                padding: 0 8px;
                gap: 8px;
            }
            
            .player-cover {
                width: 45px;
                height: 45px;
                display: none; /* Âú®Â∞èÂ±èÂπï‰∏äÈöêËóèÂ∞ÅÈù¢ */
            }
            
            .player-controls {
                gap: 8px;
            }
            
            .player-btn:not(.play-main-btn) {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .play-main-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .player-volume {
                gap: 4px;
                padding: 0 4px;
            }
            
            .volume-slider {
                width: 50px;
            }
            
            .song-list li {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .song-duration {
                font-size: 0.75rem;
            }
        }
        
        /* Ëß¶Êë∏ËÆæÂ§á‰ºòÂåñ */
        @media (hover: none) and (pointer: coarse) {
            .player-btn, .song-list-btn, .volume-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .volume-slider::-webkit-slider-thumb {
                width: 16px;
                height: 16px;
            }
            
            .progress-bar-mini {
                height: 6px;
            }
            
            .progress-thumb {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
                width: 16px;
                height: 16px;
            }
            
            .song-list li {
                padding: 12px 16px;
            }
        }
        
        /* ÂáèÂ∞ëÂä®ÁîªËÆæÁΩÆ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- ‰øÆÊ≠£ÂêéÁöÑÈ¢ÑÂä†ËΩΩÈü≥È¢ëÂÆπÂô® -->
    <div id="preloadContainer" style="display:none;">
        <!-- È¢ÑÂä†ËΩΩÈü≥È¢ë -->
        <audio class="preload-audio" preload="metadata" playsinline></audio>
        <audio class="preload-audio" preload="metadata" playsinline></audio>
        <audio class="preload-audio" preload="metadata" playsinline></audio>
    </div>

    <!-- Ê≠åÊõ≤ÂàóË°®ÂÆπÂô® -->
    <div class="dropdown-song-list" id="dropdownSongList">
        <ul class="song-list" id="songListUl"></ul>
    </div>

    <!-- Êí≠ÊîæÂô®‰∏ª‰Ωì -->
    <div class="player-container" id="playerContainer">
        <div class="mini-music-player" id="draggablePlayer">
            <!-- ÊâÄÊúâÂ∞ÅÈù¢Âå∫Âüü -->
            <div class="player-cover" id="playerCover1">
                <img src="http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300" 
                     alt="ÊòîÊ∂ü‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover2" style="display:none;">
                <img src="http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300" 
                     alt="ËÄÄÊñë‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover3" style="display:none;">
                <img src="http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300" 
                     alt="ÊãÇÊôìProiProi‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover4" style="display:none;">
                <img src="http://p1.music.126.net/gtunmoxObQyoH01HzURNUw==/109951170292455448.jpg?param=300x300" 
                     alt="‰ΩïËÄÖ‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover5" style="display:none;">
                <img src="http://p1.music.126.net/jWx1g4PbZsIu9npNOlifzA==/109951170151255339.jpg?param=300x300" 
                     alt="Áù°Ëïâ‰πãÊ≠å‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover6" style="display:none;">
                <img src="http://p1.music.126.net/sZ-rACbFrybF0x_lI6XNMw==/109951169297766755.jpg?param=300x300" 
                     alt="‰∏çÁú†‰πãÂ§ú‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover7" style="display:none;">
                <img src="http://p1.music.126.net/arz1hBaMCVcVV3yktxpoGg==/109951172346365107.jpg?param=300x300" 
                     alt="MontagemMiau‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover8" style="display:none;">
                <img src="http://p1.music.126.net/ykljhikl5x5QXgYjiIvW8g==/109951163082689392.jpg?param=300x300" 
                     alt="Áå´ÁöÑËàûÊ≠•‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover9" style="display:none;">
                <img src="http://p2.music.126.net/6y-UleORITEDfD5K8I44Qw==/109951165493980841.jpg?param=300x300" 
                     alt="Á§∫‰æãÊ≠åÊõ≤9‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover10" style="display:none;">
                <img src="http://p2.music.126.net/rMVkn75VN1Wr8KkX505pvQ==/109951168596119971.jpg?param=300x300" 
                     alt="ÂèçÊ≠£(ÁãÆÂ≠êÂ∫ßÂπªÊÉ≥Êõ≤)‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover11" style="display:none;">
                <img src="http://p1.music.126.net/tAzWfNK5KALyV7OO2Vc3SA==/6068204674100518.jpg?param=300x300" 
                     alt="CountingStars‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover12" style="display:none;">
                <img src="http://p2.music.126.net/rqIc9szkJmBA3imeK8G1yA==/109951164451064842.jpg?param=300x300" 
                     alt="DJOkawari-FlowerDance‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            <div class="player-cover" id="playerCover13" style="display:none;">
                <img src="http://p2.music.126.net/rJ89Zcogw7fb0sckH_JE_A==/109951169990094058.jpg?param=300x300" 
                     alt="MyDarling‰∏ìËæëÂ∞ÅÈù¢" 
                     loading="lazy">
            </div>
            
            <!-- Ê≠åÊõ≤‰ø°ÊÅØÂå∫ -->
            <div class="player-info">
                <div class="player-title">
                    <span id="playerTitleText">ÊòîÊ∂ü</span>
                    <button class="song-list-btn" id="songListBtn" tabindex="0">ÂàóË°®</button>
                </div>
                <div class="player-singer" id="playerSinger">Âº†Èü∂Ê∂µ„ÄÅHOYO-MiX</div>
            </div>
            
            <!-- Êí≠ÊîæÊéßÂà∂Âå∫ -->
            <div class="player-controls">
                <button class="player-btn" id="miniPrevBtn" tabindex="0">‚ùÆ</button>
                <button class="player-btn play-main-btn" id="miniPlayBtn" tabindex="0">‚ñ∂</button>
                <button class="player-btn" id="miniNextBtn" tabindex="0">‚ùØ</button>
                <button class="player-btn loop-btn" id="loopBtn" title="ÂàáÊç¢Âæ™ÁéØÊ®°Âºè" tabindex="0">üîÅ</button>
                <div class="loop-mode-tooltip" id="loopTooltip">È°∫Â∫èÊí≠ÊîæÔºàÁÇπÂáªÂàáÊç¢ÂàóË°®Âæ™ÁéØÔºâ</div>
            </div>
            
            <!-- Èü≥ÈáèÊéßÂà∂Âå∫ -->
            <div class="player-volume">
                <button class="volume-btn" id="volumeBtn" tabindex="0">üîä</button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
            </div>
        </div>
        
        <!-- ËøõÂ∫¶Êù°Âå∫Âüü -->
        <div class="player-progress">
            <div class="progress-bar-mini" id="miniProgressBar">
                <div class="progress-mini" id="miniProgress"></div>
                <div class="progress-thumb" id="progressThumb"></div>
            </div>
            <div class="time-mini">
                <span class="current-time-mini" id="currentTime">00:00</span>
                <span class="total-time-mini" id="totalTime">03:06</span>
            </div>
        </div>
        
        <!-- ÂÖ®Â±ÄÈü≥È¢ëÂØπË±° -->
        <audio id="backgroundAudio" preload="metadata" playsinline>
            <source src="" type="audio/mpeg">
        </audio>
    </div>
<script>
    // ÈÖçÁΩÆÂ∏∏Èáè
    const SONGS = [
        { 
            id: 'song-1',
            coverId: 'playerCover1', 
            title: 'ÊòîÊ∂ü', 
            singer: 'Âº†Èü∂Ê∂µ„ÄÅHOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3', 
            duration: '03:06',
            imgUrl: 'http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300'
        },
        { 
            id: 'song-2',
            coverId: 'playerCover2', 
            title: 'ËÄÄÊñë', 
            singer: 'HOYO-MiX,YMIR', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3', 
            duration: '03:33',
            imgUrl: 'http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300'
        },
        { 
            id: 'song-3',
            coverId: 'playerCover3', 
            title: 'ÊãÇÊôì Proi Proi', 
            singer: 'HOYO-MiX,NIDA', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3', 
            duration: '03:58',
            imgUrl: 'http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300'
        },
        { 
            id: 'song-4',
            coverId: 'playerCover4', 
            title: '‰ΩïËÄÖ', 
            singer: 'Ë∞≠Êô∂,HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2658660685.mp3', 
            duration: '02:26',
            imgUrl: 'http://p1.music.126.net/gtunmoxObQyoH01HzURNUw==/109951170292455448.jpg?param=300x300'
        },
        { 
            id: 'song-5',
            coverId: 'playerCover5', 
            title: 'Áù°Ëïâ‰πãÊ≠å', 
            singer: 'HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2646986980.mp3', 
            duration: '00:17',
            imgUrl: 'http://p1.music.126.net/jWx1g4PbZsIu9npNOlifzA==/109951170151255339.jpg?param=300x300'
        },
        { 
            id: 'song-6',
            coverId: 'playerCover6', 
            title: '‰∏çÁú†‰πãÂ§ú', 
            singer: 'Âº†Êù∞,HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2122308127.mp3', 
            duration: '02:18',
            imgUrl: 'http://p1.music.126.net/sZ-rACbFrybF0x_lI6XNMw==/109951169297766755.jpg?param=300x300'
        },
        { 
            id: 'song-7',
            coverId: 'playerCover7', 
            title: 'Montagem Miau', 
            singer: 'Pudding_PD,METAMOON', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=3320816993.mp3', 
            duration: '02:19',
            imgUrl: 'http://p1.music.126.net/arz1hBaMCVcVV3yktxpoGg==/109951172346365107.jpg?param=300x300'
        },
        { 
            id: 'song-8',
            coverId: 'playerCover8', 
            title: 'Áå´ÁöÑËàûÊ≠•', 
            singer: 'Candy_Wind', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=523902194.mp3', 
            duration: '03:07',
            imgUrl: 'http://p1.music.126.net/ykljhikl5x5QXgYjiIvW8g==/109951163082689392.jpg?param=300x300'
        },
        { 
            id: 'song-9',
            coverId: 'playerCover9', 
            title: 'Á§∫‰æãÊ≠åÊõ≤9', 
            singer: 'Ê≠åÊâã9', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=1428234445.mp3', 
            duration: '03:20',
            imgUrl: 'http://p2.music.126.net/6y-UleORITEDfD5K8I44Qw==/109951165493980841.jpg?param=300x300'
        },
        { 
            id: 'song-10',
            coverId: 'playerCover10', 
            title: 'ÂèçÊ≠£ÔºàÁãÆÂ≠êÂ∫ßÂπªÊÉ≥Êõ≤Ôºâ', 
            singer: 'È´òÊ°•ÂçÉÊò•', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2045500209.mp3', 
            duration: '03:11',
            imgUrl: 'http://p2.music.126.net/rMVkn75VN1Wr8KkX505pvQ==/109951168596119971.jpg?param=300x300'
        },
        { 
            id: 'song-11',
            coverId: 'playerCover11', 
            title: 'Counting Stars', 
            singer: 'OneRepublic', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=28575553.mp3', 
            duration: '04:16',
            imgUrl: 'http://p1.music.126.net/tAzWfNK5KALyV7OO2Vc3SA==/6068204674100518.jpg?param=300x300'
        },
        { 
            id: 'song-12',
            coverId: 'playerCover12', 
            title: 'DJ Okawari-Flower Dance', 
            singer: 'Chopin Remix', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=1405903472.mp3', 
            duration: '04:07',
            imgUrl: 'http://p2.music.126.net/rqIc9szkJmBA3imeK8G1yA==/109951164451064842.jpg?param=300x300'
        },
        { 
            id: 'song-13',
            coverId: 'playerCover13', 
            title: 'My Darling', 
            singer: 'FLAVOREALM!Âë≥‰πãÈ¢ÜÂüü,Dyako', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2630666360.mp3', 
            duration: '03:39',
            imgUrl: 'http://p2.music.126.net/rJ89Zcogw7fb0sckH_JE_A==/109951169990094058.jpg?param=300x300'
        }
    ];
    
    // Âæ™ÁéØÊ®°ÂºèÊûö‰∏æ
    const LOOP_MODES = {
        SEQUENCE: 0,   // È°∫Â∫èÊí≠Êîæ
        LIST_LOOP: 1,  // ÂàóË°®Âæ™ÁéØ
        SINGLE_LOOP: 2 // ÂçïÊõ≤Âæ™ÁéØ
    };
    
    // Êí≠ÊîæÂô®Áä∂ÊÄÅ
    const DEFAULT_STATE = {
        currentSongIndex: 0,
        isPlaying: false,
        currentTime: 0,
        volume: 0.7,
        loopMode: LOOP_MODES.SEQUENCE
    };
    
    // ÂÖ®Â±ÄÂèòÈáè
    let playerState = { ...DEFAULT_STATE };
    let isDragging = false;
    let isProgressDragging = false;
    let songListOpen = false;
    let progressUpdateInterval = null;

    // DOMÂÖÉÁ¥†ÁºìÂ≠ò
    const elements = {
        // Èü≥È¢ëÂÖÉÁ¥†
        audio: document.getElementById('backgroundAudio'),
        preloadAudios: document.querySelectorAll('.preload-audio'),
        
        // ÊéßÂà∂ÂÖÉÁ¥†
        playBtn: document.getElementById('miniPlayBtn'),
        prevBtn: document.getElementById('miniPrevBtn'),
        nextBtn: document.getElementById('miniNextBtn'),
        loopBtn: document.getElementById('loopBtn'),
        loopTooltip: document.getElementById('loopTooltip'),
        volumeBtn: document.getElementById('volumeBtn'),
        volumeSlider: document.getElementById('volumeSlider'),
        
        // ÊòæÁ§∫ÂÖÉÁ¥†
        playerTitle: document.getElementById('playerTitleText'),
        playerSinger: document.getElementById('playerSinger'),
        currentTime: document.getElementById('currentTime'),
        totalTime: document.getElementById('totalTime'),
        
        // ËøõÂ∫¶Êù°ÂÖÉÁ¥†
        progressBar: document.getElementById('miniProgressBar'),
        progress: document.getElementById('miniProgress'),
        progressThumb: document.getElementById('progressThumb'),
        
        // ÂàóË°®ÂÖÉÁ¥†
        songListBtn: document.getElementById('songListBtn'),
        dropdownSongList: document.getElementById('dropdownSongList'),
        songListUl: document.getElementById('songListUl'),
        
        // Êí≠ÊîæÂô®ÂÆπÂô®
        playerContainer: document.getElementById('playerContainer'),
        draggablePlayer: document.getElementById('draggablePlayer')
    };
    
    // Â∑•ÂÖ∑ÂáΩÊï∞
    const utils = {
        // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÁßí => mm:ssÔºâ
        formatTime: (seconds) => {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        },
        
        // Ëß£ÊûêÊó∂Èó¥Ôºàmm:ss => ÁßíÔºâ
        parseTime: (timeStr) => {
            const [mins, secs] = timeStr.split(':').map(Number);
            return mins * 60 + secs;
        },
        
        // Ëé∑ÂèñÈü≥ÈáèÂõæÊ†á
        getVolumeIcon: (volume) => {
            if (volume === 0) return 'üîá';
            if (volume < 0.5) return 'üîâ';
            return 'üîä';
        },
        
        // Èò≤ÊäñÂáΩÊï∞
        debounce: (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },
        
        // ËäÇÊµÅÂáΩÊï∞
        throttle: (func, limit) => {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
    };
    
    // Â≠òÂÇ®ÁÆ°ÁêÜ
    const storage = {
        KEY: 'musicPlayerState',
        
        // ‰øùÂ≠òÁä∂ÊÄÅ
        save: () => {
            try {
                // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
                if (elements.audio && !isNaN(elements.audio.currentTime)) {
                    playerState.currentTime = elements.audio.currentTime;
                }
                
                // ‰øùÂ≠òÂà∞localStorage
                localStorage.setItem(storage.KEY, JSON.stringify(playerState));
                
                // ÂêåÊ≠•Âà∞‰∏ªÈ°µÈù¢
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'MUSIC_PLAYER_STATE_CHANGED',
                        state: playerState
                    }, '*');
                }
            } catch (error) {
                console.warn('‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }
        },
        
        // Âä†ËΩΩÁä∂ÊÄÅ
        load: () => {
            try {
                const saved = localStorage.getItem(storage.KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // È™åËØÅÂπ∂ÂêàÂπ∂Áä∂ÊÄÅ
                    playerState = {
                        ...DEFAULT_STATE,
                        ...parsed,
                        currentSongIndex: Math.min(Math.max(0, parsed.currentSongIndex || 0), SONGS.length - 1)
                    };
                    
                    return true;
                }
            } catch (error) {
                console.warn('Âä†ËΩΩÊí≠ÊîæÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }
            return false;
        },
        
        // Ê∏ÖÈô§Áä∂ÊÄÅ
        clear: () => {
            localStorage.removeItem(storage.KEY);
        }
    };
    
    // Èü≥È¢ëÁÆ°ÁêÜ
    // Èü≥È¢ëÁÆ°ÁêÜ
const audioManager = {
    // È¢ÑÂä†ËΩΩÊ≠åÊõ≤
    preloadSong: (index) => {
        if (index < 0 || index >= SONGS.length) return;
        
        const song = SONGS[index];
        
        // ‰ΩøÁî®È¢ÑÂä†ËΩΩaudioÂÖÉÁ¥†
        const preloadAudio = Array.from(elements.preloadAudios)
            .find(audio => audio.src !== song.audioUrl && !audio.src);
        
        if (preloadAudio) {
            preloadAudio.src = song.audioUrl;
            preloadAudio.load().catch(console.warn);
        }
    },
    
    // È¢ÑÂä†ËΩΩÁõ∏ÈÇªÊ≠åÊõ≤
    preloadAdjacentSongs: (currentIndex) => {
        // È¢ÑÂä†ËΩΩÂâç‰∏ÄÈ¶ñÂíåÂêé‰∏ÄÈ¶ñ
        const indices = [
            currentIndex - 1,
            currentIndex + 1
        ].filter(index => index >= 0 && index < SONGS.length);
        
        indices.forEach(index => this.preloadSong(index));
    },
    
    // Êí≠ÊîæÊåáÂÆöÊ≠åÊõ≤ - Â∑≤‰øÆÂ§ç
    playSong: async (index) => {
        if (index < 0 || index >= SONGS.length) return false;
        
        playerState.currentSongIndex = index;
        const song = SONGS[index];
        
        try {
            // ËÆæÁΩÆÈü≥È¢ëÊ∫ê
            elements.audio.src = song.audioUrl;
            
            // ËÆæÁΩÆÊí≠Êîæ‰ΩçÁΩÆ
            elements.audio.currentTime = playerState.currentTime;
            
            // Êí≠Êîæ
            if (playerState.isPlaying) {
                await elements.audio.play();
                uiManager.startProgressUpdate();
            }
            
            // È¢ÑÂä†ËΩΩÁõ∏ÈÇªÊ≠åÊõ≤
            audioManager.preloadAdjacentSongs(index);
            
            // Êí≠ÊîæÊàêÂäüÂêéÊõ¥Êñ∞UI
            uiManager.updateUI();
            
            return true;
        } catch (error) {
            console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
            return false;
        }
    },
    
    // ÂàáÊç¢Êí≠ÊîæÁä∂ÊÄÅ
    togglePlayPause: async () => {
        try {
            if (playerState.isPlaying) {
                // ÊöÇÂÅú
                elements.audio.pause();
                playerState.isPlaying = false;
                uiManager.stopProgressUpdate();
            } else {
                // Êí≠Êîæ
                await elements.audio.play();
                playerState.isPlaying = true;
                uiManager.startProgressUpdate();
            }
            
            // Ëß¶ÂèëÂ∞ÅÈù¢ÊóãËΩ¨Âä®Áîª
            uiManager.triggerCoverAnimation();
            
            return true;
        } catch (error) {
            console.error('ÂàáÊç¢Êí≠ÊîæÁä∂ÊÄÅÂ§±Ë¥•:', error);
            return false;
        }
    },
    
    // ÂàáÊç¢Âà∞‰∏ã‰∏ÄÈ¶ñ
    nextSong: () => {
        let nextIndex = playerState.currentSongIndex + 1;
        
        // Ê†πÊçÆÂæ™ÁéØÊ®°ÂºèÂ§ÑÁêÜËæπÁïå
        if (nextIndex >= SONGS.length) {
            if (playerState.loopMode === LOOP_MODES.LIST_LOOP) {
                nextIndex = 0;
            } else {
                nextIndex = SONGS.length - 1;
                playerState.isPlaying = false;
            }
        }
        
        playerState.currentTime = 0;
        audioManager.playSong(nextIndex);
    },
    
    // ÂàáÊç¢Âà∞‰∏ä‰∏ÄÈ¶ñ
    prevSong: () => {
        let prevIndex = playerState.currentSongIndex - 1;
        
        // Ê†πÊçÆÂæ™ÁéØÊ®°ÂºèÂ§ÑÁêÜËæπÁïå
        if (prevIndex < 0) {
            if (playerState.loopMode === LOOP_MODES.LIST_LOOP) {
                prevIndex = SONGS.length - 1;
            } else {
                prevIndex = 0;
            }
        }
        
        playerState.currentTime = 0;
        audioManager.playSong(prevIndex);
    },
    
    // ËÆæÁΩÆÈü≥Èáè
    setVolume: (volume) => {
        const clampedVolume = Math.max(0, Math.min(1, volume));
        elements.audio.volume = clampedVolume;
        playerState.volume = clampedVolume;
    },
    
    // ÂàáÊç¢ÈùôÈü≥
    toggleMute: () => {
        if (elements.audio.volume > 0) {
            audioManager.setVolume(0);
        } else {
            audioManager.setVolume(playerState.volume || 0.7);
        }
    }
};
    
    // UIÁÆ°ÁêÜ
    const uiManager = {
        // Êõ¥Êñ∞Êí≠ÊîæÂô®UI
        updateUI: () => {
            const song = SONGS[playerState.currentSongIndex];
            if (!song) return;
            
            // Êõ¥Êñ∞Ê≠åÊõ≤‰ø°ÊÅØ
            elements.playerTitle.textContent = song.title;
            elements.playerSinger.textContent = song.singer;
            elements.totalTime.textContent = song.duration;
            
            // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆ
            elements.playBtn.textContent = playerState.isPlaying ? '‚è∏' : '‚ñ∂';
            
            // Êõ¥Êñ∞Èü≥Èáè
            elements.volumeSlider.value = playerState.volume;
            elements.volumeBtn.textContent = utils.getVolumeIcon(playerState.volume);
            
            // Êõ¥Êñ∞Âæ™ÁéØÊ®°Âºè
            uiManager.updateLoopModeUI();
            
            // Êõ¥Êñ∞Â∞ÅÈù¢ÊòæÁ§∫
            uiManager.updateCoverDisplay();
            
            // Êõ¥Êñ∞Ê≠åÊõ≤ÂàóË°®
            if (songListOpen) {
                uiManager.renderSongList();
            }
            
            // ‰øùÂ≠òÁä∂ÊÄÅ
            storage.save();
        },
        
        // Êõ¥Êñ∞Âæ™ÁéØÊ®°ÂºèUI
        updateLoopModeUI: () => {
            const modeTexts = {
                [LOOP_MODES.SEQUENCE]: { icon: 'üîÅ', tooltip: 'È°∫Â∫èÊí≠ÊîæÔºàÁÇπÂáªÂàáÊç¢ÂàóË°®Âæ™ÁéØÔºâ' },
                [LOOP_MODES.LIST_LOOP]: { icon: 'üîÑ', tooltip: 'ÂàóË°®Âæ™ÁéØÔºàÁÇπÂáªÂàáÊç¢ÂçïÊõ≤Âæ™ÁéØÔºâ' },
                [LOOP_MODES.SINGLE_LOOP]: { icon: 'üîÇ', tooltip: 'ÂçïÊõ≤Âæ™ÁéØÔºàÁÇπÂáªÂàáÊç¢È°∫Â∫èÊí≠ÊîæÔºâ' }
            };
            
            const mode = modeTexts[playerState.loopMode];
            elements.loopBtn.textContent = mode.icon;
            elements.loopTooltip.textContent = mode.tooltip;
            
            // Êõ¥Êñ∞ÊøÄÊ¥ªÁä∂ÊÄÅ
            if (playerState.loopMode !== LOOP_MODES.SEQUENCE) {
                elements.loopBtn.classList.add('active');
            } else {
                elements.loopBtn.classList.remove('active');
            }
        },
        
        // Êõ¥Êñ∞Â∞ÅÈù¢ÊòæÁ§∫
        updateCoverDisplay: () => {
            const currentSong = SONGS[playerState.currentSongIndex];
            if (!currentSong) return;
            
            // ÈöêËóèÊâÄÊúâÂ∞ÅÈù¢
            document.querySelectorAll('.player-cover').forEach(cover => {
                cover.style.display = 'none';
            });
            
            // ÊòæÁ§∫ÂΩìÂâçÂ∞ÅÈù¢
            const currentCover = document.getElementById(currentSong.coverId);
            if (currentCover) {
                currentCover.style.display = 'block';
            }
        },
        
        // Ëß¶ÂèëÂ∞ÅÈù¢Âä®Áîª
        triggerCoverAnimation: () => {
            const currentSong = SONGS[playerState.currentSongIndex];
            if (!currentSong) return;
            
            const currentCover = document.getElementById(currentSong.coverId);
            if (!currentCover) return;
            
            const coverImg = currentCover.querySelector('img');
            if (!coverImg) return;
            
            // Ëß¶ÂèëÊóãËΩ¨Âä®Áîª
            coverImg.classList.remove('rotate-on-toggle');
            void coverImg.offsetWidth; // Ëß¶ÂèëÈáçÊéí
            coverImg.classList.add('rotate-on-toggle');
            
            // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§Á±ª
            setTimeout(() => {
                coverImg.classList.remove('rotate-on-toggle');
            }, 600);
        },
        
        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        updateProgress: () => {
            const song = SONGS[playerState.currentSongIndex];
            if (!song || isProgressDragging) return;
            
            const currentTime = elements.audio.currentTime;
            const totalSeconds = utils.parseTime(song.duration);
            
            if (totalSeconds <= 0) return;
            
            const percent = (currentTime / totalSeconds) * 100;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            elements.progress.style.width = `${percent}%`;
            elements.progressThumb.style.left = `${percent}%`;
            
            // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
            elements.currentTime.textContent = utils.formatTime(currentTime);
        },
        
        // ÂºÄÂßãËøõÂ∫¶Êõ¥Êñ∞ÂÆöÊó∂Âô®
        startProgressUpdate: () => {
            uiManager.stopProgressUpdate();
            progressUpdateInterval = setInterval(() => {
                uiManager.updateProgress();
            }, 100);
        },
        
        // ÂÅúÊ≠¢ËøõÂ∫¶Êõ¥Êñ∞ÂÆöÊó∂Âô®
        stopProgressUpdate: () => {
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
                progressUpdateInterval = null;
            }
        },
        
        // Ê∏≤ÊüìÊ≠åÊõ≤ÂàóË°®
        renderSongList: () => {
            elements.songListUl.innerHTML = '';
            
            SONGS.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = index === playerState.currentSongIndex ? 'active' : '';
                li.setAttribute('data-index', index);
                
                li.innerHTML = `
                    <span>${index + 1}. ${song.title} - ${song.singer}</span>
                    <span class="song-duration">${song.duration}</span>
                `;
// Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                li.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    playerState.currentTime = 0;
                    playerState.isPlaying = true;
                    audioManager.playSong(index);
                    uiManager.toggleSongList();
                });
                
                elements.songListUl.appendChild(li);
            });
        },
        
        // ÂàáÊç¢Ê≠åÊõ≤ÂàóË°®ÊòæÁ§∫
        toggleSongList: () => {
            songListOpen = !songListOpen;
            elements.dropdownSongList.classList.toggle('show', songListOpen);
            
            // ÈÄöÁü•Áà∂È°µÈù¢Êõ¥Êñ∞Êí≠ÊîæÂô®È´òÂ∫¶
            if (window.parent) {
                window.parent.postMessage({
                    type: 'SONG_LIST_TOGGLED',
                    isShow: songListOpen
                }, '*');
            }
            
            if (songListOpen) {
                uiManager.renderSongList();
            }
        },
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°‰ΩçÁΩÆ
        setProgress: (event) => {
            const rect = elements.progressBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percent = Math.max(0, Math.min(1, clickX / rect.width));
            
            const song = SONGS[playerState.currentSongIndex];
            const totalSeconds = utils.parseTime(song.duration);
            const newTime = percent * totalSeconds;
            
            elements.audio.currentTime = newTime;
            playerState.currentTime = newTime;
            uiManager.updateProgress();
        }
    };
    
    // ‰∫ã‰ª∂ÁÆ°ÁêÜÂô®
    const eventManager = {
        // ÂàùÂßãÂåñÊâÄÊúâ‰∫ã‰ª∂ÁõëÂê¨
        init: () => {
            // Êí≠ÊîæÊåâÈíÆ
            elements.playBtn.addEventListener('click', async () => {
                await audioManager.togglePlayPause();
                uiManager.updateUI();
            });
            
            // ‰∏ä‰∏ÄÈ¶ñ/‰∏ã‰∏ÄÈ¶ñÊåâÈíÆ
            elements.prevBtn.addEventListener('click', () => {
                audioManager.prevSong();
                uiManager.updateUI();
            });
            
            elements.nextBtn.addEventListener('click', () => {
                audioManager.nextSong();
                uiManager.updateUI();
            });
            
            // Âæ™ÁéØÊ®°ÂºèÊåâÈíÆ
            elements.loopBtn.addEventListener('click', () => {
                playerState.loopMode = (playerState.loopMode + 1) % 3;
                uiManager.updateUI();
            });
            
            // Èü≥ÈáèÊéßÂà∂
            elements.volumeBtn.addEventListener('click', () => {
                audioManager.toggleMute();
                uiManager.updateUI();
            });
            
            elements.volumeSlider.addEventListener('input', utils.throttle((e) => {
                const volume = parseFloat(e.target.value);
                audioManager.setVolume(volume);
                uiManager.updateUI();
            }, 100));
            
            // ËøõÂ∫¶Êù°ÊéßÂà∂
            elements.progressBar.addEventListener('click', (e) => {
                uiManager.setProgress(e);
            });
            
            // ËøõÂ∫¶Êù°ÊãñÊãΩ
            elements.progressBar.addEventListener('mousedown', (e) => {
                isProgressDragging = true;
                uiManager.setProgress(e);
                
                const moveHandler = utils.throttle((e) => {
                    if (isProgressDragging) {
                        uiManager.setProgress(e);
                    }
                }, 100);
                
                const upHandler = () => {
                    isProgressDragging = false;
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            });
            
            // Ê≠åÊõ≤ÂàóË°®ÊåâÈíÆ
            elements.songListBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                uiManager.toggleSongList();
            });
            
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Ê≠åÊõ≤ÂàóË°®
            document.addEventListener('click', (e) => {
                if (songListOpen && 
                    !e.target.closest('#playerContainer') && 
                    !e.target.closest('#dropdownSongList')) {
                    uiManager.toggleSongList();
                }
            });
            
            // Èü≥È¢ë‰∫ã‰ª∂
            elements.audio.addEventListener('timeupdate', () => {
                uiManager.updateProgress();
            });
            
            elements.audio.addEventListener('ended', () => {
                switch (playerState.loopMode) {
                    case LOOP_MODES.SEQUENCE:
                        // È°∫Â∫èÊí≠ÊîæÔºöÊí≠ÂÆåÊúÄÂêé‰∏ÄÈ¶ñÂêéÂÅúÊ≠¢
                        if (playerState.currentSongIndex === SONGS.length - 1) {
                            playerState.isPlaying = false;
                            uiManager.stopProgressUpdate();
                            uiManager.updateUI();
                        } else {
                            audioManager.nextSong();
                        }
                        break;
                        
                    case LOOP_MODES.LIST_LOOP:
                        // ÂàóË°®Âæ™ÁéØÔºöÊí≠ÂÆåÊúÄÂêé‰∏ÄÈ¶ñÂêéÂõûÂà∞Á¨¨‰∏ÄÈ¶ñ
                        audioManager.nextSong();
                        break;
                        
                    case LOOP_MODES.SINGLE_LOOP:
                        // ÂçïÊõ≤Âæ™ÁéØÔºöÈáçÊñ∞Êí≠ÊîæÂΩìÂâçÊ≠åÊõ≤
                        elements.audio.currentTime = 0;
                        elements.audio.play();
                        break;
                }
            });
            
            // Á™óÂè£‰∫ã‰ª∂
            window.addEventListener('beforeunload', () => {
                storage.save();
                uiManager.stopProgressUpdate();
            });
            
            // Ë∑®È°µÈù¢Ê∂àÊÅØ
            window.addEventListener('message', (e) => {
                if (e.data?.type === 'INIT_STATE') {
                    const savedState = e.data.state;
                    if (savedState) {
                        playerState = {
                            ...DEFAULT_STATE,
                            ...savedState,
                            currentSongIndex: Math.min(Math.max(0, savedState.currentSongIndex || 0), SONGS.length - 1)
                        };
                        
                        // Â∫îÁî®Áä∂ÊÄÅ
                        elements.audio.volume = playerState.volume;
                        audioManager.playSong(playerState.currentSongIndex);
                        uiManager.updateUI();
                    }
                }
            });
            
            // Â≠òÂÇ®‰∫ã‰ª∂ÔºàË∑®Ê†áÁ≠æÈ°µÂêåÊ≠•Ôºâ
            window.addEventListener('storage', (e) => {
                if (e.key === storage.KEY) {
                    const savedState = JSON.parse(e.newValue || '{}');
                    if (savedState) {
                        playerState = {
                            ...DEFAULT_STATE,
                            ...savedState,
                            currentSongIndex: Math.min(Math.max(0, savedState.currentSongIndex || 0), SONGS.length - 1)
                        };
                        
                        // Êõ¥Êñ∞UI‰ΩÜ‰∏çÊí≠ÊîæÔºàÈÅøÂÖçËá™Âä®Êí≠ÊîæÈôêÂà∂Ôºâ
                        uiManager.updateUI();
                    }
                }
            });
        }
    };
    
    // ÂàùÂßãÂåñÊí≠ÊîæÂô®
    const initPlayer = () => {
        // 1. Âä†ËΩΩ‰øùÂ≠òÁöÑÁä∂ÊÄÅ
        storage.load();
        
        // 2. ËÆæÁΩÆÈü≥Èáè
        audioManager.setVolume(playerState.volume);
        
        // 3. Êí≠ÊîæÊ≠åÊõ≤
        audioManager.playSong(playerState.currentSongIndex);
        
        // 4. Êõ¥Êñ∞UI
        uiManager.updateUI();
        
        // 5. ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
        eventManager.init();
        
        // 6. ÂÆöÊúü‰øùÂ≠òÁä∂ÊÄÅ
        setInterval(() => {
            storage.save();
        }, 5000);
    };
    
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    window.addEventListener('DOMContentLoaded', initPlayer);
</script>
<script>
    // ÂõæÁâáÈîôËØØÂ§ÑÁêÜ
    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('img');
        const placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiMxZTNhMmYiLz48cGF0aCBkPSJNMTUwIDEwMHYxMDBtLTUwLTUwaDEwMCIgc3Ryb2tlPSIjM2Q3MjVmIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSIxNTAiIHk9IjIwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTlhYWJiIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBDb3ZlcjwvdGV4dD48L3N2Zz4=';
        
        images.forEach(img => {
            // Ê∑ªÂä†ÂõæÁâáÂä†ËΩΩÈîôËØØÂ§ÑÁêÜ
            img.addEventListener('error', function() {
                this.src = placeholder;
                this.alt = 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';
                console.log('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', this.getAttribute('src'));
            });
            
            // ÂØπ‰∫éÂ∞ÅÈù¢ÂõæÁâáÔºåÊ∑ªÂä†Âä†ËΩΩÊàêÂäüÂ§ÑÁêÜ
            if (img.closest('.player-cover')) {
                img.addEventListener('load', function() {
                    this.style.opacity = '1';
                });
            }
        });
        
        // ‰øÆÂ§çÈü≥È¢ëÂä†ËΩΩÈóÆÈ¢ò
        const audio = document.getElementById('backgroundAudio');
        if (audio) {
            audio.addEventListener('error', function(e) {
                console.error('Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•:', e.target.src);
                showError('Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            });
            
            audio.addEventListener('canplaythrough', function() {
                console.log('Èü≥È¢ëÂ∑≤ÂáÜÂ§áÂ•ΩÊí≠Êîæ');
            });
        }
        
        // ÈîôËØØÊèêÁ§∫ÂáΩÊï∞
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f87171;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 100000;
                animation: slideIn 0.3s ease;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
    });
    
    // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
    document.addEventListener('keydown', function(e) {
        // Âè™Âú®Êí≠ÊîæÂô®ÂèØËßÅÊó∂ÂìçÂ∫î
        const player = document.getElementById('playerContainer');
        if (!player || window.getComputedStyle(player).display === 'none') {
            return;
        }
        
        switch(e.key) {
            case ' ':
                // Á©∫Ê†ºÈîÆÂàáÊç¢Êí≠Êîæ/ÊöÇÂÅú
                e.preventDefault();
                document.getElementById('miniPlayBtn')?.click();
                break;
            case 'ArrowLeft':
                // Â∑¶ÁÆ≠Â§¥‰∏ä‰∏ÄÈ¶ñ
                e.preventDefault();
                document.getElementById('miniPrevBtn')?.click();
                break;
            case 'ArrowRight':
                // Âè≥ÁÆ≠Â§¥‰∏ã‰∏ÄÈ¶ñ
                e.preventDefault();
                document.getElementById('miniNextBtn')?.click();
                break;
            case 'ArrowUp':
                // ‰∏äÁÆ≠Â§¥Â¢ûÂä†Èü≥Èáè
                e.preventDefault();
                const volumeSlider = document.getElementById('volumeSlider');
                if (volumeSlider) {
                    let newVolume = parseFloat(volumeSlider.value) + 0.05;
                    if (newVolume > 1) newVolume = 1;
                    volumeSlider.value = newVolume;
                    volumeSlider.dispatchEvent(new Event('input'));
                }
                break;
            case 'ArrowDown':
                // ‰∏ãÁÆ≠Â§¥ÂáèÂ∞ëÈü≥Èáè
                e.preventDefault();
                const volumeSlider2 = document.getElementById('volumeSlider');
                if (volumeSlider2) {
                    let newVolume = parseFloat(volumeSlider2.value) - 0.05;
                    if (newVolume < 0) newVolume = 0;
                    volumeSlider2.value = newVolume;
                    volumeSlider2.dispatchEvent(new Event('input'));
                }
                break;
            case 'l':
            case 'L':
                // LÈîÆÂàáÊç¢ÂàóË°®ÊòæÁ§∫
                e.preventDefault();
                document.getElementById('songListBtn')?.click();
                break;
        }
    });
    
    // Ê∑ªÂä†Êí≠ÊîæÂô®ÊãñÂä®ÂäüËÉΩ‰ºòÂåñ
    (function() {
        const playerContainer = document.getElementById('playerContainer');
        const draggablePlayer = document.getElementById('draggablePlayer');
        
        if (!playerContainer || !draggablePlayer) return;
        
        let isDragging = false;
        let startX = 0;
        let startLeft = 0;
        
        // Âè™Âú®ÁâπÂÆöÂå∫ÂüüÂÖÅËÆ∏ÊãñÂä®ÔºàÈÅøÂÖçÂπ≤Êâ∞ÊåâÈíÆÔºâ
        draggablePlayer.addEventListener('mousedown', function(e) {
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÂèØ‰∫§‰∫íÂÖÉÁ¥†
            const interactiveElements = ['BUTTON', 'INPUT', 'A', 'SELECT', 'TEXTAREA'];
            if (interactiveElements.includes(e.target.tagName) || 
                e.target.closest('.player-btn, .volume-btn, .song-list-btn, .volume-slider, .progress-bar-mini')) {
                return;
            }
            
            isDragging = true;
            startX = e.clientX;
            startLeft = parseInt(window.getComputedStyle(playerContainer).left) || 0;
            
            // Ê∑ªÂä†ÊãñÂä®Áä∂ÊÄÅÊ†∑Âºè
            playerContainer.style.cursor = 'grabbing';
            playerContainer.style.transition = 'none';
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const maxLeft = window.innerWidth - playerContainer.offsetWidth;
            let newLeft = startLeft + deltaX;
            
            // ÈôêÂà∂ËæπÁïå
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            
            playerContainer.style.left = `${newLeft}px`;
        });
        
        document.addEventListener('mouseup', function() {
            if (!isDragging) return;
            
            isDragging = false;
            playerContainer.style.cursor = '';
            playerContainer.style.transition = 'left 0.3s ease';
            
            // ‰øùÂ≠ò‰ΩçÁΩÆ
            const leftPos = parseInt(playerContainer.style.left) || 0;
            try {
                localStorage.setItem('musicPlayerPosition', leftPos.toString());
            } catch (e) {
                console.warn('Êó†Ê≥ï‰øùÂ≠òÊí≠ÊîæÂô®‰ΩçÁΩÆ:', e);
            }
        });
        
        // Ëß¶Êë∏ËÆæÂ§áÊîØÊåÅ
        draggablePlayer.addEventListener('touchstart', function(e) {
            const touch = e.touches[0];
            const interactiveElements = ['BUTTON', 'INPUT', 'A', 'SELECT', 'TEXTAREA'];
            
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÂèØ‰∫§‰∫íÂÖÉÁ¥†
            let target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (interactiveElements.includes(target?.tagName) || 
                target?.closest('.player-btn, .volume-btn, .song-list-btn, .volume-slider, .progress-bar-mini')) {
                return;
            }
            
            isDragging = true;
            startX = touch.clientX;
            startLeft = parseInt(window.getComputedStyle(playerContainer).left) || 0;
            
            playerContainer.style.cursor = 'grabbing';
            playerContainer.style.transition = 'none';
            
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            const maxLeft = window.innerWidth - playerContainer.offsetWidth;
            let newLeft = startLeft + deltaX;
            
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            playerContainer.style.left = `${newLeft}px`;
            
            e.preventDefault();
        });
        
        document.addEventListener('touchend', function() {
            if (!isDragging) return;
            
            isDragging = false;
            playerContainer.style.cursor = '';
            playerContainer.style.transition = 'left 0.3s ease';
            
            const leftPos = parseInt(playerContainer.style.left) || 0;
            try {
                localStorage.setItem('musicPlayerPosition', leftPos.toString());
            } catch (e) {
                console.warn('Êó†Ê≥ï‰øùÂ≠òÊí≠ÊîæÂô®‰ΩçÁΩÆ:', e);
            }
        });
        
        // ÊÅ¢Â§ç‰ΩçÁΩÆ
        try {
            const savedPos = localStorage.getItem('musicPlayerPosition');
            if (savedPos) {
                const pos = parseInt(savedPos);
                const maxLeft = window.innerWidth - playerContainer.offsetWidth;
                playerContainer.style.left = `${Math.min(pos, maxLeft)}px`;
            }
        } catch (e) {
            console.warn('Êó†Ê≥ïÊÅ¢Â§çÊí≠ÊîæÂô®‰ΩçÁΩÆ:', e);
        }
    })();
    
    // Ê∑ªÂä†È°µÈù¢ÂèØËßÅÊÄßAPIÊîØÊåÅÔºàÈ°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÈü≥È¢ëÔºâ
    document.addEventListener('visibilitychange', function() {
        const audio = document.getElementById('backgroundAudio');
        if (!audio) return;
        
        if (document.hidden) {
            // È°µÈù¢ÈöêËóèÊó∂‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
            try {
                localStorage.setItem('musicPlayerPaused', audio.paused.toString());
            } catch (e) {
                console.warn('Êó†Ê≥ï‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ:', e);
            }
        } else {
            // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çÊí≠ÊîæÁä∂ÊÄÅ
            try {
                const wasPaused = localStorage.getItem('musicPlayerPaused') === 'true';
                if (!wasPaused && !audio.paused) {
                    // È°µÈù¢ÈáçÊñ∞ÊòæÁ§∫Êó∂ÊÅ¢Â§çÊí≠Êîæ
                    audio.play().catch(e => {
                        console.log('ÊÅ¢Â§çÊí≠ÊîæÂ§±Ë¥•:', e);
                    });
                }
            } catch (e) {
                console.warn('Êó†Ê≥ïÊÅ¢Â§çÊí≠ÊîæÁä∂ÊÄÅ:', e);
            }
        }
    });
    
    // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊµã
    window.addEventListener('online', function() {
        console.log('ÁΩëÁªúÂ∑≤ËøûÊé•');
        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÈáçËØïÊí≠ÊîæÁöÑÈÄªËæë
    });
    
    window.addEventListener('offline', function() {
        console.log('ÁΩëÁªúÂ∑≤Êñ≠ÂºÄ');
        showError('ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÈü≥‰πêÊí≠ÊîæÂèØËÉΩÂèóÂΩ±Âìç');
    });
    
    // ÊÄßËÉΩÁõëÊéß
    if ('performance' in window) {
        window.addEventListener('load', function() {
            setTimeout(() => {
                const timing = performance.getEntriesByType('navigation')[0];
                if (timing) {
                    console.log(`Êí≠ÊîæÂô®Âä†ËΩΩÊó∂Èó¥: ${timing.duration.toFixed(0)}ms`);
                }
            }, 0);
        });
    }
    
    // ËæÖÂä©ÂáΩÊï∞ÔºöÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
    function showError(message) {
        // ÈÅøÂÖçÈáçÂ§çÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        const existingError = document.querySelector('.player-error-message');
        if (existingError) {
            existingError.remove();
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'player-error-message';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f87171;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 100000;
            animation: slideIn 0.3s ease;
            font-size: 14px;
            max-width: 300px;
            word-break: break-word;
        `;
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => errorDiv.remove(), 300);
            }
        }, 3000);
        
        // Ê∑ªÂä†Âä®ÁîªÂÖ≥ÈîÆÂ∏ß
        if (!document.querySelector('#error-animations')) {
            const style = document.createElement('style');
            style.id = 'error-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }
</script>

</body>
</html>    
