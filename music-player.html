<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‡å‡†éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå…­å“¥è£è€€WIKIä¸“ç”¨ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", "PingFang SC", sans-serif; }
        body { background: transparent; padding: 0; margin: 0; height: 100%; }
        /* æ’­æ”¾å™¨ä¸»ä½“ï¼šå›ºå®šåº•éƒ¨ï¼Œè´´åˆå¸¸è§„æ’­æ”¾å™¨å¸ƒå±€ */
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            width: 100%;
            background: #1e3a2f;
            border-top: 1px solid #3d725f;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
        }
        /* æ ¸å¿ƒæ’­æ”¾åŒºï¼šå°é¢+ä¿¡æ¯ï¼ˆå«åˆ—è¡¨æŒ‰é’®ï¼‰+æ§åˆ¶+éŸ³é‡ æ¨ªå‘æ’å¸ƒ */
        .mini-music-player {
            width: 100%;
            height: 80px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }
        /* å°é¢ï¼šå¸¸è§„æ–¹å½¢è®¾è®¡ï¼Œå±…ä¸­æ˜¾ç¤º */
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px; /* å¸¸è§„æ’­æ”¾å™¨ä¸»æµæ–¹å½¢å°é¢ */
            background: #2d5243;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* æ’­æ”¾æ—¶å°é¢æ—‹è½¬åŠ¨ç”»ï¼ˆå¸¸è§„æ’­æ”¾å™¨å¸¸è§æ•ˆæœï¼‰ */
        .mini-music-player.playing .player-cover img {
            animation: rotate 10s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* æ­Œæ›²ä¿¡æ¯åŒºï¼šå·¦å¯¹é½ï¼ŒåŒ…å«åˆ—è¡¨æŒ‰é’® */
        .player-info {
            flex: 1;
            min-width: 150px;
            max-width: 350px; /* åŠ å®½ä»¥å®¹çº³åˆ—è¡¨æŒ‰é’® */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .player-title {
            font-size: 1rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .player-singer {
            font-size: 0.8rem;
            color: #99aabb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* å•ç‹¬çš„åˆ—è¡¨æŒ‰é’®ï¼ˆæ­Œæ›²åç§°åï¼‰ */
        .song-list-btn {
            background: transparent;
            border: 1px solid #3d725f;
            color: #81c784;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: auto;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .song-list-btn:hover {
            background: #2d5243;
            border-color: #81c784;
        }
        /* æ§åˆ¶åŒºï¼šå±…ä¸­æ’å¸ƒï¼ŒæŒ‰é’®å¤§å°ç»Ÿä¸€ */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        .player-btn {
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.1rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: all 0.2s ease;
        }
        /* ä¸»æ’­æ”¾æŒ‰é’®ï¼šçªå‡ºæ˜¾ç¤ºï¼ˆå¸¸è§„æ’­æ”¾å™¨è®¾è®¡ï¼‰ */
        .play-main-btn {
            background: #81c784;
            color: #121212;
            font-size: 1.3rem;
            width: 44px;
            height: 44px;
            box-shadow: 0 2px 6px rgba(129, 199, 132, 0.4);
        }
        .play-main-btn:hover {
            background: #a8d0b9;
            transform: scale(1.05);
        }
        .player-btn:not(.play-main-btn):hover {
            background: rgba(129, 199, 132, 0.15);
            color: #a8d0b9;
        }
        .player-btn.active {
            color: #81c784;
        }
        /* éŸ³é‡æ§åˆ¶åŒºï¼šç´§å‡‘å¸ƒå±€ */
        .player-volume {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        .volume-btn {
            background: transparent;
            border: none;
            color: #99aabb;
            cursor: pointer;
            font-size: 1rem;
            z-index: 99999;
            transition: all 0.2s ease;
        }
        .volume-btn:hover {
            color: #81c784;
        }
        /* éŸ³é‡æ»‘åŠ¨æ¡ï¼šå¸¸è§„æ¨ªå‘æ ·å¼ */
        .volume-slider {
            width: 80px;
            height: 3px;
            background: #2d5243;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            opacity: 1;
            transition: all 0.2s ease;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #81c784;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.5);
        }
        /* è¿›åº¦æ¡ï¼šå…¨å±å®½åº¦ï¼Œåº•éƒ¨å¸¸é©»ï¼ˆå¸¸è§„æ’­æ”¾å™¨ä½ç½®ï¼‰ */
        .player-progress {
            width: 100%;
            padding: 0 16px 8px;
            box-sizing: border-box;
        }
        .progress-bar-mini {
            width: 100%;
            height: 4px;
            background: #2d5243;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        .progress-mini {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: #81c784;
            border-radius: 2px;
        }
        /* è¿›åº¦æ¡æ‹–åŠ¨ç‚¹ï¼šå¸¸é©»æ˜¾ç¤º */
        .progress-thumb {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #81c784;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.6);
            opacity: 1;
        }
        /* æ—¶é—´æ˜¾ç¤ºï¼šè¿›åº¦æ¡ä¸‹æ–¹ä¸¤ä¾§ */
        .time-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #99aabb;
            margin-top: 4px;
        }
        /* å¾ªç¯æ¨¡å¼æç¤ºï¼šå¸¸è§„æ‚¬æµ®æç¤º */
        .loop-mode-tooltip {
            position: absolute;
            bottom: 120%;
            right: 50%;
            transform: translateX(50%);
            background: #2d5243;
            color: #81c784;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
        }
        .loop-btn:hover + .loop-mode-tooltip {
            display: block;
        }
        /* ä¸‹æ‹‰æ­Œæ›²åˆ—è¡¨ï¼ˆå‘ä¸Šå±•å¼€ï¼Œæ’­æ”¾å™¨ä¸Šæ–¹ï¼‰ */
        .dropdown-song-list {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            bottom: 80px; /* ç´§è´´æ’­æ”¾å™¨é¡¶éƒ¨ */
            left: 0;
            right: 0;
            width: 100%;
            background: #1e3a2f;
            border-bottom: 1px solid #3d725f;
            max-height: 300px;
            overflow-y: auto;
            z-index: 99998; /* ä½äºæ’­æ”¾å™¨ï¼Œä¸é®æŒ¡æ§åˆ¶åŒº */
            box-shadow: 0 -2px 12px rgba(0,0,0,0.4);
        }
        /* åˆ—è¡¨å±•å¼€çš„æ¿€æ´»çŠ¶æ€ */
        .dropdown-song-list.show {
            display: block !important;
        }
        /* æ­Œæ›²åˆ—è¡¨æ ·å¼ */
        .song-list {
            list-style: none;
        }
        .song-list li {
            padding: 10px 16px;
            color: #e0e0e0;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .song-list li.active {
            background: #2d5243;
            color: #81c784;
            font-weight: 500;
        }
        .song-list li:hover:not(.active) {
            background: rgba(45, 82, 67, 0.5);
        }
        .song-duration {
            font-size: 0.8rem;
            color: #99aabb;
            margin-left: 16px;
        }
        /* æ»šåŠ¨æ¡ä¼˜åŒ– */
        .dropdown-song-list::-webkit-scrollbar {
            width: 6px;
        }
        .dropdown-song-list::-webkit-scrollbar-track {
            background: #23322d;
        }
        .dropdown-song-list::-webkit-scrollbar-thumb {
            background: #4a6e61;
            border-radius: 3px;
        }
        .dropdown-song-list::-webkit-scrollbar-thumb:hover {
            background: #81c784;
        }
    </style>
</head>
<body>
    <!-- æ­Œæ›²åˆ—è¡¨å®¹å™¨ï¼ˆæ”¾åœ¨æ’­æ”¾å™¨å¤–ï¼Œç¡®ä¿å‘ä¸Šå±•å¼€ï¼‰ -->
    <div class="dropdown-song-list" id="dropdownSongList">
        <ul class="song-list" id="songListUl"></ul>
    </div>

    <div class="player-container" id="playerContainer">
        <div class="mini-music-player" id="draggablePlayer">
            <!-- å°é¢åŒºåŸŸ -->
            <div class="player-cover" id="playerCover1">
                <img src="http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300" alt="æ˜”æ¶Ÿ">
            </div>
            <div class="player-cover" id="playerCover2" style="display:none;">
                <img src="http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300" alt="è€€æ–‘">
            </div>
            <div class="player-cover" id="playerCover3" style="display:none;">
                <img src="http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300" alt="æ‹‚æ™“">
            </div>
            <div class="player-cover" id="playerCover4" style="display:none;">
                <img src="http://p1.music.126.net/gtunmoxObQyoH01HzURNUw==/109951170292455448.jpg?param=300x300" alt="ä½•è€…">
            </div>
            <div class="player-cover" id="playerCover5" style="display:none;">
                <img src="http://p1.music.126.net/jWx1g4PbZsIu9npNOlifzA==/109951170151255339.jpg?param=300x300" alt="ç¡è•‰ä¹‹æ­Œ">
            </div>
            <div class="player-cover" id="playerCover6" style="display:none;">
                <img src="http://p1.music.126.net/sZ-rACbFrybF0x_lI6XNMw==/109951169297766755.jpg?param=300x300" alt="ä¸çœ ä¹‹å¤œ">
            </div>
            <div class="player-cover" id="playerCover7" style="display:none;">
                <img src="http://p1.music.126.net/arz1hBaMCVcVV3yktxpoGg==/109951172346365107.jpg?param=300x300" alt="Montagem Miau">
            </div>
            <div class="player-cover" id="playerCover8" style="display:none;">
                <img src="http://p1.music.126.net/ykljhikl5x5QXgYjiIvW8g==/109951163082689392.jpg?param=300x300" alt="çŒ«çš„èˆæ­¥">
            </div>
            <div class="player-cover" id="playerCover9" style="display:none;">
                <img src="http://p2.music.126.net/6y-UleORITEDfD5K8I44Qw==/109951165493980841.jpg?param=300x300" alt="ç¤ºä¾‹æ­Œæ›²9">
            </div>
            <div class="player-cover" id="playerCover10" style="display:none;">
                <img src="http://p2.music.126.net/rMVkn75VN1Wr8KkX505pvQ==/109951168596119971.jpg?param=300x300" alt="åæ­£(ç‹®å­åº§å¹»æƒ³æ›²)">
            </div>
            <div class="player-cover" id="playerCover11" style="display:none;">
                <img src="http://p1.music.126.net/tAzWfNK5KALyV7OO2Vc3SA==/6068204674100518.jpg?param=300x300" alt="Counting Stars">
            </div>  
            <div class="player-cover" id="playerCover12" style="display:none;">
                <img src="http://p2.music.126.net/rqIc9szkJmBA3imeK8G1yA==/109951164451064842.jpg?param=300x300" alt="DJ Okawari-Flower Dance">  
            </div>
            <div class="player-cover" id="playerCover13" style="display:none;">
                <img src="111" alt="å»¶é•¿æ­Œæ›²åˆ—è¡¨ä¸“ç”¨">  
            </div>
            
            <!-- æ­Œæ›²ä¿¡æ¯åŒºï¼ˆæ­Œæ›²åç§°ååŠ åˆ—è¡¨æŒ‰é’®ï¼‰ -->
            <div class="player-info">
                <div class="player-title">
                    <span id="playerTitleText">æ˜”æ¶Ÿ</span>
                    <!-- å•ç‹¬çš„åˆ—è¡¨æŒ‰é’®ï¼ˆæ­Œæ›²åç§°å³ä¾§ï¼‰ -->
                    <button class="song-list-btn" id="songListBtn" tabindex="0">åˆ—è¡¨</button>
                </div>
                <div class="player-singer" id="playerSinger">å¼ éŸ¶æ¶µã€HOYO-MiX</div>
            </div>
            <!-- æ’­æ”¾æ§åˆ¶åŒºï¼ˆå¸¸è§„å¸ƒå±€ï¼šä¸Šä¸€é¦–-æ’­æ”¾-ä¸‹ä¸€é¦–-å¾ªç¯ï¼‰ -->
            <div class="player-controls">
                <button class="player-btn" id="miniPrevBtn" tabindex="0">â®</button>
                <button class="player-btn play-main-btn" id="miniPlayBtn" tabindex="0">â–¶</button>
                <button class="player-btn" id="miniNextBtn" tabindex="0">â¯</button>
                <button class="player-btn loop-btn" id="loopBtn" title="åˆ‡æ¢å¾ªç¯æ¨¡å¼" tabindex="0">ğŸ”</button>
            </div>
            <!-- éŸ³é‡æ§åˆ¶åŒº -->
            <div class="player-volume">
                <button class="volume-btn" id="volumeBtn" tabindex="0">ğŸ”Š</button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
            </div>
        </div>
        <!-- è¿›åº¦æ¡åŒºåŸŸï¼ˆåº•éƒ¨å¸¸é©»ï¼Œå¸¸è§„æ’­æ”¾å™¨ä½ç½®ï¼‰ -->
        <div class="player-progress">
            <div class="progress-bar-mini" id="miniProgressBar">
                <div class="progress-mini" id="miniProgress"></div>
                <div class="progress-thumb" id="progressThumb"></div>
            </div>
            <div class="time-mini">
                <span class="current-time-mini" id="currentTime">00:00</span>
                <span class="total-time-mini" id="totalTime">03:06</span>
            </div>
        </div>
        <!-- å…¨å±€éŸ³é¢‘å¯¹è±¡ -->
        <audio id="globalAudio" preload="metadata" playsinline>
            <source src="" type="audio/mpeg">
        </audio>
    </div>
<script>
    // å…ƒç´ åˆå§‹åŒ–
    const draggablePlayer = document.getElementById('draggablePlayer');
    const playBtn = document.getElementById('miniPlayBtn');
    const progress = document.getElementById('miniProgress');
    const progressThumb = document.getElementById('progressThumb');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const prevBtn = document.getElementById('miniPrevBtn');
    const nextBtn = document.getElementById('miniNextBtn');
    const loopBtn = document.getElementById('loopBtn');
    const loopTooltip = document.getElementById('loopTooltip');
    const playerTitleText = document.getElementById('playerTitleText'); // æ­Œæ›²åç§°å…ƒç´ 
    const playerSinger = document.getElementById('playerSinger');
    const globalAudio = document.getElementById('globalAudio');
    const playerContainer = document.getElementById('playerContainer');
    // åˆ—è¡¨æŒ‰é’®+ä¸‹æ‹‰åˆ—è¡¨å…ƒç´ 
    const songListBtn = document.getElementById('songListBtn');
    const dropdownSongList = document.getElementById('dropdownSongList');
    const songListUl = document.getElementById('songListUl');
    let listOpen = false; // åˆ—è¡¨å±•å¼€çŠ¶æ€æ ‡è®°

    // æ­Œæ›²åˆ—è¡¨æ•°æ®
    const songList = [
        { 
            audioId: 'miniAudio1', 
            coverId: 'playerCover1', 
            title: 'æ˜”æ¶Ÿ', 
            singer: 'å¼ éŸ¶æ¶µã€HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3',
            duration: '03:06'
        },
        { 
            audioId: 'miniAudio2', 
            coverId: 'playerCover2', 
            title: 'è€€æ–‘', 
            singer: 'HOYO-MiX,YMIR', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3',
            duration: '03:33'
        },
        { 
            audioId: 'miniAudio3', 
            coverId: 'playerCover3', 
            title: 'æ‹‚æ™“ Proi Proi', 
            singer: 'HOYO-MiX,NIDA', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3',
            duration: '03:58'
        },
        { 
            audioId: 'miniAudio4', 
            coverId: 'playerCover4', 
            title: 'ä½•è€…', 
            singer: 'è°­æ™¶,HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2658660685.mp3',
            duration: '02:26'
        },
        { 
            audioId: 'miniAudio5', 
            coverId: 'playerCover5', 
            title: 'ç¡è•‰ä¹‹æ­Œ', 
            singer: 'HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2646986980.mp3',
            duration: '00:17'
        },
        { 
            audioId: 'miniAudio6', 
            coverId: 'playerCover6', 
            title: 'ä¸çœ ä¹‹å¤œ', 
            singer: 'å¼ æ°,HOYO-MiX', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2122308127.mp3',
            duration: '02:18'
        },
        { 
            audioId: 'miniAudio7', 
            coverId: 'playerCover7', 
            title: 'Montagem Miau', 
            singer: 'Pudding_PD,METAMOON', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=3320816993.mp3',
            duration: '02:19'
        },
        { 
            audioId: 'miniAudio8', 
            coverId: 'playerCover8', 
            title: 'çŒ«çš„èˆæ­¥', 
            singer: 'Candy_Wind', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=523902194.mp3',
            duration: '03:07'
        },
        { 
            audioId: 'miniAudio9', 
            coverId: 'playerCover9', 
            title: 'ç¤ºä¾‹æ­Œæ›²9', 
            singer: 'æ­Œæ‰‹9', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=1428234445.mp3',
            duration: '03:20'
        },
        { 
            audioId: 'miniAudio10', 
            coverId: 'playerCover10', 
            title: 'åæ­£ï¼ˆç‹®å­åº§å¹»æƒ³æ›²ï¼‰', 
            singer: 'é«˜æ¡¥åƒæ˜¥', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2045500209.mp3',
            duration: '03:11'
        },
        { 
            audioId: 'miniAudio11', 
            coverId: 'playerCover11', 
            title: 'Counting Stars', 
            singer: 'OneRepublic', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=28575553.mp3',
            duration: '04:16'
        },
        { 
            audioId: 'miniAudio12', 
            coverId: 'playerCover12', 
            title: 'DJ Okawari-Flower Dance', 
            singer: 'Chopin Remix', 
            audioUrl: 'http://music.163.com/song/media/outer/url?id=1405903472.mp3',
            duration: '04:07'
        },
        { 
            audioId: 'miniAudio13', 
            coverId: 'playerCover13', 
            title: 'æµ‹è¯•', 
            singer: 'Chopin Remix', 
            audioUrl: '13',
            duration: '00:00'
        }
    ];

    // å¾ªç¯æ¨¡å¼æšä¸¾ï¼ˆå¸¸è§„æ’­æ”¾å™¨ä¸‰ç§æ¨¡å¼ï¼‰
    const LOOP_MODE = {
        SEQUENCE: 0, // é¡ºåºæ’­æ”¾
        LIST_LOOP: 1, // åˆ—è¡¨å¾ªç¯
        SINGLE_LOOP: 2 // å•æ›²å¾ªç¯
    };

    // å…¨å±€çŠ¶æ€ï¼ˆè®°å¿†æ’­æ”¾æ¨¡å¼ï¼Œè´´åˆå¸¸è§„ä½“éªŒï¼‰
    let playState = JSON.parse(localStorage.getItem('musicPlayerState')) || {
        currentSongIndex: 0,
        isPlaying: false,
        currentTime: 0,
        volume: 0.7,
        loopMode: LOOP_MODE.SEQUENCE,
        rotateDeg: 0
    };

    // é˜²æŠ–å‡½æ•°
    function debounce(fn, delay = 100) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ä¿å­˜æ’­æ”¾çŠ¶æ€ï¼ˆè‡ªåŠ¨è®°å¿†ï¼Œå¸¸è§„æ’­æ”¾å™¨å¿…å¤‡ï¼‰
    function savePlayState() {
        playState.currentTime = globalAudio.currentTime;
        playState.volume = globalAudio.volume;
        localStorage.setItem('musicPlayerState', JSON.stringify(playState));
        window.parent.postMessage({
            type: 'PLAY_STATE_UPDATED',
            state: { ...playState }
        }, '*');
    }

    // æ›´æ–°å¾ªç¯æ¨¡å¼UI
    function updateLoopModeUI() {
        switch(playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                loopBtn.textContent = 'ğŸ”';
                loopBtn.classList.remove('active');
                loopTooltip.textContent = 'é¡ºåºæ’­æ”¾ï¼ˆç‚¹å‡»åˆ‡æ¢åˆ—è¡¨å¾ªç¯ï¼‰';
                break;
            case LOOP_MODE.LIST_LOOP:
                loopBtn.textContent = 'ğŸ”„';
                loopBtn.classList.add('active');
                loopTooltip.textContent = 'åˆ—è¡¨å¾ªç¯ï¼ˆç‚¹å‡»åˆ‡æ¢å•æ›²å¾ªç¯ï¼‰';
                break;
            case LOOP_MODE.SINGLE_LOOP:
                loopBtn.textContent = 'ğŸ”‚';
                loopBtn.classList.add('active');
                loopTooltip.textContent = 'å•æ›²å¾ªç¯ï¼ˆç‚¹å‡»åˆ‡æ¢é¡ºåºæ’­æ”¾ï¼‰';
                break;
        }
    }

    // åˆ‡æ¢å¾ªç¯æ¨¡å¼
    loopBtn.addEventListener('click', () => {
        playState.loopMode = (playState.loopMode + 1) % 3;
        updateLoopModeUI();
        savePlayState();
    });

    // è·å–éŸ³é‡å›¾æ ‡ï¼ˆå¸¸è§„ä¸‰çº§éŸ³é‡æ˜¾ç¤ºï¼‰
    function getVolumeIcon(volume) {
        return volume > 0.5 ? 'ğŸ”Š' : volume > 0 ? 'ğŸ”‰' : 'ğŸ”‡';
    }

    // æ­Œæ›²åˆ‡æ¢ï¼ˆå¸¸è§„é€»è¾‘ï¼šæ— ç¼è¡”æ¥ï¼‰
    function switchSong(newIndex) {
        // å¤„ç†å¾ªç¯é€»è¾‘
        if (newIndex < 0) {
            newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? songList.length - 1 : 0;
        }
        if (newIndex >= songList.length) {
            newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? 0 : songList.length - 1;
        }

        playState.currentSongIndex = newIndex;
        const newSong = songList[newIndex];

        // æ›´æ–°UIï¼ˆå¸¸è§„æ’­æ”¾å™¨å³æ—¶åé¦ˆï¼‰
        playerTitleText.textContent = newSong.title;
        playerSinger.textContent = newSong.singer;
        totalTimeEl.textContent = newSong.duration;
        totalTimeEl.dataset.loaded = 'true';
        progress.style.width = '0%';
        progressThumb.style.left = '0%';
        currentTimeEl.textContent = '00:00';

        // åˆ‡æ¢å°é¢
        document.querySelectorAll('.player-cover').forEach(cover => cover.style.display = 'none');
        const currentCover = document.getElementById(newSong.coverId);
        if (currentCover) currentCover.style.display = 'block';

        // æ›´æ–°éŸ³é¢‘æº
        globalAudio.src = newSong.audioUrl;
        globalAudio.currentTime = 0;
        globalAudio.load();

        // æ¢å¤æ’­æ”¾çŠ¶æ€
        if (playState.isPlaying) {
            globalAudio.play().then(() => {
                playBtn.textContent = 'â¸';
                draggablePlayer.classList.add('playing');
            }).catch(() => {
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾å™¨é‡è¯•ï¼ˆæµè§ˆå™¨å¯èƒ½é™åˆ¶è‡ªåŠ¨æ’­æ”¾ï¼‰');
                playBtn.textContent = 'â–¶';
                draggablePlayer.classList.remove('playing');
                playState.isPlaying = false;
            });
        } else {
            playBtn.textContent = 'â–¶';
            draggablePlayer.classList.remove('playing');
        }

        savePlayState();
        // åˆ‡æ¢æ­Œæ›²åå…³é—­ä¸‹æ‹‰åˆ—è¡¨
        listOpen = false;
        dropdownSongList.classList.remove('show');
    }

    // æ¸²æŸ“ä¸‹æ‹‰æ­Œæ›²åˆ—è¡¨
    function renderSongList() {
        songListUl.innerHTML = '';
        songList.forEach((song, idx) => {
            const li = document.createElement('li');
            li.classList.toggle('active', idx === playState.currentSongIndex);
            li.innerHTML = `
                <span>${idx + 1}. ${song.title} - ${song.singer}</span>
                <span class="song-duration">${song.duration}</span>
            `;
            // ç‚¹å‡»æ­Œæ›²ï¼šæ’­æ”¾ + å…³é—­åˆ—è¡¨
            li.addEventListener('click', () => {
                switchSong(idx);
            });
            songListUl.appendChild(li);
        });
    }

    // åˆ—è¡¨æŒ‰é’®ï¼šç‚¹å‡»å±•å¼€/æ”¶èµ·åˆ—è¡¨ï¼ˆå‘ä¸Šå±•å¼€ï¼‰
    songListBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ’­æ”¾å™¨æ‹–åŠ¨
        listOpen = !listOpen;
        dropdownSongList.classList.toggle('show', listOpen);
        if (listOpen) {
            renderSongList(); // æ¸²æŸ“åˆ—è¡¨
        }
    });

    // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸï¼Œå…³é—­ä¸‹æ‹‰åˆ—è¡¨
    document.addEventListener('click', (e) => {
        // æ’é™¤æ’­æ”¾å™¨å’Œåˆ—è¡¨åŒºåŸŸï¼Œç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
        if (listOpen && !playerContainer.contains(e.target) && !dropdownSongList.contains(e.target)) {
            listOpen = false;
            dropdownSongList.classList.remove('show');
        }
    });

    // æ’­æ”¾/æš‚åœæ§åˆ¶ï¼ˆå¸¸è§„ç‚¹å‡»é€»è¾‘ï¼‰
    playBtn.addEventListener('click', () => {
        if (playState.isPlaying) {
            globalAudio.pause();
            playBtn.textContent = 'â–¶';
            draggablePlayer.classList.remove('playing');
        } else {
            globalAudio.play().then(() => {
                playBtn.textContent = 'â¸';
                draggablePlayer.classList.add('playing');
            }).catch(() => alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾å™¨é‡è¯•'));
        }
        playState.isPlaying = !playState.isPlaying;
        savePlayState();
    });

    // ä¸Š/ä¸‹ä¸€é¦–ï¼ˆå¸¸è§„å¿«æ·é”®é€»è¾‘ï¼‰
    prevBtn.addEventListener('click', () => switchSong(playState.currentSongIndex - 1));
    nextBtn.addEventListener('click', () => switchSong(playState.currentSongIndex + 1));

    // éŸ³é‡æ§åˆ¶ï¼ˆæŒ‰é’®+æ»‘åŠ¨æ¡ï¼‰
    volumeBtn.addEventListener('click', () => {
        globalAudio.volume = globalAudio.volume === 1.0 ? 0 : globalAudio.volume > 0 ? 1.0 : 0.7;
        volumeSlider.value = globalAudio.volume;
        volumeBtn.textContent = getVolumeIcon(globalAudio.volume);
        savePlayState();
    });

    volumeSlider.addEventListener('input', () => {
        globalAudio.volume = volumeSlider.value;
        volumeBtn.textContent = getVolumeIcon(globalAudio.volume);
        savePlayState();
    });

    // è¿›åº¦æ¡æ›´æ–°ï¼ˆå¸¸è§„å®æ—¶åŒæ­¥ï¼‰
    function updateProgress() {
        if (isNaN(globalAudio.duration)) return;
        const percent = (globalAudio.currentTime / globalAudio.duration) * 100;
        progress.style.width = `${percent}%`;
        progressThumb.style.left = `${percent}%`;
        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå¸¸è§„00:00æ ¼å¼ï¼‰
        const currentMinutes = Math.floor(globalAudio.currentTime / 60);
        const currentSeconds = Math.floor(globalAudio.currentTime % 60);
        currentTimeEl.textContent = `${currentMinutes.toString().padStart(2, '0')}:${currentSeconds.toString().padStart(2, '0')}`;
        
        if (!totalTimeEl.dataset.loaded) {
            const totalMinutes = Math.floor(globalAudio.duration / 60);
            const totalSeconds = Math.floor(globalAudio.duration % 60);
            totalTimeEl.textContent = `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
            totalTimeEl.dataset.loaded = 'true';
        }
    }
    setInterval(updateProgress, 1000);

    // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬ï¼ˆå¸¸è§„æ“ä½œï¼‰
    document.getElementById('miniProgressBar').addEventListener('click', (e) => {
        if (isNaN(globalAudio.duration)) return;
        const rect = e.target.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        globalAudio.currentTime = percent * globalAudio.duration;
        progress.style.width = `${percent * 100}%`;
        progressThumb.style.left = `${percent * 100}%`;
        savePlayState();
    });

    // æ‹–åŠ¨åŠŸèƒ½ï¼ˆä¼˜åŒ–ï¼šä¸æ‹¦æˆªåˆ—è¡¨æŒ‰é’®ï¼‰
    draggablePlayer.addEventListener('mousedown', (e) => {
        // ç²¾å‡†æ’é™¤å¯ç‚¹å‡»å…ƒç´ ï¼Œé¿å…æ‹–åŠ¨æ‹¦æˆª
        if (e.target.closest('.player-btn, .volume-btn, .song-list-btn, .volume-slider, .progress-bar-mini')) {
            return;
        }
        let isDragging = true;
        const rect = playerContainer.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const moveHandler = (e) => {
            if (!isDragging) return;
            const newLeft = e.clientX - offsetX;
            const maxLeft = window.innerWidth - playerContainer.offsetWidth;
            playerContainer.style.left = `${Math.max(0, Math.min(newLeft, maxLeft))}px`;
        };
        document.addEventListener('mousemove', moveHandler, { passive: true });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            document.removeEventListener('mousemove', moveHandler);
        }, { once: true });
    });

    // éŸ³é¢‘ç»“æŸå¤„ç†ï¼ˆå¸¸è§„å¾ªç¯é€»è¾‘ï¼‰
    globalAudio.addEventListener('ended', () => {
        switch(playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                // é¡ºåºæ’­æ”¾ï¼šæœ€åä¸€é¦–ç»“æŸåæš‚åœ
                if (playState.currentSongIndex === songList.length - 1) {
                    playState.isPlaying = false;
                    playBtn.textContent = 'â–¶';
                    draggablePlayer.classList.remove('playing');
                } else {
                    switchSong(playState.currentSongIndex + 1);
                }
                break;
            case LOOP_MODE.LIST_LOOP:
                // åˆ—è¡¨å¾ªç¯ï¼šè‡ªåŠ¨ä¸‹ä¸€é¦–ï¼Œå¾ªç¯å¾€å¤
                switchSong(playState.currentSongIndex + 1);
                break;
            case LOOP_MODE.SINGLE_LOOP:
                // å•æ›²å¾ªç¯ï¼šé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
                globalAudio.currentTime = 0;
                globalAudio.play();
                break;
        }
        savePlayState();
    });

    // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
    window.addEventListener('beforeunload', savePlayState);

    // åˆå§‹åŒ–ï¼ˆå¸¸è§„æ’­æ”¾å™¨å¯åŠ¨é€»è¾‘ï¼‰
    window.addEventListener('load', () => {
        // æ¢å¤ä¿å­˜çš„çŠ¶æ€
        globalAudio.volume = playState.volume;
        volumeSlider.value = playState.volume;
        volumeBtn.textContent = getVolumeIcon(playState.volume);
        updateLoopModeUI();

        // åŠ è½½å½“å‰æ­Œæ›²
        const currentSong = songList[playState.currentSongIndex];
        globalAudio.src = currentSong.audioUrl;
        globalAudio.currentTime = playState.currentTime;
        globalAudio.load();

        // æ›´æ–°UI
        playerTitleText.textContent = currentSong.title;
        playerSinger.textContent = currentSong.singer;
        totalTimeEl.textContent = currentSong.duration;
        document.querySelectorAll('.player-cover').forEach(cover => cover.style.display = 'none');
        document.getElementById(currentSong.coverId).style.display = 'block';

        // æ¢å¤æ’­æ”¾çŠ¶æ€
        if (playState.isPlaying) {
            globalAudio.play().then(() => {
                playBtn.textContent = 'â¸';
                draggablePlayer.classList.add('playing');
            }).catch(() => {
                playBtn.textContent = 'â–¶';
                draggablePlayer.classList.remove('playing');
                playState.isPlaying = false;
            });
        } else {
            playBtn.textContent = 'â–¶';
            draggablePlayer.classList.remove('playing');
        }
    });
</script>
</body>
</html>


