<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë∑®È°µÈü≥‰πêÊí≠ÊîæÂô®ÔºàÂÖ≠Âì•Ëç£ËÄÄWIKI‰∏ìÁî®Ôºâ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", "PingFang SC", sans-serif; }
        body { background: transparent; padding: 0; margin: 0; height: 100%; }
        /* Êí≠ÊîæÂô®‰∏ª‰Ωì */
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            width: 100%;
            background: #1e3a2f;
            border-top: 1px solid #3d725f;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
        }
        /* Ê†∏ÂøÉÊí≠ÊîæÂå∫ */
        .mini-music-player {
            width: 100%;
            height: 80px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }
        /* Â∞ÅÈù¢Ê†∑Âºè */
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #2d5243;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Êí≠Êîæ/ÊöÇÂÅúÂçïÊ¨°ÊóãËΩ¨Âä®Áîª */
        .rotate-on-toggle {
            animation: rotateOnce 0.5s linear forwards;
        }
        @keyframes rotateOnce {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Ê≠åÊõ≤‰ø°ÊÅØÂå∫ */
        .player-info {
            flex: 1;
            min-width: 150px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .player-title {
            font-size: 1rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .player-singer {
            font-size: 0.8rem;
            color: #99aabb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* ÂàóË°®ÊåâÈíÆ */
        .song-list-btn {
            background: transparent;
            border: 1px solid #3d725f;
            color: #81c784;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: auto;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .song-list-btn:hover {
            background: #2d5243;
            border-color: #81c784;
        }
        /* ÊéßÂà∂Âå∫ */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        .player-btn {
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.1rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: all 0.2s ease;
        }
        .play-main-btn {
            background: #81c784;
            color: #121212;
            font-size: 1.3rem;
            width: 44px;
            height: 44px;
            box-shadow: 0 -2px 6px rgba(129, 199, 132, 0.4);
        }
        .play-main-btn:hover {
            background: #a8d0b9;
            transform: scale(1.05);
        }
        .player-btn:not(.play-main-btn):hover {
            background: rgba(129, 199, 132, 0.15);
            color: #a8d0b9;
        }
        .player-btn.active {
            color: #81c784;
        }
        /* Èü≥ÈáèÊéßÂà∂Âå∫ */
        .player-volume {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
            pointer-events: auto !important;
            flex-shrink: 0;
        }
        .volume-btn {
            background: transparent;
            border: none;
            color: #99aabb;
            cursor: pointer;
            font-size: 1rem;
            z-index: 99999;
            transition: all 0.2s ease;
        }
        .volume-btn:hover {
            color: #81c784;
        }
        .volume-slider {
            width: 80px;
            height: 3px;
            background: #2d5243;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            opacity: 1;
            transition: all 0.2s ease;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #81c784;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.5);
        }
        /* ËøõÂ∫¶Êù°Âå∫Âüü */
        .player-progress {
            width: 100%;
            padding: 0 16px 8px;
            box-sizing: border-box;
        }
        .progress-bar-mini {
            width: 100%;
            height: 4px;
            background: #2d5243;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        .progress-mini {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: #81c784;
            border-radius: 2px;
        }
        .progress-thumb {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #81c784;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 4px rgba(129, 199, 132, 0.6);
            opacity: 1;
        }
        .time-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #99aabb;
            margin-top: 4px;
        }
        /* Âæ™ÁéØÊ®°ÂºèÊèêÁ§∫ */
        .loop-mode-tooltip {
            position: absolute;
            bottom: 120%;
            right: 50%;
            transform: translateX(50%);
            background: #2d5243;
            color: #81c784;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
        }
        .loop-btn:hover + .loop-mode-tooltip {
            display: block;
        }
        /* Ê≠åÊõ≤ÂàóË°®‰∏ãÊãâÊ°Ü */
        .dropdown-song-list {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            width: 100%;
            background: #1e3a2f;
            border-bottom: 1px solid #3d725f;
            max-height: 320px;
            overflow-y: auto;
            z-index: 99998;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.4);
            padding-bottom: 10px;
        }
        .dropdown-song-list.show {
            display: block !important;
        }
        .song-list {
            list-style: none;
        }
        .song-list li {
            padding: 10px 16px;
            color: #e0e0e0;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Á¨¨13È¶ñÂç†‰ΩçÁ¨¶Ê†∑Âºè */
        .song-list li.placeholder {
            color: #4a6e61;
            cursor: default;
            pointer-events: none;
        }
        .song-list li.placeholder:hover {
            background: transparent;
        }
        .song-list li.active {
            background: #2d5243;
            color: #81c784;
            font-weight: 500;
        }
        .song-list li:hover:not(.active):not(.placeholder) {
            background: rgba(45, 82, 67, 0.5);
        }
        .song-duration {
            font-size: 0.8rem;
            color: #99aabb;
        }
        .placeholder .song-duration {
            color: #3d725f;
        }
        /* ÊªöÂä®Êù°‰ºòÂåñ */
        .dropdown-song-list::-webkit-scrollbar {
            width: 6px;
        }
        .dropdown-song-list::-webkit-scrollbar-track {
            background: #23322d;
        }
        .dropdown-song-list::-webkit-scrollbar-thumb {
            background: #4a6e61;
            border-radius: 3px;
        }
        .dropdown-song-list::-webkit-scrollbar-thumb:hover {
            background: #81c784;
        }
        /* ÈöêËóèÈü≥È¢ëÊéß‰ª∂ */
        #backgroundAudio, .preload-audio { display: none; }
    </style>
</head>
<body>
    <!-- È¢ÑÂä†ËΩΩÈü≥È¢ëÂÆπÂô® -->
    <div id="preloadContainer">
        <audio class="preload-audio" preload="metadata" playsinline></audio>
        <audio class="preload-audio" preload="metadata" playsinline><|card|>:
        <audio class="preload-audio" preload="metadata" playsinline> ></audio>
    </div>

    <!-- Ê≠åÊõ≤ÂàóË°®ÂÆπÂô® -->
    <div class="dropdown-song-list" id="dropdownSongList">
        <ul class="song-list" id="songListUl"></ul>
    </div>

    <!-- Êí≠ÊîæÂô®‰∏ª‰Ωì -->
    <div class="player-container" id="playerContainer">
        <div class="mini-music-player" id="draggablePlayer">
            <!-- Â∞ÅÈù¢Âå∫Âüü -->
            <div class="player-cover" id="playerCover1">
                <img src="http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300" alt="ÊòîÊ∂ü">
            </div>
            <div class="player-cover" id="playerCover2" style="display:none;">
                <img src="http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300" alt="ËÄÄÊñë">
            </div>
            <div class="player-cover" id="playerCover3" style="display:none;">
                <img src="http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300" alt="ÊãÇÊôì">
            </div>
            <div class="player-cover" id="playerCover4" style="display:none;">
                <img src="http://p1.music.126.net/gtunmoxObQyoH01HzURNUw==/109951170292455448.jpg?param=300x300" alt="‰ΩïËÄÖ">
            </div>
            <div class="player-cover" id="playerCover5" style="display:none;">
                <img src="http://p1.music.126.net/jWx1g4PbZsIu9npNOlifzA==/109951170151255339.jpg?param=300x300" alt="Áù°Ëïâ‰πãÊ≠å">
            </div>
            <div class="player-cover" id="playerCover6" style="display:none;">
                <img src="http://p1.music.126.net/sZ-rACbFrybF0x_lI6XNMw==/109951169297766755.jpg?param=300x300" alt="‰∏çÁú†‰πãÂ§ú">
            </div>
            <div class="player-cover" id="playerCover7" style="display:none;">
                <img src="http://p1.music.126.net/arz1hBaMCVcVV3yktxpoGg==/109951172346365107.jpg?param=300x300" alt="Montagem Miau">
            </div>
            <div class="player-cover" id="playerCover8" style="display:none;">
                <img src="http://p1.music.126.net/ykljhikl5x5QXgYjiIvW8g==/109951163082689392.jpg?param=300x300" alt="Áå´ÁöÑËàûÊ≠•">
            </div>
            <div class="player-cover" id="playerCover9" style="display:none;">
                <img src="http://p2.music.126.net/6y-UleORITEDfD5K8I44Qw==/109951165493980841.jpg?param=300x300" alt="Á§∫‰æãÊ≠åÊõ≤9">
            </div>
            <div class="player-cover" id="playerCover10" style="display:none;">
                <img src="http://p2.music.126.net/rMVkn75VN1Wr8KkX505pvQ==/109951168596119971.jpg?param=300x300" alt="ÂèçÊ≠£(ÁãÆÂ≠êÂ∫ßÂπªÊÉ≥Êõ≤)">
            </div>
            <div class="player-cover" id="playerCover11" style="display:none;">
                <img src="http://p1.music.126.net/tAzWfNK5KALyV7OO2Vc3SA==/6068204674100518.jpg?param=300x300" alt="Counting Stars">
            </div>  
            <div class="player-cover" id="playerCover12" style="display:none;">
                <img src="http://p2.music.126.net/rqIc9szkJmBA3imeK8G1yA==/109951164451064842.jpg?param=300x300" alt="DJ Okawari-Flower Dance">  
            </div>
            
            <div class="player-cover" id="playerCover13" style="display:none;">
                <img src="http://p2.music.126.net/rJ89Zcogw7fb0sckH_JE_A==/109951169990094058.jpg?param=300x300" alt="My Darling">  
            </div>
            
            <div class="player-cover" id="playerCover999" style="display:none;">
                <img src="111" alt="Âª∂ÈïøÊ≠åÊõ≤ÂàóË°®‰∏ìÁî®">  
            </div>
            
            <!-- Ê≠åÊõ≤‰ø°ÊÅØÂå∫ -->
            <div class="player-info">
                <div class="player-title">
                    <span id="playerTitleText">ÊòîÊ∂ü</span>
                    <button class="song-list-btn" id="songListBtn" tabindex="0">ÂàóË°®</button>
                </div>
                <div class="player-singer" id="playerSinger">Âº†Èü∂Ê∂µ„ÄÅHOYO-MiX</div>
            </div>
            
            <!-- Êí≠ÊîæÊéßÂà∂Âå∫ -->
            <div class="player-controls">
                <button class="player-btn" id="miniPrevBtn" tabindex="0">‚ùÆ</button>
                <button class="player-btn play-main-btn" id="miniPlayBtn" tabindex="0">‚ñ∂</button>
                <button class="player-btn" id="miniNextBtn" tabindex="0">‚ùØ</button>
                <button class="player-btn loop-btn" id="loopBtn" title="ÂàáÊç¢Âæ™ÁéØÊ®°Âºè" tabindex="0">üîÅ</button>
                <div class="loop-mode-tooltip" id="loopTooltip">È°∫Â∫èÊí≠ÊîæÔºàÁÇπÂáªÂàáÊç¢ÂàóË°®Âæ™ÁéØÔºâ</div>
            </div>
            
            <!-- Èü≥ÈáèÊéßÂà∂Âå∫ -->
            <div class="player-volume">
                <button class="volume-btn" id="volumeBtn" tabindex="0">üîä</button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
            </div>
        </div>
        
        <!-- ËøõÂ∫¶Êù°Âå∫Âüü -->
        <div class="player-progress">
            <div class="progress-bar-mini" id="miniProgressBar">
                <div class="progress-mini" id="miniProgress"></div>
                <div class="progress-thumb" id="progressThumb"></div>
            </div>
            <div class="time-mini">
                <span class="current-time-mini" id="currentTime">00:00</span>
                <span class="total-time-mini" id="totalTime">03:06</span>
            </div>
        </div>
        
        <!-- ÂÖ®Â±ÄÈü≥È¢ëÂØπË±° -->
        <audio id="backgroundAudio" preload="metadata" playsinline>
            <source src="" type="audio/mpeg">
        </audio>
    </div>
    <script>
    // Ê†∏ÂøÉÈÖçÁΩÆ
    const songList = [
        { audioId: 'miniAudio1', coverId: 'playerCover1', title: 'ÊòîÊ∂ü', singer: 'Âº†Èü∂Ê∂µ„ÄÅHOYO-MiX', audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3', duration: '03:06' },
        { audioId: 'miniAudio2', coverId: 'playerCover2', title: 'ËÄÄÊñë', singer: 'HOYO-MiX,YMIR', audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3', duration: '03:33' },
        { audioId: 'miniAudio3', coverId: 'playerCover3', title: 'ÊãÇÊôì Proi Proi', singer: 'HOYO-MiX,NIDA', audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3', duration: '03:58' },
        { audioId: 'miniAudio4', coverId: 'playerCover4', title: '‰ΩïËÄÖ', singer: 'Ë∞≠Êô∂,HOYO-MiX', audioUrl: 'http://music.163.com/song/media/outer/url?id=2658660685.mp3', duration: '02:26' },
        { audioId: 'miniAudio5', coverId: 'playerCover5', title: 'Áù°Ëïâ‰πãÊ≠å', singer: 'HOYO-MiX', audioUrl: 'http://music.163.com/song/media/outer/url?id=2646986980.mp3', duration: '00:17' },
        { audioId: 'miniAudio6', coverId: 'playerCover6', title: '‰∏çÁú†‰πãÂ§ú', singer: 'Âº†Êù∞,HOYO-MiX', audioUrl: 'http://music.163.com/song/media/outer/url?id=2122308127.mp3', duration: '02:18' },
        { audioId: 'miniAudio7', coverId: 'playerCover7', title: 'Montagem Miau', singer: 'Pudding_PD,METAMOON', audioUrl: 'http://music.163.com/song/media/outer/url?id=3320816993.mp3', duration: '02:19' },
        { audioId: 'miniAudio8', coverId: 'playerCover8', title: 'Áå´ÁöÑËàûÊ≠•', singer: 'Candy_Wind', audioUrl: 'http://music.163.com/song/media/outer/url?id=523902194.mp3', duration: '03:07' },
        { audioId: 'miniAudio9', coverId: 'playerCover9', title: 'Á§∫‰æãÊ≠åÊõ≤9', singer: 'Ê≠åÊâã9', audioUrl: 'http://music.163.com/song/media/outer/url?id=1428234445.mp3', duration: '03:20' },
        { audioId: 'miniAudio10', coverId: 'playerCover10', title: 'ÂèçÊ≠£ÔºàÁãÆÂ≠êÂ∫ßÂπªÊÉ≥Êõ≤Ôºâ', singer: 'È´òÊ°•ÂçÉÊò•', audioUrl: 'http://music.163.com/song/media/outer/url?id=2045500209.mp3', duration: '03:11' },
        { audioId: 'miniAudio11', coverId: 'playerCover11', title: 'Counting Stars', singer: 'OneRepublic', audioUrl: 'http://music.163.com/song/media/outer/url?id=28575553.mp3', duration: '04:16' },
        { audioId: 'miniAudio12', coverId: 'playerCover12', title: 'DJ Okawari-Flower Dance', singer: 'Chopin Remix', audioUrl: 'http://music.163.com/song/media/outer/url?id=1405903472.mp3', duration: '04:07' },
        { audioId: 'miniAudio13', coverId: 'playerCover13', title: 'My Darling', singer: 'FLAVOREALM!Âë≥‰πãÈ¢ÜÂüü,Dyako', audioUrl: 'http://music.163.com/song/media/outer/url?id=2630666360.mp3', duration: '03:39' },
        { audioId: 'miniAudio999', coverId: 'playerCover999', title: 'Âª∂ÈïøÊ≠åÊõ≤ÂàóË°®‰∏ìÁî®', singer: 'Âç†‰ΩçÁ¨¶', audioUrl: '999', duration: '00:00' },
    ];
    const LOOP_MODE = { SEQUENCE: 0, LIST_LOOP: 1, SINGLE_LOOP: 2 };
    let playState = JSON.parse(localStorage.getItem('musicPlayerState')) || {
        currentSongIndex: 0,
        isPlaying: false,
        currentTime: 0,
        volume: 0.7,
        loopMode: LOOP_MODE.SEQUENCE
    };
    const preloadAudioEls = document.querySelectorAll('.preload-audio');
    const PRELOAD_COUNT = 2;
    let progressUpdateTimer = null;
    let listOpen = false;

    // ÂÖÉÁ¥†ÂàùÂßãÂåñ
    const backgroundAudio = document.getElementById('backgroundAudio');
    const playBtn = document.getElementById('miniPlayBtn');
    const progress = document.getElementById('miniProgress');
    const progressThumb = document.getElementById('progressThumb');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const prevBtn = document.getElementById('miniPrevBtn');
    const nextBtn = document.getElementById('miniNextBtn');
    const loopBtn = document.getElementById('loopBtn');
    const loopTooltip = document.getElementById('loopTooltip');
    const playerTitleText = document.getElementById('playerTitleText');
    const playerSinger = document.getElementById('playerSinger');
    const songListBtn = document.getElementById('songListBtn');
    const dropdownSongList = document.getElementById('dropdownSongList');
    const songListUl = document.getElementById('songListUl');
    const progressBar = document.getElementById('miniProgressBar');

    // Â∑•ÂÖ∑ÂáΩÊï∞
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    function getVolumeIcon(volume) {
        return volume > 0.5 ? 'üîä' : volume > 0 ? 'üîâ' : 'üîá';
    }

    function savePlayState() {
        playState.currentTime = backgroundAudio.currentTime;
        playState.volume = backgroundAudio.volume;
        localStorage.setItem('musicPlayerState', JSON.stringify(playState));
    }

    function triggerCoverRotate() {
        const currentCover = document.getElementById(songList[playState.currentSongIndex].coverId);
        const coverImg = currentCover.querySelector('img');
        coverImg.classList.remove('rotate-on-toggle');
        void coverImg.offsetWidth;
        coverImg.classList.add('rotate-on-toggle');
    }

    function updatePlayerUI() {
        const currentSong = songList[playState.currentSongIndex];
        playerTitleText.textContent = currentSong.title;
        playerSinger.textContent = currentSong.singer;
        totalTimeEl.textContent = currentSong.duration;

        document.querySelectorAll('.player-cover').forEach(cover => cover.style.display = 'none');
        document.getElementById(currentSong.coverId).style.display = 'block';

        playBtn.textContent = playState.isPlaying ? '‚è∏' : '‚ñ∂';
        volumeSlider.value = playState.volume;
        volumeBtn.textContent = getVolumeIcon(playState.volume);

        switch (playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                loopBtn.textContent = 'üîÅ';
                loopBtn.classList.remove('active');
                loopTooltip.textContent = 'È°∫Â∫èÊí≠ÊîæÔºàÁÇπÂáªÂàáÊç¢ÂàóË°®Âæ™ÁéØÔºâ';
                break;
            case LOOP_MODE.LIST_LOOP:
                loopBtn.textContent = 'üîÑ';
                loopBtn.classList.add('active');
                loopTooltip.textContent = 'ÂàóË°®Âæ™ÁéØÔºàÁÇπÂáªÂàáÊç¢ÂçïÊõ≤Âæ™ÁéØÔºâ';
                break;
            case LOOP_MODE.SINGLE_LOOP:
                loopBtn.textContent = 'üîÇ';
                loopBtn.classList.add('active');
                loopTooltip.textContent = 'ÂçïÊõ≤Âæ™ÁéØÔºàÁÇπÂáªÂàáÊç¢È°∫Â∫èÊí≠ÊîæÔºâ';
                break;
        }

        const totalSeconds = currentSong.duration.split(':').reduce((m, s) => m * 60 + parseInt(s), 0);
        const currentTime = playState.isPlaying ? backgroundAudio.currentTime : playState.currentTime;
        const percent = (currentTime / totalSeconds) * 100;
        progress.style.width = `${percent}%`;
        progressThumb.style.left = `${percent}%`;
        currentTimeEl.textContent = formatTime(currentTime);
    }

    function preloadSongs(currentIndex) {
        const preloadIndexes = [];
        for (let i = 1; i <= PRELOAD_COUNT; i++) {
            const idx = currentIndex - i;
            if (idx >= 0 && idx < 14) preloadIndexes.push(idx);
        }
        for (let i = 1; i <= PRELOAD_COUNT; i++) {
            const idx = currentIndex + i;
            if (idx < 13) preloadIndexes.push(idx);
        }
        preloadIndexes.forEach((idx, elIdx) => {
            if (elIdx < preloadAudioEls.length) {
                const audioEl = preloadAudioEls[elIdx];
                audioEl.src = songList[idx].audioUrl;
                audioEl.load();
            }
        });
    }

    function startProgressUpdate() {
        if (progressUpdateTimer) clearInterval(progressUpdateTimer);
        progressUpdateTimer = setInterval(() => {
            if (playState.isPlaying && !backgroundAudio.paused) {
                updatePlayerUI();
            }
        }, 1000);
    }

    function stopProgressUpdate() {
        if (progressUpdateTimer) {
            clearInterval(progressUpdateTimer);
            progressUpdateTimer = null;
        }
    }

    // Ê†∏ÂøÉÊí≠ÊîæÈÄªËæë
    function switchSong(newIndex) {
        if (newIndex < 0) {
            newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? 12 : 0;
        } else if (newIndex >= 12) {
            newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? 0 : 12;
        }
        playState.currentSongIndex = newIndex;
        const newSong = songList[newIndex];

        backgroundAudio.src = newSong.audioUrl;
        backgroundAudio.currentTime = 0;
        backgroundAudio.load();
        preloadSongs(newIndex);

        if (playState.isPlaying) {
            backgroundAudio.play().catch(err => {
                playState.isPlaying = false;
                savePlayState();
                updatePlayerUI();
                alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÂô®ÈáçËØïÔºàÊµèËßàÂô®ÂèØËÉΩÈôêÂà∂Ëá™Âä®Êí≠ÊîæÔºâ');
            });
            startProgressUpdate();
        } else {
            stopProgressUpdate();
        }

        savePlayState();
        updatePlayerUI();
        listOpen = false;
        dropdownSongList.classList.remove('show');
    }

    // ‰∫ã‰ª∂ÁõëÂê¨
    playBtn.addEventListener('click', () => {
        playState.isPlaying = !playState.isPlaying;
        triggerCoverRotate();

        if (playState.isPlaying) {
            backgroundAudio.play().catch(err => {
                playState.isPlaying = false;
                alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÂô®ÈáçËØï');
            });
            startProgressUpdate();
        } else {
            backgroundAudio.pause();
            stopProgressUpdate();
            playState.currentTime = backgroundAudio.currentTime;
            savePlayState();
        }

        updatePlayerUI();
    });

    prevBtn.addEventListener('click', () => switchSong(playState.currentSongIndex - 1));
    nextBtn.addEventListener('click', () => switchSong(playState.currentSongIndex + 1));

    volumeBtn.addEventListener('click', () => {
        playState.volume = playState.volume === 1 ? 0 : playState.volume > 0 ? 1 : 0.7;
        backgroundAudio.volume = playState.volume;
        savePlayState();
        updatePlayerUI();
    });

    volumeSlider.addEventListener('input', () => {
        playState.volume = parseFloat(volumeSlider.value);
        backgroundAudio.volume = playState.volume;
        volumeBtn.textContent = getVolumeIcon(playState.volume);
        savePlayState();
    });

    loopBtn.addEventListener('click', () => {
        playState.loopMode = (playState.loopMode + 1) % 3;
        savePlayState();
        updatePlayerUI();
    });

    progressBar.addEventListener('click', (e) => {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const currentSong = songList[playState.currentSongIndex];
        const totalSeconds = currentSong.duration.split(':').reduce((m, s) => m * 60 + parseInt(s), 0);
        const newProgress = percent * totalSeconds;
        backgroundAudio.currentTime = newProgress;
        playState.currentTime = newProgress;
        savePlayState();
        updatePlayerUI();
    });

    // Ê≠åÊõ≤ÂàóË°®ÈÄªËæë
    function renderSongList() {
        songListUl.innerHTML = '';
        songList.forEach((song, idx) => {
            const li = document.createElement('li');
            if (idx === 14) {
                li.classList.add('placeholder');
            } else {
                li.classList.toggle('active', idx === playState.currentSongIndex);
            }
            li.innerHTML = `
                <span>${idx + 1}. ${song.title} - ${song.singer}</span>
                <span class="song-duration">${song.duration}</span>
            `;
            if (idx < 14) {
                li.addEventListener('click', () => {
                    playState.isPlaying = true;
                    switchSong(idx);
                    triggerCoverRotate();
                });
            }
            songListUl.appendChild(li);
        });
    }

    songListBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        listOpen = !listOpen;
        dropdownSongList.classList.toggle('show', listOpen);
        if (listOpen) renderSongList();
    });

    document.addEventListener('click', (e) => {
        if (listOpen && !e.target.closest('#playerContainer') && !e.target.closest('#dropdownSongList')) {
            listOpen = false;
            dropdownSongList.classList.remove('show');
        }
    });

    // Ë∑®È°µÂêåÊ≠•
    window.addEventListener('storage', (e) => {
        if (e.key === 'musicPlayerState') {
            const oldState = { ...playState };
            playState = JSON.parse(e.newValue);
            if (playState.currentSongIndex >= 12) playState.currentSongIndex = 11;

            backgroundAudio.volume = playState.volume;
            if (backgroundAudio.src !== songList[playState.currentSongIndex].audioUrl) {
                backgroundAudio.src = songList[playState.currentSongIndex].audioUrl;
                backgroundAudio.load();
                preloadSongs(playState.currentSongIndex);
            }
            backgroundAudio.currentTime = playState.currentTime;

            if (playState.isPlaying !== oldState.isPlaying) {
                triggerCoverRotate();
                if (playState.isPlaying && backgroundAudio.paused) {
                    backgroundAudio.play().catch(() => {});
                    startProgressUpdate();
                } else if (!playState.isPlaying && !backgroundAudio.paused) {
                    backgroundAudio.pause();
                    stopProgressUpdate();
                }
            }

            updatePlayerUI();
        }
    });

    // Êí≠ÊîæÂô®ÊãñÂä®
    document.getElementById('draggablePlayer').addEventListener('mousedown', (e) => {
        if (e.target.closest('.player-btn, .volume-btn, .song-list-btn, .volume-slider, .progress-bar-mini')) return;
        let isDragging = true;
        const rect = document.getElementById('playerContainer').getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const moveHandler = (e) => {
            if (!isDragging) return;
            const newLeft = e.clientX - offsetX;
            const maxLeft = window.innerWidth - document.getElementById('playerContainer').offsetWidth;
            document.getElementById('playerContainer').style.left = `${Math.max(0, Math.min(newLeft, maxLeft))}px`;
        };
        document.addEventListener('mousemove', moveHandler, { passive: true });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            document.removeEventListener('mousemove', moveHandler);
        }, { once: true });
    });

    // Èü≥È¢ëÁªìÊùüÂ§ÑÁêÜ
    backgroundAudio.addEventListener('ended', () => {
        switch (playState.loopMode) {
            case LOOP_MODE.SEQUENCE:
                if (playState.currentSongIndex === 11) {
                    playState.isPlaying = false;
                    stopProgressUpdate();
                    savePlayState();
                    updatePlayerUI();
                } else switchSong(playState.currentSongIndex + 1);
                break;
            case LOOP_MODE.LIST_LOOP:
                switchSong(playState.currentSongIndex + 1);
                break;
            case LOOP_MODE.SINGLE_LOOP:
                backgroundAudio.currentTime = 0;
                backgroundAudio.play();
                triggerCoverRotate();
                startProgressUpdate();
                break;
        }
    });

    // ÂàùÂßãÂåñ
    window.addEventListener('load', () => {
        if (playState.currentSongIndex >= 12) playState.currentSongIndex = 0;
        backgroundAudio.volume = playState.volume;
        const currentSong = songList[playState.currentSongIndex];
        backgroundAudio.src = currentSong.audioUrl;
        backgroundAudio.currentTime = playState.currentTime;
        backgroundAudio.load();
        preloadSongs(playState.currentSongIndex);

        if (playState.isPlaying) {
            backgroundAudio.play().catch(() => {
                playState.isPlaying = false;
                savePlayState();
            });
            startProgressUpdate();
        }

        updatePlayerUI();
        setInterval(savePlayState, 3000);
    });

    window.addEventListener('beforeunload', () => {
        savePlayState();
        stopProgressUpdate();
    });
</script>
</body>
</html>
