<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿·ä½ éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: transparent; 
            padding: 0; 
            margin: 0; 
            height: 100vh;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        /* è¿·ä½ æ’­æ”¾å™¨å®¹å™¨ */
        .mini-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99999;
            width: 280px;
            height: 70px;
            background: rgba(30, 58, 47, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 35px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(61, 114, 95, 0.5);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 12px;
            cursor: move;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .mini-player:hover {
            background: rgba(30, 58, 47, 0.98);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
            transform: translateY(-2px);
        }
        
        /* è¿·ä½ å°é¢ */
        .mini-cover {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .mini-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .playing .mini-cover img {
            animation: rotateCover 20s linear infinite;
        }
        
        @keyframes rotateCover {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* æ­Œæ›²ä¿¡æ¯ */
        .mini-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .mini-title {
            font-size: 0.9rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        .mini-singer {
            font-size: 0.75rem;
            color: #99aabb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .mini-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .mini-btn {
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .mini-btn:hover {
            background: rgba(129, 199, 132, 0.15);
            color: #81c784;
            transform: scale(1.1);
        }
        
        .play-btn {
            background: #81c784;
            color: #121212;
            font-size: 1.1rem;
        }
        
        .play-btn:hover {
            background: #a8d0b9;
            color: #121212;
        }
        
        /* éŸ³é‡æ§åˆ¶ */
        .volume-popup {
            position: absolute;
            bottom: 80px;
            right: 0;
            background: rgba(30, 58, 47, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 100000;
        }
        
        .volume-popup.show {
            display: block;
        }
        
        .volume-slider {
            width: 120px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(45, 82, 67, 0.8);
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #81c784;
            cursor: pointer;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-overlay {
            position: absolute;
            top: -6px;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(45, 82, 67, 0.5);
            border-radius: 1.5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #81c784;
            transition: width 0.3s ease;
        }
        
        /* æ—¶é—´æ˜¾ç¤º */
        .time-tooltip {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 58, 47, 0.95);
            color: #99aabb;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            display: none;
            z-index: 100000;
        }
        
        /* éšè—éŸ³é¢‘ */
        audio { display: none; }
    </style>
</head>
<body>
    <!-- è¿·ä½ æ’­æ”¾å™¨ -->
    <div class="mini-player" id="miniPlayer">
        <div class="progress-overlay">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="mini-cover" id="miniCover">
            <img src="" alt="å°é¢" id="coverImage">
        </div>
        
        <div class="mini-info">
            <div class="mini-title" id="songTitle">åŠ è½½ä¸­...</div>
            <div class="mini-singer" id="songSinger"></div>
        </div>
        
        <div class="mini-controls">
            <button class="mini-btn" id="prevBtn" title="ä¸Šä¸€é¦–">â®</button>
            <button class="mini-btn play-btn" id="playBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
            <button class="mini-btn" id="nextBtn" title="ä¸‹ä¸€é¦–">â­</button>
            <button class="mini-btn" id="volumeBtn" title="éŸ³é‡">ğŸ”Š</button>
        </div>
        
        <!-- éŸ³é‡æ§åˆ¶å¼¹å‡ºå±‚ -->
        <div class="volume-popup" id="volumePopup">
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
        </div>
        
        <!-- æ—¶é—´æç¤º -->
        <div class="time-tooltip" id="timeTooltip">00:00 / 00:00</div>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

<script>
    // ğŸµ ========== æ­Œæ›²åˆ—è¡¨ ========== ğŸµ
    // åªéœ€ä¿®æ”¹è¿™ä¸ªæ•°ç»„æ¥æ·»åŠ /åˆ é™¤æ­Œæ›²
    const songList = [
        {
            title: 'æ˜”æ¶Ÿ',
            singer: 'å¼ éŸ¶æ¶µã€HOYO-MiX',
            audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3',
            duration: '03:06',
            coverUrl: 'http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300'
        },
        {
            title: 'è€€æ–‘',
            singer: 'HOYO-MiX,YMIR',
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3',
            duration: '03:33',
            coverUrl: 'http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300'
        },
        {
            title: 'æ‹‚æ™“ Proi Proi',
            singer: 'HOYO-MiX,NIDA',
            audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3',
            duration: '03:58',
            coverUrl: 'http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300'
        }
    ];

    // æ’­æ”¾çŠ¶æ€
    let currentSongIndex = 0;
    let isPlaying = false;
    let volume = 0.7;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    
    // è·¨é¡µæ’­æ”¾æ ‡è¯†
    const STORAGE_KEY = 'musicPlayerState';
    const BROADCAST_CHANNEL_NAME = 'music_player_channel';

    // DOMå…ƒç´ 
    const miniPlayer = document.getElementById('miniPlayer');
    const audioPlayer = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumePopup = document.getElementById('volumePopup');
    const volumeSlider = document.getElementById('volumeSlider');
    const songTitle = document.getElementById('songTitle');
    const songSinger = document.getElementById('songSinger');
    const coverImage = document.getElementById('coverImage');
    const progressFill = document.getElementById('progressFill');
    const timeTooltip = document.getElementById('timeTooltip');
    
    // è·¨é¡µé€šä¿¡å¯¹è±¡
    let broadcastChannel = null;
    let isInitialized = false;

    // ========== è·¨é¡µæ’­æ”¾æ ¸å¿ƒå‡½æ•° ==========
    
    // åˆå§‹åŒ–è·¨é¡µé€šä¿¡
    function initCrossPageCommunication() {
        // å°è¯•ä½¿ç”¨ BroadcastChannel API
        if ('BroadcastChannel' in window) {
            try {
                broadcastChannel = new BroadcastChannel(BROADCAST_CHANNEL_NAME);
                
                broadcastChannel.onmessage = (event) => {
                    const data = event.data;
                    
                    switch (data.type) {
                        case 'PLAYBACK_STATE_CHANGED':
                            // å…¶ä»–é¡µé¢çš„æ’­æ”¾çŠ¶æ€æ”¹å˜äº†ï¼Œæ›´æ–°æœ¬é¡µé¢
                            if (data.origin !== getPageId()) {
                                loadPlaybackState(true);
                            }
                            break;
                            
                        case 'PING':
                            // å“åº”pingæ¶ˆæ¯
                            broadcastChannel.postMessage({
                                type: 'PONG',
                                pageId: getPageId(),
                                timestamp: Date.now()
                            });
                            break;
                            
                        case 'REQUEST_STATE':
                            // å…¶ä»–é¡µé¢è¯·æ±‚å½“å‰çŠ¶æ€
                            broadcastChannel.postMessage({
                                type: 'PROVIDE_STATE',
                                state: getCurrentState(),
                                pageId: getPageId()
                            });
                            break;
                    }
                };
                
                console.log('BroadcastChannel åˆå§‹åŒ–æˆåŠŸ');
            } catch (e) {
                console.warn('BroadcastChannel åˆå§‹åŒ–å¤±è´¥:', e);
                broadcastChannel = null;
            }
        }
    }
    
    // è·å–é¡µé¢å”¯ä¸€æ ‡è¯†
    function getPageId() {
        if (!window.pageId) {
            window.pageId = 'page_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        return window.pageId;
    }
    
    // è·å–å½“å‰æ’­æ”¾çŠ¶æ€
    function getCurrentState() {
        return {
            currentSongIndex,
            currentTime: audioPlayer.currentTime,
            isPlaying,
            volume,
            songTitle: songList[currentSongIndex]?.title || '',
            songSinger: songList[currentSongIndex]?.singer || ''
        };
    }
    
    // ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ° localStorage
    function savePlaybackState() {
        const state = {
            currentSongIndex,
            currentTime: audioPlayer.currentTime,
            isPlaying,
            volume,
            timestamp: Date.now(),
            songTitle: songList[currentSongIndex]?.title || '',
            songSinger: songList[currentSongIndex]?.singer || '',
            pageId: getPageId()
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        
        // å¹¿æ’­çŠ¶æ€æ”¹å˜
        broadcastStateChange();
    }
    
    // å¹¿æ’­çŠ¶æ€æ”¹å˜
    function broadcastStateChange() {
        if (broadcastChannel) {
            broadcastChannel.postMessage({
                type: 'PLAYBACK_STATE_CHANGED',
                state: getCurrentState(),
                origin: getPageId(),
                timestamp: Date.now()
            });
        }
        
        // åŒæ—¶å­˜å‚¨åˆ° localStorage ä½œä¸ºå¤‡ä»½
        localStorage.setItem(STORAGE_KEY + '_backup', JSON.stringify(getCurrentState()));
    }
    
    // åŠ è½½æ’­æ”¾çŠ¶æ€
    function loadPlaybackState(fromBroadcast = false) {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;
            
            const state = JSON.parse(saved);
            
            // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æ—¶ï¼ˆè¶…è¿‡30ç§’è®¤ä¸ºæ˜¯æ—§çŠ¶æ€ï¼‰
            if (state.timestamp && (Date.now() - state.timestamp > 30000) && !fromBroadcast) {
                console.log('æ’­æ”¾çŠ¶æ€å·²è¿‡æœŸï¼Œå¿½ç•¥');
                return false;
            }
            
            // å¦‚æœæ˜¯æ¥è‡ªå…¶ä»–é¡µé¢çš„å¹¿æ’­ä¸”å½“å‰æ­£åœ¨æ’­æ”¾ï¼Œå¿½ç•¥
            if (fromBroadcast && isPlaying && audioPlayer.currentTime > 1) {
                // å¦‚æœæœ¬é¡µé¢å·²ç»åœ¨æ’­æ”¾ï¼Œä¸”æ’­æ”¾è¿›åº¦è¶…è¿‡1ç§’ï¼Œå¿½ç•¥å…¶ä»–é¡µé¢çš„çŠ¶æ€
                if (audioPlayer.currentTime > 1 && Math.abs(audioPlayer.currentTime - (state.currentTime || 0)) > 5) {
                    console.log('æœ¬é¡µé¢æ­£åœ¨æ’­æ”¾ï¼Œå¿½ç•¥å…¶ä»–é¡µé¢çš„çŠ¶æ€');
                    return false;
                }
            }
            
            // æ£€æŸ¥æ­Œæ›²ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
            if (state.currentSongIndex >= 0 && state.currentSongIndex < songList.length) {
                const shouldLoadSong = state.currentSongIndex !== currentSongIndex;
                const shouldRestoreTime = state.currentTime > 0.1;
                
                // æ›´æ–°çŠ¶æ€å˜é‡
                currentSongIndex = state.currentSongIndex;
                isPlaying = state.isPlaying;
                volume = state.volume || 0.7;
                
                // å¦‚æœéœ€è¦åŠ è½½æ–°æ­Œæ›²
                if (shouldLoadSong) {
                    loadSong(currentSongIndex, shouldRestoreTime ? state.currentTime : false);
                } else if (shouldRestoreTime && audioPlayer.src) {
                    // åŒä¸€é¦–æ­Œï¼Œæ¢å¤æ—¶é—´
                    audioPlayer.currentTime = state.currentTime;
                }
                
                // æ›´æ–°UI
                updatePlayerUI();
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€
                if (isPlaying && audioPlayer.src) {
                    audioPlayer.play().catch(e => {
                        console.log('æ¢å¤æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’');
                        isPlaying = false;
                        updatePlayerUI();
                    });
                }
                
                // æ¢å¤éŸ³é‡
                audioPlayer.volume = volume;
                volumeSlider.value = volume;
                updateVolumeIcon();
                
                console.log('åŠ è½½æ’­æ”¾çŠ¶æ€æˆåŠŸ:', {
                    fromBroadcast,
                    songIndex: currentSongIndex,
                    time: state.currentTime,
                    playing: isPlaying
                });
                
                return true;
            }
        } catch (e) {
            console.error('åŠ è½½æ’­æ”¾çŠ¶æ€å¤±è´¥:', e);
        }
        
        return false;
    }
    
    // æ¯éš”ä¸€æ®µæ—¶é—´ä¿å­˜çŠ¶æ€
    let saveInterval = null;
    function startAutoSave() {
        if (saveInterval) clearInterval(saveInterval);
        
        saveInterval = setInterval(() => {
            if (audioPlayer.src && (isPlaying || audioPlayer.currentTime > 0)) {
                savePlaybackState();
            }
        }, 2000); // æ¯2ç§’ä¿å­˜ä¸€æ¬¡
    }
    
    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    function setupVisibilityListener() {
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€
                savePlaybackState();
            } else {
                // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
                setTimeout(() => {
                    loadPlaybackState();
                }, 100);
            }
        });
    }

    // ========== åŸæœ‰æ’­æ”¾å™¨åŠŸèƒ½ ==========
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    // æ›´æ–°æ’­æ”¾å™¨UI
    function updatePlayerUI() {
        const song = songList[currentSongIndex];
        
        songTitle.textContent = song.title;
        songSinger.textContent = song.singer;
        coverImage.src = song.coverUrl;
        coverImage.alt = song.title;
        
        playBtn.textContent = isPlaying ? 'â¸' : 'â–¶';
        
        // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
        prevBtn.style.display = songList.length > 1 ? 'flex' : 'none';
        nextBtn.style.display = songList.length > 1 ? 'flex' : 'none';
        
        // å°é¢æ—‹è½¬
        if (isPlaying) {
            miniPlayer.classList.add('playing');
        } else {
            miniPlayer.classList.remove('playing');
        }
        
        // æ›´æ–°éŸ³é‡å›¾æ ‡
        updateVolumeIcon();
    }
    
    // æ›´æ–°éŸ³é‡å›¾æ ‡
    function updateVolumeIcon() {
        if (volume === 0) {
            volumeBtn.textContent = 'ğŸ”‡';
        } else if (volume < 0.5) {
            volumeBtn.textContent = 'ğŸ”‰';
        } else {
            volumeBtn.textContent = 'ğŸ”Š';
        }
    }

    // åŠ è½½æ­Œæ›²
    function loadSong(index, restoreTime = false) {
        if (index < 0 || index >= songList.length) return;
        
        const song = songList[index];
        
        // ä¿å­˜ä¹‹å‰çš„æ’­æ”¾çŠ¶æ€
        const wasPlaying = isPlaying;
        
        // æ›´æ–°å½“å‰æ­Œæ›²ç´¢å¼•
        currentSongIndex = index;
        
        // è®¾ç½®éŸ³é¢‘æº
        audioPlayer.src = song.audioUrl;
        audioPlayer.load();
        
        // å¦‚æœéœ€è¦æ¢å¤æ—¶é—´
        if (restoreTime) {
            if (typeof restoreTime === 'number') {
                audioPlayer.currentTime = restoreTime;
            } else {
                // ä»å­˜å‚¨ä¸­æ¢å¤æ—¶é—´
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.currentSongIndex === index && state.currentTime > 0.1) {
                        audioPlayer.currentTime = state.currentTime;
                    }
                }
            }
        }
        
        // æ¢å¤æ’­æ”¾çŠ¶æ€
        if (wasPlaying) {
            audioPlayer.play().catch(e => {
                console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’');
                isPlaying = false;
                updatePlayerUI();
            });
        }
        
        updatePlayerUI();
        updateProgress();
        
        // ä¿å­˜çŠ¶æ€
        setTimeout(() => {
            savePlaybackState();
        }, 100);
    }

    // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
    function togglePlay() {
        isPlaying = !isPlaying;
        
        if (isPlaying) {
            // å¦‚æœè¿˜æ²¡è®¾ç½®éŸ³é¢‘æºï¼Œå…ˆåŠ è½½å½“å‰æ­Œæ›²
            if (!audioPlayer.src) {
                loadSong(currentSongIndex);
            }
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
        
        updatePlayerUI();
        savePlaybackState();
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress() {
        if (!audioPlayer.duration) return;
        
        const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressFill.style.width = `${percent}%`;
        
        // æ˜¾ç¤ºæ—¶é—´æç¤º
        if (isDragging) {
            timeTooltip.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
        }
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    
    // è¿›åº¦æ¡ç‚¹å‡»
    miniPlayer.addEventListener('click', (e) => {
        const rect = miniPlayer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percent = clickX / rect.width;
        
        if (audioPlayer.duration) {
            audioPlayer.currentTime = percent * audioPlayer.duration;
            updateProgress();
            savePlaybackState();
        }
    });

    // æ‹–åŠ¨è¿›åº¦æ¡
    miniPlayer.addEventListener('mousedown', (e) => {
        if (e.target.closest('.mini-btn, .volume-popup')) return;
        
        isDragging = true;
        const rect = miniPlayer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        
        const moveHandler = (moveEvent) => {
            const moveX = moveEvent.clientX - rect.left;
            const percent = Math.max(0, Math.min(1, moveX / rect.width));
            
            if (audioPlayer.duration) {
                audioPlayer.currentTime = percent * audioPlayer.duration;
                updateProgress();
                
                // æ˜¾ç¤ºæ—¶é—´æç¤º
                timeTooltip.style.display = 'block';
                timeTooltip.style.left = `${moveX}px`;
            }
        };
        
        const upHandler = () => {
            isDragging = false;
            timeTooltip.style.display = 'none';
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', upHandler);
            savePlaybackState();
        };
        
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
        
        // åˆå§‹ç‚¹å‡»
        if (audioPlayer.duration) {
            audioPlayer.currentTime = Math.max(0, Math.min(1, clickX / rect.width)) * audioPlayer.duration;
            updateProgress();
            savePlaybackState();
        }
        
        e.preventDefault();
    });

    // æ’­æ”¾å™¨æ‹–åŠ¨åŠŸèƒ½
    miniPlayer.addEventListener('mousedown', (e) => {
        if (e.target.closest('.mini-btn') || e.target.closest('.volume-popup')) return;
        
        const startX = e.clientX;
        const startY = e.clientY;
        const startLeft = parseInt(window.getComputedStyle(miniPlayer).left) || 0;
        const startTop = parseInt(window.getComputedStyle(miniPlayer).top) || 0;
        
        const moveHandler = (moveEvent) => {
            const deltaX = moveEvent.clientX - startX;
            const deltaY = moveEvent.clientY - startY;
            
            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;
            
            // é™åˆ¶åœ¨çª—å£å†…
            newLeft = Math.max(10, Math.min(newLeft, window.innerWidth - miniPlayer.offsetWidth - 10));
            newTop = Math.max(10, Math.min(newTop, window.innerHeight - miniPlayer.offsetHeight - 10));
            
            miniPlayer.style.left = `${newLeft}px`;
            miniPlayer.style.top = `${newTop}px`;
            miniPlayer.style.right = 'auto';
            miniPlayer.style.bottom = 'auto';
            miniPlayer.style.transform = 'none';
        };
        
        const upHandler = () => {
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', upHandler);
        };
        
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
    });

    // æŒ‰é’®äº‹ä»¶ç›‘å¬
    playBtn.addEventListener('click', togglePlay);
    
    prevBtn.addEventListener('click', () => {
        if (songList.length <= 1) return;
        currentSongIndex = (currentSongIndex - 1 + songList.length) % songList.length;
        loadSong(currentSongIndex);
        if (isPlaying) audioPlayer.play();
    });
    
    nextBtn.addEventListener('click', () => {
        if (songList.length <= 1) return;
        currentSongIndex = (currentSongIndex + 1) % songList.length;
        loadSong(currentSongIndex);
        if (isPlaying) audioPlayer.play();
    });

    // éŸ³é‡æ§åˆ¶
    volumeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        volumePopup.classList.toggle('show');
    });

    volumeSlider.addEventListener('input', (e) => {
        volume = parseFloat(e.target.value);
        audioPlayer.volume = volume;
        updateVolumeIcon();
        savePlaybackState();
    });

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­éŸ³é‡æ§åˆ¶
    document.addEventListener('click', (e) => {
        if (!volumePopup.contains(e.target) && e.target !== volumeBtn) {
            volumePopup.classList.remove('show');
        }
    });

    // éŸ³é¢‘äº‹ä»¶
    audioPlayer.addEventListener('timeupdate', updateProgress);
    
    audioPlayer.addEventListener('ended', () => {
        if (songList.length > 1) {
            currentSongIndex = (currentSongIndex + 1) % songList.length;
            loadSong(currentSongIndex);
            if (isPlaying) audioPlayer.play();
        } else {
            audioPlayer.currentTime = 0;
            isPlaying = false;
            updatePlayerUI();
        }
        savePlaybackState();
    });

    audioPlayer.addEventListener('loadedmetadata', () => {
        updateProgress();
    });
    
    // éŸ³é¢‘æ’­æ”¾ç›¸å…³äº‹ä»¶
    audioPlayer.addEventListener('play', () => {
        isPlaying = true;
        updatePlayerUI();
        savePlaybackState();
    });
    
    audioPlayer.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayerUI();
        savePlaybackState();
    });
    
    audioPlayer.addEventListener('volumechange', () => {
        savePlaybackState();
    });

    // ========== åˆå§‹åŒ– ==========
    function initializePlayer() {
        if (isInitialized) return;
        
        console.log('åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨...');
        
        // åˆå§‹åŒ–è·¨é¡µé€šä¿¡
        initCrossPageCommunication();
        
        // å°è¯•åŠ è½½ä¿å­˜çš„æ’­æ”¾çŠ¶æ€
        const loaded = loadPlaybackState();
        
        // å¦‚æœåŠ è½½å¤±è´¥æˆ–æ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼ŒåŠ è½½ç¬¬ä¸€é¦–æ­Œ
        if (!loaded) {
            loadSong(0);
        }
        
        // è®¾ç½®éŸ³é‡
        audioPlayer.volume = volume;
        volumeSlider.value = volume;
        updateVolumeIcon();
        
        // å¼€å§‹è‡ªåŠ¨ä¿å­˜
        startAutoSave();
        
        // è®¾ç½®é¡µé¢å¯è§æ€§ç›‘å¬
        setupVisibilityListener();
        
        // å³é”®èœå•æ§åˆ¶
        miniPlayer.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            alert(`å½“å‰æ’­æ”¾: ${songList[currentSongIndex].title}\nåˆ—è¡¨: ${songList.map(s => s.title).join(', ')}`);
        });
        
        // åŒå‡»åˆ‡æ¢æ’­æ”¾çŠ¶æ€
        miniPlayer.addEventListener('dblclick', (e) => {
            if (e.target.closest('.mini-btn')) return;
            togglePlay();
        });
        
        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        isInitialized = true;
        
        console.log('éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰çŠ¶æ€:', getCurrentState());
        
        // å‘çˆ¶é¡µé¢å‘é€åŠ è½½å®Œæˆæ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯iframeï¼‰
        if (window.parent !== window) {
            setTimeout(() => {
                try {
                    window.parent.postMessage({
                        type: 'MUSIC_PLAYER_READY',
                        state: getCurrentState()
                    }, '*');
                } catch (e) {
                    console.log('æ— æ³•å‘çˆ¶é¡µé¢å‘é€æ¶ˆæ¯');
                }
            }, 500);
        }
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            togglePlay();
        }
        
        if (e.code === 'ArrowLeft' && songList.length > 1) {
            e.preventDefault();
            prevBtn.click();
        }
        
        if (e.code === 'ArrowRight' && songList.length > 1) {
            e.preventDefault();
            nextBtn.click();
        }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', initializePlayer);
    
    // å¦‚æœé¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
    if (document.readyState === 'complete') {
        setTimeout(initializePlayer, 100);
    }
    
    // ç›‘å¬æ¥è‡ªå…¶ä»–é¡µé¢çš„æ¶ˆæ¯
    window.addEventListener('storage', (e) => {
        if (e.key === STORAGE_KEY) {
            // localStorageä¸­çš„æ’­æ”¾çŠ¶æ€æ”¹å˜äº†
            setTimeout(() => {
                loadPlaybackState();
            }, 100);
        }
    });
    
    // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
    window.addEventListener('beforeunload', () => {
        savePlaybackState();
        
        // æ¸…ç†èµ„æº
        if (broadcastChannel) {
            broadcastChannel.close();
        }
        if (saveInterval) {
            clearInterval(saveInterval);
        }
    });
</script>
</body>
</html>