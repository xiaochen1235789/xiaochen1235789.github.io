<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æ’­æ”¾å™¨ï¼ˆè·¨é¡µé¢ç»­æ’­+å¾ªç¯æ¨¡å¼ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { background: transparent; padding: 0; margin: 0; height: 100%; }
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .player-mini-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1e3a2f;
            border: 1px solid #3d725f;
            color: #81c784;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .mini-music-player {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 300px;
            height: 60px;
            background: #1e3a2f;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px 8px 0 0;
            border: 1px solid #3d725f;
            border-bottom: none;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
            cursor: move;
            user-select: none;
            -webkit-user-drag: none;
            position: relative;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overflow: visible !important;
        }
        .player-cover {
            width: 44px;
            height: 44px;
            border-radius: 4px;
            background: #2d5243;
            overflow: hidden;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            transition: transform 0.5s ease;
        }
        .mini-music-player.playing .player-cover img { transform: rotate(360deg); }
        .player-info {
            flex: 0 0 180px;
            flex-shrink: 0;
            pointer-events: none;
        }
        .player-title {
            font-size: 0.9rem;
            color: #81c784;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.2s ease;
        }
        .player-singer {
            font-size: 0.75rem;
            color: #99aabb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-controls { display: flex; align-items: center; gap: 8px; }
        .player-btn {
            background: transparent;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto !important;
        }
        .play-main-btn { background: #81c784; color: #121212; font-weight: bold; }
        .player-btn.active { color: #81c784; transform: scale(1.1); }
        .player-volume { flex: 0 0 32px; display: flex; align-items: center; flex-shrink: 0; }
        .volume-btn {
            background: transparent;
            border: none;
            color: #99aabb;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto !important;
        }
        .toggle-btn {
            background: transparent;
            border: none;
            color: #99aabb;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
            z-index: 10;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            margin-left: 8px;
            padding: 0 8px;
            pointer-events: auto !important;
        }
        #listToggleBtn { margin-left: auto; }
        .player-progress {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            padding: 4px 2%;
            background: #1e3a2f;
            border-radius: 4px 4px 0 0;
            border-bottom: 1px solid #3d725f;
            box-sizing: border-box;
            min-height: 24px;
            transition: all 0.2s ease;
            z-index: 1;
        }
        .mini-music-player:hover .player-progress { display: block; }
        .progress-bar-mini {
            width: 100%;
            height: 3px;
            background: #2d5243;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            transition: height 0.2s ease;
        }
        .progress-mini {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: #81c784;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .time-mini {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #99aabb;
            margin-top: 2px;
            width: 100%;
        }
        .song-list-container {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100% !important;
            max-height: 300px;
            overflow-y: auto;
            background: #1e3a2f;
            border: 1px solid #3d725f;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 8px 0;
            z-index: 99999;
        }
        .song-list-container.show { display: block !important; }
        .song-list { list-style: none; }
        .song-list li {
            padding: 8px 16px;
            color: #e0e0e0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }
        .song-list li.active { background: #2d5243; color: #81c784; font-weight: 500; }
        .page-controls {
            display: flex;
            justify-content: center;
            padding: 8px 0;
            border-top: 1px solid #3d725f;
        }
        .page-btn {
            background: transparent;
            border: 1px solid #81c784;
            color: #81c784;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 4px;
            transition: all 0.2s ease;
        }
        .page-btn:disabled {
            border-color: #2d5243;
            color: #2d5243;
            cursor: not-allowed;
        }
        .loop-mode-tooltip {
            position: absolute;
            bottom: 100%;
            right: 120px;
            background: #2d5243;
            color: #81c784;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
            z-index: 999;
        }
        .loop-btn:hover + .loop-mode-tooltip { display: block; }
    </style>
</head>
<body>
    <div class="player-container" id="playerContainer">
        <button class="player-mini-btn" id="playerMiniBtn">â–¶</button>
        <div class="mini-music-player" id="draggablePlayer">
            <div class="player-cover" id="playerCover1">
                <img src="http://p2.music.126.net/BKJrPO1FlbXcy-98AYXOzg==/109951172268004943.jpg?param=300x300" alt="æ˜”æ¶Ÿ">
            </div>
            <div class="player-cover" id="playerCover2" style="display:none;">
                <img src="http://p2.music.126.net/DYDACa_8zB5irAOrasVgnQ==/109951171396677694.jpg?param=300x300" alt="è€€æ–‘">
            </div>
            <div class="player-cover" id="playerCover3" style="display:none;">
                <img src="http://p2.music.126.net/2qGGwWFlMYF2o-GyNMhH5A==/109951171066942237.jpg?param=300x300" alt="æ‹‚æ™“">
            </div>
            <div class="player-cover" id="playerCover4" style="display:none;">
                <img src="http://p1.music.126.net/gtunmoxObQyoH01HzURNUw==/109951170292455448.jpg?param=300x300" alt="ä½•è€…">
            </div>
            <div class="player-cover" id="playerCover5" style="display:none;">
                <img src="http://p1.music.126.net/jWx1g4PbZsIu9npNOlifzA==/109951170151255339.jpg?param=300x300" alt="ç¡è•‰ä¹‹æ­Œ">
            </div>
            <div class="player-cover" id="playerCover6" style="display:none;">
                <img src="http://p1.music.126.net/sZ-rACbFrybF0x_lI6XNMw==/109951169297766755.jpg?param=300x300" alt="ä¸çœ ä¹‹å¤œ">
            </div>
            <div class="player-cover" id="playerCover7" style="display:none;">
                <img src="http://p1.music.126.net/arz1hBaMCVcVV3yktxpoGg==/109951172346365107.jpg?param=300x300" alt="Montagem Miau">
            </div>
            <div class="player-cover" id="playerCover8" style="display:none;">
                <img src="http://p1.music.126.net/ykljhikl5x5QXgYjiIvW8g==/109951163082689392.jpg?param=300x300" alt="çŒ«çš„èˆæ­¥">
            </div>
            <div class="player-cover" id="playerCover9" style="display:none;">
                <img src="http://p2.music.126.net/6y-UleORITEDfD5K8I44Qw==/109951165493980841.jpg?param=300x300" alt="ç¤ºä¾‹æ­Œæ›²9">
            </div>
            <div class="player-info">
                <div class="player-title" id="playerTitle">æ˜”æ¶Ÿ</div>
                <div class="player-singer" id="playerSinger">å¼ éŸ¶æ¶µã€HOYO-MiX</div>
            </div>
            <div class="player-controls">
                <button class="player-btn" id="miniPrevBtn">â®</button>
                <button class="player-btn play-main-btn" id="miniPlayBtn">â–¶</button>
                <button class="player-btn" id="miniNextBtn">â¯</button>
                <button class="player-btn loop-btn" id="loopBtn" title="åˆ‡æ¢å¾ªç¯æ¨¡å¼">ğŸ”</button>
            </div>
            <div class="player-volume">
                <button class="volume-btn" id="volumeBtn">ğŸ”Š</button>
            </div>
            <button class="toggle-btn" id="listToggleBtn">ğŸ“œ æ­Œæ›²åˆ—è¡¨</button>
            <button class="toggle-btn" id="toggleBtn">ã€<ã€‘æ”¶èµ· </button>
            
            <div class="player-progress">
                <div class="progress-bar-mini" id="miniProgressBar">
                    <div class="progress-mini" id="miniProgress"></div>
                </div>
                <div class="time-mini">
                    <span class="current-time-mini" id="currentTime">00:00</span>
                    <span class="total-time-mini" id="totalTime">03:06</span>
                </div>
            </div>
            
            <div class="song-list-container" id="songListContainer">
                <ul class="song-list" id="songList"></ul>
            </div>
            <div class="loop-mode-tooltip" id="loopTooltip">é¡ºåºæ’­æ”¾</div>
        </div>
        <!-- å…¨å±€éŸ³é¢‘å¯¹è±¡ï¼ˆå•ä¾‹æ¨¡å¼ï¼Œè·¨é¡µé¢å¤ç”¨ï¼‰ -->
        <audio id="globalAudio" preload="none" playsinline>
            <source src="" type="audio/mpeg">
        </audio>
    </div>
    <script>
        // å…ƒç´ åˆå§‹åŒ–
        const playerContainer = document.getElementById('playerContainer');
        const draggablePlayer = document.getElementById('draggablePlayer');
        const playBtn = document.getElementById('miniPlayBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const playerMiniBtn = document.getElementById('playerMiniBtn');
        const progress = document.getElementById('miniProgress');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const volumeBtn = document.getElementById('volumeBtn');
        const prevBtn = document.getElementById('miniPrevBtn');
        const nextBtn = document.getElementById('miniNextBtn');
        const loopBtn = document.getElementById('loopBtn');
        const loopTooltip = document.getElementById('loopTooltip');
        const playerTitle = document.getElementById('playerTitle');
        const playerSinger = document.getElementById('playerSinger');
        const listToggleBtn = document.getElementById('listToggleBtn');
        const songListContainer = document.getElementById('songListContainer');
        const songListEl = document.getElementById('songList');
        const globalAudio = document.getElementById('globalAudio'); // å…¨å±€å”¯ä¸€éŸ³é¢‘å¯¹è±¡
        // æ­Œæ›²åˆ—è¡¨ï¼ˆåŒ…å«éŸ³é¢‘URLï¼Œç”¨äºè·¨é¡µé¢åŠ è½½ï¼‰
        const songList = [
            { 
                audioId: 'miniAudio1', 
                coverId: 'playerCover1', 
                title: 'æ˜”æ¶Ÿ', 
                singer: 'å¼ éŸ¶æ¶µã€HOYO-MiX', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=3316968660.mp3',
                defaultDuration: '03:06' 
            },
            { 
                audioId: 'miniAudio2', 
                coverId: 'playerCover2', 
                title: 'è€€æ–‘', 
                singer: 'HOYO-MiX,YMIR', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=2722510685.mp3',
                defaultDuration: '03:33' 
            },
            { 
                audioId: 'miniAudio3', 
                coverId: 'playerCover3', 
                title: 'æ‹‚æ™“ Proi Proi', 
                singer: 'HOYO-MiX,NIDA', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=2709812973.mp3',
                defaultDuration: '03:58' 
            },
            { 
                audioId: 'miniAudio4', 
                coverId: 'playerCover4', 
                title: 'ä½•è€…', 
                singer: 'è°­æ™¶,HOYO-MiX', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=2658660685.mp3',
                defaultDuration: '02:26' 
            },
            { 
                audioId: 'miniAudio5', 
                coverId: 'playerCover5', 
                title: 'ç¡è•‰ä¹‹æ­Œ', 
                singer: 'HOYO-MiX', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=2646986980.mp3',
                defaultDuration: '00:17' 
            },
            { 
                audioId: 'miniAudio6', 
                coverId: 'playerCover6', 
                title: 'ä¸çœ ä¹‹å¤œ', 
                singer: 'å¼ æ°,HOYO-MiX', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=2122308127.mp3',
                defaultDuration: '02:18' 
            },
            { 
                audioId: 'miniAudio7', 
                coverId: 'playerCover7', 
                title: 'Montagem Miau', 
                singer: 'Pudding_PD,METAMOON', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=3320816993.mp3',
                defaultDuration: '02:19' 
            },
            { 
                audioId: 'miniAudio8', 
                coverId: 'playerCover8', 
                title: 'çŒ«çš„èˆæ­¥', 
                singer: 'Candy_Wind', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=523902194.mp3',
                defaultDuration: '03:07' 
            },
            { 
                audioId: 'miniAudio9', 
                coverId: 'playerCover9', 
                title: 'ç¤ºä¾‹æ­Œæ›²9', 
                singer: 'æ­Œæ‰‹9', 
                audioUrl: 'http://music.163.com/song/media/outer/url?id=1428234445.mp3',
                defaultDuration: '03:20' 
            }
        ];
        // åˆ†é¡µé…ç½®
        const PAGE_SIZE = 6;
        let currentPage = 1;
        const totalPages = Math.ceil(songList.length / PAGE_SIZE);
        // å¾ªç¯æ¨¡å¼æšä¸¾ï¼š0-é¡ºåºæ’­æ”¾ï¼Œ1-åˆ—è¡¨å¾ªç¯ï¼Œ2-å•æ›²å¾ªç¯
        const LOOP_MODE = {
            SEQUENCE: 0,
            LIST_LOOP: 1,
            SINGLE_LOOP: 2
        };
        // å…¨å±€çŠ¶æ€ï¼ˆä»localStorageè¯»å–æˆ–åˆå§‹åŒ–ï¼Œæ–°å¢å¾ªç¯æ¨¡å¼ï¼‰
        let playState = {
            currentSongIndex: 0,
            isPlaying: false,
            currentTime: 0,
            volume: 0.7,
            isExpanded: true,
            loopMode: LOOP_MODE.SEQUENCE // é»˜è®¤é¡ºåºæ’­æ”¾
        };
        // é˜²æŠ–å‡½æ•°
        function debounce(fn, delay = 100) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        // ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ°localStorageï¼ˆåŒ…å«å¾ªç¯æ¨¡å¼ï¼‰
        function savePlayState() {
            playState.currentTime = globalAudio.currentTime;
            playState.volume = globalAudio.volume;
            localStorage.setItem('musicPlayerState', JSON.stringify(playState));
            // å‘ä¸»é¡µé¢å‘é€æ’­æ”¾çŠ¶æ€æ›´æ–°æ¶ˆæ¯
            window.parent.postMessage({
                type: 'PLAY_STATE_UPDATED',
                state: { ...playState }
            }, '*');
        }
        // ä»localStorageæ¢å¤æ’­æ”¾çŠ¶æ€ï¼ˆåŒ…å«å¾ªç¯æ¨¡å¼ï¼‰
        function restorePlayState() {
            const savedState = localStorage.getItem('musicPlayerState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                // éªŒè¯çŠ¶æ€åˆæ³•æ€§
                if (parsedState.currentSongIndex >= 0 && parsedState.currentSongIndex < songList.length && 
                    [0, 1, 2].includes(parsedState.loopMode)) {
                    playState = { ...playState, ...parsedState };
                }
            }
        }
        // ç›‘å¬ä¸»é¡µé¢çš„æ¢å¤çŠ¶æ€æ¶ˆæ¯
        window.addEventListener('message', (e) => {
            if (e.data.type === 'RESTORE_PLAY_STATE') {
                restorePlayState();
                updateLoopModeUI();
                // æ¢å¤éŸ³é¢‘çŠ¶æ€
                globalAudio.volume = playState.volume;
                volumeBtn.textContent = playState.volume > 0.5 ? 'ğŸ”Š' : playState.volume > 0 ? 'ğŸ”‰' : 'ğŸ”‡';
            }
        });
        // æ›´æ–°å¾ªç¯æ¨¡å¼UI
        function updateLoopModeUI() {
            switch(playState.loopMode) {
                case LOOP_MODE.SEQUENCE:
                    loopBtn.textContent = 'ğŸ”';
                    loopBtn.classList.remove('active');
                    loopTooltip.textContent = 'é¡ºåºæ’­æ”¾ï¼ˆç‚¹å‡»åˆ‡æ¢åˆ—è¡¨å¾ªç¯ï¼‰';
                    break;
                case LOOP_MODE.LIST_LOOP:
                    loopBtn.textContent = 'ğŸ”„';
                    loopBtn.classList.add('active');
                    loopTooltip.textContent = 'åˆ—è¡¨å¾ªç¯ï¼ˆç‚¹å‡»åˆ‡æ¢å•æ›²å¾ªç¯ï¼‰';
                    break;
                case LOOP_MODE.SINGLE_LOOP:
                    loopBtn.textContent = 'ğŸ”‚';
                    loopBtn.classList.add('active');
                    loopTooltip.textContent = 'å•æ›²å¾ªç¯ï¼ˆç‚¹å‡»åˆ‡æ¢é¡ºåºæ’­æ”¾ï¼‰';
                    break;
            }
        }
        // åˆ‡æ¢å¾ªç¯æ¨¡å¼
        function toggleLoopMode() {
            playState.loopMode = (playState.loopMode + 1) % 3;
            updateLoopModeUI();
            savePlayState();
        }
        // æ­Œæ›²åˆ‡æ¢ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šé€‚é…å¾ªç¯æ¨¡å¼ï¼‰
        function switchSong(newIndex) {
            // æ ¹æ®å¾ªç¯æ¨¡å¼å¤„ç†ç´¢å¼•
            if (newIndex < 0) {
                newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? songList.length - 1 : 0;
            }
            if (newIndex >= songList.length) {
                newIndex = playState.loopMode === LOOP_MODE.LIST_LOOP ? 0 : songList.length - 1;
            }
            // æ›´æ–°çŠ¶æ€
            playState.currentSongIndex = newIndex;
            const newSong = songList[newIndex];
            // æ›´æ–°UI
            playerTitle.textContent = newSong.title;
            playerSinger.textContent = newSong.singer;
            totalTimeEl.textContent = newSong.defaultDuration;
            totalTimeEl.dataset.loaded = 'false';
            progress.style.width = '0%';
            currentTimeEl.textContent = '00:00';
            // åˆ‡æ¢å°é¢
            document.querySelectorAll('.player-cover').forEach(cover => cover.style.display = 'none');
            document.getElementById(newSong.coverId).style.display = 'block';
            // æ›´æ–°éŸ³é¢‘æºå¹¶åŠ è½½
            globalAudio.src = newSong.audioUrl;
            globalAudio.currentTime = 0;
            globalAudio.load();
            // æ¢å¤æ’­æ”¾çŠ¶æ€
            if (playState.isPlaying) {
                globalAudio.play().then(() => {
                    playBtn.textContent = 'â¸';
                    draggablePlayer.classList.add('playing');
                }).catch(() => alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾å™¨é‡è¯•'));
            } else {
                playBtn.textContent = 'â–¶';
                draggablePlayer.classList.remove('playing');
            }
            // ä¿å­˜çŠ¶æ€+æ›´æ–°æ­Œæ›²åˆ—è¡¨
            savePlayState();
            debouncedRenderPage(currentPage);
        }
        // åˆ†é¡µæ¸²æŸ“ï¼ˆä¿®å¤é‡å¤é—®é¢˜ï¼‰
        function renderPage(page) {
            songListEl.innerHTML = '';
            const start = (page - 1) * PAGE_SIZE;
            const end = Math.min(start + PAGE_SIZE, songList.length);
            songList.slice(start, end).forEach((song, idx) => {
                const li = document.createElement('li');
                li.classList.toggle('active', start + idx === playState.currentSongIndex);
                li.innerHTML = `${start + idx + 1}. ${song.title} - ${song.singer}`;
                li.addEventListener('click', () => switchSong(start + idx));
                songListEl.appendChild(li);
            });
            if (totalPages > 1) {
                // å…ˆåˆ é™¤æ—§çš„åˆ†é¡µæ§ä»¶
                const oldPageControls = songListContainer.querySelector('.page-controls');
                if (oldPageControls) songListContainer.removeChild(oldPageControls);
                // åˆ›å»ºæ–°åˆ†é¡µæ§ä»¶
                const pageControls = document.createElement('div');
                pageControls.className = 'page-controls';
                pageControls.innerHTML = `
                    <button class="page-btn" ${page === 1 ? 'disabled' : ''} onclick="currentPage--;debouncedRenderPage(currentPage)">ä¸Šä¸€é¡µ</button>
                    <span class="page-info">${page}/${totalPages}</span>
                    <button class="page-btn" ${page === totalPages ? 'disabled' : ''} onclick="currentPage++;debouncedRenderPage(currentPage)">ä¸‹ä¸€é¡µ</button>
                `;
                songListContainer.appendChild(pageControls);
            }
        }
        const debouncedRenderPage = debounce(renderPage);
        // æ’­æ”¾/æš‚åœæ§åˆ¶
        playBtn.addEventListener('click', () => {
            if (playState.isPlaying) {
                globalAudio.pause();
                playBtn.textContent = 'â–¶';
                draggablePlayer.classList.remove('playing');
            } else {
                globalAudio.play().then(() => {
                    playBtn.textContent = 'â¸';
                    draggablePlayer.classList.add('playing');
                }).catch(() => alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾å™¨é‡è¯•'));
            }
            playState.isPlaying = !playState.isPlaying;
            savePlayState();
        });
        // ä¸Š/ä¸‹ä¸€é¦–
        prevBtn.addEventListener('click', () => switchSong(playState.currentSongIndex - 1));
        nextBtn.addEventListener('click', () => switchSong(playState.currentSongIndex + 1));
        // å¾ªç¯æ¨¡å¼åˆ‡æ¢
        loopBtn.addEventListener('click', toggleLoopMode);
        // åˆ—è¡¨æ˜¾ç¤º/éšè—ï¼ˆæ–°å¢å‘ä¸»é¡µé¢å‘é€çŠ¶æ€æ¶ˆæ¯ï¼‰
        listToggleBtn.addEventListener('click', () => {
            songListContainer.classList.toggle('show');
            const isShow = songListContainer.classList.contains('show');
            // å‘ä¸»é¡µé¢å‘é€æ­Œå•å±•å¼€/æ”¶èµ·çŠ¶æ€
            window.parent.postMessage({
                type: 'SONG_LIST_TOGGLED',
                isShow: isShow
            }, '*');
            
            if (isShow) {
                songListEl.innerHTML = '';
                debouncedRenderPage(currentPage);
            }
        });
        // éŸ³é‡æ§åˆ¶
        volumeBtn.addEventListener('click', () => {
            globalAudio.volume = globalAudio.volume > 0.5 ? 0.3 : globalAudio.volume > 0 ? 0 : 0.7;
            volumeBtn.textContent = globalAudio.volume > 0.5 ? 'ğŸ”Š' : globalAudio.volume > 0 ? 'ğŸ”‰' : 'ğŸ”‡';
            savePlayState();
        });
        // è¿›åº¦æ¡æ›´æ–°
        function updateProgress() {
            if (isNaN(globalAudio.duration)) return;
            const percent = (globalAudio.currentTime / globalAudio.duration) * 100;
            progress.style.width = `${percent}%`;
            currentTimeEl.textContent = `${Math.floor(globalAudio.currentTime/60).toString().padStart(2, '0')}:${Math.floor(globalAudio.currentTime%60).toString().padStart(2, '0')}`;
            if (!totalTimeEl.dataset.loaded) {
                totalTimeEl.textContent = `${Math.floor(globalAudio.duration/60).toString().padStart(2, '0')}:${Math.floor(globalAudio.duration%60).toString().padStart(2, '0')}`;
                totalTimeEl.dataset.loaded = 'true';
            }
            // å®æ—¶ä¿å­˜è¿›åº¦ï¼ˆæ¯3ç§’ä¸€æ¬¡ï¼Œé¿å…æ€§èƒ½æ¶ˆè€—ï¼‰
            if (Math.floor(globalAudio.currentTime) % 3 === 0) {
                savePlayState();
            }
        }
        setInterval(updateProgress, 1000);
        // è¿›åº¦æ¡ç‚¹å‡»
        document.getElementById('miniProgressBar').addEventListener('click', (e) => {
            if (isNaN(globalAudio.duration)) return;
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            globalAudio.currentTime = percent * globalAudio.duration;
            savePlayState();
        });
        // æ‹–åŠ¨åŠŸèƒ½
        draggablePlayer.addEventListener('mousedown', (e) => {
            if (e.target.closest('.player-btn, .volume-btn, .toggle-btn')) return;
            let isDragging = true;
            const rect = playerContainer.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', () => {
                isDragging = false;
                document.removeEventListener('mousemove', moveHandler);
            });
            function moveHandler(e) {
                if (!isDragging) return;
                const newLeft = e.clientX - offsetX;
                const maxLeft = window.innerWidth - playerContainer.offsetWidth;
                playerContainer.style.left = `${Math.max(0, Math.min(newLeft, maxLeft))}px`;
            }
        });
        // éŸ³é¢‘ç»“æŸå¤„ç†ï¼ˆæ ¹æ®å¾ªç¯æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢ï¼‰
        globalAudio.addEventListener('ended', () => {
            switch(playState.loopMode) {
                case LOOP_MODE.SEQUENCE:
                    // é¡ºåºæ’­æ”¾ï¼šæœ€åä¸€é¦–ç»“æŸåæš‚åœ
                    if (playState.currentSongIndex === songList.length - 1) {
                        playState.isPlaying = false;
                        playBtn.textContent = 'â–¶';
                        draggablePlayer.classList.remove('playing');
                        savePlayState();
                    } else {
                        switchSong(playState.currentSongIndex + 1);
                    }
                    break;
                case LOOP_MODE.LIST_LOOP:
                    // åˆ—è¡¨å¾ªç¯ï¼šæœ€åä¸€é¦–ç»“æŸåå›åˆ°ç¬¬ä¸€é¦–
                    switchSong(playState.currentSongIndex + 1);
                    break;
                case LOOP_MODE.SINGLE_LOOP:
                    // å•æ›²å¾ªç¯ï¼šé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
                    globalAudio.currentTime = 0;
                    globalAudio.play();
                    savePlayState();
                    break;
            }
        });
        // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
        window.addEventListener('beforeunload', () => {
            savePlayState();
        });
        // åˆå§‹åŒ–ï¼ˆæ ¸å¿ƒï¼šæ¢å¤çŠ¶æ€+åŠ è½½æ­Œæ›²+åˆå§‹åŒ–å¾ªç¯æ¨¡å¼ï¼‰
        window.addEventListener('load', () => {
            // æ¢å¤ä¿å­˜çš„çŠ¶æ€
            restorePlayState();
            
            // åˆå§‹åŒ–éŸ³é¢‘è®¾ç½®
            globalAudio.volume = playState.volume;
            volumeBtn.textContent = playState.volume > 0.5 ? 'ğŸ”Š' : playState.volume > 0 ? 'ğŸ”‰' : 'ğŸ”‡';
            
            // åˆå§‹åŒ–å¾ªç¯æ¨¡å¼UI
            updateLoopModeUI();
            
            // åŠ è½½å½“å‰æ­Œæ›²
            const currentSong = songList[playState.currentSongIndex];
            globalAudio.src = currentSong.audioUrl;
            globalAudio.currentTime = playState.currentTime;
            globalAudio.load();
            
            // æ›´æ–°UI
            playerTitle.textContent = currentSong.title;
            playerSinger.textContent = currentSong.singer;
            totalTimeEl.textContent = currentSong.defaultDuration;
            document.querySelectorAll('.player-cover').forEach(cover => cover.style.display = 'none');
            document.getElementById(currentSong.coverId).style.display = 'block';
            
            // æ¢å¤æ’­æ”¾çŠ¶æ€
            if (playState.isPlaying) {
                globalAudio.play().then(() => {
                    playBtn.textContent = 'â¸';
                    draggablePlayer.classList.add('playing');
                }).catch(() => {
                    playBtn.textContent = 'â–¶';
                    draggablePlayer.classList.remove('playing');
                    playState.isPlaying = false;
                });
            } else {
                playBtn.textContent = 'â–¶';
                draggablePlayer.classList.remove('playing');
            }
            
            // åˆå§‹åŒ–æ­Œæ›²åˆ—è¡¨
            debouncedRenderPage(currentPage);
            songListContainer.classList.remove('show');
        });
    </script>
</body>
            </html>
