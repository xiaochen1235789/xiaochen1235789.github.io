// script.js - 崩铁卡池UI功能实现

document.addEventListener('DOMContentLoaded', function() {
    // 初始化状态
    let state = {
        stellarJade: 3280,
        specialTicket: 5,
        regularTicket: 23,
        pity5: 45,
        pity4: 7,
        isGuaranteed: false,
        drawHistory: []
    };

    // DOM元素
    const elements = {
        stellarJade: document.getElementById('stellarJade'),
        specialTicket: document.getElementById('specialTicket'),
        regularTicket: document.getElementById('regularTicket'),
        pity5Value: document.getElementById('pity5Value'),
        pity4Value: document.getElementById('pity4Value'),
        pity5Fill: document.getElementById('pity5Fill'),
        pity4Fill: document.getElementById('pity4Fill'),
        pity5Text: document.getElementById('pity5Text'),
        pity4Text: document.getElementById('pity4Text'),
        singleDraw: document.getElementById('singleDraw'),
        tenDraw: document.getElementById('tenDraw'),
        resultModal: document.getElementById('resultModal'),
        resultBody: document.getElementById('resultBody'),
        closeModal: document.getElementById('closeModal'),
        confirmResult: document.getElementById('confirmResult'),
        resetPity: document.getElementById('resetPity'),
        countdown: document.getElementById('countdown')
    };

    // 初始化UI
    function initUI() {
        updateCurrencyDisplay();
        updatePityDisplay();
        startCountdown();
        createParticles();
    }

    // 更新货币显示
    function updateCurrencyDisplay() {
        elements.stellarJade.textContent = state.stellarJade.toLocaleString();
        elements.specialTicket.textContent = state.specialTicket;
        elements.regularTicket.textContent = state.regularTicket;
    }

    // 更新保底显示
    function updatePityDisplay() {
        elements.pity5Value.textContent = state.pity5;
        elements.pity4Value.textContent = state.pity4;
        
        const pity5Percent = (state.pity5 / CONFIG.pity5) * 100;
        const pity4Percent = (state.pity4 / CONFIG.pity4) * 100;
        
        elements.pity5Fill.style.width = `${pity5Percent}%`;
        elements.pity4Fill.style.width = `${pity4Percent}%`;
        
        elements.pity5Text.textContent = `剩余${CONFIG.pity5 - state.pity5}抽`;
        elements.pity4Text.textContent = `剩余${CONFIG.pity4 - state.pity4}抽`;
    }

    // 倒计时
    function startCountdown() {
        const endTime = new Date();
        endTime.setDate(endTime.getDate() + 7); // 7天后结束
        
        function updateCountdown() {
            const now = new Date();
            const diff = endTime - now;
            
            if (diff <= 0) {
                elements.countdown.textContent = "已结束";
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            elements.countdown.textContent = 
                `${days.toString().padStart(2, '0')}:` +
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
        }
        
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    // 卡池切换
    document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', function() {
            // 移除所有激活状态
            document.querySelectorAll('.tab-btn').forEach(t => 
                t.classList.remove('active'));
            document.querySelectorAll('.current-pool').forEach(p => 
                p.classList.remove('active'));
            
            // 激活当前标签
            this.classList.add('active');
            const target = this.dataset.target;
            document.getElementById(target).classList.add('active');
            
            // 添加切换动画
            gsap.from(`#${target}`, {
                duration: 0.5,
                opacity: 0,
                y: 30,
                ease: "power3.out"
            });
        });
    });

    // 单抽功能
    elements.singleDraw.addEventListener('click', function() {
        if (state.stellarJade < 160) {
            showMessage('星琼不足！', 'error');
            return;
        }
        
        playDrawSound();
        animateDrawButton(this);
        
        // 扣除星琼
        state.stellarJade -= 160;
        state.pity5++;
        state.pity4++;
        
        // 模拟抽卡
        setTimeout(() => {
            const result = simulateDraw();
            showDrawResult([result]);
            updateCurrencyDisplay();
            updatePityDisplay();
        }, 800);
    });

    // 十连抽功能
    elements.tenDraw.addEventListener('click', function() {
        if (state.stellarJade < 1600) {
            showMessage('星琼不足！', 'error');
            return;
        }
        
        playDrawSound();
        animateDrawButton(this);
        
        // 扣除星琼
        state.stellarJade -= 1600;
        
        // 模拟十连
        const results = [];
        for (let i = 0; i < 10; i++) {
            state.pity5++;
            state.pity4++;
            results.push(simulateDraw());
        }
        
        // 保底四星
        const has4Star = results.some(r => r.rarity >= 4);
        if (!has4Star) {
            results[9] = generateGuaranteed4Star();
        }
        
        setTimeout(() => {
            showDrawResult(results);
            updateCurrencyDisplay();
            updatePityDisplay();
        }, 1000);
    });

    // 模拟抽卡算法
    function simulateDraw() {
        const rand = Math.random();
        
        // 保底检查
        if (state.pity5 >= CONFIG.pity5) {
            return generate5Star();
        }
        if (state.pity4 >= CONFIG.pity4) {
            return generate4Star();
        }
        
        // 概率抽卡
        if (rand < CONFIG.rates[5]) {
            return generate5Star();
        } else if (rand < CONFIG.rates[5] + CONFIG.rates[4]) {
            return generate4Star();
        } else {
            return generate3Star();
        }
    }

    // 生成五星物品
    function generate5Star() {
        state.pity5 = 0;
        const isUP = state.isGuaranteed || Math.random() < CONFIG.upRate[5];
        state.isGuaranteed = !isUP;
        
        return {
            name: isUP ? '刃' : ['姬子', '瓦尔特', '布洛妮娅', '杰帕德', '克拉拉', '彦卿', '白露'][Math.floor(Math.random() * 7)],
            rarity: 5,
            type: 'character',
            isNew: Math.random() > 0.5,
            isUP: isUP
        };
    }

    // 生成四星物品
    function generate4Star() {
        state.pity4 = 0;
        const isUP = Math.random() < CONFIG.upRate[4];
        
        const upChars = ['佩拉', '娜塔莎', '阿兰'];
        const standardChars = ['三月七', '丹恒', '黑塔', '艾丝妲', '希露瓦', '桑博', '青雀'];
        
        return {
            name: isUP ? upChars[Math.floor(Math.random() * upChars.length)] : 
                         standardChars[Math.floor(Math.random() * standardChars.length)],
            rarity: 4,
            type: Math.random() > 0.7 ? 'lightcone' : 'character',
            isNew: Math.random() > 0.7,
            isUP: isUP
        };
    }

    // 生成三星物品
    function generate3Star() {
        const lightcones = [
            '轮契', '琥珀', '天倾', '俱殁', '离弦', 
            '幽邃', '智库', '灵钥', '戍御', '开疆'
        ];
        
        return {
            name: lightcones[Math.floor(Math.random() * lightcones.length)],
            rarity: 3,
            type: 'lightcone',
            isNew: false,
            isUP: false
        };
    }

    // 保底四星
    function generateGuaranteed4Star() {
        state.pity4 = 0;
        return generate4Star();
    }

    // 显示抽卡结果
    function showDrawResult(results) {
        elements.resultBody.innerHTML = '';
        
        results.forEach((result, index) => {
            const item = createResultItem(result, index);
            elements.resultBody.appendChild(item);
            
            // 逐项显示动画
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        playResultSound();
        showModal();
    }

    // 创建结果项
    function createResultItem(result, index) {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        item.style.transition = 'all 0.3s ease';
        item.style.transitionDelay = `${index * 0.1}s`;
        
        const rarityClass = `rarity-${result.rarity}`;
        const typeIcon = result.type === 'character' ? 'fas fa-user' : 'fas fa-gem';
        const newBadge = result.isNew ? '<span class="new-badge">NEW</span>' : '';
        const upBadge = result.isUP ? '<span class="up-badge">UP</span>' : '';
        
        item.innerHTML = `
            <div class="result-rarity ${rarityClass}">
                ${'★'.repeat(result.rarity)}
            </div>
            <div class="result-icon">
                <i class="${typeIcon}"></i>
            </div>
            <div class="result-info">
                <div class="result-name">${result.name}</div>
                <div class="result-type">${result.type === 'character' ? '角色' : '光锥'}</div>
            </div>
            ${newBadge}
            ${upBadge}
        `;
        
        return item;
    }

    // 显示模态窗口
    function showModal() {
        elements.resultModal.style.display = 'flex';
        gsap.from('.modal-container', {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "back.out(1.7)"
        });
    }

    // 关闭模态窗口
    elements.closeModal.addEventListener('click', hideModal);
    elements.confirmResult.addEventListener('click', hideModal);

    function hideModal() {
        gsap.to('.modal-container', {
            duration: 0.2,
            scale: 0.9,
            opacity: 0,
            ease: "power2.in",
            onComplete: () => {
                elements.resultModal.style.display = 'none';
            }
        });
    }

    // 重置保底
    elements.resetPity.addEventListener('click', function() {
        if (confirm('确定要重置保底计数吗？')) {
            state.pity5 = 0;
            state.pity4 = 0;
            state.isGuaranteed = false;
            updatePityDisplay();
            showMessage('保底计数已重置！', 'success');
        }
    });

    // 按钮动画
    function animateDrawButton(button) {
        gsap.to(button, {
            duration: 0.1,
            scale: 0.95,
            yoyo: true,
            repeat: 1,
            ease: "power2.inOut"
        });
        
        // 粒子效果
        createButtonParticles(button);
    }

    // 创建按钮粒子
    function createButtonParticles(button) {
        const rect = button.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        
        for (let i = 0; i < 15; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.cssText = `
                position: fixed;
                width: 5px;
                height: 5px;
                background: #ffd700;
                border-radius: 50%;
                pointer-events: none;
                z-index: 100;
                left: ${x}px;
                top: ${y}px;
            `;
            
            document.body.appendChild(particle);
            
            const angle = Math.random() * Math.PI * 2;
            const speed = 2 + Math.random() * 3;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;
            
            gsap.to(particle, {
                duration: 1,
                x: vx * 50,
                y: vy * 50,
                opacity: 0,
                scale: 0,
                ease: "power2.out",
                onComplete: () => particle.remove()
            });
        }
    }

    // 创建背景粒子
    function createParticles() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'floating-particle';
            
            const size = 1 + Math.random() * 3;
            const duration = 10 + Math.random() * 20;
            const delay = Math.random() * 5;
            
            particle.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                background: rgba(255, 255, 255, ${0.3 + Math.random() * 0.7});
                border-radius: 50%;
                top: ${Math.random() * 100}%;
                left: ${Math.random() * 100}%;
                animation: float ${duration}s ${delay}s infinite linear;
            `;
            
            container.appendChild(particle);
        }
        
        // 添加浮动动画到样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float {
                0% {
                    transform: translateY(0) rotate(0deg);
                    opacity: 0;
                }
                10% {
                    opacity: 1;
                }
                90% {
                    opacity: 1;
                }
                100% {
                    transform: translateY(-100vh) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // 显示消息
    function showMessage(text, type) {
        const message = document.createElement('div');
        message.className = `message ${type}`;
        message.textContent = text;
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: ${type === 'error' ? '#ff4757' : '#4caf50'};
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.style.transform = 'translateX(0)';
        }, 10);
        
        setTimeout(() => {
            message.style.transform = 'translateX(100%)';
            setTimeout(() => message.remove(), 300);
        }, 3000);
    }

    // 音效
    function playDrawSound() {
        const sound = document.getElementById('drawSound');
        sound.currentTime = 0;
        sound.play().catch(e => console.log('音效播放失败:', e));
    }

    function playResultSound() {
        const sound = document.getElementById('resultSound');
        sound.currentTime = 0;
        sound.play().catch(e => console.log('音效播放失败:', e));
    }

    // 其他交互功能
    document.getElementById('detailsBtn').addEventListener('click', () => {
        showMessage('详细规则页面开发中...', 'info');
    });

    document.getElementById('historyBtn').addEventListener('click', () => {
        showMessage('跃迁记录功能开发中...', 'info');
    });

    document.getElementById('wishSimulator').addEventListener('click', () => {
        // 模拟100抽
        const results = [];
        for (let i = 0; i < 100; i++) {
            results.push(simulateDraw());
        }
        
        const fiveStars = results.filter(r => r.rarity === 5).length;
        showMessage(`模拟100抽获得${fiveStars}个五星角色！`, 'info');
    });

    // 技能预览
    document.querySelectorAll('.skill-item').forEach(skill => {
        skill.addEventListener('click', function() {
            const skillType = this.dataset.skill;
            const skillName = this.querySelector('.skill-name').textContent;
            showMessage(`预览技能：${skillName}`, 'info');
        });
    });

    // 初始化
    initUI();
});