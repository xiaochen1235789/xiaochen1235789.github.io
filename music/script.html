// 完整JS文件 - 保存为script.js

// 游戏配置
const CONFIG = {
    pity5: 90,  // 五星保底
    pity4: 10,  // 四星保底
    rates: {
        5: 0.006,  // 0.6%
        4: 0.051,  // 5.1%
        3: 0.943   // 94.3%
    },
    upRate: 0.5,  // UP概率50%
    characterCost: 160,
    tenCost: 1600
};

// 游戏状态
let gameState = {
    stellarJade: 3280,
    specialTicket: 5,
    pity5: 45,
    pity4: 7,
    isGuaranteed: false,
    history: []
};

// 物品池
const itemPool = {
    5: {
        characters: ['刃', '姬子', '瓦尔特', '布洛妮娅', '杰帕德', '克拉拉', '彦卿', '白露'],
        upCharacter: '刃'
    },
    4: {
        characters: ['佩拉', '娜塔莎', '阿兰', '三月七', '丹恒', '黑塔', '艾丝妲'],
        upCharacters: ['佩拉', '娜塔莎', '阿兰']
    },
    3: {
        lightcones: ['轮契', '琥珀', '天倾', '俱殁', '离弦', '幽邃', '智库', '灵钥', '戍御', '开疆']
    }
};

// DOM元素
const elements = {
    stellarJade: document.getElementById('stellar-jade'),
    singleDraw: document.getElementById('single-draw'),
    tenDraw: document.getElementById('ten-draw'),
    resultModal: document.getElementById('result-modal'),
    resultGrid: document.getElementById('result-grid'),
    closeModal: document.getElementById('close-modal'),
    detailsBtn: document.getElementById('details-btn'),
    historyBtn: document.getElementById('history-btn'),
    tabs: document.querySelectorAll('.tab'),
    
    // 动态创建的元素
    probabilityList: document.querySelector('.probability-list'),
    pityCounters: document.querySelector('.pity-counters'),
    currencyDisplay: document.querySelector('.currency-display')
};

// 初始化函数
function init() {
    createStaticContent();
    updateUI();
    setupEventListeners();
    
    console.log('崩铁卡池模拟初始化完成！');
    console.log('当前星琼:', gameState.stellarJade);
    console.log('五星保底:', gameState.pity5, '/', CONFIG.pity5);
}

// 创建静态内容
function createStaticContent() {
    // 创建概率列表
    const probabilities = [
        { rarity: 5, rate: '0.600%', width: '6%' },
        { rarity: 4, rate: '5.100%', width: '51%' },
        { rarity: 3, rate: '94.300%', width: '94%' }
    ];
    
    probabilities.forEach(prob => {
        const item = document.createElement('div');
        item.className = 'prob-item';
        item.innerHTML = `
            <div>
                <span style="color: ${getRarityColor(prob.rarity)}">
                    ${'★'.repeat(prob.rarity)}
                </span>
                <span> ${prob.rate}</span>
            </div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: ${prob.width}"></div>
            </div>
        `;
        elements.probabilityList.appendChild(item);
    });
    
    // 创建保底计数器
    const pity5Remain = CONFIG.pity5 - gameState.pity5;
    const pity4Remain = CONFIG.pity4 - gameState.pity4;
    
    const pity5Percent = (gameState.pity5 / CONFIG.pity5) * 100;
    const pity4Percent = (gameState.pity4 / CONFIG.pity4) * 100;
    
    elements.pityCounters.innerHTML = `
        <div class="counter">
            <div>五星保底</div>
            <div style="font-size: 1.2em; margin: 5px 0;">
                <span style="color: #ff6b9d">${gameState.pity5}</span>
                <span style="color: #a0a0d0">/</span>
                <span>${CONFIG.pity5}</span>
            </div>
            <div class="counter-progress">
                <div class="counter-fill" style="width: ${pity5Percent}%"></div>
            </div>
            <div style="font-size: 0.9em; color: #a0a0d0">
                剩余 ${pity5Remain} 抽
            </div>
        </div>
        
        <div class="counter">
            <div>四星保底</div>
            <div style="font-size: 1.2em; margin: 5px 0;">
                <span style="color: #9370db">${gameState.pity4}</span>
                <span style="color: #a0a0d0">/</span>
                <span>${CONFIG.pity4}</span>
            </div>
            <div class="counter-progress">
                <div class="counter-fill" style="width: ${pity4Percent}%"></div>
            </div>
            <div style="font-size: 0.9em; color: #a0a0d0">
                剩余 ${pity4Remain} 抽
            </div>
        </div>
    `;
    
    // 创建货币显示
    elements.currencyDisplay.innerHTML = `
        <div class="currency-item">
            <i class="fas fa-star" style="color: #6bd9ff;"></i>
            <div>星琼</div>
            <div style="font-size: 1.5em; font-weight: bold;" id="currency-jade">${gameState.stellarJade}</div>
        </div>
        
        <div class="currency-item">
            <i class="fas fa-ticket-alt" style="color: #ff6b9d;"></i>
            <div>专票</div>
            <div style="font-size: 1.5em; font-weight: bold;" id="currency-ticket">${gameState.specialTicket}</div>
        </div>
    `;
}

// 更新UI
function updateUI() {
    elements.stellarJade.textContent = gameState.stellarJade;
    
    const currencyJade = document.getElementById('currency-jade');
    const currencyTicket = document.getElementById('currency-ticket');
    
    if (currencyJade) currencyJade.textContent = gameState.stellarJade;
    if (currencyTicket) currencyTicket.textContent = gameState.specialTicket;
    
    // 更新按钮状态
    elements.singleDraw.disabled = gameState.stellarJade < CONFIG.characterCost;
    elements.tenDraw.disabled = gameState.stellarJade < CONFIG.tenCost;
    
    // 更新保底显示
    updatePityDisplay();
}

// 更新保底显示
function updatePityDisplay() {
    const pity5Counters = document.querySelectorAll('.counter');
    if (pity5Counters.length >= 2) {
        const pity5Remain = CONFIG.pity5 - gameState.pity5;
        const pity4Remain = CONFIG.pity4 - gameState.pity4;
        
        const pity5Percent = (gameState.pity5 / CONFIG.pity5) * 100;
        const pity4Percent = (gameState.pity4 / CONFIG.pity4) * 100;
        
        // 五星保底
        pity5Counters[0].innerHTML = `
            <div>五星保底</div>
            <div style="font-size: 1.2em; margin: 5px 0;">
                <span style="color: #ff6b9d">${gameState.pity5}</span>
                <span style="color: #a0a0d0">/</span>
                <span>${CONFIG.pity5}</span>
            </div>
            <div class="counter-progress">
                <div class="counter-fill" style="width: ${pity5Percent}%"></div>
            </div>
            <div style="font-size: 0.9em; color: #a0a0d0">
                剩余 ${pity5Remain} 抽
            </div>
        `;
        
        // 四星保底
        pity5Counters[1].innerHTML = `
            <div>四星保底</div>
            <div style="font-size: 1.2em; margin: 5px 0;">
                <span style="color: #9370db">${gameState.pity4}</span>
                <span style="color: #a0a0d0">/</span>
                <span>${CONFIG.pity4}</span>
            </div>
            <div class="counter-progress">
                <div class="counter-fill" style="width: ${pity4Percent}%"></div>
            </div>
            <div style="font-size: 0.9em; color: #a0a0d0">
                剩余 ${pity4Remain} 抽
            </div>
        `;
    }
}

// 设置事件监听器
function setupEventListeners() {
    // 标签切换
    elements.tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            elements.tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const pool = this.dataset.pool;
            switchPool(pool);
        });
    });
    
    // 单抽
    elements.singleDraw.addEventListener('click', function() {
        if (gameState.stellarJade < CONFIG.characterCost) {
            alert('星琼不足！');
            return;
        }
        
        // 扣款
        gameState.stellarJade -= CONFIG.characterCost;
        gameState.pity5++;
        gameState.pity4++;
        
        // 抽卡
        const result = drawSingle();
        showResults([result]);
        updateUI();
    });
    
    // 十连
    elements.tenDraw.addEventListener('click', function() {
        if (gameState.stellarJade < CONFIG.tenCost) {
            alert('星琼不足！');
            return;
        }
        
        // 扣款
        gameState.stellarJade -= CONFIG.tenCost;
        
        // 抽十次
        const results = [];
        for (let i = 0; i < 10; i++) {
            gameState.pity5++;
            gameState.pity4++;
            results.push(drawSingle());
        }
        
        // 十连保底：确保至少一个四星
        if (!results.some(r => r.rarity >= 4)) {
            results[9] = drawItem(4); // 强制四星
        }
        
        showResults(results);
        updateUI();
    });
    
    // 关闭弹窗
    elements.closeModal.addEventListener('click', function() {
        elements.resultModal.style.display = 'none';
    });
    
    // 详情按钮
    elements.detailsBtn.addEventListener('click', function() {
        const details = `
            ☆ 卡池详情 ☆
            
            活动时间：长期开放（模拟）
            
            ★5 UP角色：刃（50%概率）
            ★4 UP角色：佩拉、娜塔莎、阿兰
            
            保底机制：
            • 90抽内必出★5角色
            • 10抽内必出★4或以上物品
            • 未抽中UP角色时，下次★5必为UP角色
            
            综合概率（含保底）：
            • ★5角色：1.600%
            • ★4物品：13.000%
            • ★3光锥：85.400%
        `;
        alert(details);
    });
    
    // 历史记录
    elements.historyBtn.addEventListener('click', function() {
        if (gameState.history.length === 0) {
            alert('暂无跃迁记录');
        } else {
            const last10 = gameState.history.slice(-10);
            const historyText = last10.map((item, i) => 
                `${i + 1}. ${'★'.repeat(item.rarity)} ${item.name} (${item.type})`
            ).join('\n');
            
            alert(`最近10次跃迁记录：\n\n${historyText}`);
        }
    });
    
    // 点击模态窗口外部关闭
    elements.resultModal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
}

// 切换卡池
function switchPool(poolType) {
    console.log('切换到卡池:', poolType);
    
    // 这里可以根据poolType更新UI
    const title = document.querySelector('.pool-title');
    if (title && poolType === 'character') {
        title.textContent = '「刃·业火锋芒」';
    } else if (title && poolType === 'lightcone') {
        title.textContent = '「到不了的彼岸」';
    } else if (title && poolType === 'standard') {
        title.textContent = '「群星跃迁」';
    }
}

// 单抽函数
function drawSingle() {
    // 保底检查
    if (gameState.pity5 >= CONFIG.pity5) {
        gameState.pity5 = 0;
        return drawItem(5);
    }
    
    if (gameState.pity4 >= CONFIG.pity4) {
        gameState.pity4 = 0;
        return drawItem(4);
    }
    
    // 概率抽卡
    const rand = Math.random() * 100;
    
    if (rand < CONFIG.rates[5] * 100) {
        gameState.pity5 = 0;
        return drawItem(5);
    } else if (rand < (CONFIG.rates[5] + CONFIG.rates[4]) * 100) {
        gameState.pity4 = 0;
        return drawItem(4);
    } else {
        return drawItem(3);
    }
}

// 抽取指定稀有度物品
function drawItem(rarity) {
    let item;
    
    switch(rarity) {
        case 5:
            const isUP = gameState.isGuaranteed || Math.random() < CONFIG.upRate;
            item = {
                name: isUP ? itemPool[5].upCharacter : 
                       itemPool[5].characters[Math.floor(Math.random() * itemPool[5].characters.length)],
                type: '角色',
                rarity: 5,
                isUP: isUP
            };
            gameState.isGuaranteed = !isUP;
            break;
            
        case 4:
            const isUP4 = Math.random() < CONFIG.upRate;
            const pool4 = isUP4 ? itemPool[4].upCharacters : itemPool[4].characters;
            item = {
                name: pool4[Math.floor(Math.random() * pool4.length)],
                type: Math.random() > 0.3 ? '角色' : '光锥',
                rarity: 4,
                isUP: isUP4
            };
            break;
            
        case 3:
            item = {
                name: itemPool[3].lightcones[Math.floor(Math.random() * itemPool[3].lightcones.length)],
                type: '光锥',
                rarity: 3,
                isUP: false
            };
            break;
    }
    
    // 记录历史
    gameState.history.push(item);
    
    return item;
}

// 显示结果
function showResults(results) {
    elements.resultGrid.innerHTML = '';
    
    results.forEach((item, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.style.animationDelay = `${index * 0.05}s`;
        
        const rarityColor = getRarityColor(item.rarity);
        const upBadge = item.isUP ? '<div style="color:#ff6b9d; font-size:0.7em;">UP</div>' : '';
        
        resultItem.innerHTML = `
            <div style="color: ${rarityColor}; font-size: 1.2em;">
                ${'★'.repeat(item.rarity)}
            </div>
            <div style="margin: 5px 0; font-weight: bold;">${item.name}</div>
            <div style="font-size: 0.8em; color: #a0a0d0">${item.type}</div>
            ${upBadge}
        `;
        
        elements.resultGrid.appendChild(resultItem);
    });
    
    // 显示弹窗
    elements.resultModal.style.display = 'flex';
    
    // 如果有五星，添加庆祝效果
    const has5Star = results.some(r => r.rarity === 5);
    if (has5Star) {
        celebrate();
    }
}

// 获取稀有度颜色
function getRarityColor(rarity) {
    switch(rarity) {
        case 5: return '#ffd700'; // 金色
        case 4: return '#9370db'; // 紫色
        case 3: return '#6bd9ff'; // 蓝色
        default: return '#ffffff';
    }
}

// 庆祝效果（抽到五星时）
function celebrate() {
    const modalContent = document.querySelector('.modal-content');
    
    // 添加闪光效果
    const sparkle = document.createElement('div');
    sparkle.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(255,215,0,0.3), transparent);
        z-index: -1;
        animation: sparkle 1s ease-out;
    `;
    
    modalContent.appendChild(sparkle);
    
    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes sparkle {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .result-item {
            animation: popIn 0.3s ease-out both;
        }
        
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
    `;
    
    document.head.appendChild(style);
    
    // 播放音效（模拟）
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQ=');
        audio.volume = 0.3;
        audio.play();
    } catch (e) {
        // 静默失败
    }
    
    // 移除闪光效果
    setTimeout(() => {
        if (sparkle.parentNode) {
            sparkle.remove();
        }
    }, 1000);
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', init);