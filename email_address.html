<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆé‚®ç®± - å…­å“¥è£è€€WIKI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f1a2b;
            --bg-secondary: #1a2b3c;
            --bg-card: #223344;
            --accent-gold: #ffd700;
            --accent-blue: #3ecf8e;
            --accent-purple: #8a4baf;
            --text-primary: #ffffff;
            --text-secondary: #a8b5c7;
            --border-color: #3a4a5a;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --transition: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(62, 207, 142, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(138, 75, 175, 0.1) 0%, transparent 50%);
        }

        /* æ¸¸æˆé£æ ¼å®¹å™¨ */
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨ */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .game-title {
            font-size: 2.5rem;
            color: var(--accent-gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
            position: relative;
            display: inline-block;
        }

        .game-title::before, .game-title::after {
            content: 'âœ‰';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8rem;
            color: var(--accent-blue);
        }

        .game-title::before {
            left: -40px;
        }

        .game-title::after {
            right: -40px;
        }

        .game-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* é‚®ç®±ä¸»åŒºåŸŸ */
        .mailbox-container {
            display: flex;
            gap: 20px;
            min-height: 600px;
        }

        @media (max-width: 768px) {
            .mailbox-container {
                flex-direction: column;
            }
        }

        /* å·¦ä¾§å¯¼èˆª */
        .mailbox-sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .write-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            width: 100%;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(62, 207, 142, 0.3);
        }

        .write-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(62, 207, 142, 0.4);
        }

        .mailbox-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-card);
            color: var(--accent-gold);
            border-left: 4px solid var(--accent-gold);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-count {
            margin-left: auto;
            background: var(--accent-blue);
            color: white;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        /* é‚®ä»¶åˆ—è¡¨ */
        .mailbox-content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .mailbox-header {
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .folder-title {
            font-size: 1.5rem;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mailbox-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .mail-list {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .mail-list::-webkit-scrollbar {
            width: 8px;
        }

        .mail-list::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 4px;
        }

        .mail-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .mail-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* é‚®ä»¶é¡¹ */
        .mail-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .mail-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(62, 207, 142, 0.2);
        }

        .mail-item.unread {
            border-left: 4px solid var(--accent-gold);
        }

        .mail-item.read {
            opacity: 0.8;
        }

        .mail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mail-sender {
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 1.1rem;
        }

        .mail-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .mail-subject {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .mail-preview {
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .mail-attachment {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: var(--accent-blue);
            font-size: 0.9rem;
            padding: 4px 10px;
            background: rgba(62, 207, 142, 0.1);
            border-radius: 12px;
        }

        /* é‚®ä»¶è¯¦æƒ… */
        .mail-detail {
            display: none;
            padding: 30px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-top: 20px;
            border: 2px solid var(--border-color);
            animation: fadeIn 0.3s ease;
        }

        .mail-detail.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .detail-header {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-subject {
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .detail-sender {
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .detail-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-content {
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .detail-content p {
            margin-bottom: 15px;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 2px solid var(--border-color);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--accent-gold);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .form-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(62, 207, 142, 0.2);
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            resize: vertical;
            min-height: 150px;
            font-family: inherit;
        }

        .form-textarea:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(62, 207, 142, 0.2);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(62, 207, 142, 0.3);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* æ¸¸æˆå¾½ç«  */
        .game-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-gold);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(62, 207, 142, 0.2);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--radius);
            background: var(--accent-blue);
            color: white;
            box-shadow: var(--shadow);
            transform: translateX(120%);
            transition: transform 0.4s ease;
            z-index: 1001;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f87171;
        }

        .notification.success {
            background: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- å¤´éƒ¨ -->
        <header class="game-header">
            <h1 class="game-title">æ¸¸æˆé‚®ç®±</h1>
            <p class="game-subtitle">æ¥æ”¶æ¸¸æˆé€šçŸ¥ã€ç³»ç»Ÿå¥–åŠ±å’Œå¥½å‹æ¶ˆæ¯</p>
        </header>

        <!-- ä¸»é‚®ç®±åŒºåŸŸ -->
        <div class="mailbox-container">
            <!-- å·¦ä¾§å¯¼èˆª -->
            <div class="mailbox-sidebar">
                <button class="write-btn" id="writeBtn">
                    <i class="fas fa-pen"></i>
                    å†™é‚®ä»¶
                </button>
                
                <div class="mailbox-nav">
                    <button class="nav-item active" data-folder="inbox">
                        <i class="fas fa-inbox nav-icon"></i>
                        æ”¶ä»¶ç®±
                        <span class="nav-count" id="inboxCount">0</span>
                    </button>
                    <button class="nav-item" data-folder="unread">
                        <i class="fas fa-envelope nav-icon"></i>
                        æœªè¯»é‚®ä»¶
                        <span class="nav-count" id="unreadCount">0</span>
                    </button>
                    <button class="nav-item" data-folder="system">
                        <i class="fas fa-cog nav-icon"></i>
                        ç³»ç»Ÿé€šçŸ¥
                        <span class="nav-count" id="systemCount">0</span>
                    </button>
                    <button class="nav-item" data-folder="rewards">
                        <i class="fas fa-gift nav-icon"></i>
                        æ¸¸æˆå¥–åŠ±
                        <span class="nav-count" id="rewardsCount">0</span>
                    </button>
                    <button class="nav-item" data-folder="sent">
                        <i class="fas fa-paper-plane nav-icon"></i>
                        å·²å‘é€
                    </button>
                </div>
            </div>

            <!-- é‚®ä»¶åˆ—è¡¨åŒºåŸŸ -->
            <div class="mailbox-content">
                <div class="mailbox-header">
                    <div class="folder-title">
                        <i class="fas fa-inbox"></i>
                        <span id="currentFolder">æ”¶ä»¶ç®±</span>
                    </div>
                    <div class="mailbox-actions">
                        <button class="action-btn" id="refreshBtn">
                            <i class="fas fa-redo"></i>
                            åˆ·æ–°
                        </button>
                        <button class="action-btn" id="markReadBtn">
                            <i class="fas fa-check"></i>
                            æ ‡è®°å·²è¯»
                        </button>
                    </div>
                </div>

                <!-- é‚®ä»¶åˆ—è¡¨ -->
                <div class="mail-list" id="mailList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>åŠ è½½é‚®ä»¶ä¸­...</p>
                    </div>
                </div>

                <!-- é‚®ä»¶è¯¦æƒ… -->
                <div class="mail-detail" id="mailDetail">
                    <div class="detail-header">
                        <h2 class="detail-subject" id="detailSubject">æ¬¢è¿æ¥åˆ°å…­å“¥è£è€€WIKI</h2>
                        <div class="detail-sender" id="detailSender">ç³»ç»Ÿç®¡ç†å‘˜</div>
                        <div class="detail-date" id="detailDate">2024å¹´3æœˆ15æ—¥</div>
                    </div>
                    <div class="detail-content" id="detailContent">
                        <p>æ¬¢è¿åŠ å…¥å…­å“¥è£è€€WIKIï¼æˆ‘ä»¬å¾ˆé«˜å…´ä½ çš„åˆ°æ¥ã€‚</p>
                        <p>åœ¨è¿™é‡Œä½ å¯ä»¥ï¼š</p>
                        <ul>
                            <li>æŸ¥çœ‹æ¸¸æˆæ”»ç•¥å’Œè‹±é›„èµ„æ–™</li>
                            <li>å‚ä¸ç¤¾åŒºè®¨è®º</li>
                            <li>æ¥æ”¶æ¸¸æˆæ›´æ–°é€šçŸ¥</li>
                            <li>é¢†å–æ¯æ—¥å¥–åŠ±</li>
                        </ul>
                        <p>ç¥ä½ æ¸¸æˆæ„‰å¿«ï¼</p>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-primary" id="replyBtn">
                            <i class="fas fa-reply"></i>
                            å›å¤
                        </button>
                        <button class="btn btn-secondary" id="deleteDetailBtn">
                            <i class="fas fa-trash"></i>
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å†™é‚®ä»¶æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="composeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">å†™é‚®ä»¶</div>
                <button class="modal-close" id="closeComposeBtn">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">æ”¶ä»¶äºº</label>
                <input type="text" class="form-input" id="composeTo" placeholder="è¾“å…¥ç©å®¶IDæˆ–é‚®ç®±">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»é¢˜</label>
                <input type="text" class="form-input" id="composeSubject" placeholder="é‚®ä»¶ä¸»é¢˜">
            </div>
            <div class="form-group">
                <label class="form-label">å†…å®¹</label>
                <textarea class="form-textarea" id="composeBody" placeholder="è¾“å…¥é‚®ä»¶å†…å®¹..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelComposeBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="sendMailBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== Supabaseé…ç½® ====================
        const SUPABASE_URL = 'https://ysmijycsyzpjoieaknmb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzbWlqeWNzeXpwam9pZWFrbm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNDgzNjMsImV4cCI6MjA4MjgyNDM2M30.H7dx2k_0099LVXprMrghHOFh16OoSSgtCUOib2otHPA';
        
        let supabaseClient = null;
        let currentUser = null;
        let currentFolder = 'inbox';
        let selectedMailId = null;

        // ==================== é‚®ä»¶æ•°æ® ====================
        const mockMails = [
            {
                id: 1,
                sender: 'ç³»ç»Ÿç®¡ç†å‘˜',
                sender_id: 'system',
                subject: 'ğŸ‰ æ¬¢è¿æ¥åˆ°å…­å“¥è£è€€WIKIï¼',
                content: `æ¬¢è¿åŠ å…¥å…­å“¥è£è€€WIKIï¼<br><br>
                         ğŸ® åœ¨è¿™é‡Œä½ å¯ä»¥ï¼š<br>
                         â€¢ æŸ¥çœ‹æœ€æ–°æ¸¸æˆæ”»ç•¥<br>
                         â€¢ äº†è§£è‹±é›„æŠ€èƒ½<br>
                         â€¢ å‚ä¸ç¤¾åŒºè®¨è®º<br>
                         â€¢ é¢†å–æ¯æ—¥å¥–åŠ±<br><br>
                         ğŸ’ æ–°æ‰‹å¥–åŠ±å·²å‘æ”¾åˆ°ä½ çš„è´¦æˆ·ï¼<br>
                         âš¡ ç¥ä½ åœ¨æ¸¸æˆä¸­å–å¾—èƒœåˆ©ï¼`,
                timestamp: new Date().toISOString(),
                read: false,
                folder: 'system',
                attachments: [],
                is_reward: true
            },
            {
                id: 2,
                sender: 'æ¸¸æˆç®¡ç†å‘˜',
                sender_id: 'game_master',
                subject: 'ğŸ“… æœ¬å‘¨æ´»åŠ¨é¢„å‘Š',
                content: `äº²çˆ±çš„ç©å®¶ï¼š<br><br>
                         ğŸ† æœ¬å‘¨å°†æœ‰ä»¥ä¸‹ç²¾å½©æ´»åŠ¨ï¼š<br>
                         â€¢ å‘¨ä¸€ï¼šåŒå€ç»éªŒæ—¥<br>
                         â€¢ å‘¨ä¸‰ï¼šé™æ—¶BossæŒ‘æˆ˜<br>
                         â€¢ å‘¨äº”ï¼šå…¬ä¼šæˆ˜<br>
                         â€¢ å‘¨æœ«ï¼šå¤©æ¢¯èµ›<br><br>
                         ğŸ å‚ä¸æ´»åŠ¨å¯è·å¾—ä¸°åšå¥–åŠ±ï¼`,
                timestamp: new Date(Date.now() - 86400000).toISOString(), // 1å¤©å‰
                read: true,
                folder: 'system',
                attachments: []
            },
            {
                id: 3,
                sender: 'å¥–åŠ±ä¸­å¿ƒ',
                sender_id: 'rewards',
                subject: 'ğŸ æ¯æ—¥ç™»å½•å¥–åŠ±',
                content: `æ­å–œä½ ï¼è¿ç»­ç™»å½•7å¤©ï¼<br><br>
                         ğŸ’° è·å¾—å¥–åŠ±ï¼š<br>
                         â€¢ é‡‘å¸ Ã— 500<br>
                         â€¢ é’»çŸ³ Ã— 50<br>
                         â€¢ ç»éªŒè¯æ°´ Ã— 3<br><br>
                         ğŸ† ç»§ç»­ä¿æŒç™»å½•å¯è·å¾—æ›´å¤šå¥–åŠ±ï¼`,
                timestamp: new Date(Date.now() - 172800000).toISOString(), // 2å¤©å‰
                read: false,
                folder: 'rewards',
                attachments: [],
                is_reward: true
            },
            {
                id: 4,
                sender: 'å¥½å‹-å¼ ä¸‰',
                sender_id: 'player_001',
                subject: 'ğŸ‘‹ ä¸€èµ·ç»„é˜Ÿå—ï¼Ÿ',
                content: `å˜¿ï¼Œæˆ‘çœ‹åˆ°ä½ ä¹Ÿåœ¨ç©è£è€€ï¼<br><br>
                         æˆ‘æœ‰ä¸ªå‰¯æœ¬ä»»åŠ¡éœ€è¦é˜Ÿå‹ï¼Œ<br>
                         ä½ æœ‰å…´è¶£ä¸€èµ·å—ï¼Ÿ<br><br>
                         æˆ‘ä»¬å¯ä»¥çº¦ä»Šæ™š8ç‚¹ã€‚<br>
                         æœŸå¾…ä½ çš„å›å¤ï¼`,
                timestamp: new Date(Date.now() - 259200000).toISOString(), // 3å¤©å‰
                read: true,
                folder: 'inbox',
                attachments: []
            }
        ];

        // ==================== åˆå§‹åŒ–å‡½æ•° ====================
        async function init() {
            try {
                // åˆå§‹åŒ–Supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    showNotification('è¯·å…ˆç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'login-real.html';
                    }, 2000);
                    return;
                }
                
                currentUser = user;
                
                // åˆå§‹åŒ–é‚®ç®±ç•Œé¢
                setupEventListeners();
                loadMails();
                updateMailCounts();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 'error');
                // é™çº§åˆ°æœ¬åœ°æ¨¡å¼
                setupEventListeners();
                loadMockMails();
            }
        }

        // ==================== é‚®ä»¶åŠ è½½å‡½æ•° ====================
        async function loadMails() {
            try {
                const mailList = document.getElementById('mailList');
                mailList.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>åŠ è½½é‚®ä»¶ä¸­...</p>
                    </div>
                `;

                let mails = [];
                
                if (supabaseClient && currentUser) {
                    // ä»SupabaseåŠ è½½é‚®ä»¶
                    const { data, error } = await supabaseClient
                        .from('user_mails')
                        .select('*')
                        .eq('receiver_id', currentUser.id)
                        .eq('folder', currentFolder)
                        .order('timestamp', { ascending: false });
                    
                    if (error) throw error;
                    mails = data || [];
                }
                
                // å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (mails.length === 0) {
                    mails = mockMails.filter(mail => mail.folder === currentFolder);
                }
                
                renderMailList(mails);
                
            } catch (error) {
                console.error('åŠ è½½é‚®ä»¶å¤±è´¥:', error);
                // é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
                const mails = mockMails.filter(mail => mail.folder === currentFolder);
                renderMailList(mails);
            }
        }

        function loadMockMails() {
            const mails = mockMails.filter(mail => mail.folder === currentFolder);
            renderMailList(mails);
            updateMailCounts();
        }

        // ==================== æ¸²æŸ“å‡½æ•° ====================
        function renderMailList(mails) {
            const mailList = document.getElementById('mailList');
            
            if (mails.length === 0) {
                mailList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox empty-icon"></i>
                        <p>å½“å‰æ–‡ä»¶å¤¹æ²¡æœ‰é‚®ä»¶</p>
                    </div>
                `;
                return;
            }
            
            mailList.innerHTML = mails.map(mail => `
                <div class="mail-item ${mail.read ? 'read' : 'unread'}" 
                     data-id="${mail.id}"
                     onclick="viewMail(${mail.id})">
                    ${mail.is_reward ? '<span class="game-badge">å¥–åŠ±</span>' : ''}
                    <div class="mail-header">
                        <div class="mail-sender">${mail.sender}</div>
                        <div class="mail-date">${formatDate(mail.timestamp)}</div>
                    </div>
                    <div class="mail-subject">${mail.subject}</div>
                    <div class="mail-preview">${mail.content.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>
                    ${mail.attachments && mail.attachments.length > 0 ? 
                        `<div class="mail-attachment"><i class="fas fa-paperclip"></i> ${mail.attachments.length}ä¸ªé™„ä»¶</div>` : ''}
                </div>
            `).join('');
        }

        function viewMail(mailId) {
            const mail = [...mockMails, ...getLocalMails()].find(m => m.id === mailId);
            if (!mail) return;
            
            // æ ‡è®°ä¸ºå·²è¯»
            if (!mail.read) {
                mail.read = true;
                updateMailReadStatus(mailId, true);
                updateMailCounts();
                loadMails(); // é‡æ–°åŠ è½½æ›´æ–°çŠ¶æ€
            }
            
            // æ›´æ–°è¯¦æƒ…è§†å›¾
            document.getElementById('detailSubject').textContent = mail.subject;
            document.getElementById('detailSender').textContent = mail.sender;
            document.getElementById('detailDate').textContent = formatDate(mail.timestamp, true);
            document.getElementById('detailContent').innerHTML = mail.content;
            
            // æ˜¾ç¤ºè¯¦æƒ…
            document.getElementById('mailDetail').classList.add('active');
            selectedMailId = mailId;
            
            // å¦‚æœæ˜¯å¥–åŠ±é‚®ä»¶ï¼Œæ·»åŠ é¢†å–æŒ‰é’®
            const detailActions = document.querySelector('.detail-actions');
            if (mail.is_reward && !mail.claimed) {
                detailActions.innerHTML = `
                    <button class="btn btn-primary" onclick="claimReward(${mailId})">
                        <i class="fas fa-gift"></i>
                        é¢†å–å¥–åŠ±
                    </button>
                    <button class="btn btn-secondary" onclick="deleteMail(${mailId})">
                        <i class="fas fa-trash"></i>
                        åˆ é™¤
                    </button>
                `;
            } else {
                detailActions.innerHTML = `
                    <button class="btn btn-primary" onclick="replyToMail(${mailId})">
                        <i class="fas fa-reply"></i>
                        å›å¤
                    </button>
                    <button class="btn btn-secondary" onclick="deleteMail(${mailId})">
                        <i class="fas fa-trash"></i>
                        åˆ é™¤
                    </button>
                `;
            }
        }

        // ==================== é‚®ä»¶æ“ä½œå‡½æ•° ====================
        async function sendMail() {
            const to = document.getElementById('composeTo').value.trim();
            const subject = document.getElementById('composeSubject').value.trim();
            const body = document.getElementById('composeBody').value.trim();
            
            if (!to || !subject || !body) {
                showNotification('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }
            
            try {
                const mailData = {
                    sender_id: currentUser.id,
                    sender_name: currentUser.user_metadata?.username || currentUser.email.split('@')[0],
                    receiver_id: to,
                    subject: subject,
                    content: body,
                    timestamp: new Date().toISOString(),
                    read: false,
                    folder: 'inbox',
                    attachments: []
                };
                
                // ä¿å­˜åˆ°Supabase
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('user_mails')
                        .insert([mailData]);
                    
                    if (error) throw error;
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveMailToLocal(mailData);
                
                showNotification('é‚®ä»¶å‘é€æˆåŠŸï¼', 'success');
                closeComposeModal();
                
                // å¦‚æœæ˜¯å‘é€ç»™è‡ªå·±çš„æµ‹è¯•é‚®ä»¶ï¼Œé‡æ–°åŠ è½½
                if (to === currentUser.id || to === currentUser.email) {
                    setTimeout(loadMails, 1000);
                }
                
            } catch (error) {
                console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
                showNotification('å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteMail(mailId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°é‚®ä»¶å—ï¼Ÿ')) return;
            
            try {
                // ä»Supabaseåˆ é™¤
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('user_mails')
                        .delete()
                        .eq('id', mailId)
                        .eq('receiver_id', currentUser.id);
                    
                    if (error) throw error;
                }
                
                // ä»æœ¬åœ°åˆ é™¤
                deleteLocalMail(mailId);
                
                showNotification('é‚®ä»¶å·²åˆ é™¤', 'success');
                document.getElementById('mailDetail').classList.remove('active');
                loadMails();
                updateMailCounts();
                
            } catch (error) {
                console.error('åˆ é™¤é‚®ä»¶å¤±è´¥:', error);
                showNotification('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        async function claimReward(mailId) {
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ é¢†å–å¥–åŠ±çš„é€»è¾‘
                // ä¾‹å¦‚ï¼šå¢åŠ ç”¨æˆ·ç»éªŒã€é‡‘å¸ç­‰
                
                showNotification('ğŸ‰ å¥–åŠ±é¢†å–æˆåŠŸï¼ç»éªŒå€¼+50ï¼Œé‡‘å¸+200', 'success');
                
                // æ ‡è®°é‚®ä»¶ä¸ºå·²é¢†å–
                if (supabaseClient) {
                    await supabaseClient
                        .from('user_mails')
                        .update({ claimed: true })
                        .eq('id', mailId);
                }
                
                document.getElementById('mailDetail').classList.remove('active');
                loadMails();
                
            } catch (error) {
                console.error('é¢†å–å¥–åŠ±å¤±è´¥:', error);
                showNotification('é¢†å–å¤±è´¥', 'error');
            }
        }

        async function updateMailReadStatus(mailId, isRead) {
            try {
                if (supabaseClient) {
                    await supabaseClient
                        .from('user_mails')
                        .update({ read: isRead })
                        .eq('id', mailId)
                        .eq('receiver_id', currentUser.id);
                }
            } catch (error) {
                console.error('æ›´æ–°å·²è¯»çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ==================== æœ¬åœ°å­˜å‚¨è¾…åŠ©å‡½æ•° ====================
        function getLocalMails() {
            try {
                const saved = localStorage.getItem(`user_mails_${currentUser?.id}`);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                return [];
            }
        }

        function saveMailToLocal(mail) {
            try {
                const mails = getLocalMails();
                mail.id = Date.now(); // ç”Ÿæˆå”¯ä¸€ID
                mails.push(mail);
                localStorage.setItem(`user_mails_${currentUser?.id}`, JSON.stringify(mails));
            } catch (error) {
                console.error('ä¿å­˜é‚®ä»¶åˆ°æœ¬åœ°å¤±è´¥:', error);
            }
        }

        function deleteLocalMail(mailId) {
            try {
                let mails = getLocalMails();
                mails = mails.filter(mail => mail.id !== mailId);
                localStorage.setItem(`user_mails_${currentUser?.id}`, JSON.stringify(mails));
            } catch (error) {
                console.error('åˆ é™¤æœ¬åœ°é‚®ä»¶å¤±è´¥:', error);
            }
        }

        // ==================== UIæ›´æ–°å‡½æ•° ====================
        function updateMailCounts() {
            const allMails = [...mockMails, ...getLocalMails()];
            
            // æ”¶ä»¶ç®±è®¡æ•°
            const inboxCount = allMails.filter(m => m.folder === 'inbox').length;
            document.getElementById('inboxCount').textContent = inboxCount;
            
            // æœªè¯»é‚®ä»¶è®¡æ•°
            const unreadCount = allMails.filter(m => !m.read).length;
            document.getElementById('unreadCount').textContent = unreadCount;
            
            // ç³»ç»Ÿé€šçŸ¥è®¡æ•°
            const systemCount = allMails.filter(m => m.folder === 'system').length;
            document.getElementById('systemCount').textContent = systemCount;
            
            // å¥–åŠ±é‚®ä»¶è®¡æ•°
            const rewardsCount = allMails.filter(m => m.folder === 'rewards').length;
            document.getElementById('rewardsCount').textContent = rewardsCount;
        }

        function updateFolderTitle(folder) {
            const titles = {
                'inbox': 'æ”¶ä»¶ç®±',
                'unread': 'æœªè¯»é‚®ä»¶',
                'system': 'ç³»ç»Ÿé€šçŸ¥',
                'rewards': 'æ¸¸æˆå¥–åŠ±',
                'sent': 'å·²å‘é€'
            };
            document.getElementById('currentFolder').textContent = titles[folder] || folder;
        }

        // ==================== äº‹ä»¶ç›‘å¬å™¨ ====================
        function setupEventListeners() {
            // å¯¼èˆªç‚¹å‡»
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentFolder = this.dataset.folder;
                    updateFolderTitle(currentFolder);
                    document.getElementById('mailDetail').classList.remove('active');
                    loadMails();
                });
            });
            
            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').addEventListener('click', loadMails);
            
            // æ ‡è®°å·²è¯»æŒ‰é’®
            document.getElementById('markReadBtn').addEventListener('click', function() {
                // æ ‡è®°æ‰€æœ‰ä¸ºå·²è¯»çš„é€»è¾‘
                showNotification('å·²æ ‡è®°æ‰€æœ‰é‚®ä»¶ä¸ºå·²è¯»', 'success');
                setTimeout(loadMails, 500);
            });
            
            // å†™é‚®ä»¶æŒ‰é’®
            document.getElementById('writeBtn').addEventListener('click', function() {
                document.getElementById('composeModal').classList.add('active');
            });
            
            // å…³é—­å†™é‚®ä»¶æ¨¡æ€æ¡†
            document.getElementById('closeComposeBtn').addEventListener('click', closeComposeModal);
            document.getElementById('cancelComposeBtn').addEventListener('click', closeComposeModal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('composeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeComposeModal();
                }
            });
            
            // å‘é€é‚®ä»¶æŒ‰é’®
            document.getElementById('sendMailBtn').addEventListener('click', sendMail);
            
            // å›å¤é‚®ä»¶
            window.replyToMail = function(mailId) {
                const mail = [...mockMails, ...getLocalMails()].find(m => m.id === mailId);
                if (mail) {
                    document.getElementById('composeTo').value = mail.sender_id;
                    document.getElementById('composeSubject').value = `å›å¤ï¼š${mail.subject}`;
                    document.getElementById('composeBody').value = `\n\n--- åŸé‚®ä»¶ ---\n${mail.content.replace(/<[^>]*>/g, '')}`;
                    document.getElementById('composeModal').classList.add('active');
                }
            };
            
            // åˆ é™¤é‚®ä»¶è¯¦æƒ…
            window.deleteMail = deleteMail;
            
            // é¢†å–å¥–åŠ±
            window.claimReward = claimReward;
            
            // æŸ¥çœ‹é‚®ä»¶
            window.viewMail = viewMail;
        }

        function closeComposeModal() {
            document.getElementById('composeModal').classList.remove('active');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('composeTo').value = '';
            document.getElementById('composeSubject').value = '';
            document.getElementById('composeBody').value = '';
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function formatDate(dateString, full = false) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (full) {
                return date.toLocaleString('zh-CN');
            }
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>